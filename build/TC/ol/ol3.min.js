!function(){Math.hypot=Math.hypot||function(){for(var e=0,t=arguments.length,r=0;t>r;r++){if(arguments[r]===1/0||arguments[r]===-(1/0))return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)}}(),function(){for(var e=0,t=["ms","moz","webkit","o"],r=0;r<t.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[r]+"CancelAnimationFrame"]||window[t[r]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,r){var a=(new Date).getTime(),o=Math.max(0,16-(a-e)),n=window.setTimeout(function(){t(a+o)},o);return e=a+o,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){var e="mousemove.tc",t="mouseout.tc",r="mouseover.tc",a=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/"));a=a.substr(0,a.lastIndexOf("/")+1)+"css/ol.css",ol.proj.oldGet=ol.proj.get,ol.proj.get=function(e){if("string"==typeof e){for(var t=0,r=ol.proj.EPSG4326.PROJECTIONS.length;r>t;t++){var a=ol.proj.EPSG4326.PROJECTIONS[t];if(a.getCode()===e)return a}TC.loadProjDef(e,!0)}return ol.proj.oldGet(e)},ol.format.GMLBase.prototype.readGeometryElement=function(e,t){var r=t[0],a=r.srsName=e.firstElementChild.getAttribute("srsName");if((this instanceof ol.format.GML2CRS84||this instanceof ol.format.GML3CRS84)&&("EPSG:4326"!==a||!a))throw"Conflicto de CRS";a&&(r.srsName=this.srsName||a,r.dataProjection=ol.proj.get(r.srsName));var o=ol.xml.pushParseAndPop(null,this.GEOMETRY_PARSERS_,e,t,this);return o?ol.format.Feature.transformWithOptions(o,!1,r):void 0};var o="http://www.opengis.net/gml",n="http://www.opengis.net/gml/3.2";ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[n]=ol.format.GMLBase.prototype.MULTIPOINT_PARSERS_[o],ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[n]=ol.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[o],ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[n]=ol.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[o],ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[n]=ol.format.GMLBase.prototype.POINTMEMBER_PARSERS_[o],ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[n]=ol.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[o],ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[n]=ol.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[o],ol.format.GMLBase.prototype.RING_PARSERS[n]=ol.format.GMLBase.prototype.RING_PARSERS[o],ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[n]=ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[o],ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[n]=ol.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[o],ol.format.GML3.prototype.GEOMETRY_PARSERS_[n]=ol.format.GML3.prototype.GEOMETRY_PARSERS_[o],ol.format.GML3.prototype.MULTICURVE_PARSERS_[n]=ol.format.GML3.prototype.MULTICURVE_PARSERS_[o],ol.format.GML3.prototype.MULTISURFACE_PARSERS_[n]=ol.format.GML3.prototype.MULTISURFACE_PARSERS_[o],ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[n]=ol.format.GML3.prototype.CURVEMEMBER_PARSERS_[o],ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[n]=ol.format.GML3.prototype.SURFACEMEMBER_PARSERS_[o],ol.format.GML3.prototype.SURFACE_PARSERS_[n]=ol.format.GML3.prototype.SURFACE_PARSERS_[o],ol.format.GML3.prototype.CURVE_PARSERS_[n]=ol.format.GML3.prototype.CURVE_PARSERS_[o],ol.format.GML3.prototype.ENVELOPE_PARSERS_[n]=ol.format.GML3.prototype.ENVELOPE_PARSERS_[o],ol.format.GML3.prototype.PATCHES_PARSERS_[n]=ol.format.GML3.prototype.PATCHES_PARSERS_[o],ol.format.GML3.prototype.SEGMENTS_PARSERS_[n]=ol.format.GML3.prototype.SEGMENTS_PARSERS_[o],ol.format.KML.prototype._readDocumentOrFolder_=ol.format.KML.prototype.readDocumentOrFolder_,ol.format.KML.prototype.readDocumentOrFolder_=function(e,t){var r=ol.format.KML.prototype._readDocumentOrFolder_.apply(this,arguments);if("Folder"==e.localName)for(var a=0;a<r.length;a++){var o=r[a];$.isArray(o._folders)||(o._folders=[]);var n=e.getElementsByTagName("name")[0];n&&TC.Util.fastUnshift(o._folders,n.innerHTML||n.textContent)}return r},ol.format.KML.readText_=function(e,t){ol.asserts.assert(e.nodeType==Node.ELEMENT_NODE),ol.asserts.assert("text"==e.localName);var r=ol.xml.getAllTextContent(e,!1);return r.trim()},ol.format.KML.BALLOON_STYLE_PARSERS_=ol.xml.makeStructureNS(ol.format.KML.NAMESPACE_URIS_,{text:ol.xml.makeObjectPropertySetter(ol.format.KML.readText_)}),ol.format.KML.BalloonStyleParser_=function(e,t){ol.asserts.assert(e.nodeType==Node.ELEMENT_NODE),ol.asserts.assert("BalloonStyle"==e.localName);var r=ol.xml.pushParseAndPop({},ol.format.KML.BALLOON_STYLE_PARSERS_,e,t);if(goog.isDef(r)){var a=t[t.length-1];ol.asserts.assert(goog.isObject(a));var o=new ol.style.Text({text:r.text});a.balloonStyle=o}};for(var i in ol.format.KML.STYLE_PARSERS_){var s=ol.format.KML.STYLE_PARSERS_[i];s.BalloonStyle=ol.format.KML.BalloonStyleParser_}ol.format.KML.readStyle_=function(e,t){var r=ol.xml.pushParseAndPop({},ol.format.KML.STYLE_PARSERS_,e,t);if(!r)return null;var a="fillStyle"in r?r.fillStyle:ol.format.KML.DEFAULT_FILL_STYLE_,o=r.fill;void 0===o||o||(a=null);var n="imageStyle"in r?r.imageStyle:ol.format.KML.DEFAULT_IMAGE_STYLE_;n==ol.format.KML.DEFAULT_NO_IMAGE_STYLE_&&(n=void 0);var i="textStyle"in r?r.textStyle:ol.format.KML.DEFAULT_TEXT_STYLE_,s="strokeStyle"in r?r.strokeStyle:ol.format.KML.DEFAULT_STROKE_STYLE_,l="balloonStyle"in r?r.balloonStyle:ol.format.KML.DEFAULT_BALLOON_STYLE_,p=r.outline;void 0===p||p||(s=null);var c=new ol.style.Style({fill:a,image:n,stroke:s,text:i,zIndex:void 0});return c._balloon=l,[c]},ol.format.KML.whenParser_=function(e,t){ol.asserts.assert(e.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT"),ol.asserts.assert("when"==e.localName,"localName should be when");var r=t[t.length-1];ol.asserts.assert(goog.isObject(r),"gxTrackObject should be an Object");var r=r.whens,a=ol.xml.getAllTextContent(e,!1);if(a=/^\s*(\d{4})($|-(\d{2})($|-(\d{2})($|T(\d{2}):(\d{2}):(\d{2})(?:.?\d{3})?(Z|(?:([+\-])(\d{2})(?::(\d{2}))?)))))\s*$/.exec(a)){var o=parseInt(a[1],10),n=a[3]?parseInt(a[3],10)-1:0,i=a[5]?parseInt(a[5],10):1,s=a[7]?parseInt(a[7],10):0,l=a[8]?parseInt(a[8],10):0,p=a[9]?parseInt(a[9],10):0,o=Date.UTC(o,n,i,s,l,p);a[10]&&"Z"!=a[10]&&(n="-"==a[11]?-1:1,o+=60*n*parseInt(a[12],10),a[13]&&(o+=3600*n*parseInt(a[13],10))),r.push(o)}else r.push(0)},ol.format.KML.GX_TRACK_PARSERS_=ol.xml.makeStructureNS(ol.format.KML.NAMESPACE_URIS_,{when:ol.format.KML.whenParser_},ol.xml.makeStructureNS(ol.format.KML.GX_NAMESPACE_URIS_,{coord:ol.format.KML.gxCoordParser_})),ol.format.XSD.readDateTime=function(e){if(e=ol.xml.getAllTextContent(e,!1),e=/^\s*(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|(?:([+\-])(\d{2})(?::(\d{2}))?))\s*$/.exec(e)){var t=parseInt(e[1],10),r=parseInt(e[2],10)-1,a=parseInt(e[3],10),o=parseInt(e[4],10),n=parseInt(e[5],10),i=parseInt(e[6],10),t=Date.UTC(t,r,a,o,n,i);return"Z"!=e[7]&&(r="-"==e[8]?-1:1,t+=60*r*parseInt(e[9],10),void 0!==e[10]&&(t+=3600*r*parseInt(e[10],10))),t}},ol.format.GPX.RTEPT_PARSERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),time:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime)}),ol.format.GPX.TRKPT_PARSERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),time:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime)}),ol.format.GPX.WPT_PARSERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),time:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDateTime),magvar:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),geoidheight:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),name:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),cmt:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),desc:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),src:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),link:ol.format.GPX.parseLink_,sym:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),type:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),fix:ol.xml.makeObjectPropertySetter(ol.format.XSD.readString),sat:ol.xml.makeObjectPropertySetter(ol.format.XSD.readNonNegativeInteger),hdop:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),vdop:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),pdop:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),ageofdgpsdata:ol.xml.makeObjectPropertySetter(ol.format.XSD.readDecimal),dgpsid:ol.xml.makeObjectPropertySetter(ol.format.XSD.readNonNegativeInteger),extensions:ol.format.GPX.parseExtensions_}),ol.format.XSD.writeDateTimeTextNode=function(e,t){var r=new Date(t),a=r.getUTCFullYear()+"-"+goog.string.padNumber(r.getUTCMonth()+1,2)+"-"+goog.string.padNumber(r.getUTCDate(),2)+"T"+goog.string.padNumber(r.getUTCHours(),2)+":"+goog.string.padNumber(r.getUTCMinutes(),2)+":"+goog.string.padNumber(r.getUTCSeconds(),2)+"Z";e.appendChild(ol.xml.DOCUMENT.createTextNode(a))},ol.format.GPX.WPT_TYPE_SERIALIZERS_=ol.xml.makeStructureNS(ol.format.GPX.NAMESPACE_URIS_,{ele:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),time:ol.xml.makeChildAppender(ol.format.XSD.writeDateTimeTextNode),magvar:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),geoidheight:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),name:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),cmt:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),desc:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),src:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),link:ol.xml.makeChildAppender(ol.format.GPX.writeLink_),sym:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),type:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),fix:ol.xml.makeChildAppender(ol.format.XSD.writeStringTextNode),sat:ol.xml.makeChildAppender(ol.format.XSD.writeNonNegativeIntegerTextNode),hdop:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),vdop:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),pdop:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),ageofdgpsdata:ol.xml.makeChildAppender(ol.format.XSD.writeDecimalTextNode),dgpsid:ol.xml.makeChildAppender(ol.format.XSD.writeNonNegativeIntegerTextNode)}),ol.format.GMLBase.prototype.readFeaturesInternal=function(e,t){ol.DEBUG&&console.assert(e.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT");var r=e.localName,a=null;if("FeatureCollection"==r)"http://www.opengis.net/wfs"===e.namespaceURI?a=ol.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,e,t,this):(this.FEATURE_COLLECTION_PARSERS[e.namespaceURI]=this.FEATURE_COLLECTION_PARSERS[e.namespaceURI]||this.FEATURE_COLLECTION_PARSERS[ol.format.GMLBase.GMLNS],a=ol.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,e,t,this));else if("featureMembers"==r||"featureMember"==r){var o,n,i=t[0],s=i.featureType,l=i.featureNS,p="p",c="p0";if(e.childNodes){for(s=[],l={},o=0,n=e.childNodes.length;n>o;++o){var u=e.childNodes[o];if(1===u.nodeType){var g=u.nodeName.split(":").pop();if(-1===s.indexOf(g)){var f="",m=0,y=u.namespaceURI;for(var d in l){if(l[d]===y){f=d;break}++m}f||(f=p+m,l[f]=y),s.push(f+":"+g)}}}"featureMember"!=r&&(i.featureType=s,i.featureNS=l)}if("string"==typeof l){var v=l;l={},l[c]=v}var h={},C=Array.isArray(s)?s:[s];for(var T in l){var w={};for(o=0,n=C.length;n>o;++o){var S=-1===C[o].indexOf(":")?c:C[o].split(":")[0];S===T&&(w[C[o].split(":").pop()]="featureMembers"==r?ol.xml.makeArrayPusher(this.readFeatureElement,this):ol.xml.makeReplacer(this.readFeatureElement,this))}h[l[T]]=w}a="featureMember"==r?ol.xml.pushParseAndPop(void 0,h,e,t):ol.xml.pushParseAndPop([],h,e,t)}null===a&&(a=[]);var E=function(e){var t=e.getGeometry();if(!t.flatCoordinates.length)throw"Geometría no válida. ¿Posible versión incorrecta de GML?"};if(a instanceof ol.Feature)E(a);else for(var o=0,L=a.length;L>o;o++)E(a[o]);return a},ol.format.GML3CRS84=function(){ol.format.GML3.call(this,{srsName:"CRS:84"})},ol.inherits(ol.format.GML3CRS84,ol.format.GML3),ol.format.GML2CRS84=function(){ol.format.GML2.call(this,{srsName:"CRS:84"})},ol.inherits(ol.format.GML2CRS84,ol.format.GML2),ol.View.prototype.getValueForResolutionFunction=function(e){var t=e||2,r=this.maxResolution_,a=this.minResolution_,o=Math.log(r/a)/Math.log(t);return function(e){var a=Math.log(r/e)/Math.log(t)/o;return a=Math.max(Math.min(1,a),0)}};var l=function(e,t){var r;return e?(r=ol.color.asArray(e),r=r.slice(),void 0!==t&&(r[3]=t)):r=[0,0,0,1],r},p=function(e,t){var r=e.map.getView(),a=r.getResolution(),o={projection:r.getProjection(),center:r.getCenter(),resolution:a,enableRotation:!1};if(e.parent.options.maxExtent&&(o.extent=e.parent.options.initialExtent),t instanceof TC.layer.Raster){var n,i,s=t.getResolutions();if(s&&s.length){n=t.maxResolution||s[0],i=t.minResolution||s[s.length-1];var l=s.indexOf(i),p=s.indexOf(n);o.resolutions=s.slice(p,l+1)}else n=t.maxResolution,i=t.minResolution;i&&(o.minResolution=i,i>a&&(o.resolution=i)),n&&(o.maxResolution=n,a>n&&(o.resolution=n))}return o};TC.wrap.Map.prototype.setMap=function(){var e=this,t=[(e.parent.options.initialExtent[0]+e.parent.options.initialExtent[2])/2,(e.parent.options.initialExtent[1]+e.parent.options.initialExtent[3])/2],r=proj4(e.parent.crs),a=function(){var t=e.parent.crs.substr(e.parent.crs.lastIndexOf(":")+1),a={units:r.oProj.units,extent:e.parent.options.baselayerExtent,global:!0,worldExtent:e.parent.options.baselayerExtent},o=[];a.code="EPSG:"+t,o.push(new ol.proj.Projection(a)),a.code="urn:ogc:def:crs:EPSG::"+t,o.push(new ol.proj.Projection(a)),ol.proj.addEquivalentProjections(o);var n=function(e,t,r,a){for(var o=[],n=a||2,i=0;i<t.length;i+=n)o=o.concat(e(t.slice(i,i+n)));if($.isArray(r)){r.length=0;for(var i=0;i<o.length;i++)r[i]=o[i];o=r}return o},i=function(e,t,a){return n(r.forward,e,t,a)},s=function(e,t,a){return n(r.inverse,e,t,a)};ol.proj.addEquivalentTransforms(ol.proj.EPSG4326.PROJECTIONS,o,i,s)};a();var o={code:e.parent.crs,units:r.oProj.units,extent:e.parent.options.baselayerExtent};"EPSG:4326"===e.parent.crs&&(o.axisOrientation="neu");var n=new ol.proj.Projection(o),i=ol.interaction.defaults(),s={projection:n,center:t,enableRotation:!1};if(e.parent.options.maxExtent){var l=e.parent.options.maxExtent;s.extent=l;var c=e.parent.div.getBoundingClientRect(),u=(c.width/c.height,l[2]-l[0]),g=l[3]-l[1];s.resolution=c.width/c.height>u/g?u/c.width:g/c.height}else s.zoom=2;e.map=new ol.Map({target:e.parent.div,renderer:ol.renderer.Type.CANVAS,view:new ol.View(s),controls:[],interactions:i}),e.map.getView().fit(e.parent.options.initialExtent,e.map.getSize()),e.map._wrap=e;var f=function(){e.map.updateSize()};$(e.parent.div).on(ol.events.EventType.RESIZE,f),e.parent.$events.one(TC.Consts.event.MAPLOAD,f),e.map.on(ol.MapBrowserEvent.EventType.SINGLECLICK,function(t){var r=$.map(e.parent.workLayers,function(){return!1});e.map.forEachFeatureAtPixel(t.pixel,function(t,a){if(t._wrap&&t._wrap.parent.showsPopup){for(var o=0;o<e.parent.workLayers.length;o++){var n=e.parent.workLayers[o];if(n.wrap.layer===a){r[o]=!0;break}}return e.parent.$events.trigger($.Event(TC.Consts.event.FEATURECLICK,{feature:t._wrap.parent})),t}});for(var a=0;a<r.length;a++)r[a]||e.parent.$events.trigger($.Event(TC.Consts.event.NOFEATURECLICK,{layer:e.parent.workLayers[a]}))});var m=e.map.getView();m.on("change:resolution",function(){e.parent.$events.trigger($.Event(TC.Consts.event.BEFOREZOOM))},e.parent),e.map.on(ol.MapEvent.Type.MOVEEND,function(){e.parent.$events.trigger($.Event(TC.Consts.event.ZOOM))}),e.mapDeferred.resolve(e.map);var y=function(t,r){var a=(e.map.getView().getResolution(),e.map.getView().getZoom(),r||p(e,t)),o=new ol.View(a);e.map.setView(o),e.map.render()};e.parent.$events.on(TC.Consts.event.BASELAYERCHANGE,function(e){y(e.layer)}),e.parent.$events.on(TC.Consts.event.MAPLOAD,function(t){y(e.parent.getBaseLayer())})},TC.wrap.Map.prototype.insertLayer=function(e,t){for(var r=this,a=r.map.getLayers(),o=!1,n=0;n<a.getLength();n++)if(a.item(n)===e){o=!0;break}if(o)a.remove(e),a.insertAt(t,e);else{if(a.insertAt(t,e),e instanceof ol.layer.Tile){var i=e.getSource().getResolutions(),s=r.map.getView();s.maxResolution_=i[0],s.minResolution_=i[i.length-1]}var l=e._wrap,p=0;l.$events.on(TC.Consts.event.BEFORETILELOAD,function(t){l.parent.state=TC.Layer.state.LOADING,0>=p&&(p=0,r.parent.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:l.parent}))),e._loadingTileCount=e._loadingTileCount+1}),l.$events.on(TC.Consts.event.TILELOAD,function(e){p-=1,0>=p&&(p=0,l.parent.state=TC.Layer.state.IDLE,r.parent.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:l.parent})))})}},TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)},TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getLayerGroup().getLayers().getLength()},TC.wrap.Map.prototype.indexOfFirstVector=function(){var e=-1;return this.map.getLayerGroup().getLayers().forEach(function(t,r){t instanceof ol.layer.Vector&&-1===e&&(e=r)}),e},TC.wrap.Map.prototype.getLayerIndex=function(e){var t=-1;return this.map.getLayerGroup().getLayers().forEach(function(r,a){r===e&&(t=a)}),t},TC.wrap.Map.prototype.setLayerIndex=function(e,t){var r=this.map.getLayers(),a=r.getArray(),o=a.indexOf(e);o>-1&&o!=t&&(this.map.removeLayer(e),this.insertLayer(e,t))},TC.wrap.Map.prototype.setBaseLayer=function(e){var t=this,r=new $.Deferred,a=p(t,e._wrap.parent),o=t.map.getView(),n=function(){var a=t.parent.getBaseLayer();a&&t.map.removeLayer(a.wrap.getLayer()),t.insertLayer(e,0),r.resolve()},i=o.getResolution();return i!==a.resolution?(t.map.beforeRender(ol.animation.zoom({duration:TC.Consts.ZOOM_ANIMATION_DURATION,resolution:i})),o.once("change:resolution",function(){setTimeout(n,TC.Consts.ZOOM_ANIMATION_DURATION)}),o.setResolution(a.resolution)):n(),r.promise()},TC.wrap.Map.prototype.setExtent=function(e,t){var r=this;r.done&&r.done.resolve(),r.done=new $.Deferred;var a=t||{};return clearTimeout(r._timeout),r._timeout=setTimeout(function(){var t=r.map.getSize(),o=r.map.getView();if(void 0===a.animate||a.animate){var n=ol.animation.zoom({duration:TC.Consts.ZOOM_ANIMATION_DURATION,resolution:o.getResolution()}),i=ol.animation.pan({duration:TC.Consts.ZOOM_ANIMATION_DURATION,source:o.getCenter()}),s=function(e){r.map.un(ol.MapEvent.Type.POSTRENDER,s),r.done.resolve()};r.map.on(ol.MapEvent.Type.POSTRENDER,s),r.map.beforeRender(n,i)}if(r.parent.baseLayer)$.when(r.parent.baseLayer.wrap.getLayer()).then(function(n){var i=n.getSource();if(i.getResolutions!=goog.abstractMethod){var s=o.getResolutionForExtent(e,t),l=r.parent.baseLayer.getResolutions();if(l&&l.length>0){var p=Math.min.apply(r,l);if(p>s){var c=.5*(p/s-1),u=ol.extent.getWidth(e)*c,g=ol.extent.getHeight(e)*c;e=e.slice(0),e[0]=e[0]-u,e[1]=e[1]-g,e[2]=e[2]+u,e[3]=e[3]+g}}}o.fit(e,t);var s=o.getResolutionForExtent(e,t),l=r.parent.baseLayer.getResolutions();if(l&&l.length>0){var f=l.filter(function(e){return Math.round(s)===Math.round(e)?!0:void 0});if(0==f.length){if((m=l.length)<2)return m-1;for(var m,y=Math.abs(l[--m]-s);m--&&!(y<(y=Math.abs(l[m]-s))););s=l[m]}}o.setResolution(s),void 0!==a.animate||a.animate||r.done.resolve()});else{var l=o.getResolutionForExtent(e,t);o.fit(e,t),o.setResolution(l),void 0!==a.animate||a.animate||r.done.resolve()}},50),r.done},TC.wrap.Map.prototype.getExtent=function(){return this.map.getView().calculateExtent(this.map.getSize())},TC.wrap.Map.prototype.setCenter=function(e,t){var r=this,a=t||{},o=r.map.getView();if(a.animate){var n=ol.animation.pan({duration:TC.Consts.ZOOM_ANIMATION_DURATION,source:o.getCenter()});r.map.beforeRender(n)}o.setCenter(e)},TC.wrap.Map.prototype.getCenter=function(){return this.map.getView().getCenter()},TC.wrap.Map.prototype.getResolution=function(){return this.map.getView().getResolution()},TC.wrap.Map.prototype.setResolution=function(e){$.when(this.getMap()).then(function(t){t.getView().setResolution(e)})},TC.wrap.Map.prototype.setRotation=function(e){$.when(this.getMap()).then(function(t){t.getView().setRotation(e)})},TC.wrap.Map.prototype.getRotation=function(){return this.map.getView().getRotation()},TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){return this.map.getCoordinateFromPixel(e)},TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)},TC.wrap.Map.prototype.getViewport=function(){var e=new $.Deferred;return $.when(this.getMap()).then(function(t){e.resolve(t.getViewport())}),e},TC.wrap.Map.prototype.isNative=function(e){return e instanceof ol.Map},TC.wrap.Map.prototype.isGeo=function(){return this.map.getView().getProjection().getUnits()===ol.proj.Units.DEGREES},TC.wrap.Map.prototype.addPopup=function(t){var r=$.Deferred(),a=this,o=void 0===t.options.draggable||t.options.draggable;TC.loadJS(o&&!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){$.when(a.getMap()).then(function(r){if(!t.$popupDiv){var n=TC.Util.getDiv();t.$popupDiv=$(n),t.$popupDiv.addClass(TC.control.Popup.prototype.CLASS).appendTo(a.parent.div),t.$contentDiv=$(TC.Util.getDiv()).addClass(TC.control.Popup.prototype.CLASS+"-content").appendTo(t.$popupDiv);var i=new ol.Overlay({element:n,positioning:"bottom-left"});r.addOverlay(i),t.wrap.popup=i;var s=$(r.getViewport());if(o){var l=t.$popupDiv.parent();t.$popupDiv.addClass(TC.Consts.classes.DRAGGABLE),l.on("touchmove",function(e){$(e.target).parents(".tc-ctl-finfo-layer-content").length&&e.stopPropagation()}).drag("start",function(e,a){var o=e.target.getBoundingClientRect();if(o.left+e.target.clientWidth<e.clientX||o.top+e.target.clientHeight<e.clientY)return!1;if(t.setDragging(!0),t._currentOffset=i.getOffset(),t._previousContainerPosition){var n=r.getSize();i.setPosition(r.getCoordinateFromPixel([t._previousContainerPosition[0],n[1]-t._previousContainerPosition[1]])),t._currentOffset=[0,0],i.setOffset(t._currentOffset),delete t._previousContainerPosition}else t._currentOffset=i.getOffset()}).drag("end",function(e,a){t.setDragging(!1);var o=r.getCoordinateFromPixel([0,0]),n=r.getCoordinateFromPixel(i.getOffset()),s=[n[0]-o[0],n[1]-o[1]],p=i.getPosition();i.setPosition([p[0]+s[0],p[1]+s[1]]),i.setOffset([0,0]),t._currentOffset=[0,0],t._previousContainerPosition=[parseInt(l.css("left")),parseInt(l.css("bottom"))]}).drag(function(e,r){return e.buttons||Modernizr.touch?void i.setOffset([t._currentOffset[0]+r.deltaX,t._currentOffset[1]+r.deltaY]):!1},{not:"th,td,input,select"})}s.off(e+".popup").on(e+".popup",function(e){var t=r.getTarget(),o=!1;if(!a.parent.activeControl||!a.parent.activeControl.isExclusive()){var n=r.getEventPixel(e.originalEvent);o=r.forEachFeatureAtPixel(n,function(e,t){var r=!0;return e._wrap&&!e._wrap.parent.showsPopup&&(r=!1),r})}t.style.cursor=o?"pointer":""})}}),r.resolve()}),r.promise()},TC.wrap.Map.prototype.hidePopup=function(e){var t=this;t.parent.currentFeature=null,e.$popupDiv&&e.$popupDiv.removeClass(TC.Consts.classes.VISIBLE)};var c=function(e){switch(e){case TC.Consts.layerType.KML:case TC.Consts.mimeType.KML:return new ol.format.KML({showPointNames:!1});case TC.Consts.layerType.GPX:return new ol.format.GPX;case TC.Consts.layerType.GEOJSON:case TC.Consts.mimeType.JSON:case TC.Consts.format.JSON:return new ol.format.GeoJSON;case TC.Consts.format.GML2:return new ol.format.GML2;case TC.Consts.format.GML3:return new ol.format.GML3;case TC.Consts.mimeType.GML:case TC.Consts.format.GML:return new ol.format.GML;case TC.Consts.format.TOPOJSON:return new ol.format.TopoJSON;case TC.Consts.format.WKT:return new ol.format.WKT}};TC.wrap.Map.prototype.exportFeatures=function(e,t){var r=this,a=h({styles:r.parent.options.styles}),o=e.map(function(e){var t=e.wrap.feature;return t.getStyle()||t.setStyle(a),t}),n=c(t.format);if(n instanceof ol.format.GMLBase){n.featureNS="sitna",n.featureType="getFeatureInfoResult";var i=n.writeFeaturesNode(o,{featureProjection:r.parent.crs}),s=ol.xml.createElementNS("http://www.opengis.net/gml","FeatureCollection");return ol.xml.setAttributeNS(s,"http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",n.schemaLocation),i.removeAttribute("xmlns:xsi"),i.removeAttribute("xsi:schemaLocation"),s.appendChild(i),s.outerHTML}return n.writeFeatures(o,{featureProjection:r.parent.crs})};var u=function(e){for(var t=0,r=e.dataTransfer.types.length;r>t;t++)if("Files"===e.dataTransfer.types[t])return!0;return!1},g=function(e){var t=this;u(e)&&(t.getMap()._wrap.parent._$div.addClass(TC.Consts.classes.DROP),e.preventDefault(),e.stopPropagation())},f=function(e){var t=this;if(u(e)){var r=t.getMap()._wrap.parent;e.target===t.target&&r._$div.removeClass(TC.Consts.classes.DROP)}};TC.wrap.Map.prototype.enableDragAndDrop=function(e){var t=this,r=e||{},a={formatConstructors:[ol.format.KML,ol.format.GPX,ol.format.GML3CRS84,ol.format.GML2CRS84,ol.format.GML,ol.format.GML2,ol.format.GeoJSON,ol.format.WKT,ol.format.TopoJSON]};a.target=r.dropTarget?TC.getDiv(r.dropTarget):t.parent.div;var o=new ol.interaction.DragAndDrop(a);if(o.on(ol.interaction.DragAndDrop.EventType.ADD_FEATURES,function(e){var r=e.features?e.features.map(function(e){return TC.wrap.Feature.createFeature(e)}):[];$.when.apply(this,r).then(function(){for(var r=new Array(arguments.length),a=0,o=r.length;o>a;a++)r[a]=arguments[a];var n=t.parent.getLoadingIndicator();n&&n.removeWait(t._featureImportWaitId),t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESIMPORT,{features:r,fileName:e.file.name}))})}),r.once)o.map_=t.map;else{t.map.addInteraction(o);var n=o.target?o.target:t.map.getViewport(),i=function(e){if(u(e)){var r=t.parent;if(o.target===e.target){var a=r.getLoadingIndicator();a&&(t._featureImportWaitId=a.addWait()),e.stopPropagation()}else e.preventDefault();r._$div.removeClass(TC.Consts.classes.DROP)}};o.dropListenKeys_.push(ol.events.listen(n,ol.events.EventType.DRAGENTER,g,o)),o.dropListenKeys_.push(ol.events.listen(document.body,ol.events.EventType.DRAGENTER,g,o)),o.dropListenKeys_.push(ol.events.listen(n,ol.events.EventType.DRAGOVER,g,o)),o.dropListenKeys_.push(ol.events.listen(document.body,ol.events.EventType.DRAGOVER,g,o)),o.dropListenKeys_.push(ol.events.listen(n,ol.events.EventType.DROP,i,o)),o.dropListenKeys_.push(ol.events.listen(document.body,ol.events.EventType.DROP,i,o)),o.dropListenKeys_.push(ol.events.listen(document.body,"dragleave",f,o)),o.dropListenKeys_.push(ol.events.listen(document.body,"dragend",f,o)),t.ddEnabled=!0}return o},TC.wrap.Map.prototype.loadFiles=function(e){var t,r=this;r.ddEnabled?r.map.getInteractions().forEach(function(e){e instanceof ol.interaction.DragAndDrop&&(t=e)}):t=r.enableDragAndDrop({once:!0});var a=r.parent.getLoadingIndicator();a&&(r._featureImportWaitId=a.addWait()),ol.interaction.DragAndDrop.handleDrop_.call(t,{dataTransfer:{files:e}})},TC.wrap.Layer.prototype.getVisibility=function(e){var t=this,r=!1;return t.layer&&(r=t.layer.getVisible()),r},TC.wrap.Layer.prototype.setVisibility=function(e){var t=this;$.when(t.getLayer()).then(function(t){t.setVisible(e)})},TC.wrap.Layer.prototype.isNative=function(e){return e instanceof ol.layer.Layer},TC.wrap.layer.Raster.prototype.WmsParser=ol.format.WMSCapabilities,TC.wrap.layer.Raster.prototype.WmtsParser=ol.format.WMTSCapabilities,TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.on("change:visible",function(){t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent}))},t.parent.map)},TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null,t=this;switch(t.getServiceType()){case TC.Consts.layerType.WMS:for(var r=t.parent.capabilities.Capability.Request.GetMap.DCPType,a=0;a<r.length;a++)if(r[a].HTTP&&r[a].HTTP.Get){e=r[a].HTTP.Get.OnlineResource;break}break;case TC.Consts.layerType.WMTS:e=t.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href}return e=$("<textarea />").html(e).text()},TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Capability.Request.GetFeatureInfo&&(e=t.Capability.Request.GetFeatureInfo.Format),e},TC.wrap.layer.Raster.infoFormatPreference=["application/json","application/vnd.ogc.gml/3.1.1","application/vnd.ogc.gml","application/vnd.esri.wms_featureinfo_xml","text/html","text/plain","text/xml"],TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this,r=t.parent.capabilities;if(r&&r.Contents)for(var a=0;a<r.Contents.Layer.length;a++)for(var o=r.Contents.Layer[a],n=0;n<o.TileMatrixSetLink.length;n++)if(t.parent.options.matrixSet===o.TileMatrixSetLink[n].TileMatrixSet){e=o;break}return e},TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,r=this,a=r.parent.capabilities;if(a&&a.Contents&&a.Contents.TileMatrixSet)for(var o=0;o<a.Contents.TileMatrixSet.length;o++){var n=a.Contents.TileMatrixSet[o];if(n.Identifier===e){t=n.TileMatrix;break}}return t},TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[],r=this;if(e.ScaleDenominator?t=[e.ScaleDenominator,e.ScaleDenominator]:(e.MinScaleDenominator||e.MaxScaleDenominator)&&(t=[e.MaxScaleDenominator,e.MinScaleDenominator]),!t.length&&!r.getName(e)){for(var a=r.getLayerNodes(e),o=-(1/0),n=1/0,i=0,s=a.length;s>i;i++){var l=r.getScaleDenominators(a[i]);l[0]>o&&(o=l[0]),l[1]<n&&(n=l[1])}o>-(1/0)&&1/0>n&&(t=[o,n])}return t},TC.wrap.layer.Raster.prototype.getAttribution=function(e){var t=null;return e&&(t=e.ServiceIdentification?e.ServiceIdentification.Title:e.Service.Title),t},TC.wrap.layer.Raster.prototype.getInfo=function(e){var t=this,r={},a=t.parent.capabilities;if(a&&a.Capability)for(var o=t.getAllLayerNodes(),n=0;n<o.length;n++){var i=o[n];if(t.parent.compareNames(t.getName(i),e)){i.Title&&(r.title=i.Title),i.Abstract&&(r["abstract"]=i.Abstract),r.legend=[];var s=function(e){var t=this.getLegend(e);t.src&&r.legend.push({src:t.src,title:e.Title})},l=function(e,r){if(e.Layer&&e.Layer.length>0)for(var a in e.Layer)l(e.Layer[a],r);else r.apply(t,[e])};if(l(i,s),i.MetadataURL&&i.MetadataURL.length){r.metadata=[];for(var p=0;p<i.MetadataURL.length;p++){var c=i.MetadataURL[p];r.metadata.push({format:c.Format,type:c.type,url:c.OnlineResource})}}r.queryable=i.queryable;break}}return r},TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Capability.Request&&t.Capability.Request.GetMap?e=TC.Consts.layerType.WMS:t.OperationsMetadata&&t.OperationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS),e},TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Service?e=t.Service.Title:t.ServiceIdentification&&(e=t.ServiceIdentification.Title),e},TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e,t=this;return t.getServiceType()===TC.Consts.layerType.WMS&&(e=t.parent.capabilities.Capability.Layer),e},TC.wrap.layer.Raster.prototype.getName=function(e,t){var r=e.Name;if(r&&t){var a=r.indexOf(":");a>=0&&(r=r.substr(a+1))}return r},TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.Identifier},TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.Layer;return $.isArray(t)||(t=t?[t]:[]),t},TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this;if(!e._layerList)switch(e.getServiceType()){case TC.Consts.layerType.WMS:var t=function a(t){for(var r=[t],o=e.getLayerNodes(t),n=0;n<o.length;n++)r=r.concat(a(o[n]));return r},r=e.getRootLayerNode();e._layerList=r?t(r):[];break;case TC.Consts.layerType.WMTS:e._layerList=e.parent.capabilities.Contents.Layer.slice();break;default:e._layerList=[]}return e._layerList},TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){return e},TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return e},TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},r=e.Style;if(r&&r.length&&r.length&&r[0].LegendURL&&r[0].LegendURL.length){var a=r[0].LegendURL[0];t.src=$("<textarea />").html(a.OnlineResource).text();

}return t},TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!0,a=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(a.capabilities&&a.capabilities.Capability&&a.capabilities.Capability.Layer&&a.names.length>0)for(var o=a.names.slice(0),n=function p(r,o,n){var i=!1;if(r)for(var s=0;s<r.length;s++){var l=r[s],c=n||$.inArray(e,l.CRS||l.SRS)>=0;if(a.compareNames(t.getName(l),o)){c&&(i=!0);break}if(p(l.Layer,o,c)){i=!0;break}}return i};o.length>0;)if(!n([a.capabilities.Capability.Layer],o.pop())){r=!1;break}break;case TC.Consts.layerType.WMTS:var i=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$|^"+e+"$","g");if(r=!1,a.capabilities&&a.capabilities.Contents&&a.capabilities.Contents.TileMatrixSet)for(var s=a.capabilities.Contents.TileMatrixSet,l=0;l<s.length;l++)if(s[l].Identifier===a.options.matrixSet){r=i.test(s[l].SupportedCRS);break}}return r},TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=this,r=[],a=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(a.capabilities&&a.capabilities.Capability&&a.capabilities.Capability.Layer){var o=function(e,t,a){var n=a||$.inArray(t,e.CRS||e.SRS)>=0;if(n&&e.Name&&(r[r.length]=e.Name),e.Layer)for(var i=0;i<e.Layer.length;i++)o(e.Layer[i],t,n)};o(a.capabilities.Capability.Layer,e)}break;case TC.Consts.layerType.WMTS:var n=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$","g");if(a.capabilities&&a.capabilities.Contents&&a.capabilities.Contents.TileMatrixSet)for(var i=a.capabilities.Contents.TileMatrixSet,s=0;s<i.length;s++)n.test(i[s].SupportedCRS)&&(r[r.length]=i[s].Identifier)}return r},TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){var e=this;$.when(e.getLayer()).then(function(t){e.parent.options=e.parent.options||{};var r=t.getSource().getUrls();e.parent.options.urlPattern=r[r.length-1]})};var m=function(e,t){var r=this,a=e.getImage();t=r.parent.usesProxy?TC.proxify(t):t,a.src=r.parent.names.length?t:TC.Consts.BLANK_IMAGE},y=function(e,t){var r=this;r.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e}));var a=e.getImage();if("function"==typeof window.btoa){for(var o=new XMLHttpRequest,n=t.split("?"),i=n[1].split("&"),s="",l=0;l<i.length;l++){var p=i[l].split("=");p&&p.length>1&&p[1]&&"LAYERS"!==p[0]&&(s+="&"+i[l])}o.open("POST",n[0],!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.responseType="arraybuffer",o.onload=function(t){if(200===this.status){for(var n=new Uint8Array(this.response),i=n.length,s=new Array(i);i--;)s[i]=String.fromCharCode(n[i]);var l=s.join(""),p=o.getResponseHeader("content-type");if(0===p.indexOf("image")){var c=function(){r.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e}))};a.addEventListener("load",c),a.addEventListener("error",c),a.src="data:"+p+";base64,"+window.btoa(l)}}},o.send(s)}};TC.wrap.layer.Raster.prototype.createWmsLayer=function(e,t,r){var a=this,o=null,n=null,i=r&&r.method&&"POST"===r.method;a.$events=$(a),n=i?$.proxy(y,a):$.proxy(m,a);var s=new ol.source.ImageWMS({url:e,crossOrigin:r.map?r.map.options.crossOrigin:void 0,params:t,extent:TC.Cfg.initialExtent,ratio:TC.Cfg.imageRatio,imageLoadFunction:n});s.on(ol.source.Image.EventType.IMAGELOADSTART,function(e){a.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.image.getImage()}))}),s.on(ol.source.Image.EventType.IMAGELOADEND,function(e){a.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))}),s.on(ol.source.Image.EventType.IMAGELOADERROR,function(e){a.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))});var l={visible:!!t.LAYERS.length||i,source:s};return r.minResolution&&(l.minResolution=r.minResolution),r.maxResolution&&(l.maxResolution=r.maxResolution),o=new ol.layer.Image(l),o._wrap=a,a.addCommonEvents(o),o},TC.wrap.layer.Raster.prototype.createWmtsLayer=function(e,t,r){var a=this,o=null;a.$events=$(a);var n=ol.source.WMTS.optionsFromCapabilities(a.parent.capabilities,{layer:t,matrixSet:r.matrixSet,requestEncoding:r.encoding,format:r.format}),i="https:";location.protocol===i&&(n.urls=n.urls.map(function(e){return e.replace("http:",i)})),n.crossOrigin=r.map?r.map.options.crossOrigin:void 0;var s=new ol.source.WMTS(n);s.setTileLoadFunction($.proxy(m,a)),s.on(ol.source.Tile.EventType.TILELOADSTART,function(e){a.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.tile.getImage()}))}),s.on(ol.source.Tile.EventType.TILELOADEND,function(e){a.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))}),s.on(ol.source.Tile.EventType.TILELOADERROR,function(e){a.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))});var l={source:s};r.minResolution&&(l.minResolution=r.minResolution),r.maxResolution&&(l.maxResolution=r.maxResolution),o=new ol.layer.Tile(l),o._wrap=a;var p=$.proxy(s.getResolutions,s);s.getResolutions=function(){var e=p(),t=o._wrap.parent.getLimitedMatrixSet();if(t&&t.length){var r=t[0].matrixIndex;e=e.slice(r,t.length+r)}return e},a.addCommonEvents(o);var c=s.getResolutions();return o.setMaxResolution(c[0]+1),o.setMinResolution(c[c.length-1]),o},TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.getSource().getParams()},TC.wrap.layer.Raster.prototype.setParams=function(e){this.layer.getSource().updateParams(e)},TC.wrap.layer.Raster.prototype.getResolutions=function(){if(this.layer.getSource){var e=this.layer.getSource();return e.getResolutions&&e.getResolutions!=goog.abstractMethod?e.getResolutions():[]}return[]},TC.wrap.Geometry={getNearest:function(e,t){var r=new ol.geom.LineString(t);return r.getClosestPoint(e)}};var d=function(e,t,r){if(e){var a=function(a){var o=(r&&r._wrap?r._wrap.parent.options.width:null)||t;if(a>o){var n=o/a;e.setScale(n)}},o=e.getSize();if(o)a(o[0]);else{var n=e.getImage();n.addEventListener("load",function(){a(this.width)})}}},v=function(e,t){var r=e,a=t&&t.wrap&&t.wrap.feature;if("string"==typeof e){var o=e.match(/^\$\{(.+)\}$/);if(o&&a){for(var n=o[1].split("."),i=a.getProperties(),s=0;s<n.length&&void 0!==i;s++)i=i[n[s]];if(void 0===i){i=t.data;for(var s=0;s<n.length&&void 0!==i;s++)i=i[n[s]]}r=i}}else $.isFunction(e)&&(r=e(t));return r},h=function(e,t){var r,a={};t&&(r=t._wrap?t._wrap.parent:{id:TC.wrap.Feature.prototype.getId.call({feature:t}),features:t.get("features"),getData:function(){return TC.wrap.Feature.prototype.getData.call({feature:t})}});var o,n=r&&$.isArray(r.features)&&r.features.length>1&&e.cluster;o=n?e.cluster.styles||TC.Cfg.styles.cluster:e.styles||TC.Cfg.styles,o.line&&(a.stroke=new ol.style.Stroke({color:v(o.line.strokeColor,r),width:v(o.line.strokeWidth,r),lineDash:o.line.lineDash})),o.polygon&&(a.fill=new ol.style.Fill({color:l(v(o.polygon.fillColor,r),v(o.polygon.fillOpacity,r))}),a.stroke=new ol.style.Stroke({color:v(o.polygon.strokeColor,r),width:v(o.polygon.strokeWidth,r),lineDash:o.polygon.lineDash}));var i=function(e){var t={text:""+v(e.label,r)};if(e.fontSize&&(t.font=v(e.fontSize,r)+"pt sans-serif"),e.angle&&(t.rotation=-Math.PI*v(e.angle,r)/180),e.fontColor&&(t.fill=new ol.style.Fill({color:l(v(e.fontColor,r),1)})),e.labelOutlineColor&&(t.stroke=new ol.style.Stroke({color:l(v(e.labelOutlineColor,r),1),width:v(e.labelOutlineWidth,r)})),e.labelOffset)if(e.width&&e.height)t.offsetX=e.width*e.labelOffset[0],t.offsetY=e.height*e.labelOffset[1];else if(e.radius){var a=2*e.radius;t.offsetX=a*e.labelOffset[0],t.offsetY=a*e.labelOffset[1]}return new ol.style.Text(t)};if(o.point){var s=o.point,p={radius:v(s.radius,r)||(v(s.height,r)+v(s.width,r))/4};s.fillColor&&(p.fill=new ol.style.Fill({color:l(v(s.fillColor,r),v(s.fillOpacity,r))})),s.strokeColor&&(p.stroke=new ol.style.Stroke({color:v(s.strokeColor,r),width:v(s.strokeWidth,r),lineDash:s.lineDash})),isNaN(p.radius)||(a.image=new ol.style.Circle(p)),s.label&&(a.text=i(s))}if(o.marker){var c=o.marker;c.url&&(a.image=new ol.style.Icon({anchor:c.anchor,src:c.url})),c.label&&(a.text=i(c))}return[new ol.style.Style(a)]};TC.wrap.layer.Vector.prototype.reloadSource=function(){var e=this,t=new $.Deferred,r=e.createVectorSource(e.parent,e.createStyles(e.parent));if(e.parent.type===TC.Consts.layerType.WFS)var a=r.source.on("change",function(e){"ready"==r.source.getState()&&(ol.Observable.unByKey(a),t.resolve())});var o=e.layer.getSource().getFeatures();return e.layer.setSource(r.source),r.style&&e.layer.setStyle(r.style),e.parent.type!=TC.Consts.layerType.WFS&&(r.source.addFeatures(o),t.resolve()),t},TC.wrap.layer.Vector.prototype["import"]=function(e){var t=this,r=$.extend({},e);r.type=e.format;var a=t.layer.getSource().getFeatures(),o=t.createVectorSource(r,t.createStyles(t.parent));t.layer.setSource(o.source),o.style&&t.layer.setStyle(o.style),o.source.addFeatures(a)},TC.wrap.layer.Vector.prototype.createVectorSource=function(e,t){var r,a,o=this,n=function(e){var t=e.indexOf("?");switch(t>=0?e=e.substr(0,t):(t=e.indexOf("#"),t>=0&&(e=e.substr(0,t))),e.substr(e.lastIndexOf(".")+1).toLowerCase()){case"kml":return TC.Consts.layerType.KML;case"gpx":return TC.Consts.layerType.GPX;case"json":case"geojson":return TC.Consts.layerType.GEOJSON;default:return TC.Consts.layerType.VECTOR}};if($.isArray(e.url)||e.urls){var i=e.urls||e.url;i=$.map(i,function(e,t){return TC.proxify(e)}),a={url:i,format:new ol.format.KML({showPointNames:!1}),projection:e.crs}}else if(e.url&&e.type!==TC.Consts.layerType.WFS)a={url:TC.proxify(e.url),projection:e.crs},a.format=c(n(e.url))||c(e.type);else if(e.data)a={projection:e.crs,loader:function(t,r,a){var n=this.getFormat();try{var i=n.readFeatures(e.data,{featureProjection:a});this.addFeatures(i)}catch(s){o.parent.map&&o.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:o.parent,reason:s.message}))}}},a.format=c(e.format)||c(e.type);else if(e.type==TC.Consts.layerType.WFS){var s,l;switch(e.outputFormat){case TC.Consts.format.JSON:s=new ol.format.GeoJSON({geometryName:e.geometryName}),l="json";break;case TC.Consts.format.GML3:s=new ol.format.GML3,l=TC.Consts.mimeType.GML;break;default:s=new ol.format.GML2,l=TC.Consts.mimeType.GML}a={format:s,loader:function(t,r,a){var n=this,i=e.url;if(i){o.parent.state=TC.Layer.state.LOADING,o.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:o.parent}));var p={},c=a.getCode(),u=e.version||"1.1.0",g=i,f=$.isArray(e.featureType)?e.featureType:[e.featureType];if(!e.properties||e.properties instanceof Array&&!e.properties.length||!Object.keys(e.properties).length)g=g+"?service=WFS&version="+u+"&request=GetFeature&typename="+f.join(",")+"&outputFormat="+l+"&srsname="+c,t[0]!==-(1/0)&&t[1]!==-(1/0)&&t[2]!==1/0&&t[3]!==1/0&&(g=g+"&bbox="+t.join(",")+","+c),e.maxFeatures&&(g=g+"maxFeatures="+e.maxFeatures);else{p.type="POST",p.contentType=TC.Consts.mimeType.XML,p.processData=!1;var m=[];m[m.length]='<wfs:GetFeature xmlns:wfs="http://www.opengis.net/wfs" service="WFS" version="',m[m.length]=u,m[m.length]='" outputFormat="',m[m.length]=e.outputFormat,e.maxFeatures&&(m[m.length]='" maxFeatures="',m[m.length]=e.maxFeatures),m[m.length]='" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/',m[m.length]=u,m[m.length]='/wfs.xsd">';for(var y=0;y<f.length;y++){if(m[m.length]='<wfs:Query typeName="feature:',m[m.length]=f[y],m[m.length]='" srsName="',m[m.length]=c,m[m.length]='">',m[m.length]='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">',(e.properties.length>1||Object.keys(e.properties).length>1)&&(m[m.length]="<ogc:And>"),e.properties instanceof Array)for(var d=0;d<e.properties.length;d++){var v=e.properties[d];m[m.length]='<ogc:PropertyIsEqualTo matchCase="true"><ogc:PropertyName>',m[m.length]=v.name,m[m.length]="</ogc:PropertyName><ogc:Literal>",m[m.length]=v.value,m[m.length]="</ogc:Literal></ogc:PropertyIsEqualTo>"}else if(e.properties instanceof Object)for(var d=0;d<e.properties[f[y]].length;d++){var v=e.properties[f[y]][d];m[m.length]='<ogc:PropertyIsEqualTo matchCase="true"><ogc:PropertyName>',m[m.length]=v.name,m[m.length]="</ogc:PropertyName><ogc:Literal>",m[m.length]=v.value,m[m.length]="</ogc:Literal></ogc:PropertyIsEqualTo>"}(e.properties.length>1||Object.keys(e.properties).length>1)&&(m[m.length]="</ogc:And>"),m[m.length]="</ogc:Filter></wfs:Query>"}m[m.length]="</wfs:GetFeature>",p.data=m.join("")}p.url=g,o._requestUrl=g,$.ajax(p).done(function(e){n.addFeatures(s.readFeatures(e)),o.parent.state=TC.Layer.state.IDLE,o.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:o.parent}))})}},projection:e.crs}}r=new ol.source.Vector(a),r._tcLayer=o.parent;var p=e.style&&e.style.marker?e.style.marker:TC.Cfg.styles.marker;if(e.style&&e.style.marker||(p=$.extend({},p,{anchor:TC.Cfg.styles.point.anchor})),e.cluster&&(r=new ol.source.Cluster({projection:e.crs,distance:e.cluster.distance,source:r}),e.cluster.animation)){var u=function(e,t,r,a){var o=Math.min((Date.now()-a)/r,1),n=(t[0]-e[0])*o,i=(t[1]-e[1])*o;return[e[0]+n,e[1]+i]},g=function(e,t){var r=Date.now(),a=e.getGeometry().getCoordinates(),o=t.getGeometry().getCoordinates();t.setGeometry(new ol.geom.Point(a));var n=function i(){var n=u(a,o,TC.Consts.CLUSTER_ANIMATION_DURATION,r);t.setGeometry(new ol.geom.Point(n)),n[0]!==o[0]&&n[1]!==o[1]?requestAnimationFrame(i):f.splice($.inArray(e,f),1)};requestAnimationFrame(n)},f=[];r.addEventListener(ol.source.Vector.EventType.REMOVEFEATURE,function(e){var t=e.feature.get("features");t&&t.length>1&&f.push(e.feature)}),r.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){var t=e.feature.get("features");if(t){var r=t[0].getGeometry().getCoordinates();if(t.length>1){var a=$.grep(f,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});a.length&&f.splice($.inArray(a[0],f),1)}var o=$.grep(f,function(e){var t=e.get("features");if(t&&t.length>0){var a=$.grep(t,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});return a.length>0}});o.length&&g(o[o.length-1],e.feature)}})}var m=r;do m.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){var t=e.feature,r=t.getStyle();$.isFunction(r)&&(r=r.call(t)),$.isArray(r)&&(r=r[0]),r&&d(r.getImage(),p.width,t)}),m=$.isFunction(m.getSource)?m.getSource():null;while(m);var y=function(e){var t=null,r=e.getStyle();if($.isFunction(r)&&(r=r.call(e,e)),$.isArray(r)&&(r=r[0]),r){var a=r.getImage();a instanceof ol.style.Icon&&(t=a.getSrc())}return t};r.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){var t=e.feature;if(!t._wrap){var r,a=t.getGeometry();a instanceof ol.geom.Point?r=y(t)?o.parent.addMarker(t):o.parent.addPoint(t):a instanceof ol.geom.LineString?r=o.parent.addPolyline(t):a instanceof ol.geom.Polygon?r=o.parent.addPolygon(t):a instanceof ol.geom.MultiLineString?r=o.parent.addMultiPolyline(t):a instanceof ol.geom.MultiPolygon&&(r=o.parent.addMultiPolygon(t));var n;$.when(r).then(function(e){var r=t.get("features");$.isArray(r)&&(e.features=$.map(r,function(t){return new e.constructor(t)})),clearTimeout(n),n=setTimeout(function(){o.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:o.parent,features:[e]}))},50)})}}),r.addEventListener(ol.source.Vector.EventType.REMOVEFEATURE,function(e){var t=e.feature;if(t._wrap){var r=$.inArray(t._wrap.parent,o.parent.features);r>-1&&(o.parent.features.splice(r,1),o.parent.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:o.parent,feature:t._wrap.parent})))}}),r.addEventListener(ol.source.Vector.EventType.ADDFEATURE,function(e){o.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:o.parent}))}),r.addEventListener(ol.source.Vector.EventType.REMOVEFEATURE,function(){o.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:o.parent}))});var v={source:r};return a&&a.format instanceof ol.format.KML||(v.style=t||e.styles),v},TC.wrap.layer.Vector.prototype.createStyles=function(e){var t=this,r=!1;if($.isFunction(e))r=!0,t.styleFunction=function(t){return h(e(t))};else{e=$.extend({},e),e.crs=e.crs||TC.Cfg.crs,e.styles=e.styles||TC.Cfg.styles;var a=function n(e){for(var t in e){var r=e[t];switch(typeof r){case"string":if(/^\$\{(.+)\}$/.test(r))return!0;break;case"object":if(n(r))return!0;break;case"function":return!0}}return!1};r=!(!e.cluster||!e.cluster.styles)||a(e.styles),t.styleFunction=function(e){return h(t.parent.options,e)}}var o=r?t.styleFunction:t.styleFunction();return o},TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var e=this,t=null;e.$events=$(e);var r=e.parent.options,a=e.createVectorSource(r,e.createStyles(r));return t=new ol.layer.Vector(a),t._wrap=e,e.addCommonEvents(t),t},TC.wrap.layer.Vector.prototype.addFeatures=function(e){$.when(this.getLayer()).then(function(t){for(var r=t;$.isFunction(r.getSource);)r=r.getSource();r.addFeatures(e)})},TC.wrap.layer.Vector.prototype.getFeatures=function(){var e=this.getLayer();return e instanceof ol.layer.Layer?e.getSource().getFeatures():[]},TC.wrap.layer.Vector.prototype.getFeatureById=function(e){var t=this.getLayer();return t instanceof ol.layer.Layer?t.getSource().getFeatureById(e):null},TC.wrap.layer.Vector.prototype.removeFeature=function(e){$.when(this.getLayer()).then(function(t){var r=t.getSource();r.removeFeature(e.wrap.feature)})},TC.wrap.layer.Vector.prototype.clearFeatures=function(){$.when(this.getLayer()).then(function(e){var t=e.getSource();t.clearFeatures?t.clearFeatures():t.clear()})},TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(e,t){var r=this,a={color:"rgba(0, 0, 0, 0)"},o={color:"rgba(0, 0, 0, 0)"},n=new ol.style.Style({image:new ol.style.Circle({radius:0,fill:new ol.style.Fill(a),stroke:new ol.style.Stroke(o)}),fill:new ol.style.Fill(a),stroke:new ol.style.Stroke(o)}),i=$.inArray(e,r.parent.features);if(i>=0){var s=e.wrap.feature;t&&s._originalStyle?s.setStyle(s._originalStyle):(s._originalStyle=s.getStyle(),s.setStyle(n)),$.when(r.getLayer()).then(function(e){r.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:r.parent}))})}},TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){return l(e,t)},TC.wrap.layer.Vector.prototype.findFeature=function(e){},TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return this._requestUrl},TC.wrap.layer.Vector.prototype.getDescribeFeatureTypeUrl=function(){var e=this,t=e.parent,r=t.options.version||"1.1.0",a=t.url,o=$.isArray(t.options.featureType)?t.options.featureType:[t.options.featureType];return a=a+"?service=WFS&version="+r+"&request=DescribeFeatureType&typename="+o.join(",")+"&outputFormat=XMLSCHEMA"},TC.wrap.layer.Vector.prototype.sendTransaction=function(e,t,r){var a=this,o=$.Deferred(),n=function(e){return e.wrap.feature},i=$.map(e,n),s=$.map(t,n),l=$.map(r,n);return e.length||t.length||r.length?$.when(a.getLayer()).then(function(e){var t=(e.getSource(),new ol.format.WFS),r=a.parent.options,n=t.writeTransaction(i,s,l,{featurePrefix:r.featurePrefix,featureNS:r.featureNS,featureType:r.featureType[0]}),p={url:a.parent.url,type:"POST",contentType:TC.Consts.mimeType.XML,processData:!1,data:n.outerHTML};$.ajax(p).done(function(e){var r=e.getElementsByTagName("ExceptionReport")[0],a={reason:""};if(r){var n=r.getElementsByTagName("Exception")[0];if(n){a.code=n.getAttribute("exceptionCode");for(var i=n.getElementsByTagName("ExceptionText"),s=0,l=i.length;l>s;s++)a.reason+="\n"+i[s].innerHTML}o.reject(a)}else{var p=t.readTransactionResponse(e);o.resolve(p)}}).fail(function(){o.reject({code:"",reason:"unknown"})})}):o.resolve(a.parent),o},TC.wrap.layer.Vector.prototype.setDraggable=function(e,t,r){var a=this;$.when(a.parent.map.wrap.getMap(),a.getLayer()).then(function(o,n){if(e){var i={layers:[n],features:new ol.Collection(n.getSource().getFeatures())};a.interaction=new ol.interaction.Translate(i),$.isFunction(t)&&a.interaction.on(ol.interaction.Translate.EventType.TRANSLATEEND,function(e){e.features.getLength()&&t(e.features.item(0)._wrap.parent)}),$.isFunction(r)&&a.interaction.on(ol.interaction.Translate.EventType.TRANSLATESTART,function(e){e.features.getLength()&&r(e.features.item(0)._wrap.parent)}),o.addInteraction(a.interaction)}else a.interaction&&o.removeInteraction(a.interaction)})},TC.wrap.control.Click.prototype.register=function(e){var t=this;t._trigger=function(r){var a=0;return e.wrap.map.forEachFeatureAtPixel(r.pixel,function(e,t){e._wrap&&e._wrap.parent.showsPopup&&a++}),a||(t.parent.map.$events.trigger($.Event(TC.Consts.event.CLICK,{coordinate:r.coordinate,pixel:r.pixel})),t.parent.callback(r.coordinate,r.pixel)),0===a}},TC.wrap.control.Click.prototype.activate=function(){var e=this;$.when(e.parent.map.wrap.getMap()).then(function(t){t.on(ol.MapBrowserEvent.EventType.SINGLECLICK,e._trigger)})},TC.wrap.control.Click.prototype.deactivate=function(){var e=this;$.when(e.parent.map.wrap.getMap()).then(function(t){t.un(ol.MapBrowserEvent.EventType.SINGLECLICK,e._trigger)})},TC.wrap.control.ScaleBar.prototype.render=function(){var e=this;e.ctl?e.ctl.updateElement_():e.ctl=new ol.control.ScaleLine({target:e.parent.div})},TC.wrap.control.ScaleBar.prototype.getText=function(){var e=this;return e.ctl?e.ctl.renderedHTML_:void 0},TC.wrap.control.NavBar.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){var a=t.parent.div;t.zCtl=new ol.control.Zoom({target:a}),t.zsCtl=new ol.control.ZoomSlider({target:a,render:function(e){if(!e.frameState||!e.frameState.viewState||r.getView().getMinResolution()<=e.frameState.viewState.resolution){var a=function(){this.element.offsetWidth>this.element.offsetHeight?(t.requestSliderSize||(t.requestSliderSize=window.requestAnimationFrame(a.bind(this))),window.requestAnimationFrame(a.bind(this))):this.element.offsetWidth<this.element.offsetHeight&&(t.requestSliderSize&&(window.cancelAnimationFrame(t.requestSliderSize),delete t.requestSliderSize),ol.control.ZoomSlider.render.call(this,e))};a.call(this)}}}),t.z2eCtl=new ol.control.ZoomToExtent({target:a,extent:e.options.initialExtent,tipLabel:""}),r.addControl(t.zCtl),r.addControl(t.zsCtl),r.addControl(t.z2eCtl);var o=t.parent._$div;$buttons=o.find("button").addClass("tc-ctl-btn "+t.parent.CLASS+"-btn").css("display","block").html(""),$buttons.filter(".ol-zoom-in").addClass(t.parent.CLASS+"-btn-zoomin").attr("title",t.parent.getLocaleString("zoomIn")),$buttons.filter(".ol-zoom-out").addClass(t.parent.CLASS+"-btn-zoomout").attr("title",t.parent.getLocaleString("zoomOut")),o.find(".ol-zoom-extent button").addClass(t.parent.CLASS+"-btn-home").attr("title",t.parent.getLocaleString("zoomToInitialExtent")),$(e.div).find(".ol-zoomslider").addClass(t.parent.CLASS+"-bar").find(".ol-zoomslider-thumb").addClass(t.parent.CLASS+"-slider"),e.on(TC.Consts.event.BASELAYERCHANGE,$.proxy(t.refresh,t))})},TC.wrap.control.NavBar.prototype.refresh=function(){var e=this,t=e.parent.map.wrap.map;if(e.zsCtl.sliderInitialized_){var r=t.getView().getResolution();e.zsCtl.setThumbPosition_(r)}else t.once(ol.MapEvent.Type.POSTRENDER,function(t){e.zsCtl.render(t)})},TC.wrap.control.Coordinates.prototype.register=function(r){var a=this,o=new $.Deferred;return a.map=r,a._cleanCoordsTrigger=function(e){var t=a.map.getControlsByClass(TC.control.Popup)[0];e.toElement&&$(e.toElement).attr("class")&&t&&$(e.toElement).attr("class").indexOf(t.CLASS)>-1?a.parent.coordsToClick({coordinate:[(a.map.getExtent()[0]+a.map.getExtent()[2])/2,(a.map.getExtent()[1]+a.map.getExtent()[3])/2]}):a.parent.cleanCoordsPointer(e)},a._coordsTrigger=function(e){a.parent.coordsToClick(e)},$.when(r.wrap.getMap()).then(function(r){a.olMap=r;var n=r.getView().getProjection();a.parent.crs=n.getCode(),a.parent.units=n.getUnits(),a.parent.isGeo=a.parent.units===ol.proj.Units.DEGREES;var i=r.getViewport();$(i).add(a.parent.div).on(e+".coords",function(e){var t=r.getEventCoordinate(e);t&&(a.parent.isGeo?a.parent.latLon=t.reverse():a.parent.xy=t,a.parent.update.apply(a.parent,arguments))}).on(t,function(e){a.parent.clear.apply(a.parent,arguments)}),o.resolve()}),o},TC.wrap.control.Geolocation.prototype.register=function(e){var t=this;t.map=e,t._snapTrigger=function(e){e.dragging||t.initSnap(t.olMap.getEventCoordinate(e.originalEvent))},t._postcomposeTrigger=function(e){t.duringTrackSnap(e)},$.when(e.wrap.getMap()).then(function(e){t.olMap=e})},TC.wrap.control.Geolocation.prototype.hasCoordinates=function(){var e=this;return e.trackData&&e.trackData.trackFeature&&e.trackData.trackFeature.getGeometry().getCoordinates().length>=1};var C=function(e,t){var r=t-e,a={s:Math.floor(r/1e3%60),m:Math.floor(r/6e4%60),h:Math.floor(r/36e5%24)};return $.extend({},a,{toString:("00000"+a.h).slice(-2)+":"+("00000"+a.m).slice(-2)+":"+("00000"+a.s).slice(-2)})};TC.wrap.control.Geolocation.prototype.getTooltip=function(e){var t=this;t.parent.elevationMarker||(t.parent.elevationMarker=new ol.Overlay({element:t.parent.track.htmlElevationMarker,offset:[0,-11],positioning:ol.Overlay.Positioning.CENTER_CENTER,stopEvent:!1})),t.parent.layerTrack.getVisibility()&&t.parent.layerTrack.getOpacity()>0&&($(t.parent.track.htmlElevationMarker).show(),t.olMap.addOverlay(t.parent.elevationMarker),t.parent.elevationMarker.setPosition(t.parent.chart.coordinates[e[0].index]));var r=t.map.getExtent(),a=t.parent.chart.coordinates[e[0].index];r[0]<=a[0]&&a[0]<=r[2]&&r[1]<=a[1]&&a[1]<=r[3]||TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Point,[TC.apiLocation+"TC/feature/Point.js"],function(){t.map.setCenter(a.slice(0,2),{animate:!0})});var o=e[0].x;o/=1e3;var n;4==t.parent.chart.coordinates[0].length&&t.parent.chart.coordinates[0][3]>0&&(n=C(t.parent.chart.coordinates[0][3],a[3]));var i,s,l=t.parent.map.options.locale&&t.parent.map.options.locale.replace("_","-")||void 0,p=parseInt(e[0].value.toFixed(0)).toLocaleString(l);return 1>o?(i=Math.round(1e3*o),s=" m"):(i=Math.round(100*o)/100,s=" km"),i=i.toLocaleString(l),'<div class="track-elevation-tooltip"><div><span>'+p+" m </span><br><span>"+i+s+" </span></div>"+(n?"<span>"+n.toString+"</span><div/>":"")},TC.wrap.control.Geolocation.prototype.addWaypoint=function(e,t){var r=this,a=new ol.Feature({geometry:new ol.geom.Point([e[0],e[1],t.ele,t.time],"XYZM")});a.setProperties(t),r.parent.layerTracking.wrap.layer.getSource().addFeature(a)};var T=!0,w=function(e,t){var r=e.getGeometry(),a=r.getType().toLowerCase(),o=!T,n=[];return n.push(new ol.style.Style({stroke:new ol.style.Stroke({width:2,color:"rgba(0,206,209, "+(o&&e.get("tracking")?0:1)+")",lineDash:[.1,6]})})),"point"!=a||o||n.push(new ol.style.Style({image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"rgba(0,206,209, "+(o&&e.get("tracking")?0:.5)+")"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, "+(o&&e.get("tracking")?0:1)+")",width:1})}),text:new ol.style.Text({textAlign:"center",textBaseline:"middle",font:"bold 14px Arial",text:o&&e.get("tracking")?"":e.get("name"),fill:new ol.style.Fill({color:"rgba(0,206,209, "+(o&&e.get("tracking")?0:1)+")"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, "+(o&&e.get("tracking")?0:1)+")",width:parseInt(3,10)}),offsetX:parseInt(0,10),offsetY:parseInt(0,10)})})),n},S=function(e,t){var r=e.getGeometry(),a=r.getType().toLowerCase(),o=[];if(a.indexOf("linestring")>-1){var n=r.getFirstCoordinate();o.push(new ol.style.Style({geometry:new ol.geom.Point(n),image:new ol.style.Icon({anchor:[.5,1],src:TC.Util.getPointIconUrl({cssClass:"tc-ctl-geolocation-track-marker-icon-end"})})}));var i=r.getLastCoordinate();o.push(new ol.style.Style({geometry:new ol.geom.Point(i),image:new ol.style.Icon({anchor:[.5,1],src:TC.Util.getPointIconUrl({cssClass:"tc-ctl-geolocation-track-marker-icon"})})}))}return o.push(new ol.style.Style({stroke:new ol.style.Stroke({width:2,color:"rgba(197, 39, 55, 1)"})})),"point"==a&&o.push(new ol.style.Style({image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"rgba(197, 39, 55, .5)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 1)",width:1})}),text:new ol.style.Text({textAlign:"center",textBaseline:"middle",font:"bold 14px Arial",text:e.get("name"),fill:new ol.style.Fill({color:"rgba(197, 39, 55, 1)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 1)",width:parseInt(3,10)}),offsetX:parseInt(0,10),offsetY:parseInt(0,10)})})),o};TC.wrap.control.Geolocation.prototype.setTrackOnMapVisibility=function(e){var t=this;T=e,t.parent.layerTracking.wrap.layer.setStyle(w)},TC.wrap.control.Geolocation.prototype.addPosition=function(e,t,r,a,o,n,i){var s=this,l=Math.round(e[0]),p=Math.round(e[1]);if(s.trackData&&s.trackData.trackFeature){var c=s.trackData.trackFeature.getGeometry().getLastCoordinate();if(c&&0==c.length)s.trackData.trackFeature.getGeometry().appendCoordinate([l,p,t,r]);else{var u=Math.round(c[0]),g=Math.round(c[1]);(l!=u||p!=g)&&s.trackData.trackFeature.getGeometry().appendCoordinate([l,p,t,r])}}s.parent.$events.trigger($.Event(s.parent.Const.Event.STATEUPDATED,{moving:void 0!=t&&void 0!=a&&a>0&&t>0}))},TC.wrap.control.Geolocation.prototype.positionChangehandler=function(e){var t,r,a,o,n,i=this,s=$.Deferred();if(e&&e.coords)if(i.parent.layerGPS.clearFeatures(),t=e.coords.accuracy||0,r=e.coords.heading||e[2]||0,a=e.coords.speed?3.6*e.coords.speed:0,o=e.coords.altitude||0,n=e.coords.altitudeAccuracy||0,i.trackData&&i.trackData.trackFeature){var l=[e.coords&&e.coords.longitude||e[0],e.coords&&e.coords.latitude||e[1]],p=TC.Util.reproject(l,"EPSG:4326",i.parent.map.crs);i.addPosition(p,r,(new Date).getTime(),a,t,n,o);var c=i.trackData.trackFeature.getGeometry().getCoordinates(),u=c.length;u>=2&&(i.parent.deltaMean=(c[u-1][3]-c[0][3])/(u-1)),i.parent.$events.trigger($.Event(i.parent.Const.Event.POSITIONCHANGE,{pd:{position:[p[0],p[1]],altitude:o,accuracy:t,heading:TC.Util.radToDeg(r),speed:a}})),$.when(i.parent.layerGPS.addPoint(p,{radius:4,fillColor:"#00CED1",fillOpacity:1,strokeColor:"#ffffff",strokeWidth:2,showsPopup:!1}),i.parent.layerGPS.addCircle([p,t],{strokeColor:"#00CED1",strokeWidth:.4,fillColor:"#ffffff",fillOpacity:.2,showsPopup:!1})).done(function(e,t){i.parent.geopositionTracking=!0,0==i.parent.firstPosition&&(i.parent.firstPosition=!0,i.parent.$centerDiv?i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1):(i.parent.$centerDiv=i.parent._$div.find("."+i.parent.CLASS+"-track-center"),i.parent.$button=i.parent._$div.find("."+i.parent.CLASS+"-track-center button"),i.parent.$button.on("click",function(){i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features),i.parent.track.$info.find(".prsidebar-body").fadeIn("slide"),i.parent.track.$info.find(".prcollapsed").hide()}),i.parent.$centerDiv.appendTo(i.parent.map._$div),i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1)),i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features)),s.resolve({marker:e,accuracy:t})})}else s.resolve(null);else s.resolve(null);return s.promise()},TC.wrap.control.Geolocation.prototype.setTracking=function(e){function t(){var e=l++;navigator.geolocation.getCurrentPosition(function(e){clearInterval(s),r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting),r.positionChangehandler(e).then(function(e){1==r.parent.geopositionTracking&&e&&e.marker&&e.accuracy&&(r.currentPositionTrk=navigator.geolocation.watchPosition(r.positionChangehandler.bind(r),r.parent.onGeolocateError.bind(r.parent),p))})},function(e){switch(e.code){case e.TIMEOUT:t();break;default:clearInterval(s),r.parent.onGeolocateError.call(r.parent,e)}},{timeout:5e3+e,maximumAge:10,enableHighAccuracy:!0})}var r=this;if(e){r.parent.firstPosition=!1,r.trackData={};var a=[];if(r.parent.sessionTracking)for(var o=(new ol.format.GeoJSON).readFeatures(r.parent.sessionTracking),n=0;n<o.length;n++){var i=o[n].getGeometry().getType().toLowerCase();"point"==i?a.push(o[n]):"linestring"==i&&(r.trackData.trackFeature=o[n],r.trackData.trackFeature.setProperties({tracking:!0}))}else r.trackData.trackFeature=new ol.Feature({geometry:new ol.geom.LineString([],"XYZM"),tracking:!0});r.parent.layerTracking.wrap.layer.setSource(new ol.source.Vector({features:[r.trackData.trackFeature]})),a.length>0&&r.parent.layerTracking.wrap.addFeatures(a),
r.parent.layerTracking.wrap.layer.setStyle(w),r.trackData.trackFeature.getGeometry().getCoordinates().length>1&&r.parent.map.setExtent(r.parent.layerTracking.wrap.layer.getSource().getExtent()),r.parent.currentPositionWaiting=r.parent.getLoadingIndicator().addWait();var s,l=0,p={enableHighAccuracy:!0,timeout:6e5};s=setInterval(t,1e3),setTimeout(function(){r.trackData&&0==r.trackData.trackFeature.getGeometry().getLastCoordinate().length&&(clearInterval(s),r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting),r.map.toast(r.parent.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING}),r.parent.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1),r.parent.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0))},p.timeout+1e3)}else T=!0,r.parent.firstPosition=!1,window.navigator.geolocation.clearWatch(r.currentPositionTrk),delete r.trackData,r.parent.$centerDiv&&r.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!0)},TC.wrap.control.Geolocation.prototype.activateSnapping=function(){var e=this;T=!0,TC.Util.detectMobile()||(e.olMap.on([ol.MapBrowserEvent.EventType.POINTERMOVE,ol.MapBrowserEvent.EventType.SINGLECLICK],e._snapTrigger),e.olMap.on(ol.render.Event.Type.POSTCOMPOSE,e._postcomposeTrigger))},TC.wrap.control.Geolocation.prototype.deactivateSnapping=function(){var e=this;$.when(e.parent.map.wrap.getMap()).then(function(t){TC.Util.detectMobile()||(t.un([ol.MapBrowserEvent.EventType.POINTERMOVE,ol.MapBrowserEvent.EventType.SINGLECLICK],e._snapTrigger),t.un(ol.render.Event.Type.POSTCOMPOSE,e._postcomposeTrigger)),e.snapInfo&&t.removeOverlay(e.snapInfo),e.snapInfoElement&&(e.snapInfoElement.style.display="none"),e.snapLine&&(delete e.snapLine,t.render())})},TC.wrap.control.Geolocation.prototype.clear=function(e){var t=this;e&&e.wrap.layer&&(e.wrap.layer.getSource().clear(),e.wrap.layer.setSource(new ol.source.Vector)),L=!1,t.deactivateSnapping.call(t)};var E;TC.wrap.control.Geolocation.prototype.duringTrackSnap=function(e){var t=this,r=E=e.vectorContext;r&&t.snapLine&&("function"==typeof r.setFillStrokeStyle&&r.setFillStrokeStyle(null,new ol.style.Stroke({color:"rgba(197, 39, 55, 1)",width:1})),"function"==typeof r.drawGeometry&&r.drawGeometry(t.snapLine.wrap.feature.getGeometry()))},TC.wrap.control.Geolocation.prototype.initSnap=function(e){var t=this;if(t.parent.layerTrack){var r=t.parent.layerTrack.wrap.layer.getSource(),a=r.getClosestFeatureToCoordinate(e);if(null!==a){var o=a.getGeometry(),n=o.getClosestPoint(e),i=[e,[n[0],n[1]]];t.snapLine?t.snapLine.wrap.feature.getGeometry().setCoordinates(i):t.snapLine=new TC.feature.Polyline(i),t.snapInfoElement||(t.snapInfoElement=document.getElementsByClassName("tc-ctl-geolocation-track-snap-info")[0]),t.snapInfoElement.style.display="block",t.snapInfo||(t.snapInfo=new ol.Overlay({element:t.snapInfoElement,offset:[5,18]}),t.olMap.addOverlay(t.snapInfo)),void 0==t.snapInfo.getMap()&&t.snapInfo.setMap(t.olMap),t.snapInfo.setPosition(e);var s={};"LineString"!=a.getGeometry().getType()&&a.getKeys().indexOf("name")>-1&&(s.n=a.get("name"));var l=t.parent.map.options.locale&&t.parent.map.options.locale.replace("_","-")||void 0;s.x=Math.round(n[0]).toLocaleString(l),s.y=Math.round(n[1]).toLocaleString(l),s.z=n.length>=3?(Math.round(100*n[2])/100).toLocaleString(l):void 0,s.m=4==n.length&&n[3]>0?new Date(n[3]).toLocaleString(l):void 0,s&&t.parent.getRenderedHtml(t.parent.CLASS+"-track-snapping-node",s,function(e){t.snapInfoElement.innerHTML=e})}t.olMap.render()}};var L=!1;TC.wrap.control.Geolocation.prototype.drawTrackingData=function(e){var t=this,r=$.Deferred(),a=[],o=new TC.wrap.parser.JSON,n=o.parser.readFeatures(e);t.activateSnapping.call(t),L||($(document).on("mouseover",".tc-ctl-p-results",function(e){t.parent.layerTrack.getVisibility()||0!=t.parent.layerTrack.getOpacity()||t.deactivateSnapping.call(t)}),$(document).on("mouseout",".tc-ctl-p-results",function(e){t.parent.layerTrack.getVisibility()&&t.parent.layerTrack.getOpacity()>0&&t.activateSnapping.call(t)}),L=!0);for(var i=0,s=n.length;s>i;i++)a.push(TC.wrap.Feature.createFeature(n[i]));return $.when.apply($,a).then(function(){for(var e=0;e<arguments.length;e++){var a=arguments[e];a&&t.parent.layerTrack.addFeature(a)}t.parent.map.zoomToFeatures(t.parent.layerTrack.features),t.parent.layerTrack.wrap.layer.setStyle(S),r.resolve()}),r.promise()},TC.wrap.control.Geolocation.prototype.formattedToStorage=function(e,t){var r=new TC.wrap.parser.JSON;r=r.parser;var a=e.wrap.layer.getSource().getFeatures();if(t)for(var o=0;o<a.length;o++)a[o].get("tracking")&&a[o].set("tracking",!1);return r.writeFeatures(a)},TC.wrap.control.Geolocation.prototype["export"]=function(e,t){var r=this,a=new $.Deferred,o=[];return r.parent.getTrackingData(t).then(function(n){if(n){var i=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(n)});if(i.getFeatures().length>0)i.forEachFeature(function(e){var t=e.clone();if(t.getGeometry().transform(r.parent.map.crs,"EPSG:4326"),"linestring"==t.getGeometry().getType().toLowerCase()){var a=new ol.geom.MultiLineString([],t.getGeometry().getLayout());a.appendLineString(t.getGeometry()),o.push(new ol.Feature({geometry:a}))}else o.push(t)});else{var s=r.parent.getTrackingData(t),l=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(s)});l.forEachFeature(function(e){var t=e.clone();if(t.getGeometry().transform(r.parent.map.crs,"EPSG:4326"),"linestring"==t.getGeometry().getType().toLowerCase()){var a=new ol.geom.MultiLineString([],t.getGeometry().getLayout());a.appendLineString(t.getGeometry()),o.push(new ol.Feature({geometry:a}))}else o.push(t)})}}switch(e){case"GPX":a.resolve(o?(new ol.format.GPX).writeFeatures(o):null);break;case"KML":a.resolve(o?(new ol.format.KML).writeFeatures(o):null)}}),a};var M=function(e){var t=[],r=[];if(e.length>1){4==e[0].length&&(e=e.sort(function(e,t){return e[0][3]==t[0][3]?0:e[0][3]<t[0][3]?-1:1}));for(var a=0;a<e.length;a++){for(var o=e[a],n=-1,i=1/0,s=o.getLastCoordinate(),l=a+1;l<e.length;l++){var p=e[l].getFirstCoordinate(),c=Math.hypot(s[0]-p[0],s[1]-p[1]);i>c&&(n=l,i=c)}t.length<e.length&&(-1==t.indexOf(a)&&(t.push(a),r=r.concat(o.getCoordinates())),-1==t.indexOf(n)&&(t.push(n),r=r.concat(e[n].getCoordinates())))}return r}return e[0].getCoordinates()};TC.wrap.control.Geolocation.prototype.processImportedFeatures=function(e){for(var t=this,r=t.parent.layerTrack.wrap.layer.getSource(),a=t.parent.importedFileName,o=[],n=[],i=[],s=r.getFeatures(),l=[],p=0;p<s.length;p++){var c=s[p];if(c instanceof TC.Feature&&(c=s[p].wrap.feature),c.getGeometry()instanceof ol.geom.LineString)l.push(c.getGeometry()),i.push(c);else if(c.getGeometry()instanceof ol.geom.MultiLineString){var u=c.clone();o.push(u.getProperties().hasOwnProperty("name")?u.getProperties().name.trim().length>0?u.getProperties().name:a:a);var g=u.getGeometry().getLineStrings(),f=M(g);n.push(new ol.Feature({geometry:new ol.geom.LineString(f)})),i.push(c)}}if(l.length>0){var f=M(l);n.push(new ol.Feature({geometry:new ol.geom.LineString(f)}))}if(i.length>0)for(var m=0;m<i.length;m++)r.removeFeature(i[m]);if(n.length>0){var y,d=function(e,t){for(var r=[],a=e.indexOf(t);-1!=a;)if(r.push(a),a=e.indexOf(t,a+1),r.length>1)return!0;return r.length>1?!0:!1},v=(new $.Deferred,0),h=function(){var e=[];return $.each(n,function(i){var s=new $.Deferred;y&&r.removeFeature(y);var l;if(o.length>i){var l=o[i];d(o,l)&&(l="["+(i+1)+"] "+l)}t.parent.importedFileName=l?l:a,y=n[i],r.addFeature(y),t.parent.saveTrack(t.parent.getLocaleString("geo.trk.upload.ok",{trackName:t.parent.importedFileName})).then(function(e){0==i&&(v=e),s.resolve()}),e.push(s)}),$.when.apply(void 0,e).promise()};h().then(function(){t.parent.$events.trigger(t.parent.Const.Event.IMPORTEDTRACK,v),delete t.parent.importedFileName,t.parent.map.setExtent(r.getExtent()),t.parent.getLoadingIndicator().removeWait(e)})}else t.parent.layerTrack&&(t.parent.map.removeLayer(t.parent.layerTrack),t.parent.layerTrack=void 0),delete t.parent.importedFileName,t.parent.getLoadingIndicator().removeWait(e),TC.alert(t.parent.getLocaleString("geo.trk.upload.error4"))},TC.wrap.control.Geolocation.prototype["import"]=function(e,t,r){var a,o,n=this;if(t&&t.text){var i=n.parent.layerTrack.wrap.createVectorSource({data:t.text,type:r});a=i.source,o=a.on("change",function(t){"ready"==a.getState()&&(ol.Observable.unByKey(o),n.processImportedFeatures(e))});var s=n.parent.layerTrack.wrap.layer;s.setStyle(S),s.setSource(a)}else n.parent.layerTrack&&(n.parent.map.removeLayer(n.parent.layerTrack),n.parent.layerTrack=void 0),delete n.parent.importedFileName,n.parent.getLoadingIndicator().removeWait(e),TC.alert(n.parent.getLocaleString("geo.trk.upload.error4"))};var R;TC.wrap.control.Geolocation.prototype.simulateTrackEnd=function(){var e=this;$(e.miProgressTextDiv).remove(),$(e.miProgressDiv).remove(),$(e.miDiv).remove(),e.simulateMarker&&(window.cancelAnimationFrame(R),e.simulateMarker.layer.wrap.layer.getSource().getFeatures().length>0&&e.simulateMarker.layer.removeFeature(e.simulateMarker),delete e.simulateMarker)},TC.wrap.control.Geolocation.prototype.simulateTrack=function(){for(var e,t=this,r=t.parent.layerTrack.wrap.layer.getSource().getFeatures(),a=0;a<r.length;a++)if(r[a].getGeometry()instanceof ol.geom.LineString){e=r[a].getGeometry().getCoordinates();break}if(e&&e.length>0){var o=e[0],n=function(){var e=new $.Deferred;return t.simulateMarker?(t.simulateMarker.setCoords(o.slice(0,2)),e.resolve(t.simulateMarker)):t.parent.layerTrack.addPoint(o.slice(0,2),{radius:7,fillColor:"#ff0000",strokeColor:"#ffffff",strokeWidth:2}).then(function(t){e.resolve(t)}),e};n().then(function(r){t.simulateMarker=r;var a=function(){var r,a,o,n=(e.length,!1);if(t.parent.hasElevation){var i=d3.select(".c3-event-rects,.c3-event-rects-single").node().getBoundingClientRect();$("body").append('<div class="miDiv">'),t.miDiv=$("div.miDiv"),t.miDiv.width(i.width),t.miDiv.height(i.height),t.miDiv.append('<div class="miProgressDiv">'),t.miProgressDiv=$("div.miProgressDiv"),t.miProgressDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress"),t.miProgressDiv.width("0%"),t.miProgressDiv.height(i.height),t.miProgressDiv.append('<div class="miProgressTextDiv">'),t.miProgressTextDiv=$("div.miProgressTextDiv"),t.miProgressTextDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress text"),t.miProgressTextDiv.width(i.width),t.miProgressTextDiv.height(i.height),t.miDiv.css({top:i.top,left:i.left,bottom:i.bottom,right:i.right,position:"absolute","z-index":1e4})}var s=e;if(4==s[0].length&&s[0][3]>0)r=s[0][3],a=s[s.length-1][3],n=!0;else{s[0][3]=Date.now();for(var l=1;l<s.length;l++){var p;s[l][3]=0,p=l+1<s.length?new ol.geom.LineString(s.slice(l-1,l+1)).getLength():new ol.geom.LineString(s.slice(l-1)).getLength(),s[l][3]=s[l-1][3]+36e5*p/t.parent.walkingSpeed}r=s[0][3],a=s[s.length-1][3]}var c=new ol.geom.LineString(s),u=r,g=c.getLength(),p=0,f=function(e){for(var t=0;t<s.length;t++)if(s[t][3]>e)return{d:new ol.geom.LineString(s.slice(0,t)).getLength(),p:s[t-1].slice(0,2)}},m=function(){if(!t.parent.simulate_paused){var e=c.getCoordinateAtM(u),r=f(u);if(o>=1||!e||!r){t.simulateTrackEnd();var a=t.parent.getSelectedTrack();return a&&t.parent.uiSimulate(!1,a),$(t.miProgressTextDiv).remove(),$(t.miProgressDiv).remove(),void $(t.miDiv).remove()}if(t.parent.hasElevation){p=r.d;var i=(p+Math.hypot(r.p[0]-e[0],r.p[1]-e[1]))/g*100;t.miProgressDiv.width(i+"%");var l;n&&(l=C(s[0][3],e[3]));var y,d,v=t.parent.map.options.locale&&t.parent.map.options.locale.replace("_","-")||void 0,h=parseInt(e[2].toFixed(0)).toLocaleString(v);1>p/1e3?(y=Math.round(p/1e3*1e3),d=" m"):(y=Math.round(p/1e3*100)/100,d=" km"),y=y.toLocaleString(v),t.miProgressTextDiv.html("<div><span>"+h+" m</span><br><span>"+y+d+"</span></div>"+(n?"<br><span>"+l.toString+"</span>":""))}if(t.simulateMarker){{var T=t.simulateMarker.getCoords(),w=e;180*Math.atan2(w[1]-T[1],w[0]-T[0])/Math.PI}t.simulateMarker.setCoords(e)}u+=1!==t.parent.simulate_speed?t.parent.delta*t.parent.simulate_speed:t.parent.delta}R=requestAnimationFrame(m)};R=requestAnimationFrame(m)},o=new $.Deferred;window.d3?o.resolve():TC.loadJS(!window.d3,[TC.Consts.url.D3C3],function(){o.resolve()}),o.then(function(){R=requestAnimationFrame(a)})})}},TC.wrap.control.Geolocation.prototype.headingChangehandler=function(e){var t=this;t.parent.track.$infoOnMap||(t.parent.track.$infoOnMap=$('<div style="overflow-y: scroll; height: 200px; width: 200px; top: 0; left: 100px; background-color: fuchsia; position: absolute;"></div>').appendTo(t.parent.map._$div)),t.parent.track.$infoOnMap.show(),t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> salta headingChangehandler </p>"),t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> evt.target.getHeading(): "+e.target.getHeading()+" </p>"),t.heading=e.target.getHeading(),$.when(t.map.wrap.getMap()).then(function(e){e.getView().setRotation(-t.heading)}),t.parent.$events.trigger($.Event(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))},TC.wrap.control.Geolocation.prototype.orientationChangehandler=function(e){var t=this,r=t.map.wrap.map.getView(),a=r.getCenter(),o=r.getResolution(),n=e.target.getBeta()||0,i=e.target.getGamma()||0;a[0]-=o*i*25,a[1]+=o*n*25,r.setCenter(r.constrainCenter(a)),t.parent.$events.trigger($.Event(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))},TC.wrap.control.Geolocation.prototype.pulsate=function(e){var t=this;t.pulsated=!0;var r,a=e.wrap.feature.getGeometry().getRadius(),o=(new Date).getTime(),n=500,i=function(e){switch(!0){case 50>=e:return a;case e>50&&100>=e:return 1.02*a;case e>100&&150>=e:return 1.05*a;case e>150&&200>=e:return 1.02*a;case e>200&&300>=e:return a;case e>300&&350>=e:return 1.02*a;case e>350&&400>=e:return 1.05*a;case e>400&&450>=e:return 1.02*a;case e>450&&500>=e:return 1*a;default:return a}};r=t.olMap.on(ol.render.Event.Type.POSTCOMPOSE,function(t){var a=t.vectorContext,s=t.frameState,l=s.time-o,p=e.wrap.feature.getGeometry().clone(),c=i(l);return p.setRadius(c),a.setFillStrokeStyle(new ol.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),new ol.style.Stroke({color:"rgba(255, 0, 0, .8)",width:1})),a.drawCircleGeometry(p),l>n?void ol.Observable.unByKey(r):void(s.animate=!0)})},TC.wrap.control.Coordinates.prototype.coordsActivate=function(){var e=this;e.olMap.on(ol.MapBrowserEvent.EventType.SINGLECLICK,e._coordsTrigger);var r=e.olMap.getViewport();$(r).on(t,e._cleanCoordsTrigger)},TC.wrap.control.Coordinates.prototype.coordsDeactivate=function(){var e=this;e.olMap.un(ol.MapBrowserEvent.EventType.SINGLECLICK,e._coordsTrigger);var r=e.olMap.getViewport();$(r).off(t,e._cleanCoordsTrigger)},TC.wrap.Parser=function(){},TC.wrap.Parser.prototype.read=function(e){var t=[],r=this;return r.parser&&(TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature.js"),t=$.map(r.parser.readFeatures(e),function(e){return new TC.Feature(null,{id:e.getId(),data:e.getProperties()})})),t},TC.wrap.parser={WFS:function(e){this.parser=new ol.format.WFS(e)},JSON:function(e){this.parser=new ol.format.GeoJSON(e)}},TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser),TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser),TC.wrap.control.OverviewMap.prototype.register=function(e){var t=this;$.when(t.parent.layer.wrap.getLayer()).then(function(r){t.ovMap=new ol.control.OverviewMap({target:t.parent.div,collapsed:!1,collapsible:!1,className:t.parent.CLASS+" ol-overviewmap",layers:[r]});var a=$(t.ovMap.boxOverlay_.getElement()).parents(".ol-overlay-container").first();TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jquery/jquery.event.drag.js",TC.apiLocation+"lib/jquery/jquery.event.drop.js"],function(){var r,o,n=t.ovMap.ovmap_;a.drag("start",function(t,a){var i=$(this);r=parseInt(i.css("bottom")),o=parseInt(i.css("left"));var s=n.getPixelFromCoordinate([e.options.maxExtent[0],e.options.maxExtent[1]]),l=n.getPixelFromCoordinate([e.options.maxExtent[2],e.options.maxExtent[3]]),p=n.getSize();a.limit={bottom:p[1]-s[1],left:s[0],top:p[1]-l[1]-i.height(),right:l[0]-i.width()}}).drag("end",function(r,a){var o=($(this),t.ovMap.getMap()),i=o.getView(),s=n.getPixelFromCoordinate(i.getCenter()),l=n.getCoordinateFromPixel([s[0]+a.deltaX,s[1]+a.deltaY]),p=e.getExtent(),c=(p[2]-p[0])/2,u=(p[3]-p[1])/2;l[0]+c>e.options.maxExtent[2]?l[0]=e.options.maxExtent[2]-c:l[0]-c<e.options.maxExtent[0]&&(l[0]=e.options.maxExtent[0]+c),l[1]+u>e.options.maxExtent[3]?l[1]=e.options.maxExtent[3]-u:l[1]-u<e.options.maxExtent[1]&&(l[1]=e.options.maxExtent[1]+u);var g=ol.animation.pan({duration:500,source:i.getCenter()});o.beforeRender(g),i.setCenter(l)}).drag(function(e,t){{var a=$(this);parseInt(a.css("bottom")),parseInt(a.css("left"))}t.limit.top?(a.css("bottom",Math.min(Math.max(r-t.deltaY,t.limit.bottom),t.limit.top)+"px"),a.css("left",Math.min(Math.max(o+t.deltaX,t.limit.left),t.limit.right)+"px")):(a.css("bottom",r-t.deltaY+"px"),a.css("left",o+t.deltaX+"px"))})}),$.when(e.wrap.getMap()).then(function(a){t.ovMap.ovmap_.setView(new ol.View(p(e.wrap,r._wrap.parent)));var o=$(t.parent.div).find("."+t.parent.CLASS+"-load");r._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){o.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)}),r._wrap.$events.on(TC.Consts.event.TILELOAD,function(){o.removeClass(TC.Consts.classes.VISIBLE).addClass(TC.Consts.classes.HIDDEN)}),a.addControl(t.ovMap),t.parent.isLoaded=!0,t.parent.$events.trigger($.Event(TC.Consts.event.MAPLOAD))})})},TC.wrap.control.OverviewMap.prototype.enable=function(){var e=this;e.parent.layer&&e.parent.layer.setVisibility&&(e.parent.layer.setVisibility(!0),$(e.parent.map.div).trigger("resize"))},TC.wrap.control.OverviewMap.prototype.disable=function(){var e=this;e.parent.layer&&e.parent.layer.setVisibility&&e.parent.layer.setVisibility(!1)},TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var a=t._trigger;t._trigger=function(r){t.hasElegibleLayers().then(function(o){o&&a.call(t,r)&&e.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:r.pixel,control:t.parent}))})}})},TC.wrap.control.FeatureInfo.prototype.hasElegibleLayers=function(){var e=$.Deferred(),t=this.parent.map,r=!1;return $.when(t.wrap.getMap()).then(function(a){a.getLayers().forEach(function(e){var a=e._wrap.parent,o=e.getSource();return o.getGetFeatureInfoUrl&&$.inArray(a,t.workLayers)>=0?(r=!0,!1):void 0}),e.resolve(r)}),e};var x,P=function(e){var t=e.innerHTML||e.textContent;return x=x||document.createElement("textarea"),x.innerHTML=t,x.value},I={readFeatures:function(e){var t=[],r=(new DOMParser).parseFromString(e,"text/xml");if("FeatureInfoResponse"===r.documentElement.tagName)for(var a=r.documentElement.getElementsByTagName("FeatureInfoCollection"),o=0,n=a.length;n>o;o++)for(var i=a[o],s=i.getAttribute("layername"),l=i.getElementsByTagName("FeatureInfo"),p=0,c=l.length;c>p;p++){for(var u=l[p].getElementsByTagName("Field"),g={},f=0,m=u.length;m>f;f++){var y=u[f];g[P(y.getElementsByTagName("FieldName")[0])]=P(y.getElementsByTagName("FieldValue")[0])}var d=new ol.Feature(g);d.setId(s+"."+TC.getUID()),t[t.length]=d}return t}},A=function(e,t,r){var a=t.getPath(r);e.layers.push({name:r,title:a[a.length-1],path:a.slice(1),features:[]})};TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(e,t){var r=this,a=t||{},o=r.parent.map;$.when(o.wrap.getMap()).then(function(t){for(var n={},i={},s=[],l=[],p=t.getLayers().getArray(),c=0;c<p.length;c++){var u=p[c];if(u.getVisible()){var g=u._wrap.parent,f=u.getSource();if(f.getGetFeatureInfoUrl&&$.inArray(g,o.workLayers)>=0&&g.names.length>0&&(!a.serviceUrl||a.serviceUrl===g.url)){var m={};if(n[g.title]?m=n[g.title]:(m={layers:[],mapLayer:g,request:null},n[g.title]=m,i[g.title]={source:jQuery.extend(!0,{},f),layers:[]}),a.layerName)u._wrap.getInfo(a.layerName).queryable&&A(m,g,a.layerName),i[g.title].layers.push(a.layerName);else{for(var y=g.getDisgregatedLayerNames(),d=0;d<y.length;d++){var v=y[d];u._wrap.getInfo(v).queryable?A(m,g,v):(y.splice(d,1),d-=1)}i[g.title].layers=i[g.title].layers.concat(y)}}}}var h=a.mapSize||t.getSize(),C=Math.round(e[0]),T=Math.round(e[1]),w=a.boundingBox||o.getExtent(),S=t.getView().getResolution();for(var E in n){var m=n[E],f=i[E].source,p=i[E].layers,L=f.getParams();f.params_.LAYERS=p.join(",");var M=f.getGetFeatureInfoUrl(e,S,o.crs,{QUERY_LAYERS:p.join(","),INFO_FORMAT:L.INFO_FORMAT,FEATURE_COUNT:1e3,radius:o.options.pixelTolerance,buffer:o.options.pixelTolerance});M=M.replace(/I=\d+(\.\d+)?/,"I="+C).replace(/J=\d+(\.\d+)?/,"J="+T).replace(/WIDTH=\d+/,"WIDTH="+h[0]).replace(/HEIGHT=\d+/,"HEIGHT="+h[1]).replace(/BBOX=-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?/,"BBOX="+w.join("%2C")).replace(/sld_body=[a-zA-Z%0-9._]*/);var R=M;M=TC.proxify(M);var x=$.ajax({url:M});x.originalUrl=M,x.title=E,x.requestedFormat=L.INFO_FORMAT,x.expandUrl=R,s.push(x)}s.length>0?$.when.apply(r,s).then(function(){for(var t=s.length>1?arguments:[arguments],i=!1,p=0,c=[],u=0;u<t.length;u++){var g=t[u],f=n[s[u].title],m=g[2];if("success"===g[1]){i=!0,f.text=m.responseText;var y,d=m.getResponseHeader("Content-type");if(d&&d.indexOf(";")>-1&&(d=d.substr(0,d.indexOf(";")).trim()),d||(d=m.requestedFormat),d===m.requestedFormat){switch(d){case"application/json":y=new ol.format.GeoJSON;break;case"application/vnd.ogc.gml":y=m.responseText.indexOf("FeatureCollection")>-1?new ol.format.WFS({gmlFormat:new ol.format.GML2}):new ol.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":y=new ol.format.GML3;break;case"application/vnd.esri.wms_featureinfo_xml":y=I;break;default:y=null}if(y){var v=y.readFeatures(m.responseText,{featureProjection:ol.proj.get(o.crs)});p+=v.length;for(var h=function(e,t,r){var a=!1;if(t===r)a=!0;else{var o=e.getNodePath(t),n=e.getNodePath(r);if(o.length>0&&n.length>=o.length){a=!0;for(var i=0;i<o.length;i++)if(e.wrap.getName(o[i])!==e.wrap.getName(n[i])){a=!1;break}}}return a},C={},T=0;T<v.length;T++){var w=v[T];if(w instanceof ol.Feature){for(var S=w.getId()||TC.getUID(),E=!1,L=S.substr(0,S.lastIndexOf(".")),M=0;M<f.layers.length;M++){var R=f.layers[M],x=R.name.substr(R.name.indexOf(":")+1);if(h(f.mapLayer,x,L)){E=!0,a.featureId&&w.getId()!==a.featureId||(l.push(TC.wrap.Feature.createFeature(w)),c.push(R.features));break}}if(!E){var P;C[L]?P=C[L]:(P={name:L,title:L,features:[]},C[L]=P,f.layers.push(P)),a.featureId&&w.getId()!==a.featureId||(l.push(TC.wrap.Feature.createFeature(w)),c.push(P.features))}}}}else{var A={name:"layer"+TC.getUID(),title:"Datos en el punto",features:[]};f.layers[f.layers.length]=A,A.features[0]={rawUrl:m.originalUrl,expandUrl:m.expandUrl,rawContent:m.responseText,rawFormat:d},p+=1}}else o.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:e,control:r.parent,layer:f.mapLayer,message:m.responseText}))}else o.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:e,control:r.parent,layer:f.mapLayer,message:m.responseText}))}if(i){var F=l;if(l.length){var O=$.Deferred();F=F.concat(O),TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry.js",function(){O.resolve()})}$.when.apply(this,F).then(function(){var t;if(arguments.length)for(var a=o.wrap.getCoordinateFromPixel(e),i=0;i<arguments.length;i++){var s=arguments[i];if(s){s.attributes=[];for(var l in s.data){var u=s.data[l];"object"!=typeof u&&s.attributes.push({name:l,value:"number"==typeof u?u.toLocaleString(TC.Util.getMapLocale(r.parent.map)):u})}s.showsPopup=!1,!t&&TC.Geometry.isInside(a,s.geometry)&&(t=s),c[i].push(s)}}var g=[];for(var f in n)n.hasOwnProperty(f)&&g.push(n[f]);o.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,{xy:e||null,services:g,featureCount:p,defaultFeature:t,control:r.parent}))})}},function(e,t,a){o.$events.trigger(TC.Consts.event.NOFEATUREINFO),o.toast(r.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})}):o.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,{xy:e,services:n,featureCount:0,control:r.parent}))})},TC.wrap.control.PolygonFeatureInfo.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var a=t._trigger;t._trigger=function(e){t.hasElegibleLayers().then(function(r){r&&(t.parent._isSearching||e.type!=ol.MapBrowserEvent.EventType.SINGLECLICK||t.parent._isDrawing||t.parent._isSearching||a.call(t,e))})}})},TC.wrap.control.PolygonFeatureInfo.prototype.hasElegibleLayers=function(){var e=$.Deferred(),t=this.parent.map,r=!1;return $.when(t.wrap.getMap()).then(function(a){a.getLayers().forEach(function(e){var a=e._wrap.parent,o=e.getSource();return o.getGetFeatureInfoUrl&&$.inArray(a,t.workLayers)>=0?(r=!0,!1):void 0}),e.resolve(r)}),e},TC.wrap.control.PolygonFeatureInfo.prototype.beginDraw=function(e,t,r){var a=this,o=!1;a.drawCtrl?(a.drawCtrl.setActive(!0),a.drawCtrl.startDrawing_({coordinate:e})):$.when(t.wrap.getLayer()).then(function(t){a.drawCtrl=new ol.interaction.Draw({source:t.getSource(),type:ol.geom.GeometryType.POLYGON,style:t.getStyle()}),t.getSource().on("addfeature",function(e){e.feature._wrap.parent.showsPopup=!1}),a.drawCtrl.handleEvent=function(e){return e.type==ol.MapBrowserEvent.EventType.SINGLECLICK&&(o&&2==this.sketchCoords_[0].length&&null!==this.sketchFeature_?this.addToDrawing_(e):o=!0),ol.interaction.Draw.handleEvent.call(this,e)},a.parent.map.wrap.getMap().addInteraction(a.drawCtrl),a.drawCtrl.on("drawstart",function(e){a.parent._isDrawing=!0;var t=a.parent.map;$.when(t.wrap.getMap()).then(function(e){e.getInteractions().forEach(function(e,t){e instanceof ol.interaction.DoubleClickZoom&&e.setActive(!1)})})}),a.drawCtrl.startDrawing_({coordinate:e}),a.drawCtrl.on("drawend",function(e){a.parent._isDrawing=!1;var o=a.parent.map;$.when(o.wrap.getMap()).then(function(e){e.getInteractions().forEach(function(e,t){e instanceof ol.interaction.DoubleClickZoom&&e.setActive(!1)})}),r&&r(e.feature.getGeometry().getCoordinates()[0]),this.setActive(!1),a.parent.map.wrap.getMap().removeInteraction(a.drawCtrl),a.drawCtrl=null,t.getSource().clear(),a.parent._drawToken=!0,setTimeout(function(){a.parent._drawToken=!1},500)})})},TC.wrap.control.PolygonFeatureInfo.prototype.cancelDraw=function(e,t,r){var a=this;a.drawCtrl&&a.parent._isDrawing&&(a.parent._isDrawing=!1,a.drawCtrl.setActive(!1),a.drawCtrl.source_.clear())},TC.wrap.control.PolygonFeatureInfo.prototype.getFeaturesByPolygon=function(e,t){this.writeGMLPolygon||(this.writeGMLPolygon=function(e,t){switch(t){case"3.1.1":break;case"3.2":for(var r=e.toString();r.indexOf(",")>=0;)r=r.replace(","," ");return'<gml:Polygon srsDimension="2"><gml:exterior><gml:LinearRing><gml:posList>'+r+"</gml:posList></gml:LinearRing></gml:exterior></gml:Polygon>";case"2.0":default:var r=jQuery.each(e,function(e,t){return t.join(",")}).join(" ");return"<gml:Polygon><gml:outerBoundaryIs><gml:LinearRing><gml:coordinates>"+r+"</gml:coordinates></gml:LinearRing></gml:outerBoundaryIs></gml:Polygon>"}});var r=this,a=r.parent.map,o=[],n={};$.when(a.wrap.getMap()).then(function(i){if(!t){for(var s=null,l=0;l<e.length;l++)(!s||s[1]<e[l][1])&&(s=e[l]);t=i.getPixelFromCoordinate(new ol.geom.Point(s).getCoordinates())}a.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:t,control:r.parent}));var p={};i.getLayers().forEach(function(i){if(i.getVisible()){var s=i._wrap.parent;if($.inArray(s,a.workLayers)<0||s.type!==TC.Consts.layerType.WMS)return;var l=s.options.url.substring(0,s.options.url.lastIndexOf("/wms")||s.options.url.lastIndexOf("/WMS")||s.options.url.lastIndexOf("/"))+"/wfs",c=s.getDisgregatedLayerNames()||s.availableNames;n[s.title]||(n[s.title]={layers:[],mapLayer:s,layerNames:[]});for(var u=0;u<c.length;u++){var g=c[u];if(s.isVisibleByScale(g)&&s.wrap.getInfo(g).queryable){n[s.title].layerNames.push(g);var f=s.getPath(g);n[s.title].layers.push({name:g,title:f[f.length-1],path:f.slice(1),features:[]})}}if(0==n[s.title].layerNames.length)return;if("undefined"!=typeof n[s.title].request)return;n[s.title].request=s.getWFSCapabilitiesPromise(),n[s.title].defer=$.Deferred(),o.push(n[s.title].defer),$.when(n[s.title].request).then(function(o){var i=null,s=null;for(var c in n)if(n[c].request&&n[c].request.promise()==this){s=n[c];break}var u=s.layerNames,g=s.defer;if(u instanceof Array&&u.length){if("undefined"==typeof o.Operations.GetFeature)return TC.error("El servicio "+s.mapLayer.title+" no tiene habilitado el GetFeature de WFS"),void g.resolve(null);for(var f=[],m=0;m<u.length;m++){for(var y=u[m].substring(u[m].indexOf(":")+1);"_"===y[y.length-1];)y=y.substring(0,y.lastIndexOf("_"));o.FeatureTypes.hasOwnProperty(y)?f.indexOf(y)<0&&f.push(y):TC.error("El servicio "+s.mapLayer.title+" no dispone de la capa "+y)}if(0==f.length)return TC.error("No hay ninguna capa válida para el servicio "+s.mapLayer.title+" por lo que no se consultará dicho servicio"),void g.resolve(null);o.Operations.GetFeature.CountDefault&&(i=o.Operations.GetFeature.CountDefault.DefaultValue),r.queryBuilder||(r.queryBuilder=function(e,t,r,a,o){var n='<wfs:GetFeature service="WFS" ';switch(t.version){case"1.0.0":if(n+='xmlns:wfs="http://www.opengis.net/wfs" xmlns:gml="http://www.opengis.net/gml" ',!t.Operations.GetFeature.Operations.hasOwnProperty("Query"))return TC.error("El servicio "+s.mapLayer.title+" no tiene habilitado el Query de WFS"),null;break;case"1.1.0":break;case"2.0.0":if(n+='xmlns="http://www.opengis.net/wfs/2.0" xmlns:wfs="http://www.opengis.net/wfs/2.0" xmlns:gml="http://www.opengis.net/gml/3.2" ',t.Operations.QueryExpressions.AllowedValues.Value.indexOf("wfs:Query")<0)return TC.error("El servicio "+s.mapLayer.title+" no tiene habilitado el Query de WFS"),null}for(var i in t)"string"==typeof t[i]&&i.indexOf("gml")<0&&t[i].indexOf("wfs")<0&&(n+=i+'="'+t[i]+'" ');t.Operations.GetFeature.outputFormat.indexOf("json")>=0&&(n+=' outputFormat="JSON" '),o&&(n+=' resultType="hits" '),n+=">";for(var i=0;i<a.length;i++)if("1.0.0"===t.version&&(n+='<wfs:Query typeName="'+a[i]+'"><ogc:Filter><ogc:Intersects><ogc:PropertyName></ogc:PropertyName>'+this.writeGMLPolygon(r,"2.0")+"</ogc:Intersects></ogc:Filter></wfs:Query>"),"2.0.0"===t.version){for(var l=r.toString();l.indexOf(",")>=0;)l=l.replace(","," ");n+='<wfs:Query typeNames="'+a[i]+'"><fes:Filter><fes:Intersects><fes:ValueReference></fes:ValueReference>'+this.writeGMLPolygon(r,"3.2")+"</fes:Intersects></fes:Filter></wfs:Query>"}n+="</wfs:GetFeature>";var p=$.Deferred();return jQuery.ajax({url:e,data:n,cache:!1,contentType:"application/xml",type:"POST"}).then(function(){"success"==arguments[1]?p.resolve(arguments):p.reject(arguments)}),p});var d=null;i&&r.queryBuilder(l,o,e,f,!0).done(function(e){var t=parseInt(xml2json(e[0]).numberMatched,10);t>parseInt(i,10)&&d.reject({err:"NumMaxFeatures",limit:i,message:"Se ha superado el máximo de {0} elementos de este servicio",service:s})}),d=r.queryBuilder(l,o,e,f,!1),d.done(function(e){var o=e[0],n=e[1],i=e[2],l=!1,c=[];if("success"===n){l=!0;var u,f=i.getResponseHeader("Content-type");switch(f&&f.indexOf(";")>-1&&(f=f.substr(0,f.indexOf(";")).trim()),f||(f=o.requestedFormat),f){case"application/json":u=new ol.format.GeoJSON;break;case"application/vnd.ogc.gml":u=o.responseText.indexOf("FeatureCollection")>-1?new ol.format.WFS({gmlFormat:new ol.format.GML2}):new ol.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":u=new ol.format.GML3;break;case"text/xml":var m=xml2json(o);m.ServiceException&&TC.error(m.ServiceException),u=null;break;default:u=null}if(u)for(var y=u.readFeatures(i.responseText,{featureProjection:ol.proj.get(a.crs)}),d=function(e,t,r){var a=!1;if(t===r||0===t.indexOf(r))a=!0;else{var o=e.getPath(t),n=e.getPath(r);if(o.length>0&&n.length>=o.length){a=!0;for(var i=0;i<o.length;i++)if(o[i]!==n[i]){a=!1;break}}}return a},v={},h=0;h<y.length;h++){var C=y[h];if(C instanceof ol.Feature){for(var T=C.getId()||TC.getUID(),w=!1,S=T.substr(0,T.lastIndexOf(".")),E=0;E<s.layers.length;E++){var L=s.layers[E],M=L.name.substr(L.name.indexOf(":")+1);

if(d(s.mapLayer,M,S)){w=!0,c.push(TC.wrap.Feature.createFeature(C)),p[C.id_]=L.features;break}}if(!w){var R;v[S]?R=v[S]:(R={name:S,title:S,features:[]},v[S]=R,s.layers.push(R)),c.push(TC.wrap.Feature.createFeature(C)),p[C.id_]=R.features}}}else{var L=s.layers[0];L.features.push({error:i.responseText})}}else a.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:t||null,control:r.parent,layer:s.mapLayer}));l&&$.when.apply(this,c).then(function(){if(arguments.length)for(var e=0;e<arguments.length;e++){var t=arguments[e];t.attributes=[];for(var r in t.data){var a=t.data[r];"object"!=typeof a&&t.attributes.push({name:r,value:a})}p[t.id].push(t)}g.resolve({service:s})})}).fail(function(e){e.err&&"NumMaxFeatures"===e.err?g.resolve({service:e.service,Error:e.message.format(e.limit)}):g.reject(e)})}},function(e){TC.error(e.Message?e.Message:e.responseText)})}}),$.when.apply($,o).then(function(){for(var e=[],o=0,o=0,n=0;n<arguments.length;n++)if(arguments[n]){arguments[n].Error&&(arguments[n].service.hasLimits=arguments[n].Error),e.push(arguments[n].service);for(var i=0;i<arguments[n].service.layers.length;i++)o+=arguments[n].service.layers[i].features.length}a.$events.trigger(o?$.Event(TC.Consts.event.FEATUREINFO,{xy:t||null,services:e,featureCount:o,control:r.parent}):$.Event(TC.Consts.event.NOFEATUREINFO,{xy:t,control:r.parent}))},function(e){console.log(e)})})},TC.wrap.control.Popup.prototype=function(){this.popup=null},TC.Consts.event.PANANIMATIONSTART="pananimationstart.tc",TC.Consts.event.PANANIMATIONEND="pananimationend.tc",TC.wrap.control.Popup.prototype.fitToView=function(){var e=this,t=e.parent.map,r=e.parent.map.wrap.map,a=e.parent.$popupDiv[0].getBoundingClientRect(),o=t._$div[0].getBoundingClientRect(),n=r.getCoordinateFromPixel([a.left-o.left,a.top-o.top]),i=r.getCoordinateFromPixel([a.right-o.left,a.bottom-o.top]),s=n[0],l=n[1],p=i[0],c=i[1],u=[s,c,p,l],g=t.getExtent();if(!ol.extent.containsExtent(g,u)){var f={left:Math.max(g[0]-u[0],0),bottom:Math.max(g[1]-u[1],0),right:Math.max(u[2]-g[2],0),top:Math.max(u[3]-g[3],0)};if(e.parent.dragged){var m=e.popup.getPosition();f.right?m[0]=m[0]-f.right:f.left&&(m[0]=m[0]+f.left),f.top?m[1]=m[1]-f.top:f.bottom&&(m[1]=m[1]+f.bottom);var y=r.getPixelFromCoordinate(m);y[1]=r.getSize()[1]-y[1],e.parent._previousContainerPosition=y,e.popup._oldUpdatePixelPosition(m)}else if(e.parent.isVisible()){var d=r.getView(),v=d.getCenter().slice();f.top?v[1]+=f.top:f.bottom&&(v[1]-=f.bottom),f.right?v[0]+=f.right:f.left&&(v[0]-=f.left);var h,C=ol.animation.pan({duration:500,source:d.getCenter()});r.beforeRender(function(t,r){var a=C(t,r);return a?(h||e.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONSTART)),h=!0):(e.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONEND)),h=!1),a}),d.setCenter(v)}}},TC.wrap.control.Popup.prototype.setDragged=function(e){var t=this.popup;e?(t._oldUpdatePixelPosition||(t._oldUpdatePixelPosition=t.updatePixelPosition,t.updatePixelPosition=function(){}),t._newHandleOffsetChanged||(t._newHandleOffsetChanged=function(){this._oldUpdatePixelPosition()},ol.events.unlisten(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t.handleOffsetChanged,t),ol.events.listen(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t._newHandleOffsetChanged,t))):(delete this.parent._previousContainerPosition,t._oldUpdatePixelPosition&&(t.updatePixelPosition=t._oldUpdatePixelPosition,delete t._oldUpdatePixelPosition),t._newHandleOffsetChanged&&(ol.events.unlisten(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t._newHandleOffsetChanged,t),ol.events.listen(t,ol.Object.getChangeEventType(ol.Overlay.Property.OFFSET),t.handleOffsetChanged,t),delete t._newHandleOffsetChanged))},TC.wrap.Feature.prototype.getLegend=function(){var e=this,t={},r=e.feature.getStyle();if("function"==typeof r&&(r=r.call(e.feature)),r){var a=r[0].getImage();if(a)a instanceof ol.style.Icon?t.src=a.getSrc():a instanceof ol.style.Circle&&(t.src=a.canvas_.toDataURL()),e.parent.options.radius?t.height=t.width=2*e.parent.options.radius:(t.width=e.parent.options.width,t.height=e.parent.options.height);else{var o=r[0].getStroke(),n=r[0].getFill();if(o){var i=o.getColor();i&&(t.strokeColor=ol.color.asString(i));var s=o.getWidth();s&&(t.strokeWidth=s)}if(n){var l=n.getColor();l&&(t.fillColor=ol.color.asString(l))}}}return t};var F=function(e,t,r){var a,o={},n=r||"geometry";return o[n]=new t(e),a=new ol.Feature(o),r&&a.setGeometryName(r),a};TC.wrap.Feature.prototype.createPoint=function(e,t){var r=this;$.isArray(e)?r.feature=F(e,ol.geom.Point,t.geometryName):r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates()),r.feature._wrap=r,r.feature.setStyle(h({styles:{point:t}},r.feature))},TC.wrap.Feature.prototype.createMarker=function(e,t){var r=this,a=TC.Util.getPointIconUrl(t);a?(t.url=a,$.isArray(e)?r.feature=F(e,ol.geom.Point,t.geometryName):r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates()),r.feature._wrap=r,r.feature.setStyle(h({styles:{marker:t}},r.feature))):r.createPoint(e,t)},TC.wrap.Feature.prototype.createPolyline=function(e,t){var r=this;$.isArray(e)?r.feature=F(e,ol.geom.LineString,t.geometryName):r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates()),r.feature._wrap=r,t&&r.feature.setStyle(h({styles:{line:t}},r.feature))},TC.wrap.Feature.prototype.createPolygon=function(e,t){var r=this;if($.isArray(e)){if(e.length){var a=e[0];if($.isArray(a)&&a.length){var o=a[0];$.isArray(o)||(e=[e]);for(var n=0;n<e.length;n++){a=e[n];var i=a[0],s=a[a.length-1];(i[0]!==s[0]||i[1]!==s[1])&&(a[a.length]=i)}r.parent.geometry=e,r.feature=F(e,ol.geom.Polygon,t.geometryName)}}}else r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates());r.feature._wrap=r;var l=t||{};(l.strokeColor||l.strokeWidth||l.fillColor||l.fillOpacity)&&r.feature.setStyle(h({styles:{polygon:l}},r.feature))},TC.wrap.Feature.prototype.createMultiPolyline=function(e,t){var r=this;if($.isArray(e)){if(e.length){var a=e[0];if($.isArray(a)&&a.length){var o=a[0];$.isArray(o)||(e=[e]),r.parent.geometry=e,r.feature=F(e,ol.geom.MultiLineString,t.geometryName)}}}else r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates());r.feature._wrap=r,t&&r.feature.setStyle(h({styles:{line:t}},r.feature))},TC.wrap.Feature.prototype.createMultiPolygon=function(e,t){var r=this;if($.isArray(e)){if(e.length){var a=e[0];if($.isArray(a)&&a.length){var o=a[0];if($.isArray(o)&&o.length){var n=o[0];$.isArray(n)||(e=[e])}else e=[[e]];for(var i=0,s=e.length;s>i;i++){a=e[i];for(var l=0,p=a.length;p>l;l++){o=a[l];var c=o[0],u=o[o.length-1];(c[0]!==u[0]||c[1]!==u[1])&&(o[o.length]=c)}}r.parent.geometry=e,r.feature=F(e,ol.geom.MultiPolygon,t.geometryName)}}}else r.isNative(e)&&(r.feature=e,r.parent.geometry=e.getGeometry().getCoordinates());r.feature._wrap=r;var g=t||{};(g.strokeColor||g.strokeWidth||g.fillColor||g.fillOpacity)&&r.feature.setStyle(h({styles:{polygon:g}},r.feature))},TC.wrap.Feature.prototype.createCircle=function(e,t){var r=this;if($.isArray(e)&&$.isArray(e[0])&&"number"==typeof e[0][0]&&"number"==typeof e[0][1]&&"number"==typeof e[1]){var a={},o=t.geometryName||"geometry";a[o]=new ol.geom.Circle(e[0],e[1]),r.feature=new ol.Feature(a),t.geometryName&&r.feature.setGeometryName(t.geometryName)}else if(r.isNative(e)){r.feature=e;var n=e.getGeometry();r.parent.geometry=[n.getCenter(),n.getRadius()]}r.feature._wrap=r,t&&r.feature.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:t.strokeColor,width:t.strokeWidth,lineDash:t.lineDash}),fill:new ol.style.Fill({color:l(t.fillColor,t.fillOpacity)})}))},TC.wrap.Feature.createFeature=function(e){var t,r=new $.Deferred,a=e.getGeometry(),o={id:e.getId()};switch(!0){case a instanceof ol.geom.Point:t="Point";break;case a instanceof ol.geom.LineString:t="Polyline";break;case a instanceof ol.geom.Polygon:t="Polygon";break;case a instanceof ol.geom.MultiLineString:t="MultiPolyline";break;case a instanceof ol.geom.MultiPolygon:t="MultiPolygon"}return t?TC.loadJS(!TC.feature||TC.feature&&!TC.feature[t],[TC.apiLocation+"TC/feature/"+t+".js"],function(){var a=new TC.feature[t](e,o);a.data=a.wrap.getData(),r.resolve(a)}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature.js"],function(){var t=new TC.Feature(e,o);t.data=t.wrap.getData(),r.resolve(t)}),r},TC.wrap.Feature.prototype.getGeometry=function(){var e,t=this;if(t.feature&&t.feature.getGeometry){var r=t.feature.getGeometry();r&&(r.getCoordinates?e=r.getCoordinates():r instanceof ol.geom.Circle&&(e=[r.getCenter(),r.getRadius()]))}return e},TC.wrap.Feature.prototype.setGeometry=function(e){var t=!1,r=this;if(r.feature&&r.feature.getGeometry){var a,o,n,i,s,l,p,c=r.feature.getGeometry();switch(!0){case c instanceof ol.geom.MultiPolygon:s=!0,i=e,$.isArray(i)&&(n=e[0]);case c instanceof ol.geom.Polygon||c instanceof ol.geom.MultiLineString:l=!0,n=s?n:e,$.isArray(n)&&(o=n[0]);case c instanceof ol.geom.LineString:p=!0,o=l?o:e,$.isArray(o)&&(a=o[0]);case c instanceof ol.geom.Point:a=p?a:e,$.isArray(a)&&"number"==typeof a[0]&&"number"==typeof a[1]&&(c.setCoordinates(e),t=!0);break;case c instanceof ol.geom.Circle:$.isArray(e)&&$.isArray(e[0])&&"number"==typeof e[0][0]&&"number"==typeof e[0][1]&&"number"==typeof e[1]&&(c.setCenterAndRadius(e[0],e[1]),t=!0)}}return t},TC.wrap.Feature.prototype.getId=function(){var e,t=this;return t.feature&&(e=t.feature.getId()),e},TC.wrap.Feature.prototype.setId=function(e){var t=this;t.feature&&t.feature.setId(e)},TC.wrap.Feature.prototype.setStyle=function(e){var t=this,r=t.feature,a=t.parent,o=r.getGeometry();if(o instanceof ol.geom.Point){var n;if(e.anchor){var i={anchor:v(e.anchor,a),src:TC.Util.getPointIconUrl(e),size:[v(e.width,a),v(e.height,a)]};e.angle&&(i.angle=e.angle),n=new ol.style.Icon(i)}else{var s={radius:v(e.radius,a)||(v(e.height,a)+v(e.width,a))/4};e.fillColor&&(s.fill=new ol.style.Fill({color:l(v(e.fillColor,a),v(e.fillOpacity,a))})),e.strokeColor&&(s.stroke=new ol.style.Stroke({color:v(e.strokeColor,a),width:v(e.strokeWidth,a),lineDash:e.lineDash})),isNaN(s.radius)||(n=new ol.style.Circle(s))}r.setStyle(new ol.style.Style({image:n}))}else o instanceof ol.geom.LineString||o instanceof ol.geom.MultiLineString?r.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:v(e.strokeColor,a),width:v(e.strokeWidth,a),lineDash:e.lineDash})})):(o instanceof ol.geom.Polygon||o instanceof ol.geom.MultiPolygon)&&r.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:v(e.strokeColor,a),width:v(e.strokeWidth,a),lineDash:e.lineDash}),fill:new ol.style.Fill({color:l(v(e.fillColor,a),v(e.fillOpacity,a))})}))},TC.wrap.Feature.prototype.getInnerPoint=function(e){var t,r=e||{},a=this.feature,o=a.getGeometry(),n=function(e){var t=r.clipBox;e[0]=Math.min(Math.max(e[0],t[0]),t[2]),e[1]=Math.min(Math.max(e[1],t[1]),t[3])},i=function g(e){if(r.clipBox&&$.isArray(e))if($.isArray(e[0]))for(var t=0,a=e.length;a>t;t++)g(e[t]);else n(e)};switch(t=o.getFirstCoordinate(),o.getType()){case ol.geom.GeometryType.MULTI_POLYGON:o=o.getPolygon(0);case ol.geom.GeometryType.POLYGON:var s=function(e,t){for(var r=!1,a=0,o=t.length-1;a<t.length;o=a++){var n=t[a][0],i=t[a][1],s=t[o][0],l=t[o][1],p=i>e[1]!=l>e[1]&&e[0]<(s-n)*(e[1]-i)/(l-i)+n;p&&(r=!r)}return r},l=o.getCoordinates();i(l),o=new ol.geom.Polygon(l),t=o.getInteriorPoint().getCoordinates();for(var p=o.getLinearRings(),c=1;c<p.length;c++)if(s(t,p[c].getCoordinates())){t=o.getClosestPoint(t);break}break;case ol.geom.GeometryType.MULTI_LINE_STRING:o=o.getLineString(0);case ol.geom.GeometryType.LINE_STRING:var u=[0,0],l=o.getCoordinates();i(l),o=new ol.geom.LineString(l);for(var c=0;c<l.length;c++)u[0]+=l[c][0],u[1]+=l[c][1];u[0]/=l.length,u[1]/=l.length,t=o.getClosestPoint(u)}return t},TC.wrap.Feature.prototype.showPopup=function(e){var t=this,r=e.map;if(r){var a=t.feature;if(a){r.currentFeature=t.parent;var o=r.getExtent();if(t._innerCentroid=t.getInnerPoint({clipBox:o}),e.$contentDiv.html(t.parent.getInfo()),e.options.closeButton){var n=e.$popupDiv.find("."+e.CLASS+"-close").length;if(0==n){var i=$("<div>").addClass(e.CLASS+"-close").attr("title",e.getLocaleString("close")).appendTo(e.$popupDiv);i.on(TC.Consts.event.CLICK,function(){e.hide()}),e.$contentDiv.addClass(e.CLASS+"-has-btn"),e.$contentDiv.find(".tc-ctl-finfo").css("width","auto").css("height","auto")}}var s,l=t.parent.options;if(l.anchor)s=l.anchor;else{for(var p,c=a._wrap.parent,u=0;u<r.workLayers.length;u++){var g=r.workLayers[u];if(!g.isRaster()&&$.inArray(c,g.features)>=0){p=g.wrap.styleFunction(a);break}}if($.isArray(p)){var f=p[0].getImage();s=!f||f instanceof ol.style.Icon?[.5,0]:[.5,.5]}}e.wrap.popup.setOffset(s&&l.height?[0,-l.height*s[1]]:[0,0]),e.wrap.popup.setPosition(t._innerCentroid),e.$popupDiv.addClass(TC.Consts.classes.VISIBLE)}else r.wrap.hidePopup(e)}},TC.wrap.Feature.prototype.isNative=function(e){return e instanceof ol.Feature},TC.wrap.Feature.prototype.getPath=function(){var e=[],t=this;return t.feature&&t.feature._folders&&(e=t.feature._folders),e},TC.wrap.Feature.prototype.getBounds=function(){var e=null,t=this;return t.feature&&(e=t.feature.getGeometry().getExtent()),e},TC.wrap.Feature.prototype.getTemplate=function(){var e=null,t=this,r=t.feature.getStyle();if("function"==typeof r&&(r=r.call(t.feature)),$.isArray(r))for(var a=0;a<r.length;a++)if(r[a]._balloon){var o=r[a]._balloon.getText();if(o){r=r[a]._balloon;break}}return r&&!$.isArray(r)&&r.getText&&(e=r.getText()),e},TC.wrap.Feature.prototype.getData=function(){var e=this,t=e.feature.getProperties();$.isArray(t.features)&&(t=1===t.features.length?t.features[0].getProperties():t.features.length+" elementos");var r=e.feature.getGeometryName();return t[r]&&delete t[r],t},TC.wrap.Feature.prototype.setData=function(e){this.feature.setProperties(e)},TC.wrap.control.Draw.prototype.mouseMoveHandler=function(e){var t=e.data;t.sketch&&t.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,t.getMeasureData()))},TC.wrap.control.Draw.prototype.mouseOverHandler=function(e){var t=e.data;t.sketch&&t.hoverCoordinate&&(t.pushCoordinate(t.hoverCoordinate),t.hoverCoordinate=null)},TC.wrap.control.Draw.prototype.clickHandler=function(e){var t=e.data;if(t.sketch){var r=t.sketch.getGeometry().getCoordinates();t.parent.$events.trigger($.Event(TC.Consts.event.POINT,{point:r[r.length-1]}))}},TC.wrap.control.Draw.prototype.getGeometry=function(){var e={};if(this.sketch){var t=this.sketch.getGeometry();t instanceof ol.geom.Polygon?e.geometry=new TC.feature.Polygon(t.getCoordinates()):t instanceof ol.geom.LineString?e.geometry=new TC.feature.Polyline(t.getCoordinates()):t instanceof ol.geom.Point&&(e.geometry=new TC.feature.Point(t.getCoordinates()))}return e},TC.wrap.control.Draw.prototype.getMeasureData=function(){var e=this,t=function(t,r){r.length=t.getLength(),r.units=e.units,r.length>100&&e.units===ol.proj.Units.METERS&&(r.length=r.length/1e3,r.units="km")},r=function(t,r){r.area=t.getArea();var a=t.getLinearRing(0);r.perimeter=ol.geom.flat.length.linearRing(a.flatCoordinates,0,a.flatCoordinates.length,a.stride),r.units=e.units,r.area>1e4&&e.units===ol.proj.Units.METERS&&(r.area=r.area/1e6,r.perimeter=r.perimeter/1e3,r.units="km")},a={};if(this.sketch){var o=this.sketch.getGeometry();o instanceof ol.geom.Polygon?r(o,a):o instanceof ol.geom.LineString&&t(o,a)}return a},TC.wrap.control.Draw.prototype.activate=function(t){var a,o=this;switch(t){case TC.Consts.geom.POLYGON:a=ol.geom.GeometryType.POLYGON;break;case TC.Consts.geom.POINT:a=ol.geom.GeometryType.POINT;break;default:a=ol.geom.GeometryType.LINE_STRING}o.parent.map&&$.when(o.parent.map.wrap.getMap(),o.parent.getLayer()).then(function(n,i){o.units=n.getView().getProjection().getUnits(),$.when(i&&i.wrap.getLayer()).then(function(i){if(o.$viewport||(o.$viewport=$(n.getViewport())),o.interaction&&(n.removeInteraction(o.interaction),o.$viewport.off(TC.Consts.event.CLICK,o.clickHandler),o.parent.measure&&o.$viewport.off(e+".draw",o.mouseMoveHandler).off(r,o.mouseOverHandler)),o.snapInteraction&&n.removeInteraction(o.snapInteraction),t){o.$viewport.on(TC.Consts.event.CLICK,o,o.clickHandler),o.parent.measure&&o.$viewport.on(e+".draw",o,o.mouseMoveHandler).on(r,o,o.mouseOverHandler);var s={type:a,snapTolerance:0,condition:function(){return ol.events.condition.shiftKeyOnly(arguments[0])&&(hole=n.forEachFeatureAtPixel(n.getPixelFromCoordinate(arguments[0].coordinate),function(e){return ol.geom.GeometryType.POLYGON==e.getGeometry().getType()||ol.geom.GeometryType.MULTI_POLYGON==e.getGeometry().getType()?e:null})),!0}};if(i)s.source=i.getSource(),s.style=i.getStyle();else{var l=o.parent.map.options.styles.selection;s.style=h({styles:{point:$.extend({},l.point,{fillOpacity:0}),line:l.line,polygon:l.polygon}})}if(t===TC.Consts.geom.RECTANGLE&&(s.type=ol.geom.GeometryType.LINE_STRING,s.maxPoints=2,s.geometryFunction=function(e,t){t||(t=new ol.geom.Polygon(null));var r=e[0],a=e[1];return t.setCoordinates([[r,[r[0],a[1]],a,[a[0],r[1]],r]]),t}),o.interaction=new ol.interaction.Draw(s),o.interaction.on("drawstart",function(e){o.sketch=e.feature,o.parent.$events.trigger($.Event(TC.Consts.event.DRAWSTART))},this),o.interaction.on("drawend",function(e){o.parent.$events.trigger(o.parent.measure?$.Event(TC.Consts.event.MEASURE,o.getMeasureData()):$.Event(TC.Consts.event.DRAWEND,o.getGeometry())),o.sketch=null},this),n.addInteraction(o.interaction),o.parent.snapping){var p={};i?p.source=i.getSource():o.parent.snapping instanceof TC.Layer&&(p.source=o.parent.snapping.wrap.layer.getSource()),o.snapInteraction=new ol.interaction.Snap(p),n.addInteraction(o.snapInteraction)}}o.redoStack=[]})})},TC.wrap.control.Draw.prototype.deactivate=function(){var e=this;e.parent.map&&$.when(e.parent.map.wrap.getMap(),e.parent.getLayer()).then(function(t,r){e.$viewport&&e.$viewport.off(TC.Consts.event.CLICK,e.clickHandler),r&&r.clearFeatures(),e.interaction&&(t.removeInteraction(e.interaction),e.interaction=null)})},TC.wrap.control.Draw.prototype.popCoordinate=function(){var e=this,t=null;if(e.interaction){var r=e.interaction.sketchFeature_;if(r){var a,o=r.getGeometry();o instanceof ol.geom.Polygon?a=o.getCoordinates()[0]:o instanceof ol.geom.LineString&&(a=o.getCoordinates());if(a.length>1){var n;o instanceof ol.geom.Polygon?n=e.interaction.sketchCoords_[0]:o instanceof ol.geom.LineString&&(n=e.interaction.sketchCoords_);var i=!1;if(e.interaction.sketchPoint_)for(var s=e.interaction.sketchPoint_.getGeometry().getCoordinates(),l=0;l<a.length;l++)if(a[l][0]==s[0]&&a[l][1]==s[1]){i=!0;break}var p;p=i?n.length-2:n.length-1,t=n[p],n.splice(p,1),o instanceof ol.geom.Polygon?(o.setCoordinates([n]),e.interaction.sketchLine_.getGeometry().setCoordinates(n)):o.setCoordinates(n),r.setGeometry(o)}}}return t},TC.wrap.control.Draw.prototype.pushCoordinate=function(e){var t=this,r=!1;if(t.interaction){var a=t.interaction.sketchFeature_;if(a){var o,n=a.getGeometry();n instanceof ol.geom.Polygon?o=n.getCoordinates()[0]:n instanceof ol.geom.LineString&&(o=n.getCoordinates());var i;n instanceof ol.geom.Polygon?i=t.interaction.sketchCoords_[0]:n instanceof ol.geom.LineString&&(i=t.interaction.sketchCoords_);var s=!1;if(t.interaction.sketchPoint_)for(var l=t.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<o.length;p++)if(o[p][0]==l[0]&&o[p][1]==l[1]){s=!0;break}index=s?i.length-1:i.length,i.splice(index,0,e),n instanceof ol.geom.LineString?n.setCoordinates(i,ol.geom.GeometryLayout.XY):(n.setCoordinates([i],ol.geom.GeometryLayout.XY),t.interaction.sketchLine_.getGeometry().setCoordinates(i)),r=!0}}return r},TC.wrap.control.Draw.prototype.undo=function(){var e=this,t=!1,r=e.popCoordinate();return r&&(e.redoStack.push(r),t=!0),e.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,e.getMeasureData())),t},TC.wrap.control.Draw.prototype.redo=function(){var e=this,t=!1;return e.redoStack.length>0&&(e.pushCoordinate(e.redoStack.pop()),t=!0),e.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,e.getMeasureData())),t},TC.wrap.control.Draw.prototype.end=function(){var e=this;e.interaction&&e.interaction.sketchFeature_&&e.interaction.finishDrawing()},TC.wrap.control.CacheBuilder.prototype.getRequestSchemas=function(e){for(var t=e.extent,r=e.layers,a=new Array(r.length),o=0,n=a.length;n>o;o++){var i=r[o],s={layerId:i.id},l=i.wrap.layer.getSource();if(l.getUrls&&(s.url=l.getUrls()[0]),l.getTileGrid){for(var p=l.getTileGrid(),c=p.getResolutions(),u=p.getMatrixIds(),g=i.getLayerNodeByName(i.layerNames),f=null,m=0,y=g.TileMatrixSetLink.length;y>m;m++){var d=g.TileMatrixSetLink[m];if(d.TileMatrixSet===i.matrixSet){f=d.TileMatrixSetLimits;break}}s.tileMatrixLimits=[];for(var m=0,v=c.length;v>m;m++){var h=p.getOrigin(m),C=p.getTileSize(m),T=c[m],w=C*T,S={mId:u[m],res:T,origin:h,tSize:C,cl:Math.floor((t[0]-h[0])/w),cr:Math.floor((t[2]-h[0])/w),rt:Math.floor((h[1]-t[3])/w),rb:Math.floor((h[1]-t[1])/w)};if(f){var E=f[m];E&&(S.cl=Math.max(S.cl,E.MinTileCol),S.cr=Math.min(S.cr,E.MaxTileCol),S.rt=Math.max(S.rt,E.MinTileRow),S.rb=Math.min(S.rb,E.MaxTileRow))}S.cl<=S.cr&&S.rt<=S.rb&&s.tileMatrixLimits.push(S)}}a[o]=s}return a},TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){var t="",r=e.wrap.layer.getSource();return r.getUrls&&(t=r.getUrls()[0]),e.options.encoding!==TC.Consts.WMTSEncoding.RESTFUL&&(t.indexOf("?")<0&&(t+="?"),t.indexOf("?")===t.length-1&&(t=t+"layer="+e.layerNames+"&style=default&tilematrixset="+encodeURIComponent(e.matrixSet)+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+encodeURIComponent(e.format)+"&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}")),t},TC.wrap.control.Edit.prototype.activate=function(e){var t=this;t.cancel(!0),e===TC.Consts.editMode.SELECT&&t.parent.map&&$.when(t.parent.map.wrap.getMap(),t.parent.layer.wrap.getLayer()).then(function(e,r){var a=t.parent.map.options.styles.selection;t.selectInteraction&&e.removeInteraction(t.selectInteraction);var o=new ol.interaction.Select({layers:[r],style:h({styles:{point:$.extend({},a.point,{fillOpacity:0}),line:a.line,polygon:a.polygon}})});t.selectInteraction=o,e.addInteraction(o);var n=function(e){return e._wrap.parent};o.on("select",function(e){e.selected.length>0&&t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESSELECT,{ctrl:t,features:e.selected.map(n)})),e.deselected.length>0&&0==e.selected.length&&t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:t.parent,features:e.deselected.map(n)}))}),t.modifyInteraction&&e.removeInteraction(t.modifyInteraction);var i=new ol.interaction.Modify({features:o.getFeatures(),style:h({styles:{point:$.extend({},a.point,{fillOpacity:0}),line:a.line,polygon:a.polygon}})});i.on(ol.interaction.Modify.EventType.MODIFYEND,function(e){e.features.forEach(function(e){e._wrap.parent.geometry=e._wrap.getGeometry(),t.parent.$events.trigger($.Event(TC.Consts.event.FEATUREMODIFY,{feature:e._wrap.parent,layer:t.parent.layer}))})}),t.modifyInteraction=i,e.addInteraction(i),t.snapInteraction&&e.removeInteraction(t.snapInteraction),t.parent.snapping&&(t.snapInteraction=new ol.interaction.Snap({source:r.getSource()}),e.addInteraction(t.snapInteraction))})},TC.wrap.control.Edit.prototype.deactivate=function(){var e=this;e.modifyInteraction&&(e.modifyInteraction.setActive(!1),e.selectInteraction.setActive(!1),$.when(e.parent.map.wrap.getMap()).then(function(t){t.removeInteraction(e.modifyInteraction),e.modifyInteraction=null,e.selectInteraction=null})),e.drawInteraction&&(e.drawInteraction.abortDrawing_(),e.drawInteraction.setActive(!1),$.when(e.parent.map.wrap.getMap()).then(function(t){t.removeInteraction(e.drawInteraction),e.drawInteraction=null})),e.parent.$events.trigger($.Event(TC.Consts.event.CONTROLDEACTIVATE,{ctrl:e}))},TC.wrap.control.Edit.prototype.cancel=function(e,t){var r=this;r.points=[],r.histPoints=[];r.control&&r.control.layer||r.modifyInteraction&&r.modifyInteraction.layer;if(r.selectInteraction){var a=r.selectInteraction.getFeatures();r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:r.parent,feature:a.get(0)})),a.clear(),r.selectInteraction.setActive(!1)}},TC.wrap.control.Edit.prototype.getSelectedFeatures=function(){var e=this,t=[];return e.selectInteraction&&e.selectInteraction.getFeatures().forEach(function(e){t[t.length]=e._wrap.parent}),t},TC.wrap.control.Edit.prototype.setSelectedFeatures=function(e){var t=this;if(t.selectInteraction){var r=t.selectInteraction.featureOverlay_.getSource();r.clear(),r.addFeatures(e.map(function(e){return e.wrap.feature}))}},TC.wrap.control.Edit.prototype.deleteFeatures=function(e){var t=this;if($.isArray(e)){var r=e.map(function(e){return e.wrap.feature});$.when(t.parent.layer.wrap.getLayer()).then(function(e){for(var a=t.selectInteraction?t.selectInteraction.getFeatures():null,o=0,n=r.length;n>o;o++){var i=r[o];a&&(a.remove(i),t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{feature:i._wrap.parent}))),e.getSource().removeFeature(i),t.parent.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:i._wrap.parent}))}})}}}();