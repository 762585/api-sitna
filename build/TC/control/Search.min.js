!function(){if(window.performance){if(window.performance&&!window.performance.now){window.performance.offset=Date.now();window.performance.now=function(){return Date.now()-window.performance.offset}}}else window.performance={offset:Date.now(),now:function(){return Date.now()-this.offset}}}();TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Search=function(){var e=this;TC.Control.apply(e,arguments);TC.Consts.event.TOOLSCLOSE=TC.Consts.event.TOOLSCLOSE||"toolsclose.tc";e.url="//idena.navarra.es/ogc/wfs";e.version="1.1.0";e.featurePrefix="IDENA";e.options&&e.options.url&&(e.url=e.options.url);e._LIKE_PATTERN="*";e._MATCH_PATTERN=".*";e.UTMX="X";e.UTMY="Y";e.LON="Lon";e.LAT="Lat";e.UTMX_LABEL="X: ";e.UTMY_LABEL="Y: ";e.LON_LABEL="Lon: ";e.LAT_LABEL="Lat: ";e.MUN="M";e.POL="P";e.PAR="Par";e.MUN_LABEL="Mun: ";e.POL_LABEL="Pol: ";e.PAR_LABEL="Par: ";e.availableSearchTypes={};e.availableSearchTypes[TC.Consts.searchType.CADASTRAL]={suggestionRoot:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["CATAST_Pol_ParcelaRusti","CATAST_Pol_ParcelaUrba","CATAST_Pol_ParcelaMixta"],municipality:{featureType:"CATAST_Pol_Municipio",outputProperties:["CMUNICIPIO","MUNICIPIO"]},queryProperties:{municipality:"CMUNICIPIO",polygon:"POLIGONO",parcel:"PARCELA"},suggestionListHead:function(){return{label:e.getLocaleString("search.list.cadastral"),color:{"#e5475f":e.getLocaleString("search.list.cadastral.mixed"),"#0c8b3d":e.getLocaleString("search.list.cadastral.rustic"),"#136278":e.getLocaleString("search.list.cadastral.urban")}}},styles:{CATAST_Pol_ParcelaUrba:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#136278",strokeWidth:2,strokeOpacity:1}},CATAST_Pol_ParcelaRusti:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#0c8b3d",strokeWidth:2,strokeOpacity:1}},CATAST_Pol_ParcelaMixta:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#e5475f",strokeWidth:2,strokeOpacity:1}}},parser:e.getCadastralRef,goTo:e.goToCadastralRef,goToIdFormat:"M{0}P{1}Par{2}",idPropertiesIdentifier:"#"};e.availableSearchTypes[TC.Consts.searchType.COORDINATES]={parser:e.getCoordinates,goTo:e.goToCoordinates,label:null,suggestionListHead:function(t){return{label:e.availableSearchTypes[TC.Consts.searchType.COORDINATES].label||e.getLocaleString("search.list.coordinates")}}};e.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Municipio",dataIdProperty:["CMUNICIPIO"],queryProperties:{tProperty:["MUNINOAC","MUNICIPIO"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.municipality"),color:{"#fe06a5":e.getLocaleString("search.list.municipality")}}},outputProperties:["MUNICIPIO"],outputFormatLabel:"{0}",searchWeight:2,styles:{CATAST_Pol_Municipio:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fe06a5",strokeWidth:2,strokeOpacity:1}}},parser:e.getStringPattern.bind(this,[TC.Consts.searchType.MUNICIPALITY]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.LOCALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["CATAST_Pol_Municipio","ESTADI_Pol_EntidadPob"],renderFeatureType:["CATAST_Pol_Municipio"],dataIdProperty:{CATAST_Pol_Municipio:["CMUNICIPIO"],ESTADI_Pol_EntidadPob:["CMUNICIPIO","CENTIDAD"]},queryProperties:{tProperty:{CATAST_Pol_Municipio:["MUNINOAC","MUNICIPIO"],ESTADI_Pol_EntidadPob:["ENTINOAC","ENTIDAD"]}},suggestionListHead:function(){return{label:e.getLocaleString("search.list.locality"),color:{"#feba1e":e.getLocaleString("search.list.locality")}}},outputProperties:{CATAST_Pol_Municipio:["MUNICIPIO"],ESTADI_Pol_EntidadPob:["MUNICIPIO","ENTIDAD"]},outputFormatLabel:{CATAST_Pol_Municipio:"{0}",ESTADI_Pol_EntidadPob:"{1} ({0})"},searchWeight:2,styles:{CATAST_Pol_Municipio:{polygon:{fillColor:"#000000",fillOpacity:0,strokeColor:"#ffffff",strokeWidth:5,strokeOpacity:1}},ESTADI_Pol_EntidadPob:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#feba1e",strokeWidth:2,strokeOpacity:1}}},parser:e.getStringPattern.bind(this,[TC.Consts.searchType.LOCALITY]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.COUNCIL]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Concejo",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CCONCEJO"],queryProperties:{tProperty:["CONCEJO"]},outputProperties:["MUNICIPIO","CONCEJO"],outputFormatLabel:"{1} ({0})",searchWeight:2,parser:e.getStringPattern.bind(this,[TC.Consts.searchType.COUNCIL]),goTo:e.goToStringPattern,idPropertiesIdentifier:"#",suggestionListHead:function(){return{label:e.getLocaleString("search.list.council"),color:{"#49006a":e.getLocaleString("search.list.council")}}},styles:{CATAST_Pol_Concejo:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#49006a",strokeWidth:2,strokeOpacity:1}}}};e.availableSearchTypes[TC.Consts.searchType.STREET]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Lin_CalleEje",renderFeatureType:"CATAST_Txt_Calle",dataIdProperty:["CVIA"],searchWeight:2,queryProperties:{tProperty:["ENTINOAC","ENTIDADC"],sProperty:["VIA","VIANOAC"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.street"),color:{"#CB0000":e.getLocaleString("search.list.street")}}},outputProperties:["ENTIDADC","VIA","CENTIDADC","CMUNICIPIO"],outputFormatLabel:"{1}, {0}",styles:{CATAST_Lin_CalleEje:{line:{strokeColor:"#CB0000",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid"}},CATAST_Txt_Calle:{point:{label:"VIA",angle:"CADANGLE",fontColor:"#000000",fontSize:7,fontWeight:"bold",labelOutlineColor:"#ffffff",labelOutlineWidth:2}}},parser:e.getStringPattern.bind(this,[TC.Consts.searchType.STREET]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.NUMBER]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Txt_Portal",renderFeatureType:"",searchWeight:2,dataIdProperty:["CMUNICIPIO","CENTIDADC","CVIA","PORTAL"],queryProperties:{tProperty:["ENTIDADC","ENTINOAC"],sProperty:["VIA","VIANOAC"],pProperty:["PORTAL"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.number"),color:{"#CB0000":e.getLocaleString("search.list.number")}}},outputProperties:["ENTIDADC","VIA","PORTAL","CENTIDADC","CMUNICIPIO"],outputFormatLabel:"{1} {2}, {0}",styles:{CATAST_Txt_Portal:{point:{radius:0,label:"PORTAL",angle:"CADANGLE",fontColor:"#CB0000",fontSize:14,fontWeight:"bold",labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}},parser:e.getStringPattern.bind(this,[TC.Consts.searchType.NUMBER]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.URBAN]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"ESTADI_Pol_EntidadPob",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDAD"],idPropertiesIdentifier:"#",queryProperties:{tProperty:["ENTINOAC","ENTIDAD"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.urban"),color:{"#feba1e":e.getLocaleString("search.list.urban")}}},outputProperties:["MUNICIPIO","ENTIDAD"],outputFormatLabel:"{1} ({0})",searchWeight:2,styles:{ESTADI_Pol_EntidadPob:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#feba1e",strokeWidth:2,strokeOpacity:1}}},parser:e.getStringPattern.bind(this,[TC.Consts.searchType.URBAN]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.PLACENAME]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"TOPONI_Txt_Toponimos",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CTOPONIMO"],idPropertiesIdentifier:"#",queryProperties:{tProperty:["MUNICIPIO"],sProperty:["TOPONIMO"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.placeName"),color:{"#ff5722":e.getLocaleString("search.list.placeName")}}},outputProperties:["MUNICIPIO","TOPONIMO"],outputFormatLabel:"{1} ({0})",searchWeight:3,filterByMatch:!0,styles:{TOPONI_Txt_Toponimos:{point:{radius:0,label:"CADTEXT",angle:"CADANGLE",fontColor:"#ff5722",fontSize:14,fontWeight:"bold",labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}},parser:e.getStringPattern.bind(this,[TC.Consts.searchType.PLACENAME]),goTo:e.goToStringPattern};e.availableSearchTypes[TC.Consts.searchType.COMMONWEALTH]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["POLUCI_Pol_MancoRSUg"],renderFeatureType:"",dataIdProperty:["CMANCOMUNI"],queryProperties:{tProperty:["MANCOMUNID"]},outputProperties:["MANCOMUNID"],outputFormatLabel:"{0}",searchWeight:3,styles:{POLUCI_Pol_MancoRSUg:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fc4e2a",strokeWidth:2,strokeOpacity:1}}}};e.rootCfg={};e.rootCfg[TC.Consts.searchType.MUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Municipio",dataIdProperty:["CMUNICIPIO"],queryProperties:{tProperty:["MUNICIPIO"]},outputProperties:["MUNICIPIO"],outputFormatLabel:"{0}",getRootLabel:function(){var t=new $.Deferred;if(e.rootCfg.active&&!e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel){var r={SERVICE:"WFS"};r.VERSION=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].version;r.REQUEST="GetFeature";r.TYPENAME=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].featurePrefix+":"+e.rootCfg[TC.Consts.searchType.MUNICIPALITY].featureType;r.OUTPUTFORMAT=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputFormat;r.PROPERTYNAME=["CMUNICIPIO"].concat(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties).join(",");r.CQL_FILTER=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].root.map(function(e){return["CMUNICIPIO"].map(function(t,r){return t+"="+e[r]}).join(" AND ")});r.CQL_FILTER=r.CQL_FILTER.join(" OR ");$.ajax({url:e.rootCfg[TC.Consts.searchType.MUNICIPALITY].url+"?"+$.param(r),type:"GET"}).done(function(r){if(r.totalFeatures>0){e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel=r.features.map(function(t){return{id:["CMUNICIPIO"].map(function(e){return t.properties[e]}).join("#"),label:t.properties[e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties[0]].toLowerCase()}});t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel)}else{e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel=[];t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel)}}).fail(function(){t.resolve([])})}else t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);return t}};e.rootCfg[TC.Consts.searchType.LOCALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["ESTADI_Pol_EntidadPob"],renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDADC"],queryProperties:{tProperty:["ENTINOAC"]},outputProperties:["ENTINOAC"],getRootLabel:function(){var t=new $.Deferred;if(e.rootCfg.active&&!e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel){var r={SERVICE:"WFS"};r.VERSION=e.rootCfg[TC.Consts.searchType.LOCALITY].version;r.REQUEST="GetFeature";r.TYPENAME=e.rootCfg[TC.Consts.searchType.LOCALITY].featurePrefix+":"+e.rootCfg[TC.Consts.searchType.LOCALITY].featureType;r.OUTPUTFORMAT=e.rootCfg[TC.Consts.searchType.LOCALITY].outputFormat;r.PROPERTYNAME=["CMUNICIPIO","CENTIDAD"].concat(e.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties).join(",");r.CQL_FILTER=e.rootCfg[TC.Consts.searchType.LOCALITY].root.map(function(e){return["CMUNICIPIO","CENTIDAD"].map(function(t,r){return t+"="+e[r]}).join(" AND ")});r.CQL_FILTER=r.CQL_FILTER.join(" OR ");$.ajax({url:e.rootCfg[TC.Consts.searchType.LOCALITY].url+"?"+$.param(r),type:"GET"}).done(function(r){if(r.totalFeatures>0){e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel=r.features.map(function(t){return{id:["CMUNICIPIO","CENTIDAD"].map(function(e){return t.properties[e]}).join("#"),label:t.properties[e.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties[0]].toLowerCase()}});t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel)}else{e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel=[];t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel)}}).fail(function(){t.resolve([])})}else t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);return t}};if(e.options.allowedSearchTypes)for(var t in e.options.allowedSearchTypes){if(e.availableSearchTypes[t]&&!$.isEmptyObject(e.options.allowedSearchTypes[t])){$.extend(e.availableSearchTypes[t],e.options.allowedSearchTypes[t]);if(e.options.allowedSearchTypes[t].root&&t!=TC.Consts.searchType.MUNICIPALITY&&e.options.allowedSearchTypes[t].rootType==TC.Consts.searchType.MUNICIPALITY||t!=TC.Consts.searchType.LOCALITY&&e.options.allowedSearchTypes[t].rootType==TC.Consts.searchType.LOCALITY){e.rootCfg.active=e.rootCfg[e.options.allowedSearchTypes[t].rootType];e.rootCfg.active.root=e.options.allowedSearchTypes[t].root;e.rootCfg.active.limit=e.options.allowedSearchTypes[t].limit;e.availableSearchTypes[TC.Consts.searchType.STREET].queryProperties.tProperty=e.availableSearchTypes[TC.Consts.searchType.NUMBER].queryProperties.tProperty=e.rootCfg.active.dataIdProperty}}e.options.allowedSearchTypes[t]||delete e.options.allowedSearchTypes[t]}e.allowedSearchTypes=e.options.allowedSearchTypes||{};e.rootCfg.active&&e.rootCfg.active.getRootLabel();e.queryableFeatures=e.options.queryableFeatures||!1;e.UTMX_LEN=6;e.UTMY_LEN=7;e.CADASTRAL=TC.Consts.searchType.CADASTRAL;e.COORDINATES=TC.Consts.searchType.COORDINATES;e.MUNICIPALITY=TC.Consts.searchType.MUNICIPALITY;e.LOCALITY=TC.Consts.searchType.LOCALITY;e.COUNCIL=TC.Consts.searchType.COUNCIL;e.STREET=TC.Consts.searchType.STREET;e.NUMBER=TC.Consts.searchType.NUMBER;e.COMMONWEALTH=TC.Consts.searchType.COMMONWEALTH;e.URBAN=TC.Consts.searchType.URBAN;e.ROAD=TC.Consts.searchType.ROAD;e.ROADPK=TC.Consts.searchType.ROADPK;e.PLACENAME=TC.Consts.searchType.PLACENAME;e.wrap=new TC.wrap.control.Search(e);e.interval=500;e.NORMAL_PATTERNS={ROMAN_NUMBER:/M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3}){1,}?\S?\./i,ABSOLUTE_NOT_DOT:/[`~!@#$%^&*_|+\=?;:'"\{\}\[\]\\]/gi,ABSOLUTE:/[`~!@#$%^&*_|+\=?;:'.\{\}\[\]\\]/gi};e.filter=function(e){var t=function(t,r){for(var a=0;a<e._search.data.length;a++)if(e._search.data[a].id==t&&(!r||r&&e._search.data[a].dataRole===r))return e._search.data[a]},r=function(t){var r=e.availableSearchTypes[t.dataRole],a=t.dataLayer;if(r.renderFeatureType){t.dataLayer instanceof Array||(a=[t.dataLayer]);a=a.concat(r.renderFeatureType instanceof Array?r.renderFeatureType:[r.renderFeatureType])}return a};return{getPropertyName:function(t,r){return e.availableSearchTypes[t].queryProperties[r+"Property"]},getPropertyValue:function(t,r){return e.availableSearchTypes[t][r]},getIsLikeNode:function(t,r){var a=/([\-\"\.\\xba\(\)\/])/g;a.test(r)&&(r=r.replace(a,"\\$1"));return r.toString().indexOf(e._LIKE_PATTERN)>-1?'<Or><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+t+"</PropertyName><Literal>"+r.toLowerCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+'</Literal></PropertyIsLike><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+t+"</PropertyName><Literal>"+r.toUpperCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsLike></Or>":"<PropertyIsEqualTo><PropertyName>"+t+"</PropertyName><Literal>"+r.replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsEqualTo>"},getFunctionStrMatches:function(t,r){var a=/([\-\"\\xba\(\)\/])/g;a.test(r)&&(r=r.replace(a,"\\$1"));if(r.toString().indexOf(e._LIKE_PATTERN)>-1){var o=r;return'<ogc:PropertyIsEqualTo> <ogc:Function name="strMatches"> <ogc:PropertyName>'+t+"</ogc:PropertyName> <ogc:Literal>(?i)"+(o=(o=(o=(o=(o=o.replace(/a/gi,"[a\xe1]")).replace(/e/gi,"[e\xe9]")).replace(/i/gi,"[i\xed]")).replace(/o/gi,"[o\xf3]")).replace(/u/gi,"[u\xfa\xfc]")).replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</ogc:Literal> </ogc:Function> <ogc:Literal>true</ogc:Literal> </ogc:PropertyIsEqualTo>"}return"<PropertyIsEqualTo><PropertyName>"+t+"</PropertyName><Literal>"+r.replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsEqualTo>"},getFilterNode:function(t,r,a){var o,i=e.filter.getIsLikeNode;if(a){i=e.filter.getFunctionStrMatches;var s=new RegExp("\\"+e._LIKE_PATTERN,"gi");r=r.replace(s,e._MATCH_PATTERN)}if(t instanceof Array||"string"==typeof t){if(t instanceof Array&&t.length>1){o="<ogc:Or>";for(c=0;c<t.length;c++)o+=i($.trim(t[c]),r);return o+"</ogc:Or>"}return i(t instanceof Array&&1===t.length?$.trim(t[0]):$.trim(t),r)}var l=[];for(var n in t)if(t[n]instanceof Array&&t[n].length>1){o="<Or>";for(var c=0;c<t[n].length;c++)o+=i($.trim(t[n][c]),r);o+="</Or>";l.push('(<Filter xmlns="http://www.opengis.net/ogc">'+o+"</Filter>)")}else{var p=t[n];t[n]instanceof Array&&1==t[n].length&&(p=t[n][0]);l.push('(<Filter xmlns="http://www.opengis.net/ogc"><Or>'+i($.trim(p),r)+"</Or></Filter>)")}return l.join("")},getFilter:function(t,r){var a={multiL:!1,f:""},o=function(t,r){var a=[];if(r!=e.rootCfg.active.root)for(var o=r.split("#"),i=0;i<e.rootCfg.active.dataIdProperty.length;i++){0==i&&e.rootCfg.active.dataIdProperty.length>1&&a.push("<ogc:And>");a.push(e.filter.getFilterNode(e.rootCfg.active.dataIdProperty[i],o.length>i?o[i]:o[0]));i==e.rootCfg.active.dataIdProperty.length-1&&e.rootCfg.active.dataIdProperty.length>1&&a.push("</ogc:And>")}else{for(var s=0;s<e.rootCfg.active.root.length;s++){o=e.rootCfg.active.root[s];0==s&&e.rootCfg.active.root.length>1&&a.push("<ogc:Or>");for(i=0;i<e.rootCfg.active.dataIdProperty.length;i++){0==i&&e.rootCfg.active.dataIdProperty.length>1&&a.push("<ogc:And>");a.push(e.filter.getFilterNode(e.rootCfg.active.dataIdProperty[i],o.length>i?o[i]:o[0]));i==e.rootCfg.active.dataIdProperty.length-1&&e.rootCfg.active.dataIdProperty.length>1&&a.push("</ogc:And>")}}e.rootCfg.active.root.length>1&&a.push("</ogc:Or>")}return t.concat(a)};switch(!0){case r===e.NUMBER:s=[];if(e.rootCfg.active||!/(\<|\>|\<\>)/gi.exec(t.t)&&!/(\<|\>|\<\>)/gi.exec(t.s)){e.rootCfg.active?s=o(s,t.t):s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch));s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch))}else{(i=/(\<|\>|\<\>)/gi.exec(t.t))?s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t.substring(0,t.t.indexOf(i[0])).trim()+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch)):e.rootCfg.active?s=o(s,t.t):s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch));(i=/(\<|\>|\<\>)/gi.exec(t.s))?s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s.substring(0,t.s.indexOf(i[0])).trim()+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch)):s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch))}s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"p"),t.p+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch));a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;case r===e.STREET:s=[];if(e.rootCfg.active||!/(\<|\>|\<\>)/gi.exec(t.t)&&!/(\<|\>|\<\>)/gi.exec(t.s)){e.rootCfg.active?s=o(s,t.t):s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch));s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch))}else{var i;(i=/(\<|\>|\<\>)/gi.exec(t.t))?s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t.substring(0,t.t.indexOf(i[0])).trim()+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch)):e.rootCfg.active?s=o(s,t.t):s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch));(i=/(\<|\>|\<\>)/gi.exec(t.s))?s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s.substring(0,t.s.indexOf(i[0])).trim()+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch)):s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch))}a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;case r===e.LOCALITY:a.f=e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch);a.multiL=!0;break;case e.allowedSearchTypes.hasOwnProperty(r)&&e.availableSearchTypes[r].queryProperties.hasOwnProperty("sProperty"):var s;(s=[]).push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch));s.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch));a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;default:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN,e.availableSearchTypes[r].filterByMatch)+"</ogc:Filter>"}return a},getParams:function(t,r,a,o){var i=e.filter.getFilter(t,r),s={REQUEST:"GetFeature",SERVICE:"WFS",MAXFEATURES:500,VERSION:e.availableSearchTypes[r].version,OUTPUTFORMAT:e.availableSearchTypes[r].outputFormat},l=e.filter.getPropertyValue(r,"featureType");if(l instanceof Array){for(var n=[],c=0;c<l.length;c++)n.push(e.availableSearchTypes[r].featurePrefix?e.availableSearchTypes[r].featurePrefix+":"+$.trim(l[c]):$.trim(l[c]));s.TYPENAME=n.join(",")}else s.TYPENAME=e.availableSearchTypes[r].featurePrefix?e.availableSearchTypes[r].featurePrefix+":"+$.trim(l):$.trim(l);var p=function(e){if(""!==(e||"")){if(e instanceof Array)return e.join(",");var t=[];if(e instanceof Object)for(var r in e){var a=e[r][0];e[r].length>1&&(a=e[r].join(","));t.push(a)}return t}},u=p(a),T=p(o);if(u instanceof Array&&T instanceof Array){s.PROPERTYNAME="";for(c=0;c<u.length;c++)s.PROPERTYNAME+="("+u[c]+","+T[c]+")"}else s.PROPERTYNAME=u+","+T;s.FILTER=i.f;return $.param(s)},getGoToFilterLayer:function(e,a){var o=t(e,a);return r(o)},getGoToFilter:function(a,o){var i=[],s=a.split("#"),l=t(a,o);if(l&&l.dataRole){var n=e.availableSearchTypes[l.dataRole].dataIdProperty,c=r(l);if(a.indexOf("#")>-1&&c instanceof Array)for(var p=0;p<c.length;p++)for(var u=0;u<n[c[p]].length;u++)i.push({name:n[c[p]][u],value:s[u]});else if(-1==a.indexOf("#")&&c instanceof Array){var T=n;for(p=0;p<c.length;p++)if(!i.hasOwnProperty(c[p])){T instanceof Object&&n.hasOwnProperty(c[p])&&(T=n[c[p]]);for(u=0;u<T.length;u++)u<s.length&&i.push({name:T[u],value:s[u]})}}else{n instanceof Object&&n.hasOwnProperty(c)&&(n=n[c]);for(p=0;p<n.length;p++)i.push({name:n[p],value:s[p]})}}return e.transformFilter(i)},getGoToElement:function(e){return t(e)}}}(e)};TC.inherit(TC.control.Search,TC.Control);!function(){var e=TC.control.Search.prototype;e.CLASS="tc-ctl-search";TC.Consts.event.SEARCHQUERYEMPTY=TC.Consts.event.SEARCHQUERYEMPTY||"searchqueryempty.tc";TC.isDebug?e.template=TC.apiLocation+"TC/templates/Search.html":e.template=function(){dust.register(e.CLASS,t);function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"search.1"}).w('</h2><div class="tc-ctl-search-content"><input type="search" class="tc-ctl-search-txt" placeholder="').h("i18n",t,{},{$key:"search.placeholder"}).w('" title="').h("i18n",t,{},{$key:"search.instructions"}).w('" /><a title="').h("i18n",t,{},{$key:"search.instructions"}).w('" class="tc-ctl-btn tc-ctl-search-btn">').h("i18n",t,{},{$key:"search.2"}).w('</a><ul class="tc-ctl-search-list"></ul></div>')}t.__dustBody=!0;return t};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t._search={data:[]};t.layerStyleFN=function(){function e(e){return e.indexOf(".")>-1?e.split(".")[0]:e}function r(e,r,a){for(var o in t.allowedSearchTypes){var i=t.availableSearchTypes[o]||t.allowedSearchTypes[o];if(i&&i.hasOwnProperty("featureType")&&(i.featureType.indexOf(a)>-1||i.renderFeatureType&&i.renderFeatureType.indexOf(a)>-1)&&i.styles[a].hasOwnProperty(r))return i.styles[a][r][e]}return TC.Cfg.styles[r][e]}return function(t,a,o,i){!TC.Feature||i instanceof TC.Feature||this.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:this.layer,geom:i.geom}));var s=r(a,t,e(i.id));if(o){if(s instanceof Array){var l=s.map(function(e){return i.getData().hasOwnProperty(e)?i.getData()[e]:""}),n=this.getSearchTypeByFeature(e(i.id));return n?n.outputFormatLabel.tcFormat(l):l.join(" ")}return i.getData().hasOwnProperty(s)?i.getData()[s]:""}return s}}();e.loaded(function(){var r=t.layerStyleFN;t.layerPromise=e.addLayer({id:TC.getUID(),title:"B\xfasquedas",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{polygon:{fillColor:r.bind(t,"polygon","fillColor",!1),fillOpacity:r.bind(t,"polygon","fillOpacity",!1),strokeColor:r.bind(t,"polygon","strokeColor",!1),strokeOpacity:r.bind(t,"polygon","strokeOpacity",!1),strokeWidth:r.bind(t,"polygon","strokeWidth",!1)},line:{strokeColor:r.bind(t,"line","strokeColor",!1),strokeOpacity:r.bind(t,"line","strokeOpacity",!1),strokeWidth:r.bind(t,"line","strokeWidth",!1)},marker:{anchor:TC.Defaults.styles.marker.anchor,height:TC.Defaults.styles.marker.height,width:TC.Defaults.styles.marker.width},point:{radius:r.bind(t,"point","radius",!1),height:r.bind(t,"point","height",!1),width:r.bind(t,"point","width",!1),fillColor:r.bind(t,"point","fillColor",!1),fillOpacity:r.bind(t,"point","fillOpacity",!1),strokeColor:r.bind(t,"point","strokeColor",!1),strokeWidth:r.bind(t,"point","strokeWidth",!1),fontSize:r.bind(t,"point","fontSize",!1),fontColor:r.bind(t,"point","fontColor",!1),labelOutlineColor:r.bind(t,"point","labelOutlineColor",!1),labelOutlineWidth:r.bind(t,"point","labelOutlineWidth",!1),label:r.bind(t,"point","label",!0),angle:r.bind(t,"point","angle",!0)}}});t.layerPromise.then(function(e){t.layer=e})});t.EMPTY_RESULTS_LABEL=t.getLocaleString("noResults");t.EMPTY_RESULTS_TITLE=t.getLocaleString("checkCriterion");t.OUTBBX_LABEL=t.getLocaleString("outsideOfLimits");t.WFS_TYPE_ATTRS=["url","version","geometryName","featurePrefix","featureType","properties","outputFormat"];t.availableSearchTypes[TC.Consts.searchType.ROAD]={root:null,limit:!1,url:t.url||"//idena.navarra.es/ogc/wfs",version:t.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:t.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"INFRAE_Lin_CtraEje",dataIdProperty:["DCARRETERA"],queryProperties:{tProperty:["DCARRETERA"]},suggestionListHead:function(){return{label:t.getLocaleString("search.list.road"),color:{"#00b2fc":t.getLocaleString("search.list.road")}}},outputProperties:["DCARRETERA"],outputFormatLabel:t.getLocaleString("search.list.road.shorter")+": {0}",searchWeight:2,styles:{INFRAE_Lin_CtraEje:{polygon:{strokeColor:"#00b2fc",strokeOpacity:1,strokeWidth:5},line:{strokeColor:"#00b2fc",strokeOpacity:1,strokeWidth:5,strokeLinecap:"round",strokeDashstyle:"solid"}}},parser:t.getRoad,goTo:t.goToRoad,pattern:new RegExp("^(?:(?:"+t.getLocaleString("search.list.road")+"|"+t.getLocaleString("search.list.road.shorter")+")\\:?)?\\s*((A?|AP?|N?|NA?|PA?)\\s*\\-?\\s*(\\d{1,4})\\s*\\-?\\s*(A?|B?|C?|R?))$","i")};t.availableSearchTypes[TC.Consts.searchType.ROADPK]={root:null,limit:!1,url:t.url||"//idena.navarra.es/ogc/wfs",version:t.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:t.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"INFRAE_Sym_CtraPK",dataIdProperty:["DCARRETERA","CPK"],queryProperties:{tProperty:["DCARRETERA"],sProperty:["PK"]},suggestionListHead:function(){return{label:t.getLocaleString("search.list.pk.larger"),color:{"#00b2fc":t.getLocaleString("search.list.road")+" "+t.getLocaleString("search.list.pk")}}},outputProperties:["DCARRETERA","PK"],outputFormatLabel:t.getLocaleString("search.list.road.shorter")+": {0} "+t.getLocaleString("search.list.pk")+": {1}",searchWeight:2,styles:{INFRAE_Sym_CtraPK:{point:{label:["DCARRETERA","PK"],fontColor:"#00b2fc",fontSize:14,fontWeight:"bold",labelOutlineColor:"#ffffff",labelOutlineWidth:2}}},parser:t.getPK,goTo:t.goToPK,pattern:new RegExp("^(?:(?:"+t.getLocaleString("search.list.road")+"|"+t.getLocaleString("search.list.road.shorter")+")\\:?)?\\s*((A?|AP?|N?|NA?|PA?)\\s*\\-?\\s*(\\d{1,4})\\s*\\-?\\s*(A?|B?|C?|R?))\\s*\\,*\\s*(?:(?:"+t.getLocaleString("search.list.pk")+"\\:?)|(?:P\\:?)|(?:K\\:?)|(?:KM\\:?)|(?:\\s+|\\,+))\\s*(\\d{1,4})$","i")}};e.renderData=function(e,t){var r=this;r._search=r._search||{};var a=function(){r.search(r.$text.val(),function(e){if(1===e.length){r.$text.val(e[0].label);r.goToResult(e[0].id);r.$list.hide("fast")}else 0===e.length&&r.$list.hide("fast")})};TC.Control.prototype.renderData.call(r,e,function(){var e=function(){r.$text.val(r.$list[0].label||r.$list.find("li:not([header]) > a > span").text());r.lastPattern=r.$text.val();r.goToResult(r.$list[0].id||unescape(r.$list.find("li:not([header]) > a").attr("href")).substring(1),r.$list.find("li:not([header])").attr("dataRole"));r.$list.hide("fast")};r.$text=r._$div.find("input.tc-ctl-search-txt");r.options&&r.options.placeHolder&&r.$text.attr("placeHolder",r.options.placeHolder.trim());r.$list=r._$div.find(".tc-ctl-search-list");r.$button=r._$div.find(".tc-ctl-search-btn");r.$button.on(TC.Consts.event.CLICK,function(){r.getLayer().then(function(t){r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length>1||(t.features.length>0?t.map.zoomToFeatures(t.features):1===r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length?e():r.$text.trigger("keyup.autocomplete"))})});if(r.options.instructions){r.$text.attr("title",r.options.instructions.trim());r.$button.attr("title",r.options.instructions.trim())}r.$list.on(TC.Consts.event.CLICK,"a.tc-ctl-search-li-empty",function(){r.$list.hide("fast");r.$text.focus()});try{if(r.$text.has($("::-ms-clear"))){r.$text.on("mouseup",function(e){""!==r.$text.val()&&setTimeout(function(){if(""===r.$text.val()){r.$list.hide("fast");a()}},1)})}}catch(e){}r.$text.on("keypress",function(t){if(13==t.which){t.preventDefault();t.stopPropagation();r.lastPattern="";1===r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length?e():a();return!1}}).on("search",function(){if(0===r.$text.val().length){r.$list.hide("fast");a()}}).on("input",function(){if(0===r.$text.val().length){r.$list.hide("fast");a()}}).on("targetCleared.autocomplete",function(){r.$list.hide("fast")}).on("targetUpdated.autocomplete",function(){r.$list.find("li").length>0&&r.$list.show("fast")});r.lastPattern="";r.retryTimeout=null;TC.loadJS(!r.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){var e;r.$text=r._$div.find("input.tc-ctl-search-txt");r.$text.autocomplete({link:"#",target:r.$list,minLength:2,ctx:r,source:function(t,a){r.lastpress=performance.now();if(!e){e=requestAnimationFrame(function t(){var o=r.$text.val().trim();if(o.length>0&&(!r.lastPattern||o!=r.lastPattern)&&performance.now()-r.lastpress>r.interval){window.cancelAnimationFrame(e);e=void 0;r.$list.hide("fast");r.lastPattern=o;r.search(o,a)}else e=requestAnimationFrame(t)})}},callback:function(e){var t=$(e.target);$(e.target).is("a")||(t=$(e.target).closest("a"));r.$text.val($(t).find("span[hidden]").text());r.lastPattern=r.$text.val();r.goToResult(unescape($(t).attr("href")).substring(1),$(t).parent().attr("dataRole"));r.$text.autocomplete("clear")},buildHTML:function(e){var t=[],a=[],o=/[^a-zA-Z]/g,i=/[^0-9]/g;function s(e,t){var r=parseInt(e,10),a=parseInt(t,10);if(isNaN(r)&&isNaN(a)){var s=e.replace(o,""),l=t.replace(o,"");if(s===l){var n=parseInt(e.replace(i,""),10),c=parseInt(t.replace(i,""),10);return n===c?0:n>c?1:-1}return s>l?1:-1}return isNaN(r)?1:isNaN(a)?-1:r>a?1:-1}var l=e.results.sort(function(e,t){return this.ctx.availableSearchTypes[e.dataRole].searchWeight&&this.ctx.availableSearchTypes[t.dataRole].searchWeight?(this.ctx.availableSearchTypes[e.dataRole].searchWeight||0)>(this.ctx.availableSearchTypes[t.dataRole].searchWeight||0)?1:(this.ctx.availableSearchTypes[e.dataRole].searchWeight||0)<(this.ctx.availableSearchTypes[t.dataRole].searchWeight||0)?-1:s(e.label,t.label):e.dataRole>t.dataRole?1:e.dataRole<t.dataRole?-1:s(e.label,t.label)}.bind(this));r.rootCfg.active&&(l=l.sort(function(e,t){var r=this.rootCfg.active.root[0].join("-"),a=this.rootCfg.active.dataIdProperty.map(function(t){return e.properties[t].toString()}).join("-"),o=this.rootCfg.active.dataIdProperty.map(function(e){return t.properties[e].toString()}).join("-");return a!==r&&o===r?1:a===r&&o!==r?-1:s(e.label,t.label)}.bind(r)));for(var n=0;n<l.length;n++){var c=l[n];if(-1==a.indexOf(c.dataRole)){var p=(this.ctx.availableSearchTypes[c.dataRole]||this.ctx.allowedSearchTypes[c.dataRole]).suggestionListHead(),u='<li header><span class="header">'+p.label+"</span>";for(var T in p.color)u+='<span class="header-color" title="'+p.color[T]+'" style="color: '+T+';"></span>';t[t.length]=u+"</li>";a.push(c.dataRole)}var f=c.label,h=[],g=this.ctx.lastPattern,C=[],y=",";-1==(g=r.NORMAL_PATTERNS.ROMAN_NUMBER.test(g)?g.replace(r.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):g.replace(r.NORMAL_PATTERNS.ABSOLUTE,"")).indexOf(y)&&(y=" ");C=g.trim().split(y);if(c.label.indexOf(this.ctx.LAT_LABEL)>-1&&c.label.indexOf(this.ctx.LON_LABEL)>-1||c.label.indexOf(this.ctx.UTMX_LABEL)>-1&&c.label.indexOf(this.ctx.UTMY_LABEL)>-1){C=this.ctx.lastPattern.split(" ");for(var d=0;d<C.length;d++)","==C[d].trim().slice(-1)&&(C[d]=C[d].slice(0,-1))}for(var m=0;m<C.length;m++)if(C[m].trim().length>0){h.push("("+C[m].trim().replace(/\(/gi,"").replace(/\)/gi,"")+")");if(L=/((\<)|(\>)|(\<\>))/gi.exec(C[m].trim()))for(var A=C[m].trim().replace(/((\<)|(\>)|(\<\>))/gi,"").split(" "),v=0;v<A.length;v++)A[v].trim().length>0&&h.push("("+A[v].trim().replace(/\(/gi,"\\(").replace(/\)/gi,"\\)")+")")}if(c.dataRole==TC.Consts.searchType.ROAD||c.dataRole==TC.Consts.searchType.ROADPK){var L;if(L=r.availableSearchTypes[c.dataRole].pattern.exec(this.ctx.lastPattern)){h=[];if(L[2]&&L[3]){h.push(L[2]+"-"+L[3]);L[4]&&(h[h.length-1]=h[h.length-1]+"-"+L[4]);h[h.length-1]="("+h[h.length-1]+")"}L[5]&&h.push("(?:"+r.getLocaleString("search.list.pk")+"\\:\\s\\d*)("+L[5]+")\\d*")}}var P="("+h.join("|")+")";P=(P=(P=(P=(P=(P=(P=(P=(P=(P=(P=P.replace(/\u00e1/gi,"a")).replace(/\u00e9/gi,"e")).replace(/\u00ed/gi,"i")).replace(/\u00f3/gi,"o")).replace(/\u00fa/gi,"u")).replace(/\u00fc/gi,"u")).replace(/a/gi,"[a|\xe1]")).replace(/e/gi,"[e|\xe9]")).replace(/i/gi,"[i|\xed]")).replace(/o/gi,"[o|\xf3]")).replace(/u/gi,"[u|\xfa|\xfc]");var E=new RegExp(P,"gi"),S=c.label;f=c.dataRole==TC.Consts.searchType.ROAD||c.dataRole==TC.Consts.searchType.ROADPK?S.replace(E,function(){var e=Array.prototype.slice.call(arguments,0);return e[e.length-3]?e[0].replace(e[e.length-3],"<b>"+e[e.length-3]+"</b>"):"<b>"+e[0]+"</b>"}):S.replace(E,"<b>$1</b>");t[t.length]='<li dataRole="'+c.dataRole+'"><a href="#'+encodeURIComponent(c.id)+'"><span hidden>'+c.label+"</span>"+f+"</a></li>"}return t.join("")}});r.$text.add(r.$list).keydown(function(e){if(!e.ctrlKey&&!e.altKey&&!e.shiftKey)if(40===e.keyCode){r.$text[0]==document.activeElement?r.$list.find("li:not([header]):first a").focus():r.$list.find("li:not([header]):last a").is(":focus")?r.$text.focus():r.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").nextAll("li:not([header]):first").find("a").focus();e.preventDefault();e.stopPropagation()}else if(38===e.keyCode){r.$text[0]==document.activeElement?r.$list.find("li:not([header]):last a").focus():document.activeElement==r.$list.find("li:not([header]):first a").get(0)?r.$list.find("li:not([header]):last a").focus():r.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").prevAll("li:not([header]):first").find("a").focus();e.preventDefault();e.stopPropagation()}e.stopPropagation()})})});$.isFunction(t)&&t()};e.getLayer=function(){this.layerPromise=this.layerPromise||new $.Deferred;if(this.layer){var e=new $.Deferred;e.resolve(this.layer);return e}return this.layerPromise};e.getFeatures=function(){return this.layer.features};e.getSearchTypeByFeature=function(e){for(var t in this.allowedSearchTypes){var r=this.availableSearchTypes[t]||this.allowedSearchTypes[t];if(r&&r.hasOwnProperty("featureType")&&(r.featureType.indexOf(e)>-1||r.renderFeatureType&&r.renderFeatureType.indexOf(e)>-1))return r}return null};e.cleanMap=function(){var e=this;e.getLayer().then(function(t){var r=t.features;t.clearFeatures();e.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:t,feature:r}));for(var a=0;a<e.WFS_TYPE_ATTRS.length;a++)t.hasOwnProperty(e.WFS_TYPE_ATTRS[a])&&delete t[e.WFS_TYPE_ATTRS[a]]})};e.getMunicipalities=function(){var e=this;TC.cache.search=TC.cache.search||{};if(!TC.cache.search.municipalities){e._municipalitiesDeferred=new $.Deferred;var t={REQUEST:"GetFeature",SERVICE:"WFS",TYPENAME:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featureType,VERSION:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].version,PROPERTYNAME:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties.join(","),OUTPUTFORMAT:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat};e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix&&(t.TYPENAME=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix+":"+t.TYPENAME);var r=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].url+"?"+$.param(t);$.ajax({url:r,type:"GET",dataType:"text"}).done(function(t){var r=(e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featurePrefix,featureType:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featureType})).read(t);TC.cache.search.municipalities=[];for(var a=0;a<r.length;a++){var o=r[a];TC.cache.search.municipalities.push({label:o.data[e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties[1]],id:o.data[e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties[0]]})}TC.cache.search.municipalities.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0});e._municipalitiesDeferred.resolve(TC.cache.search.municipalities)}).fail(function(){e._municipalitiesDeferred.resolve()})}return TC.cache.search.municipalities||e._municipalitiesDeferred.promise()};e.getCoordinates=function(e){var t=new $.Deferred,r=e.match(new RegExp("^"+$.trim(this.UTMX_LABEL.toLowerCase())+"*\\s*([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(this.UTMY_LABEL.toLowerCase())+"*\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$"));r&&(e=r[1]+" "+r[2]);(r=e.match(new RegExp("^"+$.trim(this.LAT_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(this.LON_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")))&&(e=r[1]+" "+r[3]);if(/\d/.test(e)&&(new RegExp("^([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$").test(e)||/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.test(e))){if((r=/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.exec(e))&&(r[1].indexOf(",")>-1||r[3].indexOf(",")>-1)){r[1]=r[1].replace(",",".");r[3]=r[3].replace(",",".");e=r[1]+" "+r[3]}if(!r||r&&(r[1].indexOf(",")>-1?r[1].replace(",","."):r[1])<=180&&(r[3].indexOf(",")>-1?r[3].replace(",","."):r[3])<=90){if((r=new RegExp("^([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$").exec(e))&&(r[1].indexOf(",")>-1||r[2].indexOf(",")>-1)){r[1]=r[1].replace(",",".");r[2]=r[2].replace(",",".");e=r[1]+" "+r[2]}e=e.replace(this.UTMX_LABEL,"").replace(this.UTMY_LABEL,"").replace(this.LON_LABEL,"").replace(this.LAT_LABEL,"");var a=TC.Util.parseCoords(e);if(a){var o=a[0].value,i=a[1].value,s=a[0].type===TC.Consts.UTM?this.UTMX:this.LAT,l=a[1].type===TC.Consts.UTM?this.UTMY:this.LON,n=s+o+l+i,c=this.getPoint(n);if(c&&!this.insideLimit(c)){o=a[1].value;i=a[0].value;n=(s=a[1].type===TC.Consts.UTM?this.UTMX:this.LAT)+o+(l=a[0].type===TC.Consts.UTM?this.UTMY:this.LON)+i;c=this.getPoint(n)}if(c){this.availableSearchTypes[TC.Consts.searchType.COORDINATES].label=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.test(n)?this.getLocaleString("search.list.coordinates.utm")+this.map.crs:this.getLocaleString("search.list.coordinates.geo");t.resolve([{id:n,label:this.getLabel(n),dataRole:TC.Consts.searchType.COORDINATES}])}else t.resolve([])}else t.resolve([])}else t.resolve([])}else t.resolve([]);return t.promise()};e.getCadastralRef=function(e){var t=this,r=new $.Deferred,a=e.match(new RegExp($.trim(t.MUN_LABEL.toLowerCase())+"?\\s(.*)\\,\\s?"+$.trim(t.POL_LABEL.toLowerCase())+"?\\s(\\d{1,2})\\,\\s?"+$.trim(t.PAR_LABEL.toLowerCase())+"?\\s(\\d{1,4})"));a&&(e=a[1]+", "+a[2]+", "+a[3]);var o=e;!/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(e)&&t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].suggestionRoot&&(o=t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].suggestionRoot+", "+e);/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(o)&&!new RegExp("^([0-9]{"+t.UTMX_LEN+"})\\s*\\,\\s*([0-9]{"+t.UTMY_LEN+"})$").test(e)?$.when(t.getMunicipalities()).then(function(e){var a=/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.exec(o);if(a){var i=new RegExp($.trim(a[1]).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),s=$.grep(e,function(e){e=e.label||e.id||e;return i.test(e)||i.test(t.removePunctuation(e))}),l=function(e,r,a,o){var i=[];i.push[t.MUN]=e;i.push[t.POL]=a;i.push[t.PAR]=o;return{id:t.MUN+e+t.POL+a+t.PAR+o,label:t.getLabel(t.MUN+r+t.POL+a+t.PAR+o),dataRole:TC.Consts.searchType.CADASTRAL,properties:i}};if(s.length>0)for(var n=0;n<s.length;n++)s[n]=l(s[n].id,s[n].label,$.trim(a[2]),$.trim(a[3]));/^[0-9]*$/g.test(a[1])&&s.push(l($.trim(a[1]),$.trim(a[1]),$.trim(a[2]),$.trim(a[3])));r.resolve(s)}}):r.resolve([]);return r.promise()};e.getStringPattern=function(e,t){var r=this,a=new $.Deferred,o=[],i=function(e,t){return(r.availableSearchTypes[t].outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:r.availableSearchTypes[t].featurePrefix,featureType:r.availableSearchTypes[t].featureType})).read(e)},s=function(e){for(var t=[function(e){return/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.test(e)},function(e){return/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.test(e)},function(e){return/^(sn|S\/N|s\/n|s\-n)$/i.test(e)},function(e){return/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.test(e)}],a=[function(e){var t=[],a=/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.exec(e);if(a){for(var o=1;o<a.length;o++)a[o].trim().length>0&&t.push(a[o].trim());return t.join(r._LIKE_PATTERN)}return e},function(e){var t=[],a=/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.exec(e);if(a){for(var o=1;o<a.length;o++)a[o].trim().length>0&&t.push(a[o].trim());return t.join(r._LIKE_PATTERN)}return e},function(e){return/^(sn|S\/N|s\/n|s\-n)$/i.exec(e)?"s*n":e},function(e){/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);return e}],o=0;o<a.length&&!t[o].call(r,e);)o++;return o<a.length?a[o].call(r,e):e},l=function(e,t,a){var o=new $.Deferred;","==(e=e.trim()).charAt(e.length-1)&&(e=e.substring(0,e.length-1));var i=[],l=function(e){if(t)for(var r=e.length;r--;)if(a){if(e[r].t){var o=this.rootCfg.active.rootLabel.filter(function(t){return t.label.indexOf(this.removePunctuation(e[r].t).toLowerCase())>-1}.bind(this));1==o.length?e[r].t=o[0].id:o.length>1?o.map(function(t){var a=$.extend({},e[r]);a.t=t.id;e.push(a)}):0==o.length&&e.splice(r,1)}}else e.push($.extend({},e[r],{t:t}))}.bind(r),n=function(e,r){var a=/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9\<\>]+)$/i.exec(e);if(a&&a[1]){t?r.push({t:t,s:a[1].trim()}):r.push({t:a[1].trim()});return!0}return!1},c=function(e,r){var a=/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/]+)\s*\,?\s*((\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(a&&a[1]&&a[2]){t?r.push({t:t,s:a[1].trim(),p:s(a[2].trim())}):r.push({t:a[1].trim(),s:a[2].trim()});return!0}return!1},p=function(e,r){var a=/^([^\,][0-9\s*\-\.\(\)\/]+)\s*\,?\s*(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);if(a&&a[1]&&a[2]&&t){r.push({t:t,s:a[1].trim(),p:s(a[2].trim())});return!0}return!1};if(function(){for(var t=[function(e){return e.length>=3},function(e){return!/^\d+$/.test(e)&&!/^\d+\,\s*\d+$/.test(e)}],a=0;a<t.length;a++)if(!t[a].call(r,e))return!1;return!0}()){var u=[function(e,t){var r=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(r&&r[1]&&r[2]){var a=function(){return s((r[3]||r[4]||r[5]||r[6]).trim())};if(/^([^0-9]+)$/i.test(r[1].trim())&&/^([^0-9]+)$/i.test(r[2].trim())){t.push({t:r[1].trim(),s:r[2].trim(),p:a()});t.push({t:r[2].trim(),s:r[1].trim(),p:a()})}else/^([^0-9]+)$/i.test(r[1].trim())?t.push({t:r[1].trim(),s:r[2].trim(),p:a()}):t.push({s:r[1].trim(),t:r[2].trim(),p:a()});l(t);return!0}return!1},function(e,t){var r=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))(?:\s*\,\s*)([^0-9\,]+)$/i.exec(e);if(r&&r[6]&&r[1]){var a=function(){return s((r[2]||r[3]||r[4]||r[5]).trim())};if(/^([^0-9]+)$/i.test(r[6].trim())&&/^([^0-9]+)$/i.test(r[1].trim())){t.push({t:r[6].trim(),s:r[1].trim(),p:a()});t.push({t:r[1].trim(),s:r[6].trim(),p:a()})}else/^([^0-9]+)$/i.test(r[6].trim())?t.push({t:r[6].trim(),s:r[1].trim(),p:a()}):t.push({s:r[6].trim(),t:r[1].trim(),p:a()});l(t);return!0}return!1},function(e,t){var r=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(r&&r[1]&&r[2]){t.push({t:r[2].trim(),s:r[1].trim(),p:s((r[3]||r[4]||r[5]||r[6]).trim())});l(t);return!0}return!1},function(e,t){var a=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc"\s*\-\.\(\)\/0-9]+))$/i.exec(e);if(!a&&/^[^0-9]*$/i.test(e.trim())){var o=e.split(",").reverse();a=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc"\s*\-\.\(\)\/0-9]+))$/i.exec(o.join(","))}if(a&&a[1]&&a[2]){if(/^([^0-9]+)$/i.test(a[1].trim())&&/^([^0-9]+)$/i.test(a[2].trim())){t.push({t:a[1].trim(),s:a[2].trim()});t.push({s:a[1].trim(),t:a[2].trim()})}else{var i=function(e){for(var t=e.split(" ").reverse(),a=[],o=0;o<t.length;o++)if(1==t[o].length){a.push(t[o]);t[o]=""}return a.length>0?t.reverse().join(" ").trim()+r._LIKE_PATTERN+a.reverse().join(r._LIKE_PATTERN):t.reverse().join(" ").trim()};/^([^0-9]+)$/i.test(a[1].trim())?t.push({t:a[1].trim(),s:i(a[2].trim())}):t.push({s:i(a[1].trim()),t:a[2].trim()})}l(t);return!0}return!1},function(e,t){var a=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)$/i.exec(e);if(!a){var o=e.split(",").reverse();a=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc"\s*\-\.\(\)\/0-9]+))$/i.exec(o.join(","))}if(a){for(var i={},n=(o=e.split(",").reverse(),0);n<o.length;n++)if(/^([^0-9\,]+)$/i.test(o[n].trim()))i.t=o[n].trim();else if(/(\s*\d+)/i.test(o[n].trim()))if(-1==o[n].trim().indexOf(" "))i.s=o[n].trim();else{for(var c=o[n].trim().split(" ").reverse(),p=function(e){if(/^(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e.trim())){i.p=s(e.trim());return!0}return!1},u=0,T=c[u].trim();u<c.length&&!p(T);)++u<c.length&&(T+=c[u]);if(i.p){for(var f=c,h=0;h<f.length;h++){for(var g=!1,C=0;C<f[h].split("").length;C++)i.p.indexOf(f[h][C])>-1&&(g=!0);if(g){f[h];f[h]="";if(i.p==s(T))break}}if(/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+)$/i.test(c.reverse().join(" ").trim())){for(var y=[],d=c.reverse(),m=0;m<d.length;m++)if(1==d[m].trim().length){y.push(d[m].trim());d[m]=""}i.s=y.length>0?d.reverse().join(" ").trim()+r._LIKE_PATTERN+y.reverse().join(r._LIKE_PATTERN):d.reverse().join(" ").trim()}t.push({t:i.t,s:i.s+" "+i.p})}else i.s=o[n].trim()}t.push(i);l(t);return!0}return!1}];u=t&&e.split(",").length<3?[c,p,n].concat(u):u.concat([c,p,n]);var T=0;try{for(;T<u.length&&!u[T].call(r,e,i);)T++}catch(t){TC.error("Error seg\xfan el patr\xf3n: "+e,TC.Consts.msgErrorMode.EMAIL,"Error en la b\xfasqueda del callejero")}}i.length>0&&t?$.when(r.rootCfg.active.getRootLabel()).then(function(e){if(e)for(var a=i.length;a--;){var s=i[a];if(i.length>1&&s.t==t&&e.filter(function(e){return e.indexOf(r.removePunctuation(s.s).toLowerCase())>-1}).length>0){i.splice(a,1);break}}o.resolve(i)}):o.resolve(i);return o},n=function(e,t,a,i){for(var s=0;s<e.length;s++){var l=[],n=[],c="",p=a,u=i,T=r.filter.getPropertyValue(t,"outputFormatLabel"),f=e[s].id.split(".").slice(0,1).shift();if(!(a instanceof Array)){p=a[f];u=i[f];T=T[f]}for(var h=0;h<p.length;h++)l.push(e[s].data[p[h]]);for(h=0;h<u.length;h++)n.push(e[s].data[u[h]]);var g=function(e){for(var t=[],r=0;r<e.length;r++)-1==jQuery.inArray(e[r],t)&&t.push(e[r]);return t};l instanceof Array&&T&&g(l).length>1?c=T.tcFormat(l):l instanceof Array&&1==g(l).length&&(c=l[0]);var C=c.toCamelCase();if(!function(e,t){for(var r=0;r<o.length;r++)if(e===TC.Consts.searchType.NUMBER){if(o[r].dataRole==e&&o[r].text.toLowerCase().trim()==t.toLowerCase().trim())return!0}else if(o[r].dataRole==e&&TC.Util.getSoundexDifference(o[r].text.trim().soundex(),t.trim().soundex())>=3)return!0;return!1}(t,C)){for(var y=[],d=0;d<a.length;d++)y[a[d]]=l[d];o.push({text:C,label:C,id:n.join("#"),dataRole:t,dataLayer:f,properties:y})}}}.bind(r),c=function(t){if(t){r._search.data=o;r.request||(r.request=[]);function s(e,t){var s=r.filter.getPropertyValue(t,"outputProperties"),l=r.filter.getPropertyValue(t,"dataIdProperty");return $.ajax({url:r.availableSearchTypes[t].url,type:"POST",contentType:"application/x-www-form-urlencoded;charset=UTF-8",dataType:"text",data:r.filter.getParams(e,t,s,l),beforeSend:function(){r.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+r.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>');r.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var r=i(e,t);n(r,t,s,l)}).fail(function(e){"abort"!==e.statusText&&alert("error");a.resolve(o)})}$.map(t,function(t,a){var o=function(t){var a=[];for(var o in r.allowedSearchTypes)e.indexOf(o)>-1&&r.availableSearchTypes[o]&&r.availableSearchTypes[o].hasOwnProperty("queryProperties")&&Object.keys(r.availableSearchTypes[o].queryProperties).length===Object.keys(t).length&&a.push(o);return a=a.sort(function(e,t){return(r.availableSearchTypes[e].searchWeight||0)>=(r.availableSearchTypes[t].searchWeight||0)?1:0}).filter(function(e){for(var t=0;t<a.length;t++)if((r.availableSearchTypes[a[t]].searchWeight||0)>(r.availableSearchTypes[e].searchWeight||0))return!1;return!0})}(t);for(a=0;a<o.length;a++){var i=o[a];i&&r.allowedSearchTypes[i]&&r.request.push(s(t,i))}});$.when.apply($,r.request).then(function(){a.resolve(o)})}else a.resolve(o)};t=function(e){e=r.removePunctuation(e);return(e=r.NORMAL_PATTERNS.ROMAN_NUMBER.test(e)?e.replace(r.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):e.replace(r.NORMAL_PATTERNS.ABSOLUTE,"")).toLowerCase()}(t);var p=/(.*)\((.*)\)/.exec(t);if(p&&p.length>2){var u=[];l(p[1],r.rootCfg.active&&r.rootCfg.active.root||"",r.rootCfg.active&&r.rootCfg.active.limit||!1).then(function(e){u=e||[];l(p[1]+","+p[2],r.rootCfg.active&&r.rootCfg.active.root||"",r.rootCfg.active&&r.rootCfg.active.limit||!1).then(function(e){u=u.concat(e);c(u)})});return a.promise()}l(t,r.rootCfg.active&&r.rootCfg.active.root||"",r.rootCfg.active&&r.rootCfg.active.limit||!1).then(c);return a.promise()};e.getRoad=function(e){var t=this,r=new $.Deferred;if((e=e.trim()).length<2)r.resolve([]);else{var a=TC.Consts.searchType.ROAD,o=t.availableSearchTypes[a].pattern.exec(e);if(o&&o[3]){var i=t.filter.getPropertyValue(a,"outputProperties"),s=t.filter.getPropertyValue(a,"dataIdProperty"),l=t.filter.getPropertyValue(a,"outputFormatLabel"),n=o[2]?o[2].trim()+"-"+o[3].trim():o[3].trim();o[4]&&o[4].length>0&&(n=n+"-"+o[4].trim());$.ajax({url:t.availableSearchTypes[a].url+"?"+t.filter.getParams({t:n},a,i,s),type:"GET",contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>');t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=[];if(e.totalFeatures>0){e.features.map(function(e){if(!t.some(function(t){return t.text==e.properties[i[0]]})){var r=l.tcFormat(i.map(function(t){return e.properties[t]})),o=i.map(function(t){return e.properties[t]}).join("-");t.push({id:s.map(function(t){return e.properties[t]}).join("#"),label:r,text:o,dataLayer:e.id.split(".")[0],dataRole:a})}});r.resolve(t)}else r.resolve([])}).fail(function(e){r.resolve([])})}else r.resolve([])}return r.promise()};e.getPK=function(e){var t=this,r=new $.Deferred;if((e=e.trim()).length<3)r.resolve([]);else{var a=TC.Consts.searchType.ROADPK,o=t.availableSearchTypes[a].pattern.exec(e);if(o&&o[3]&&o[5]){var i=t.filter.getPropertyValue(a,"outputProperties"),s=t.filter.getPropertyValue(a,"dataIdProperty"),l=t.filter.getPropertyValue(a,"outputFormatLabel"),n=o[2]?o[2].trim()+"-"+o[3].trim():o[3].trim();o[4]&&o[4].length>0&&(n=n+"-"+o[4].trim());$.ajax({url:t.availableSearchTypes[a].url+"?"+t.filter.getParams({t:n,s:o[5].trim()},a,i,s),type:"GET",contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>');t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=[];if(e.totalFeatures>0){e.features.map(function(e){if(!t.some(function(t){return t.label==e.properties[i[0]]})){var r=l.tcFormat(i.map(function(t){return e.properties[t]}));t.push({id:s.map(function(t){return e.properties[t]}).join("#"),label:r,text:r,dataLayer:e.id.split(".")[0],dataRole:a})}});r.resolve(t)}else r.resolve([])}).fail(function(e){r.resolve([])})}else r.resolve([])}return r.promise()};e.search=function(e,t){var r=this,a=[];if(r.request){for(var o=0;o<r.request.length;o++){console.log("new criteria: search promise/s aborted");r.request[o].abort()}r.request=[]}if((e=$.trim(e)).length>0){e=e.toLowerCase();var i=[],s=function(t){var o=new $.Deferred;i.push(o);$.when(t.call(r,e)).then(function(e){a=a.concat(e);o.resolve(a)})};for(var l in r.allowedSearchTypes)r.availableSearchTypes[l]&&r.availableSearchTypes[l].parser?s(r.availableSearchTypes[l].parser):r.allowedSearchTypes[l].parser?s(r.allowedSearchTypes[l].parser):console.log("Falta implementaci\xf3n del m\xe9todo parser");$.when.apply(r,i).then(function(){a&&(r._search.data=a=a.sort(function(e,t){var r,a=/(\d+)/,o="";if(a.test(e.label)&&a.test(t.label)){r=e.label.match(a)[1];o=t.label.match(a)[1]}else{r=e.label;o=t.label}return r>o?1:r<o?-1:0}.bind(r)));t&&t(a);if(0===a.length){r.cleanMap();if(!r.layer||r.layer&&0===r.layer.features.length&&r.request.length>0){r.$list.html('<li><a title="'+r.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+r.EMPTY_RESULTS_LABEL+"</a></li>");r.$text.trigger("targetUpdated.autocomplete")}}})}else r.cleanMap()};var t=function(e){if(e&&e.length>0)for(var t=0;t<e.length;t++)e[t].showsPopup!=this.queryableFeatures&&(e[t].showsPopup=this.queryableFeatures)};e.goToResult=function(e,r){var a,o=this,i=null;o.loading||(o.loading=o.map.getControlsByClass("TC.control.LoadingIndicator")[0]);a=o.loading.addWait();if(Modernizr.mq("(max-width: 30em)")){o.$text.blur();o.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{})}o.cleanMap();var s=!1,l=!0;for(var n in o.allowedSearchTypes)if(l)if(o.availableSearchTypes[n]){var c=r||o.filter.getGoToElement(e).dataRole;if(c)if(o.availableSearchTypes[c].goTo)null!==(i=o.availableSearchTypes[c].goTo.call(o,e,c))&&(l=!1);else if(o.allowedSearchTypes[c].goTo){s=!0;null!==(i=o.allowedSearchTypes[c].goTo.call(o,e,c))&&(l=!1)}else console.log("Falta implementaci\xf3n del m\xe9todo goTo")}else if(o.allowedSearchTypes[n].goTo){s=!0;null!==(i=o.allowedSearchTypes[n].goTo.call(o,e))&&(l=!1)}else console.log("Falta implementaci\xf3n del m\xe9todo goTo");o.loading.removeWait(a);i?o.getLayer().then(function(e){switch(!0){case i.params.type==TC.Consts.layerType.VECTOR:for(var r=0;r<o.WFS_TYPE_ATTRS.length;r++)e.hasOwnProperty(o.WFS_TYPE_ATTRS[r])&&delete e[o.WFS_TYPE_ATTRS[r]];break;case i.params.type==TC.Consts.layerType.WFS:for(r=0;r<o.WFS_TYPE_ATTRS.length;r++)e[o.WFS_TYPE_ATTRS[r]]=i.params[o.WFS_TYPE_ATTRS[r]];a=o.loading.addWait()}e.type=i.params.type;e.refresh().then(function(){o.map.one(TC.Consts.event.LAYERUPDATE,function(r){if(r.layer==e){o.map.one(TC.Consts.event.FEATURESADD,function(r){if(r.layer==e){if(!r.layer.features||0==r.layer.features.length&&r.layer.wrap.layer.getSource().getFeatures()){o.$list.hide("fast");var s=r.layer.wrap.layer.getSource().getExtent(),l=r.layer.map.options.pointBoundsRadius;if(s[2]-s[0]==0){s[0]=s[0]-l;s[2]=s[2]+l}if(s[3]-s[1]==0){s[1]=s[1]-l;s[3]=s[3]+l}r.layer.map.setExtent(s);o.map.$events.trigger($.Event(TC.Consts.event.ZOOMTO,{extent:s,layer:r.layer}))}else if(r.layer.features&&r.layer.features.length>0){o.$list.hide("fast");t.call(o,r.layer.features);o.layer.map.zoomToFeatures(r.layer.features);o.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:o.layer,features:o.layer.features}))}else if(r.layer.features&&0==r.layer.features.length&&i.params.type==TC.Consts.layerType.WFS){o.$list.html(i.emptyResultHTML);o.$text.trigger("targetUpdated.autocomplete");o.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))}o.loading.removeWait(a)}});if(r.layer.features&&r.layer.features.length>0){o.$list.hide("fast");t.call(o,r.layer.features);o.layer.map.zoomToFeatures(o.layer.features);o.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:o.layer,features:o.layer.features}));o.loading.removeWait(a)}else if(r.layer.features&&0==r.layer.features.length&&i.params.type==TC.Consts.layerType.WFS){o.$list.html(i.emptyResultHTML);o.$text.trigger("targetUpdated.autocomplete");r.newData&&r.newData.features&&r.newData.features.length>0||o.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY));o.loading.removeWait(a)}}})})}):s||o.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))};var r=function(e){var t=this;wait=t.loading.addWait();var r,a,o,i=t.getPoint(e);if(i&&t.insideLimit(i)){a=t.getLabel(e);o=t.layer.addMarker(i,$.extend({},t.map.options.styles.point,{title:a,group:a}));r=t.map.options.pointBoundsRadius;t.map.setExtent([i[0]-r,i[1]-r,i[0]+r,i[1]+r])}else{var s=/^Lat((?:[+-]?)\d+(?:\.\d+)?)Lon((?:[+-]?)\d+(?:\.\d+)?)$/.exec(e);e=t.LAT+s[2]+t.LON+s[1];if((i=t.getPoint(e))&&t.insideLimit(i)){a=t.getLabel(e);o=t.layer.addMarker(i,$.extend({},t.map.options.styles.point,{title:a,group:a}));r=t.map.options.pointBoundsRadius;t.map.setExtent([i[0]-r,i[1]-r,i[0]+r,i[1]+r]);t.$text.val(a)}else{t.$list.html(goTo.emptyResultHTML);t.$text.trigger("targetUpdated.autocomplete");t.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY));t.loading.removeWait(wait)}}$.when(o).then(function(e){t.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:t.layer,features:[e]}));t.loading.removeWait(wait)})};e.goToCoordinates=function(e){var t={};if(/^X(\d+(?:[\.\,]\d+)?)Y(\d+(?:[\.\,]\d+)?)$/.test(e)||/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.test(e)){t.params={type:TC.Consts.layerType.VECTOR,styles:{marker:{url:this.layerStyleFN.bind(this,"marker","url",!0)}}};t.emptyResultHTML='<li><a class="tc-ctl-search-li-empty">'+this.OUTBBX_LABEL+"</a></li>";r.call(this,e);return t}return null};e.goToCadastralRef=function(e){var t={};if(/^\M(\d+)\P(\d{1,2})Par{1}(\d{1,4})/g.test(e)){var r=/^\M(\d+)\P(\d{1,2})Par{1}(\d{1,4})/g.exec(e);TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");t.params={type:TC.Consts.layerType.WFS,url:this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].url,version:this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].version,geometryName:this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].geometryName,featurePrefix:this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix,featureType:this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featureType,properties:new TC.filter.and(new TC.filter.equalTo(this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.municipality,$.trim(r[1])),new TC.filter.equalTo(this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.polygon,$.trim(r[2])),new TC.filter.equalTo(this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.parcel,$.trim(r[3]))),outputFormat:this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat,styles:this.availableSearchTypes[TC.Consts.searchType.CADASTRAL].styles};t.emptyResultHTML='<li><a title="'+this.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+this.EMPTY_RESULTS_LABEL+"</a></li>";return t}return null};e.goToRoad=function(e){var t={},r=TC.Consts.searchType.ROAD;t.params={type:TC.Consts.layerType.WFS,url:this.availableSearchTypes[r].url,version:this.availableSearchTypes[r].version,geometryName:this.availableSearchTypes[r].geometryName,featurePrefix:this.availableSearchTypes[r].featurePrefix,featureType:this.filter.getGoToFilterLayer(e),maxFeatures:3e3,properties:this.filter.getGoToFilter(e,r),outputFormat:this.availableSearchTypes[r].outputFormat,styles:this.availableSearchTypes[r].styles};t.emptyResultHTML='<li><a title="'+this.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+this.EMPTY_RESULTS_LABEL+"</a></li>";return t};e.goToPK=function(e){var t={},r=TC.Consts.searchType.ROADPK;t.params={type:TC.Consts.layerType.WFS,url:this.availableSearchTypes[r].url,version:this.availableSearchTypes[r].version,geometryName:this.availableSearchTypes[r].geometryName,featurePrefix:this.availableSearchTypes[r].featurePrefix,featureType:this.filter.getGoToFilterLayer(e),maxFeatures:3e3,properties:this.filter.getGoToFilter(e,r),outputFormat:this.availableSearchTypes[r].outputFormat,styles:this.availableSearchTypes[r].styles};t.emptyResultHTML='<li><a title="'+this.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+this.EMPTY_RESULTS_LABEL+"</a></li>";return t};e.goToStringPattern=function(e,t){var r={},a=this.availableSearchTypes[t];r.params={type:TC.Consts.layerType.WFS,url:a.url,version:a.version,geometryName:a.geometryName,featurePrefix:a.featurePrefix,featureType:this.filter.getGoToFilterLayer(e),maxFeatures:3e3,properties:this.filter.getGoToFilter(e,t),outputFormat:a.outputFormat,styles:a.styles};return r};e.getPoint=function(e){var t,r=this.map.wrap.isGeo(),a=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.exec(e);if(a&&3===a.length){t=[parseFloat(a[1]),parseFloat(a[2])];r&&(t=TC.Util.reproject(t,this.map.options.utmCrs,this.map.crs))}else{if((a=/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e))&&3===a.length){t=[parseFloat(a[2]),parseFloat(a[1])];if(!r)return TC.Util.reproject(t,this.map.options.geoCrs,this.map.crs)}if((a=/^Lon((?:[+-]?)\d+(?:[.,]\d+)?)Lat((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e))&&3===a.length){t=[parseFloat(a[2]),parseFloat(a[1])];if(!r)return TC.Util.reproject(t,this.map.options.geoCrs,this.map.crs)}}return t};e.insideLimit=function(e){return!!function(e,t){return!(e instanceof Array)||t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3]}(this.map.options.maxExtent,e)};e.getPattern=function(){return this.$text.val()};e.getLabel=function(e){var t=e,r=TC.Util.getMapLocale(this.map);if(e.match(new RegExp("^(?:"+this.LAT+"[-\\d])|(?:"+this.UTMX+"[\\d])"))){(o=(t=t.replace(this.LAT,this.LAT_LABEL).replace(this.LON," "+this.LON_LABEL).replace(this.UTMX,this.UTMX_LABEL).replace(this.UTMY," "+this.UTMY_LABEL)).match(new RegExp("^"+$.trim(this.LAT_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(this.LON_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")))&&(t=(t=t.replace(o[1],parseFloat(o[1]).toLocaleString(r))).replace(o[3],parseFloat(o[3]).toLocaleString(r)));var a=1.1.toLocaleString(r).substring(1,2);if(o=t.match(new RegExp("^"+$.trim(this.UTMX_LABEL)+"*\\s*([0-9]{"+this.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(this.UTMY_LABEL)+"*\\s*([0-9]{"+this.UTMY_LEN+"}(?:[.,]\\d+)?)$"))){Number.isInteger(parseFloat(o[1]))||(t=t.replace(o[1],o[1].replace(".",a)));Number.isInteger(parseFloat(o[2]))||(t=t.replace(o[2],o[2].replace(".",a)))}}else if(e.match(new RegExp("^(?:"+this.LON+"[-\\d])"))){(o=(t=t.replace(this.LON,this.LON_LABEL).replace(this.LAT," "+this.LAT_LABEL)).match(new RegExp("^"+$.trim(this.LON_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(this.LAT_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")))&&(t=(t=t.replace(o[1],parseFloat(o[1]).toLocaleString(r))).replace(o[3],parseFloat(o[3]).toLocaleString(r)))}else if(e.match(new RegExp("^(?:(\\"+this.MUN+"{1})(.*)(\\"+this.POL+"{1})(\\d{1,2})(\\"+this.PAR+"{1})(\\d{1,4}))"))){var o=e.match(new RegExp("^(?:(\\"+this.MUN+"{1})(.*)(\\"+this.POL+"{1})(\\d{1,2})(\\"+this.PAR+"{1})(\\d{1,4}))"));t=this.MUN_LABEL+o[2]+", "+this.POL_LABEL+o[4]+", "+this.PAR_LABEL+o[6]}return t};e.removePunctuation=function(e){e=e||"";for(var t=new Array(e.length),r={"\xe1":"a","\xc1":"A","\xe9":"e","\xc9":"E","\xed":"i","\xcd":"I","\xf3":"o","\xd3":"O","\xfa":"u","\xfc":"u","\xda":"U","\xdc":"U"},a=0,o=e.length;a<o;a++)t[a]=r[e.charAt(a)]||e.charAt(a);return t.join("")};e.decodeEntities=function(e){return $("<div/>").html(e).text()};e.transformFilter=function(e){TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");if(e&&e instanceof Array){var t=e.map(function(e){if(!e.hasOwnProperty("type"))return new TC.filter.equalTo(e.name,e.value);switch(!0){case e.type==TC.Consts.comparison.EQUAL_TO:return new TC.filter.equalTo(e.name,e.value)}});return t.length>1?TC.filter.and.apply(null,t):t[0]}}}();String.prototype.tcFormat||(String.prototype.tcFormat=function(){var e=(arguments||[""])[0];return this.replace(/{(\d+)}/g,function(t,r){return void 0!==e[r]?e[r]:t})});String.prototype.splitRemoveWhiteSpaces||(String.prototype.splitRemoveWhiteSpaces=function(e){for(var t=[],r=this.split(e),a=0;a<r.length;a++)$.trim(r[a]).length>0&&t.push($.trim(r[a]));return t});String.prototype.toCamelCase||(String.prototype.toCamelCase=function(){var e=this.toLowerCase(),t=this.toLowerCase().match(/\W+(.)/g);if(t)for(var r=0;r<t.length;r++)/[;:.<>\{\}\[\]\/\s()]/g.test(t[r])&&(e=e.replace(t[r],t[r].toUpperCase()));return e.charAt(0).toUpperCase()+e.substring(1)});Array.prototype.hasOwnProperty("findByProperty")||Object.defineProperty(Array.prototype,"findByProperty",{enumerable:!1,writable:!0,value:function(e,t){for(var r=0;r<this.length;r++)if(this[r][e]==t)return this[r]}});String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var r=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>r.length)&&(t=r.length);t-=e.length;var a=r.indexOf(e,t);return-1!==a&&a===t});