TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.Search=function(){var e=this;if(TC.Control.apply(e,arguments),TC.Consts.event.TOOLSCLOSE=TC.Consts.event.TOOLSCLOSE||"toolsclose.tc",e.url="//idena.navarra.es/ogc/wfs",e.version="1.1.0",e.featurePrefix="IDENA",e._LIKE_PATTERN="*",e.UTMX="X",e.UTMY="Y",e.LON="Lon",e.LAT="Lat",e.UTMX_LABEL="X: ",e.UTMY_LABEL="Y: ",e.LON_LABEL="Lon: ",e.LAT_LABEL="Lat: ",e.MUN="M",e.POL="P",e.PAR="Par",e.MUN_LABEL="Mun: ",e.POL_LABEL="Pol: ",e.PAR_LABEL="Par: ",e.availableSearchTypes={},e.availableSearchTypes[TC.Consts.searchType.CADASTRAL]={suggestionRoot:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["CATAST_Pol_ParcelaRusti","CATAST_Pol_ParcelaUrba","CATAST_Pol_ParcelaMixta"],municipality:{featureType:"CATAST_Pol_Municipio",outputProperties:["CMUNICIPIO","MUNICIPIO"]},queryProperties:{municipality:"CMUNICIPIO",polygon:"POLIGONO",parcel:"PARCELA"},suggestionListHead:function(){return{label:e.getLocaleString("search.list.cadastral"),color:{"#e5475f":e.getLocaleString("search.list.cadastral.mixed"),"#0c8b3d":e.getLocaleString("search.list.cadastral.rustic"),"#136278":e.getLocaleString("search.list.cadastral.urban")}}},styles:{CATAST_Pol_ParcelaUrba:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#136278",strokeWidth:2,strokeOpacity:1}},CATAST_Pol_ParcelaRusti:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#0c8b3d",strokeWidth:2,strokeOpacity:1}},CATAST_Pol_ParcelaMixta:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#e5475f",strokeWidth:2,strokeOpacity:1}}},parser:e.getCadastralRef,goTo:e.goToCadastralRef,goToIdFormat:"M{0}P{1}Par{2}",idPropertiesIdentifier:"#"},e.availableSearchTypes[TC.Consts.searchType.COORDINATES]={parser:e.getCoordinates,goTo:e.goToCoordinates,label:null,suggestionListHead:function(t){return{label:e.availableSearchTypes[TC.Consts.searchType.COORDINATES].label||e.getLocaleString("search.list.coordinates")}}},e.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Municipio",dataIdProperty:["CMUNICIPIO"],queryProperties:{tProperty:["MUNINOAC","MUNICIPIO"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.municipality"),color:{"#fe06a5":e.getLocaleString("search.list.municipality")}}},outputProperties:["MUNICIPIO"],outputFormatLabel:"{0}",searchWeight:2,styles:{CATAST_Pol_Municipio:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fe06a5",strokeWidth:2,strokeOpacity:1}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.LOCALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["CATAST_Pol_Municipio","ESTADI_Pol_EntidadPob"],renderFeatureType:["CATAST_Pol_Municipio"],dataIdProperty:{CATAST_Pol_Municipio:["CMUNICIPIO"],ESTADI_Pol_EntidadPob:["CMUNICIPIO","CENTIDAD"]},queryProperties:{tProperty:{CATAST_Pol_Municipio:["MUNINOAC","MUNICIPIO"],ESTADI_Pol_EntidadPob:["ENTINOAC","ENTIDAD"]}},suggestionListHead:function(){return{label:e.getLocaleString("search.list.locality"),color:{"#feba1e":e.getLocaleString("search.list.locality")}}},outputProperties:{CATAST_Pol_Municipio:["MUNICIPIO"],ESTADI_Pol_EntidadPob:["MUNICIPIO","ENTIDAD"]},outputFormatLabel:{CATAST_Pol_Municipio:"{0}",ESTADI_Pol_EntidadPob:"{1} ({0})"},searchWeight:2,styles:{CATAST_Pol_Municipio:{polygon:{fillColor:"#000000",fillOpacity:0,strokeColor:"#ffffff",strokeWidth:5,strokeOpacity:1}},ESTADI_Pol_EntidadPob:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#feba1e",strokeWidth:2,strokeOpacity:1}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.COUNCIL]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Concejo",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CCONCEJO"],queryProperties:{tProperty:["CONCEJO"]},outputProperties:["MUNICIPIO","CONCEJO"],outputFormatLabel:"{1} ({0})",searchWeight:2,parser:e.getAddress,goTo:e.goToAddress,idPropertiesIdentifier:"#",suggestionListHead:function(){return{label:e.getLocaleString("search.list.council"),color:{"#49006a":e.getLocaleString("search.list.council")}}},styles:{CATAST_Pol_Concejo:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#49006a",strokeWidth:2,strokeOpacity:1}}}},e.availableSearchTypes[TC.Consts.searchType.STREET]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Lin_CalleEje",renderFeatureType:"CATAST_Txt_Calle",dataIdProperty:["CVIA"],queryProperties:{tProperty:["ENTINOAC","ENTIDADC"],sProperty:["VIA","VIANOAC"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.street"),color:{"#CB0000":e.getLocaleString("search.list.street")}}},outputProperties:["ENTIDADC","VIA"],outputFormatLabel:"{1}, {0}",styles:{CATAST_Lin_CalleEje:{line:{strokeColor:"#CB0000",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid"}},CATAST_Txt_Calle:{point:{label:"VIA",angle:"CADANGLE",fontColor:"#000000",fontSize:7,fontWeight:"bold",labelOutlineColor:"#ffffff",labelOutlineWidth:2}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.NUMBER]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Txt_Portal",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDADC","CVIA","PORTAL"],queryProperties:{tProperty:["ENTIDADC","ENTINOAC"],sProperty:["VIA","VIANOAC"],pProperty:["PORTAL"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.number"),color:{"#CB0000":e.getLocaleString("search.list.number")}}},outputProperties:["ENTIDADC","VIA","PORTAL"],outputFormatLabel:"{1} {2}, {0}",styles:{CATAST_Txt_Portal:{point:{radius:0,label:"PORTAL",angle:"CADANGLE",fontColor:"#CB0000",fontSize:14,fontWeight:"bold",labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.URBAN]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"ESTADI_Pol_EntidadPob",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDAD"],idPropertiesIdentifier:"#",queryProperties:{tProperty:["ENTINOAC","ENTIDAD"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.urban"),color:{"#feba1e":e.getLocaleString("search.list.urban")}}},outputProperties:["MUNICIPIO","ENTIDAD"],outputFormatLabel:"{1} ({0})",searchWeight:2,styles:{ESTADI_Pol_EntidadPob:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#feba1e",strokeWidth:2,strokeOpacity:1}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.COMMONWEALTH]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["POLUCI_Pol_MancoRSUg"],renderFeatureType:"",dataIdProperty:["CMANCOMUNI"],queryProperties:{tProperty:["MANCOMUNID"]},outputProperties:["MANCOMUNID"],outputFormatLabel:"{0}",searchWeight:1,styles:{POLUCI_Pol_MancoRSUg:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fc4e2a",strokeWidth:2,strokeOpacity:1}}}},e.allowedSearchTypes=e.options.allowedSearchTypes||{},e.options.allowedSearchTypes)for(var t in e.options.allowedSearchTypes)e.availableSearchTypes[t]&&!$.isEmptyObject(e.options.allowedSearchTypes[t])&&($.extend(e.availableSearchTypes[t],e.options.allowedSearchTypes[t]),t!=TC.Consts.searchType.MUNICIPALITY&&e.options.allowedSearchTypes[t].root&&(e.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root=e.options.allowedSearchTypes[t].root,e.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].limit=e.options.allowedSearchTypes[t].limit||!0,e.availableSearchTypes[TC.Consts.searchType.STREET].queryProperties.tProperty=e.availableSearchTypes[TC.Consts.searchType.NUMBER].queryProperties.tProperty=e.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].dataIdProperty));e.queryableFeatures=e.options.queryableFeatures||!1,e.UTMX_LEN=6,e.UTMY_LEN=7,e.CADASTRAL=TC.Consts.searchType.CADASTRAL,e.COORDINATES=TC.Consts.searchType.COORDINATES,e.MUNICIPALITY=TC.Consts.searchType.MUNICIPALITY,e.LOCALITY=TC.Consts.searchType.LOCALITY,e.COUNCIL=TC.Consts.searchType.COUNCIL,e.STREET=TC.Consts.searchType.STREET,e.NUMBER=TC.Consts.searchType.NUMBER,e.COMMONWEALTH=TC.Consts.searchType.COMMONWEALTH,e.URBAN=TC.Consts.searchType.URBAN,e.wrap=new TC.wrap.control.Search(e),e.interval=500,e.rootLabel="",e.searchTypes={CADASTRAL_SEARCH:{parser:e.getCadastralRef,goTo:e.goToCadastralRef},COORDINATES_SEARCH:{parser:e.getCoordinates,goTo:e.goToCoordinates},ADDRESS_SEARCH:{types:[TC.Consts.searchType.MUNICIPALITY,TC.Consts.searchType.LOCALITY,TC.Consts.searchType.COUNCIL,TC.Consts.searchType.URBAN,TC.Consts.searchType.STREET,TC.Consts.searchType.NUMBER],parser:e.getAddress,goTo:e.goToAddress}},e.NORMAL_PATTERNS={ROMAN_NUMBER:/M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3}){1,}?\S?\./g,ABSOLUTE_NOT_DOT:/[`~!@#$%^&*_|+\=?;:'"\{\}\[\]\\]/g,ABSOLUTE:/[`~!@#$%^&*_|+\=?;:'.\{\}\[\]\\]/g}},TC.inherit(TC.control.Search,TC.Control),function(){var e=TC.control.Search.prototype;e.CLASS="tc-ctl-search",TC.Consts.event.SEARCHQUERYEMPTY=TC.Consts.event.SEARCHQUERYEMPTY||"searchqueryempty.tc",e.template=TC.isDebug?TC.apiLocation+"TC/templates/Search.html":function(){function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"search.1"}).w('</h2><div class="tc-ctl-search-content"><input type="search" class="tc-ctl-search-txt" placeholder="').h("i18n",t,{},{$key:"search.placeholder"}).w('" title="').h("i18n",t,{},{$key:"search.instructions"}).w('" /><a title="').h("i18n",t,{},{$key:"search.instructions"}).w('" class="tc-ctl-btn tc-ctl-search-btn">').h("i18n",t,{},{$key:"search.2"}).w('</a><ul class="tc-ctl-search-list"></ul></div>')}return dust.register(e.CLASS,t),t.__dustBody=!0,t},e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t._search={data:[]};var r=function(){function e(e){return e.indexOf(".")>-1?e.split(".")[0]:e}function r(e,r,a){for(var s in t.allowedSearchTypes)if(t.availableSearchTypes[s].hasOwnProperty("featureType")&&(t.availableSearchTypes[s].featureType.indexOf(a)>-1||t.availableSearchTypes[s].renderFeatureType&&t.availableSearchTypes[s].renderFeatureType.indexOf(a)>-1)&&t.availableSearchTypes[s].styles[a].hasOwnProperty(r))return t.availableSearchTypes[s].styles[a][r][e];return console.log("No hay estilo definido"),TC.Cfg.styles[r][e]}return function(t,a,s,o){var i=this;o instanceof TC.Feature||i.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:i.layer,geom:o.geom}));var n=r(a,t,e(o.id));return s?o.getData().hasOwnProperty(n)?o.getData()[n]:"":n}}();e.loaded(function(){t.layerPromise=e.addLayer({id:TC.getUID(),title:"Búsquedas",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{polygon:{fillColor:r.bind(t,"polygon","fillColor",!1),fillOpacity:r.bind(t,"polygon","fillOpacity",!1),strokeColor:r.bind(t,"polygon","strokeColor",!1),strokeOpacity:r.bind(t,"polygon","strokeOpacity",!1),strokeWidth:r.bind(t,"polygon","strokeWidth",!1)},line:{strokeColor:r.bind(t,"line","strokeColor",!1),strokeOpacity:r.bind(t,"line","strokeOpacity",!1),strokeWidth:r.bind(t,"line","strokeWidth",!1)},point:{radius:r.bind(t,"point","radius",!1),height:r.bind(t,"point","height",!1),width:r.bind(t,"point","width",!1),fillColor:r.bind(t,"point","fillColor",!1),fillOpacity:r.bind(t,"point","fillOpacity",!1),strokeColor:r.bind(t,"point","strokeColor",!1),strokeWidth:r.bind(t,"point","strokeWidth",!1),fontSize:r.bind(t,"point","fontSize",!1),fontColor:r.bind(t,"point","fontColor",!1),labelOutlineColor:r.bind(t,"point","labelOutlineColor",!1),labelOutlineWidth:r.bind(t,"point","labelOutlineWidth",!1),label:r.bind(t,"point","label",!0),angle:r.bind(t,"point","angle",!0)}}}),$.when(t.layerPromise).then(function(e){t.layer=e})}),t.EMPTY_RESULTS_LABEL=t.getLocaleString("noResults"),t.EMPTY_RESULTS_TITLE=t.getLocaleString("checkCriterion"),t.OUTBBX_LABEL=t.getLocaleString("outsideOfLimits"),t.WFS_TYPE_ATTRS=["url","version","geometryName","featurePrefix","featureType","properties","outputFormat"]},e.renderData=function(e,t){var r=this;r._search=r._search||{};var a=function(){r.search(r.$text.val(),function(e){1===e.length?(r.$text.val(e[0].label),r.goToResult(e[0].id),r.$list.hide("fast")):0===e.length&&r.$list.hide("fast")})};TC.Control.prototype.renderData.call(r,e,function(){var e=function(){r.$text.val(r.$list[0].label||r.$list.find("li:not([header]) > a > span").text()),r.lastPattern=r.$text.val(),r.goToResult(r.$list[0].id||unescape(r.$list.find("li:not([header]) > a").attr("href")).substring(1)),r.$list.hide("fast")};r.$text=r._$div.find("input.tc-ctl-search-txt"),r.$list=r._$div.find(".tc-ctl-search-list"),r.$button=r._$div.find(".tc-ctl-search-btn"),r.$button.on(TC.Consts.event.CLICK,function(){r.getLayer().then(function(t){r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length>1||(t.features.length>0?t.map.zoomToFeatures(t.features):1===r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length?e():r.$text.trigger("keyup.autocomplete"))})}),r.$list.on(TC.Consts.event.CLICK,"a.tc-ctl-search-li-empty",function(){r.$list.hide("fast"),r.$text.focus()});try{if(r.$text.has($("::-ms-clear"))){var t;r.$text.on("mouseup",function(e){t=r.$text.val(),""!==t&&setTimeout(function(){var e=r.$text.val();""===e&&(r.$list.hide("fast"),a())},1)})}}catch(s){}r.$text.on("keypress",function(t){return 13==t.which?(t.preventDefault(),t.stopPropagation(),1===r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length&&e(),!1):void 0}).on("search",function(){0===r.$text.val().length&&(r.$list.hide("fast"),a())}).on("input",function(){0===r.$text.val().length&&(r.$list.hide("fast"),a())}).on("targetCleared.autocomplete",function(){r.$list.hide("fast")}).on("targetUpdated.autocomplete",function(){r.$list.find("li").length>0&&r.$list.show("fast")}),r.lastPattern="",r.retryTimeout=null,TC.loadJS(!r.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){r.$text=r._$div.find("input.tc-ctl-search-txt"),r.$text.autocomplete({link:"#",target:r.$list,minLength:2,ctx:r,source:function(e,t){e!=r.lastPattern&&(r.$list.hide("fast"),r.lastPattern=e,r.retryTimeout&&clearTimeout(r.retryTimeout),r.retryTimeout=setTimeout(function(){r.search(e,t)},r.interval))},callback:function(e){var t=$(e.target);$(e.target).is("a")||(t=$(e.target).closest("a")),r.$text.val($(t).find("span[hidden]").text()),r.lastPattern=r.$text.val(),r.goToResult(unescape($(t).attr("href")).substring(1),$(t).parent().attr("dataRole")),r.$text.autocomplete("clear")},buildHTML:function(e){for(var t=[],a=[],s=e.results.sort(function(e,t){return e.dataRole>t.dataRole?1:e.dataRole<t.dataRole?-1:0}),o=0;o<s.length;o++){var i=s[o];if(-1==a.indexOf(i.dataRole)){var n=this.ctx.availableSearchTypes[i.dataRole].suggestionListHead(),l='<li header><span class="header">'+n.label+"</span>";for(var c in n.color)l+='<span class="header-color" title="'+n.color[c]+'" style="color: '+c+';"></span>';t[t.length]=l+"</li>",a.push(i.dataRole)}var T=i.label,p=[],u=this.ctx.lastPattern;u=r.NORMAL_PATTERNS.ROMAN_NUMBER.test(u)?u.replace(r.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):u.replace(r.NORMAL_PATTERNS.ABSOLUTE,"");var h=u.trim().split(",");if(i.label.indexOf(this.ctx.LAT_LABEL)>-1&&i.label.indexOf(this.ctx.LON_LABEL)>-1||i.label.indexOf(this.ctx.UTMX_LABEL)>-1&&i.label.indexOf(this.ctx.UTMY_LABEL)>-1){h=this.ctx.lastPattern.split(" ");for(var C=0;C<h.length;C++)","==h[C].trim().slice(-1)&&(h[C]=h[C].slice(0,-1))}for(var f=0;f<h.length;f++){p.push("("+h[f].trim().replace(/\(/gi,"\\(").replace(/\)/gi,"\\)")+")");var y=/((\<)|(\>)|(\<\>))/gi.exec(h[f].trim());if(y)for(var d=h[f].trim().replace(/((\<)|(\>)|(\<\>))/gi,"").split(" "),g=0;g<d.length;g++)d[g].trim().length>0&&p.push("("+d[g].trim().replace(/\(/gi,"\\(").replace(/\)/gi,"\\)")+")")}var A="("+p.join("|")+")";A=A.replace(/a/gi,"[a|á]"),A=A.replace(/e/gi,"[e|é]"),A=A.replace(/i/gi,"[i|í]"),A=A.replace(/o/gi,"[o|ó]"),A=A.replace(/u/gi,"[u|ú|ü]");var L=new RegExp(A,"gi");T=i.label.replace(L,"<b>$1</b>"),t[t.length]='<li dataRole="'+i.dataRole+'"><a href="#'+encodeURIComponent(i.id)+'"><span hidden>'+i.label+"</span>"+T+"</a></li>"}return t.join("")}}),r.$text.add(r.$list).keydown(function(e){e.ctrlKey||e.altKey||e.shiftKey||(40===e.keyCode?(r.$text[0]==document.activeElement?r.$list.find("li:not([header]):first a").focus():r.$list.find("li:not([header]):last a").is(":focus")?r.$text.focus():r.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").nextAll("li:not([header]):first").find("a").focus(),e.preventDefault(),e.stopPropagation()):38===e.keyCode&&(r.$text[0]==document.activeElement?r.$list.find("li:not([header]):last a").focus():document.activeElement==r.$list.find("li:not([header]):first a").get(0)?r.$list.find("li:not([header]):last a").focus():r.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").prevAll("li:not([header]):first").find("a").focus(),e.preventDefault(),e.stopPropagation())),e.stopPropagation()})})}),$.isFunction(t)&&t()},e.getLayer=function(){var e=this;if(e.layerPromise=e.layerPromise||new $.Deferred,e.layer){var t=new $.Deferred;return t.resolve(e.layer),t}return e.layerPromise},e.getFeatures=function(){var e=this;return e.layer.features},e.cleanMap=function(){var e=this;e.getLayer().then(function(t){t.clearFeatures();for(var r=0;r<e.WFS_TYPE_ATTRS.length;r++)t.hasOwnProperty(e.WFS_TYPE_ATTRS[r])&&delete t[e.WFS_TYPE_ATTRS[r]]})},e.getMunicipalities=function(){var e=this;if(TC.cache.search=TC.cache.search||{},!TC.cache.search.municipalities){e._municipalitiesDeferred=new $.Deferred;var t={REQUEST:"GetFeature",SERVICE:"WFS",TYPENAME:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featureType,VERSION:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].version,PROPERTYNAME:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties.join(","),OUTPUTFORMAT:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat};e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix&&(t.TYPENAME=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix+":"+t.TYPENAME);var r=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].url+"?"+$.param(t);$.ajax({url:r,type:"GET",dataType:"text"}).done(function(t){var r;r=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featurePrefix,featureType:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featureType});var a=r.read(t);TC.cache.search.municipalities=[];for(var s=0;s<a.length;s++){var o=a[s];TC.cache.search.municipalities.push({label:o.data[e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties[1]],id:o.data[e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties[0]]})}TC.cache.search.municipalities.sort(function(e,t){var r;return r=e.label<t.label?-1:e.label>t.label?1:0}),e._municipalitiesDeferred.resolve(TC.cache.search.municipalities)})}return TC.cache.search.municipalities||e._municipalitiesDeferred.promise()},e.getCoordinates=function(e){var t=this,r=new $.Deferred,a=e.match(new RegExp("^"+$.trim(t.UTMX_LABEL.toLowerCase())+"*\\s*([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(t.UTMY_LABEL.toLowerCase())+"*\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$"));if(a&&(e=a[1]+" "+a[2]),a=e.match(new RegExp("^"+$.trim(t.LAT_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(t.LON_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")),a&&(e=a[1]+" "+a[3]),/\d/.test(e)&&(new RegExp("^([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$").test(e)||/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.test(e)))if(a=/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.exec(e),a&&(a[1].indexOf(",")>-1||a[3].indexOf(",")>-1)&&(a[1]=a[1].replace(",","."),a[3]=a[3].replace(",","."),e=a[1]+" "+a[3]),!a||a&&(a[1].indexOf(",")>-1?a[1].replace(",","."):a[1])<=180&&(a[3].indexOf(",")>-1?a[3].replace(",","."):a[3])<=90){a=new RegExp("^([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$").exec(e),a&&(a[1].indexOf(",")>-1||a[2].indexOf(",")>-1)&&(a[1]=a[1].replace(",","."),a[2]=a[2].replace(",","."),e=a[1]+" "+a[2]),e=e.replace(t.UTMX_LABEL,"").replace(t.UTMY_LABEL,"").replace(t.LON_LABEL,"").replace(t.LAT_LABEL,"");var s=TC.Util.parseCoords(e);if(s){var o=s[0].value,i=s[1].value,n=s[0].type===TC.Consts.UTM?t.UTMX:t.LAT,l=s[1].type===TC.Consts.UTM?t.UTMY:t.LON,c=n+o+l+i,T=t.getPoint(c);T&&!t.insideLimit(T)&&(o=s[1].value,i=s[0].value,n=s[1].type===TC.Consts.UTM?t.UTMX:t.LAT,l=s[0].type===TC.Consts.UTM?t.UTMY:t.LON,c=n+o+l+i,T=t.getPoint(c)),T?(t.availableSearchTypes[TC.Consts.searchType.COORDINATES].label=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.test(c)?t.getLocaleString("search.list.coordinates.utm")+t.map.crs:t.getLocaleString("search.list.coordinates.geo"),r.resolve([{id:c,label:t.getLabel(c),dataRole:TC.Consts.searchType.COORDINATES}])):r.resolve([])}}else r.resolve([]);else r.resolve([]);return r.promise()},e.getCadastralRef=function(e){var t=this,r=new $.Deferred,a=e.match(new RegExp($.trim(t.MUN_LABEL.toLowerCase())+"?\\s(.*)\\,\\s?"+$.trim(t.POL_LABEL.toLowerCase())+"?\\s(\\d{1,2})\\,\\s?"+$.trim(t.PAR_LABEL.toLowerCase())+"?\\s(\\d{1,4})"));a&&(e=a[1]+", "+a[2]+", "+a[3]);var s=e;return!/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(e)&&t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].suggestionRoot&&(s=t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].suggestionRoot+", "+e),/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(s)&&!new RegExp("^([0-9]{"+t.UTMX_LEN+"})\\s*\\,\\s*([0-9]{"+t.UTMY_LEN+"})$").test(e)?$.when(t.getMunicipalities()).then(function(e){var a=/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.exec(s);if(a){var o=new RegExp($.trim(a[1]).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),i=$.grep(e,function(e){return e=e.label||e.id||e,o.test(e)||o.test(t.removePunctuation(e))}),n=function(e,r,a,s){return{id:t.MUN+e+t.POL+a+t.PAR+s,label:t.getLabel(t.MUN+r+t.POL+a+t.PAR+s),dataRole:TC.Consts.searchType.CADASTRAL}};if(i.length>0)for(var l=0;l<i.length;l++)i[l]=n(i[l].id,i[l].label,$.trim(a[2]),$.trim(a[3]));/^[0-9]*$/g.test(a[1])&&i.push(n($.trim(a[1]),$.trim(a[1]),$.trim(a[2]),$.trim(a[3]))),r.resolve(i)}}):r.resolve([]),r.promise()},e.getAddress=function(e){var t=this,r=new $.Deferred,a=[],s=function(e){var r=[];for(var a in t.allowedSearchTypes)switch(!0){case a==TC.Consts.searchType.MUNICIPALITY:case a==TC.Consts.searchType.LOCALITY:case a==TC.Consts.searchType.COUNCIL:case a==TC.Consts.searchType.URBAN:case a==TC.Consts.searchType.STREET:case a==TC.Consts.searchType.NUMBER:t.availableSearchTypes[a]&&t.availableSearchTypes[a].hasOwnProperty("queryProperties")&&Object.keys(t.availableSearchTypes[a].queryProperties).length===Object.keys(e).length&&r.push(a)}return r=r.sort(function(e,r){return(t.availableSearchTypes[e].searchWeight||0)>=(t.availableSearchTypes[r].searchWeight||0)?1:0}).filter(function(e){for(var a=0;a<r.length;a++)if((t.availableSearchTypes[r[a]].searchWeight||0)>(t.availableSearchTypes[e].searchWeight||0))return!1;return!0})},o=function(e,r){var a;return a=t.availableSearchTypes[r].outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:t.availableSearchTypes[r].featurePrefix,featureType:t.availableSearchTypes[r].featureType}),a.read(e)},i=function(e){var r="";e=t.removePunctuation(e);var a,s=/(.*)\s<>\s.*/;return(e.indexOf("(")>-1||e.indexOf(")")>-1)&&(s=/(.*)(\s<>\s.*\(.*\))/,e.indexOf("<>")>-1&&s.test(e)?(a=e.match(s),null!==a&&(r=e.replace(a[2],""),r=r.splitRemoveWhiteSpaces(",").join(","))):(s=/\(.*\)/,s.test(e)||(s=/\(.*/,s.test(e)||(s=/.*\)/,s.test(e)||(s=/\(.*\)/))),r=e.replace(s,""),r=r.splitRemoveWhiteSpaces(",").join(",")),e=r),e=t.NORMAL_PATTERNS.ROMAN_NUMBER.test(e)?e.replace(t.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):e.replace(t.NORMAL_PATTERNS.ABSOLUTE,""),e.toLowerCase()},n=function(e){for(var r=function(e){return/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.test(e)},a=function(e){var r=[],a=/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.exec(e);if(a){for(var s=1;s<a.length;s++)a[s].trim().length>0&&r.push(a[s].trim());return r.join(t._LIKE_PATTERN)}return e},s=function(e){return/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.test(e)},o=function(e){var r=[],a=/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.exec(e);if(a){for(var s=1;s<a.length;s++)a[s].trim().length>0&&r.push(a[s].trim());return r.join(t._LIKE_PATTERN)}return e},i=function(e){return/^(sn|S\/N|s\/n|s\-n)$/i.test(e)},n=function(e){var t=/^(sn|S\/N|s\/n|s\-n)$/i.exec(e);return t?"s*n":e},l=function(e){return/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.test(e)},c=function(e){var t=/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);return t?e:e},T=[r,s,i,l],p=[a,o,n,c],u=0;u<p.length&&!T[u].call(t,e);)u++;return u<p.length?p[u].call(t,e):e},l=function(e,r,a){var s=new $.Deferred;e=e.trim(),","==e.charAt(e.length-1)&&(e=e.substring(0,e.length-1));var o=[],i=function(e){if(r)for(var t=0;t<e.length;t++)a?e[t].t&&(e[t].t=r):e.push($.extend({},e[t],{t:r}))},l=function(e,t){var r=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(r){var a=function(){return n((r[3]||r[4]||r[5]||r[6]).trim())};return/^([^0-9]+)$/i.test(r[1].trim())&&/^([^0-9]+)$/i.test(r[2].trim())?(t.push({t:r[1].trim(),s:r[2].trim(),p:a()}),t.push({t:r[2].trim(),s:r[1].trim(),p:a()})):t.push(/^([^0-9]+)$/i.test(r[1].trim())?{t:r[1].trim(),s:r[2].trim(),p:a()}:{s:r[1].trim(),t:r[2].trim(),p:a()}),i(t),!0}return!1},c=function(e,t){var r=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);return r?(t.push({t:r[2].trim(),s:r[1].trim(),p:n((r[3]||r[4]||r[5]||r[6]).trim())}),i(t),!0):!1},T=function(e,r){var a=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))$/i.exec(e);if(a){if(/^([^0-9]+)$/i.test(a[1].trim())&&/^([^0-9]+)$/i.test(a[2].trim()))r.push({t:a[1].trim(),s:a[2].trim()}),r.push({s:a[1].trim(),t:a[2].trim()});else{var s=function(e){for(var r=e.split(" ").reverse(),a=[],s=0;s<r.length;s++)1==r[s].length&&(a.push(r[s]),r[s]="");return a.length>0?r.reverse().join(" ").trim()+t._LIKE_PATTERN+a.reverse().join(t._LIKE_PATTERN):r.reverse().join(" ").trim()};r.push(/^([^0-9]+)$/i.test(a[1].trim())?{t:a[1].trim(),s:s(a[2].trim())}:{s:s(a[1].trim()),t:a[2].trim()})}return i(r),!0}return!1},p=function(e,r){var a=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)$/i.exec(e);if(a){for(var s={},o=e.split(",").reverse(),l=0;l<o.length;l++)if(/^([^0-9\,]+)$/i.test(o[l].trim()))s.t=o[l].trim();else if(/(\s*\d+)/i.test(o[l].trim()))if(-1==o[l].trim().indexOf(" "))s.s=o[l].trim();else{for(var c=o[l].trim().split(" ").reverse(),T=function(e){var t=/^(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e.trim());return t?(s.p=n(e.trim()),!0):!1},p=0,u=c[p].trim();p<c.length&&!T(u);)p++,p<c.length&&(u+=c[p]);if(s.p){for(var h=c,C=0;C<h.length;C++){for(var f=!1,y=0;y<h[C].split("").length;y++)s.p.indexOf(h[C][y])>-1&&(f=!0);if(f){{h[C]}if(h[C]="",s.p==n(u))break}}if(/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+)$/i.test(c.reverse().join(" ").trim())){for(var d=[],g=c.reverse(),A=0;A<g.length;A++)1==g[A].trim().length&&(d.push(g[A].trim()),g[A]="");s.s=d.length>0?g.reverse().join(" ").trim()+t._LIKE_PATTERN+d.reverse().join(t._LIKE_PATTERN):g.reverse().join(" ").trim()}r.push({t:s.t,s:s.s+" "+s.p})}else s.s=o[l].trim()}return r.push(s),i(r),!0}return!1},u=function(e,t){var a=/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9\<\>]+)$/i.exec(e);return a?(t.push(r?{t:r,s:a[1].trim()}:{t:a[1].trim()}),!0):!1},h=function(e,t){var a=/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/]+)\s*\,?\s*(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);return a&&e.indexOf(",")>-1&&e.split(",").length<3?(t.push(r?{t:r,s:a[1].trim(),p:n(a[2].trim())}:{t:a[1].trim(),s:a[2].trim()}),!0):!1},C=function(e,t){var a=/^([^\,][0-9\s*\-\.\(\)\/]+)\s*\,?\s*(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);return a&&r?(t.push({t:r,s:a[1].trim(),p:n(a[2].trim())}),!0):!1},f=function(){for(var r=[function(e){return e.length>=3},function(e){return/^\d+$/.test(e)?!1:/^\d+\,\s*\d+$/.test(e)?!1:!0}],a=0;a<r.length;a++)if(!r[a].call(t,e))return!1;return!0};if(f(e)){var y=[l,c,T,p];y=r&&e.split(",").length<3?[h,C,u].concat(y):y.concat([h,C,u]);for(var d=0;d<y.length&&!y[d].call(t,e,o);)d++}if(o.length>0&&r){var g=new $.Deferred;t.rootLabel?g.resolve(t.rootLabel):$.when(t.getMunicipalities()).then(function(e){for(var a=0;a<e.length;a++)if(e[a].id==r){t.rootLabel=t.removePunctuation(e[a].label).toLowerCase();break}g.resolve(t.rootLabel)}),$.when(g).then(function(e){if(e)for(var a=o.length;a--;){var i=o[a];if(e.indexOf(t.removePunctuation(i.s).toLowerCase())>-1&&i.t==r){o.splice(a,1);break}}s.resolve(o)})}else s.resolve(o);return s.promise()},c=function(e,r){return t.availableSearchTypes[e].queryProperties[r+"Property"]},T=function(e,r){return t.availableSearchTypes[e][r]},p=function(e,r){var a=/([\-\"\.\º\(\)\/])/g;return a.test(r)&&(r=r.replace(a,"\\$1")),r.toString().indexOf(t._LIKE_PATTERN)>-1?'<Or><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+e+"</PropertyName><Literal>"+r.toLowerCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+'</Literal></PropertyIsLike><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+e+"</PropertyName><Literal>"+r.toUpperCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsLike></Or>":"<PropertyIsEqualTo><PropertyName>"+e+"</PropertyName><Literal>"+r.replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsEqualTo>"},u=function(e,t){var r;if(e instanceof Array||"string"==typeof e){if(e instanceof Array&&e.length>1){r="<ogc:Or>";for(var a=0;a<e.length;a++)r+=p($.trim(e[a]),t);return r+="</ogc:Or>"}return p($.trim(e instanceof Array&&1===e.length?e[0]:e),t)}var s=[];for(var o in e)if(e[o]instanceof Array&&e[o].length>1){
r="<Or>";for(var a=0;a<e[o].length;a++)r+=p($.trim(e[o][a]),t);r+="</Or>",s.push('(<Filter xmlns="http://www.opengis.net/ogc">'+r+"</Filter>)")}else{var i=e[o];e[o]instanceof Array&&1==e[o].length&&(i=e[o][0]),s.push('(<Filter xmlns="http://www.opengis.net/ogc"><Or>'+p($.trim(i),t)+"</Or></Filter>)")}return s.join("")},h=function(e,r){var a={};a.multiL=!1,a.f="";var s;switch(r){case t.NUMBER:if(s=[],t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root||!/(\<|\>|\<\>)/gi.exec(e.t)&&!/(\<|\>|\<\>)/gi.exec(e.s))s.push(u(c(r,"t"),t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root?e.t:t._LIKE_PATTERN+e.t+t._LIKE_PATTERN)),s.push(u(c(r,"s"),t._LIKE_PATTERN+e.s+t._LIKE_PATTERN));else{var o=/(\<|\>|\<\>)/gi.exec(e.t);s.push(o?u(c(r,"t"),t._LIKE_PATTERN+e.t.substring(0,e.t.indexOf(o[0])).trim()+t._LIKE_PATTERN):u(c(r,"t"),t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root?e.t:t._LIKE_PATTERN+e.t+t._LIKE_PATTERN)),o=/(\<|\>|\<\>)/gi.exec(e.s),s.push(o?u(c(r,"s"),t._LIKE_PATTERN+e.s.substring(0,e.s.indexOf(o[0])).trim()+t._LIKE_PATTERN):u(c(r,"s"),t._LIKE_PATTERN+e.s+t._LIKE_PATTERN))}s.push(u(c(r,"p"),e.p+"*")),a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;case t.STREET:if(s=[],t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root||!/(\<|\>|\<\>)/gi.exec(e.t)&&!/(\<|\>|\<\>)/gi.exec(e.s))s.push(u(c(r,"t"),t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root?e.t:t._LIKE_PATTERN+e.t+t._LIKE_PATTERN)),s.push(u(c(r,"s"),t._LIKE_PATTERN+e.s+t._LIKE_PATTERN));else{var o=/(\<|\>|\<\>)/gi.exec(e.t);s.push(o?u(c(r,"t"),t._LIKE_PATTERN+e.t.substring(0,e.t.indexOf(o[0])).trim()+t._LIKE_PATTERN):u(c(r,"t"),t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root?e.t:t._LIKE_PATTERN+e.t+t._LIKE_PATTERN)),o=/(\<|\>|\<\>)/gi.exec(e.s),s.push(o?u(c(r,"s"),t._LIKE_PATTERN+e.s.substring(0,e.s.indexOf(o[0])).trim()+t._LIKE_PATTERN):u(c(r,"s"),t._LIKE_PATTERN+e.s+t._LIKE_PATTERN))}a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+s.join("")+"</ogc:And></ogc:Filter>";break;case t.COUNCIL:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+u(c(r,"t"),t._LIKE_PATTERN+e.t+t._LIKE_PATTERN)+"</ogc:Filter>";break;case t.URBAN:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+u(c(r,"t"),t._LIKE_PATTERN+e.t+t._LIKE_PATTERN)+"</ogc:Filter>";break;case t.LOCALITY:a.f=u(c(r,"t"),t._LIKE_PATTERN+e.t+t._LIKE_PATTERN),a.multiL=!0;break;case t.MUNICIPALITY:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+u(c(r,"t"),t._LIKE_PATTERN+e.t+t._LIKE_PATTERN)+"</ogc:Filter>"}return a},C=function(e,r,a,s){var o=h(e,r),i={REQUEST:"GetFeature",SERVICE:"WFS",MAXFEATURES:20,VERSION:t.availableSearchTypes[r].version,OUTPUTFORMAT:t.availableSearchTypes[r].outputFormat},n=T(r,"featureType");if(n instanceof Array){for(var l=[],c=0;c<n.length;c++)l.push(t.availableSearchTypes[r].featurePrefix?t.availableSearchTypes[r].featurePrefix+":"+$.trim(n[c]):$.trim(n[c]));i.TYPENAME=l.join(",")}else i.TYPENAME=t.availableSearchTypes[r].featurePrefix?t.availableSearchTypes[r].featurePrefix+":"+$.trim(n):$.trim(n);var p=function(e){if(""!==(e||"")){if(e instanceof Array)return e.join(",");var t=[];if(e instanceof Object)for(var r in e){var a=e[r][0];e[r].length>1&&(a=e[r].join(",")),t.push(a)}return t}},u=p(a),C=p(s);if(u instanceof Array&&C instanceof Array){i.PROPERTYNAME="";for(var c=0;c<u.length;c++)i.PROPERTYNAME+="("+u[c]+","+C[c]+")"}else i.PROPERTYNAME=u+","+C;return i.FILTER=o.f,$.param(i)},f=function(e,t,r,s){for(var o=0;o<e.length;o++){var i=[],n=[],l="",c=r,p=s,u=T(t,"outputFormatLabel"),h=e[o].id.split(".").slice(0,1).shift();r instanceof Array||(c=r[h],p=s[h],u=u[h]);for(var C=0;C<c.length;C++)i.push(e[o].data[c[C]]);for(var C=0;C<p.length;C++)n.push(e[o].data[p[C]]);var f=function(e){for(var t=[],r=0;r<e.length;r++)-1==jQuery.inArray(e[r],t)&&t.push(e[r]);return t};i instanceof Array&&u&&f(i).length>1?l=u.tcFormat(i):i instanceof Array&&1==f(i).length&&(l=i[0]);var y=l.toCamelCase(),d=function(e,t){for(var r=0;r<a.length;r++)if(a[r].dataRole==e&&a[r].text.toLowerCase().trim()==t.toLowerCase().trim())return!0;return!1};d(t,y)||a.push({text:y,label:y,id:n.join("#"),dataRole:t,dataLayer:h})}};return e=i(e),$.when(l(e,t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].root||"",t.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY].limit||!1)).then(function(e){function i(e,r){var a=T(r,"outputProperties"),s=T(r,"dataIdProperty");return $.ajax({url:t.availableSearchTypes[r].url,type:"POST",contentType:"application/x-www-form-urlencoded;charset=UTF-8",dataType:"text",data:C(e,r,a,s),beforeSend:function(){t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>'),t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=o(e,r);f(t,r,a,s)}).fail(function(e){"abort"!==e.statusText&&alert("error")})}if(e){if(t._search.data=a,t.request){for(var n=0;n<t.request.length;n++)t.request[n].abort();t.request=[]}else t.request=[];$.map(e,function(e,r){for(var a=s(e),r=0;r<a.length;r++){var o=a[r];o&&t.allowedSearchTypes[o]&&t.request.push(i(e,o))}}),$.when.apply($,t.request).then(function(){t.request=null,r.resolve(a)})}else r.resolve(a)}),r.promise()},e.search=function(e,t){var r=this,a=[];if(e=$.trim(e),e.length>0){e=e.toLowerCase();var s=[],o=function(t){var o=new $.Deferred;s.push(o),$.when(t.call(r,e)).then(function(e){a=a.concat(e),o.resolve(a)})},i=!1;for(var n in r.allowedSearchTypes)switch(n){case TC.Consts.searchType.CADASTRAL:o(r.availableSearchTypes[TC.Consts.searchType.CADASTRAL].parser);break;case TC.Consts.searchType.COORDINATES:o(r.availableSearchTypes[TC.Consts.searchType.COORDINATES].parser);break;case TC.Consts.searchType.MUNICIPALITY:case TC.Consts.searchType.LOCALITY:case TC.Consts.searchType.COUNCIL:case TC.Consts.searchType.URBAN:case TC.Consts.searchType.STREET:case TC.Consts.searchType.NUMBER:i||(o(r.availableSearchTypes[n].parser),i=!0);break;default:r.allowedSearchTypes[n].parser?o(r.allowedSearchTypes[n].parser):console.log("Falta implementación del método parser")}$.when.apply(r,s).then(function(){a&&(r._search.data=a=a.sort(function(e,t){var r,a=/(\d+)/,s="";return a.test(e.label)&&a.test(t.label)?(r=e.label.match(a)[1],s=t.label.match(a)[1]):(r=e.label,s=t.label),r>s?1:s>r?-1:0})),t&&t(a),0===a.length&&(r.cleanMap(),(!r.layer||r.layer&&0===r.layer.features.length)&&(r.$list.html('<li><a title="'+r.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+r.EMPTY_RESULTS_LABEL+"</a></li>"),r.$text.trigger("targetUpdated.autocomplete")))})}else r.cleanMap()};var t=function(e){var t=this;if(e&&e.length>0)for(var r=0;r<e.length;r++)e[r].showsPopup!=t.queryableFeatures&&(e[r].showsPopup=t.queryableFeatures)};e.goToResult=function(e,r){var s=this,o=null;s.loading||(s.loading=s.map.getControlsByClass("TC.control.LoadingIndicator")[0]);var i;i=s.loading.addWait(),Modernizr.mq("(max-width: 30em)")&&(s.$text.blur(),s.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{})),s.cleanMap();var n=!1,l=!0;for(var c in s.allowedSearchTypes)if(l)switch(c){case TC.Consts.searchType.CADASTRAL:o=s.availableSearchTypes[TC.Consts.searchType.CADASTRAL].goTo.call(s,e),null!==o&&(l=!1);break;case TC.Consts.searchType.COORDINATES:o=s.availableSearchTypes[TC.Consts.searchType.COORDINATES].goTo.call(s,e),null!==o&&(l=!1);break;case TC.Consts.searchType.MUNICIPALITY:case TC.Consts.searchType.LOCALITY:case TC.Consts.searchType.COUNCIL:case TC.Consts.searchType.URBAN:case TC.Consts.searchType.STREET:case TC.Consts.searchType.NUMBER:var T=r||a.call(s,e).dataRole;T&&(o=s.availableSearchTypes[T].goTo.call(s,e,T),null!==o&&(l=!1));break;default:s.allowedSearchTypes[c].goTo?(n=!0,o=s.allowedSearchTypes[c].goTo.call(s,e),null!==o&&(l=!1)):console.log("Falta implementación del método goTo")}s.loading.removeWait(i),o?(i=s.loading.addWait(),s.getLayer().then(function(r){switch(!0){case o.params.type==TC.Consts.layerType.VECTOR:for(var a=0;a<s.WFS_TYPE_ATTRS.length;a++)r.hasOwnProperty(s.WFS_TYPE_ATTRS[a])&&delete r[s.WFS_TYPE_ATTRS[a]];break;case o.params.type==TC.Consts.layerType.WFS:for(var a=0;a<s.WFS_TYPE_ATTRS.length;a++)r[s.WFS_TYPE_ATTRS[a]]=o.params[s.WFS_TYPE_ATTRS[a]]}r.type=o.params.type,r.refresh().then(function(){s.map.one(TC.Consts.event.LAYERUPDATE,function(e){e.layer==r&&(s.map.one(TC.Consts.event.FEATURESADD,function(e){e.layer==r&&(!e.layer.features||0==e.layer.features.length&&e.layer.wrap.layer.getSource().getFeatures()?(s.$list.hide("fast"),e.layer.map.setExtent(e.layer.wrap.layer.getSource().getExtent())):e.layer.features&&e.layer.features.length>0?(s.$list.hide("fast"),t.call(s,e.layer.features),s.layer.map.zoomToFeatures(e.layer.features)):e.layer.features&&0==e.layer.features.length&&o.params.type==TC.Consts.layerType.WFS&&(s.$list.html(o.emptyResultHTML),s.$text.trigger("targetUpdated.autocomplete"),s.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))),s.loading.removeWait(i))}),o.params.type!=TC.Consts.layerType.WFS&&s.map.one(TC.Consts.event.FEATURESADD,function(e){e.layer.features&&0==e.layer.features.length&&(s.$list.html(o.emptyResultHTML),s.$text.trigger("targetUpdated.autocomplete"),s.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY)))}),e.layer.features&&e.layer.features.length>0?(s.$list.hide("fast"),t.call(s,e.layer.features),s.layer.map.zoomToFeatures(s.layer.features),s.loading.removeWait(i)):e.layer.features&&0==e.layer.features.length&&o.params.type==TC.Consts.layerType.WFS&&(s.$list.html(o.emptyResultHTML),s.$text.trigger("targetUpdated.autocomplete"),s.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY)),s.loading.removeWait(i)))}),0==r.features.length&&s.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:r,id:e}))})})):n||s.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))};var r=function(e){var t=this;if(e&&e.layer==t.layer){var r,a,s,o=e.id,i=t.getPoint(o);if(i&&t.insideLimit(i))a=t.getLabel(o),s=t.layer.addMarker(i,$.extend({},t.map.options.styles.point,{title:a,group:a})),r=t.map.options.pointBoundsRadius,t.map.setExtent([i[0]-r,i[1]-r,i[0]+r,i[1]+r]);else{var n=/^Lat((?:[+-]?)\d+(?:\.\d+)?)Lon((?:[+-]?)\d+(?:\.\d+)?)$/.exec(o);o=t.LAT+n[2]+t.LON+n[1],i=t.getPoint(o),i&&t.insideLimit(i)&&(a=t.getLabel(o),s=t.layer.addMarker(i,$.extend({},t.map.options.styles.point,{title:a,group:a})),r=t.map.options.pointBoundsRadius,t.map.setExtent([i[0]-r,i[1]-r,i[0]+r,i[1]+r]),t.$text.val(a))}$.when(s).then(function(e){t.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:t.layer,features:[e]}))})}};e.goToCoordinates=function(e){var t=this,a={};if(/^X(\d+(?:[\.\,]\d+)?)Y(\d+(?:[\.\,]\d+)?)$/.test(e)||/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.test(e)){a.params={type:TC.Consts.layerType.VECTOR,styles:{point:{}}},a.emptyResultHTML='<li><a class="tc-ctl-search-li-empty">'+t.OUTBBX_LABEL+"</a></li>";var s=r.bind(t);return t.map.one(TC.Consts.event.LAYERUPDATE,s),a}return null},e.goToCadastralRef=function(e){var t=this,r={};if(/^\M(\d+)\P(\d{1,2})Par{1}(\d{1,4})/g.test(e)){var a=/^\M(\d+)\P(\d{1,2})Par{1}(\d{1,4})/g.exec(e);return r.params={type:TC.Consts.layerType.WFS,url:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].url,version:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].version,geometryName:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].geometryName,featurePrefix:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix,featureType:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featureType,properties:[{name:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.municipality,value:$.trim(a[1]),type:TC.Consts.comparison.EQUAL_TO},{name:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.polygon,value:$.trim(a[2]),type:TC.Consts.comparison.EQUAL_TO},{name:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.parcel,value:$.trim(a[3]),type:TC.Consts.comparison.EQUAL_TO}],outputFormat:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat,styles:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].styles},r.emptyResultHTML='<li><a title="'+t.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+t.EMPTY_RESULTS_LABEL+"</a></li>",r}return null};var a=function(e,t){for(var r=this,a=0;a<r._search.data.length;a++)if(r._search.data[a].id==e&&(!t||t&&r._search.data[a].dataRole===t))return r._search.data[a]};e.goToAddress=function(e,t){var r,s=this,o={},i=function(t,r){var a=[],s=e.split("#");if(e.indexOf("#")>-1&&r instanceof Array){a={};for(var o=0;o<r.length;o++){a[r[o]]=[];for(var i=0;i<t[r[o]].length;i++)a[r[o]].push({name:t[r[o]][i],value:s[i],type:TC.Consts.comparison.EQUAL_TO})}}else if(-1==e.indexOf("#")&&r instanceof Array){var n=t;a={};for(var o=0;o<r.length;o++)if(!a.hasOwnProperty(r[o])){a[r[o]]=[],n instanceof Object&&t.hasOwnProperty(r[o])&&(n=t[r[o]]);for(var i=0;i<n.length;i++)i<s.length&&a[r[o]].push({name:n[i],value:s[i],type:TC.Consts.comparison.EQUAL_TO})}}else{t instanceof Object&&t.hasOwnProperty(r)&&(t=t[r]);for(var o=0;o<t.length;o++)a.push({name:t[o],value:s[o],type:TC.Consts.comparison.EQUAL_TO})}return a};if(r=a.call(s,e,t),r&&r.dataRole){var n=s.availableSearchTypes[r.dataRole],l=r.dataLayer;return n.renderFeatureType&&(r.dataLayer instanceof Array||(l=[r.dataLayer]),l=l.concat(n.renderFeatureType instanceof Array?n.renderFeatureType:[n.renderFeatureType])),o.params={type:TC.Consts.layerType.WFS,url:n.url,version:n.version,geometryName:n.geometryName,featurePrefix:n.featurePrefix,featureType:l,properties:i(n.dataIdProperty,l),outputFormat:n.outputFormat,styles:n.styles},o}return null},e.getPoint=function(e){var t,r=this,a=r.map.wrap.isGeo(),s=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.exec(e);if(s&&3===s.length)t=[parseFloat(s[1]),parseFloat(s[2])],a&&(t=TC.Util.reproject(t,r.map.options.utmCrs,r.map.crs));else{if(s=/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e),s&&3===s.length&&(t=[parseFloat(s[2]),parseFloat(s[1])],!a))return TC.Util.reproject(t,r.map.options.geoCrs,r.map.crs);if(s=/^Lon((?:[+-]?)\d+(?:[.,]\d+)?)Lat((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e),s&&3===s.length&&(t=[parseFloat(s[2]),parseFloat(s[1])],!a))return TC.Util.reproject(t,r.map.options.geoCrs,r.map.crs)}return t},e.insideLimit=function(e){var t=this,r=function(e,t){return e instanceof Array?t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3]:!0};return r(t.map.options.maxExtent,e)?!0:!1},e.getPattern=function(){var e=this;return e.$text.val()},e.getLabel=function(e){var t=this,r=e,a=TC.Util.getMapLocale(t.map);if(e.match(new RegExp("^(?:"+t.LAT+"[-\\d])|(?:"+t.UTMX+"[\\d])"))){r=r.replace(t.LAT,t.LAT_LABEL).replace(t.LON," "+t.LON_LABEL).replace(t.UTMX,t.UTMX_LABEL).replace(t.UTMY," "+t.UTMY_LABEL);var s=r.match(new RegExp("^"+$.trim(t.LAT_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(t.LON_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$"));s&&(r=r.replace(s[1],parseFloat(s[1]).toLocaleString(a)),r=r.replace(s[3],parseFloat(s[3]).toLocaleString(a)));var o=1.1.toLocaleString(a).substring(1,2),s=r.match(new RegExp("^"+$.trim(t.UTMX_LABEL)+"*\\s*([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(t.UTMY_LABEL)+"*\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$"));s&&(Number.isInteger(parseFloat(s[1]))||(r=r.replace(s[1],s[1].replace(".",o))),Number.isInteger(parseFloat(s[2]))||(r=r.replace(s[2],s[2].replace(".",o))))}else if(e.match(new RegExp("^(?:"+t.LON+"[-\\d])"))){r=r.replace(t.LON,t.LON_LABEL).replace(t.LAT," "+t.LAT_LABEL);var s=r.match(new RegExp("^"+$.trim(t.LON_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(t.LAT_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$"));s&&(r=r.replace(s[1],parseFloat(s[1]).toLocaleString(a)),r=r.replace(s[3],parseFloat(s[3]).toLocaleString(a)))}else if(e.match(new RegExp("^(?:(\\"+t.MUN+"{1})(.*)(\\"+t.POL+"{1})(\\d{1,2})(\\"+t.PAR+"{1})(\\d{1,4}))"))){var s=e.match(new RegExp("^(?:(\\"+t.MUN+"{1})(.*)(\\"+t.POL+"{1})(\\d{1,2})(\\"+t.PAR+"{1})(\\d{1,4}))"));r=t.MUN_LABEL+s[2]+", "+t.POL_LABEL+s[4]+", "+t.PAR_LABEL+s[6]}return r},e.removePunctuation=function(e){e=e||"";for(var t=new Array(e.length),r={"á":"a","Á":"A","é":"e","É":"E","í":"i","Í":"I","ó":"o","Ó":"O","ú":"u","ü":"u","Ú":"U","Ü":"U"},a=0,s=e.length;s>a;a++)t[a]=r[e.charAt(a)]||e.charAt(a);return t.join("")},e.decodeEntities=function(e){return $("<div/>").html(e).text()}}(),String.prototype.tcFormat||(String.prototype.tcFormat=function(){var e=(arguments||[""])[0];return this.replace(/{(\d+)}/g,function(t,r){return"undefined"!=typeof e[r]?e[r]:t})}),String.prototype.splitRemoveWhiteSpaces||(String.prototype.splitRemoveWhiteSpaces=function(e){for(var t=[],r=this.split(e),a=0;a<r.length;a++)$.trim(r[a]).length>0&&t.push($.trim(r[a]));return t}),String.prototype.toCamelCase||(String.prototype.toCamelCase=function(){var e=this.toLowerCase(),t=this.toLowerCase().match(/\W+(.)/g);if(t)for(var r=0;r<t.length;r++)/[;:.<>\{\}\[\]\/\s()]/g.test(t[r])&&(e=e.replace(t[r],t[r].toUpperCase()));return e.charAt(0).toUpperCase()+e.substring(1)}),Array.prototype.hasOwnProperty("findByProperty")||Object.defineProperty(Array.prototype,"findByProperty",{enumerable:!1,writable:!0,value:function(e,t){for(var r=0;r<this.length;r++)if(this[r][e]==t)return this[r]}});