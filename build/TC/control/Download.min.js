TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.Download=function(e){var t=this;t._classSelector="."+t.CLASS,TC.Control.apply(t,arguments);var o=e||{};t._$dialogDiv=$(TC.Util.getDiv(o.dialogDiv)),o.dialogDiv||t._$dialogDiv.appendTo("body")},TC.inherit(TC.control.Download,TC.Control),function(){var e=TC.control.Download.prototype;e.CLASS="tc-ctl-download",e.template={},TC.isDebug?(e.template[e.CLASS]=TC.apiLocation+"TC/templates/Download.html",e.template[e.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/DownloadDialog.html"):(e.template[e.CLASS]=function(){function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"download"}).w('</h2><div><div class="tc-ctl-download-div"><div class="tc-ctl-download"><div class="tc-group tc-ctl-download-cnt"><label>').h("i18n",t,{},{$key:"format"}).w(':</label><select id="download-format" class="tc-combo"><option value="GML32">GML</option><option value="application/json">GeoJSON</option><option value="application/vnd.google-earth.kml+xml">KML (Google Earth)</option><option value="shape-zip">Shape (ESRI)</option></select></div></div><form class="tc-ctl-download-form" method="post" enctype="text/plain"><!--HACK: El servicio WFS espera que en el payload del POST llegue la consulta WFS (en este caso GetFeature). El problema es que debe llegar solo la consulta,no en formato clave=valor. Por tanto, lo único que se me ha ocurrido es buscar el primer signo ‘=’ de la consulta, y poner lo que hay a la izquerda en el namedel input Y lo de la derecha en el value (se inserta desde al archivo Download.js)--><input type="hidden" name="<wfs:GetFeature xmlns:xsi" class="tc-ctl-download-query" /></form><div class="tc-group tc-ctl-download-cnt"><i class="tc-ctl-download-help icon-question-sign" data-toggle="tooltip" data-placement="top" title="').h("i18n",t,{},{$key:"showDownloadHelp"}).w('"></i><button class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",t,{},{$key:"downloadLayersFromCurrentExtent"}).w('">').h("i18n",t,{},{$key:"download"}).w('</button></div><div class="tc-alert alert-warning tc-hidden"><p id="zoom-msg"><strong>').h("i18n",t,{},{$key:"tooManyFeatures"}).w(": </strong>").h("i18n",t,{},{$key:"tooManyFeatures.instructions"}).w('</p><p id="layers-msg"><strong>').h("i18n",t,{},{$key:"noLayersLoaded"}).w(": </strong>").h("i18n",t,{},{$key:"noLayersLoaded.instructions"}).w('</p><p id="url-msg"><strong>').h("i18n",t,{},{$key:"tooManySelectedLayers"}).w(": </strong>").h("i18n",t,{},{$key:"tooManySelectedLayers.instructions"}).w('</p><p id="noFeatures-msg"><strong>').h("i18n",t,{},{$key:"noData"}).w(": </strong>").h("i18n",t,{},{$key:"noData.instructions"}).w("</p></div></div></div>")}return dust.register(e.CLASS,t),t.__dustBody=!0,t},e.template[e.CLASS+"-dialog"]=function(){function t(e,t){return e.w(' <div class="tc-ctl-download-help-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"downloadData"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",t,{},{$key:"dl.instructions.1|s"}).w("</p><ul><li>").h("i18n",t,{},{$key:"dl.instructions.2|s"}).w("</li><li>").h("i18n",t,{},{$key:"dl.instructions.3|s"}).w("</li><li>").h("i18n",t,{},{$key:"dl.instructions.4|s"}).w("<ul><li>").h("i18n",t,{},{$key:"dl.instructions.5|s"}).w("</li><li>").h("i18n",t,{},{$key:"dl.instructions.6|s"}).w('</li></ul></li></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",t,{},{$key:"close"}).w("</button></div></div></div>")}return dust.register(e.CLASS+"-dialog",t),t.__dustBody=!0,t}),e.render=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e)}).then(function(){TC.Control.prototype.render.call(t,e)})},e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);var o=[],n=0,l=function(){return t.options.serviceUrl?void $.get(t.options.serviceUrl+"?request=getcapabilities").done(function(e){var t=TC.Util.getElementByNodeName(e,"ows:Operation");if(t&&t.length>0){for(var o,l=0;l<t.length;l++)"GetFeature"==t[l].attributes.name.value&&(o=t[l]);if(o)for(var a=TC.Util.getElementByNodeName(o,"ows:Constraint"),l=0;l<a.length;l++)"CountDefault"==a[l].attributes.name.value&&(n=parseInt(TC.Util.getElementByNodeName(a[l],"ows:DefaultValue")[0].textContent))}}).fail(function(e){console.error(e)}):void TC.error("No se ha encontrado el parámetro serviceUrl en el control de descarga")},a=function(e){o.push(e.name)},i=function(e,t){if(e instanceof Array)for(var o=0;o<e.length;o++)i(e[o],t);else e.hasOwnProperty("children")&&e.children.length>0&&i(e.children,t);e.hasOwnProperty("children")&&0==e.children.length&&t.apply(this,[e])},r=function(){var e=t._$div.find("select").val(),l=s();if(l.length>0){o=[];for(var r=0;r<l.length;r++)l[r].url.indexOf(t.options.downloadServiceUrl)>=0&&i(l[r].getTree(),a);var c=0,u=t.map.getExtent(),p='"http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" xmlns:gml="http://www.opengis.net/gml" xmlns:wfs="http://www.opengis.net/wfs" xmlns:ogc="http://www.opengis.net/ogc" service="WFS" version="1.1.0" {resultType} outputFormat="{format}">';query="<wfs:GetFeature xmlns:xsi="+p.format({resultType:'resultType="hits"',format:"application/json"});var m='<wfs:Query typeName="{typeName}"><ogc:Filter xmlns="http://www.opengis.net/ogc"><ogc:BBOX><gml:Envelope><gml:lowerCorner>{lowerCorner}</gml:lowerCorner><gml:upperCorner>{upperCorner}</gml:upperCorner></gml:Envelope></ogc:BBOX></ogc:Filter></wfs:Query>',w="";$.each(o,function(e,t){w+=m.format({typeName:t,lowerCorner:u[0]+" "+u[1],upperCorner:u[2]+" "+u[3]})}),query+=w+"</wfs:GetFeature>",$.ajax({url:t.options.serviceUrl,async:!1,data:query,contentType:"application/xml",type:"POST",success:function(o){if(o.childNodes[0].attributes.numberOfFeatures)if(c=parseInt(o.childNodes[0].attributes.numberOfFeatures.value),query=p.format({resultType:"",format:e})+w+"</wfs:GetFeature>",n>c){var l=$("form.tc-ctl-download-form");$(".tc-ctl-download-query").val(query),l.attr("action",t.options.serviceUrl+"?download=zip"),l.submit()}else d({zoom:!0});else d({noFeatures:!0})}})}else d({layers:!0})},s=function(){for(var e=[],o=0;o<t.map.workLayers.length;o++){var n=t.map.workLayers[o];n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0&&e.push(n)}return e},d=function(e){var o,n=t._$div.find(".alert-warning");e.zoom?o=n.find("#zoom-msg").html():e.layers?o=n.find("#layers-msg").html():e.url?o=n.find("#url-msg").html():e.noFeatures&&(o=n.find("#noFeatures-msg").html()),t.map.toast(o,{type:TC.Consts.msgType.WARNING})},c=function(e){e.stopPropagation(),TC.Util.showModal(t._$dialogDiv.find(t._classSelector+"-help-dialog"))};l(),t._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-btn",r),t._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-help",c)}}();