TC.control=TC.control||{};TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient");!function(){TC.Consts.classes.CONNECTION_OFFLINE=TC.Consts.classes.CONNECTION_OFFLINE||"tc-conn-offline";TC.Consts.classes.CONNECTION_WIFI=TC.Consts.classes.CONNECTION_WIFI||"tc-conn-wifi";TC.Consts.classes.CONNECTION_MOBILE=TC.Consts.classes.CONNECTION_MOBILE||"tc-conn-mobile";TC.Consts.classes.OFFLINE=TC.Consts.classes.OFFLINE||"tc-offline";var e=window.applicationCache;TC._appCacheBuilders||(TC._appCacheBuilders=[]);TC._appCacheUpdater||(TC._appCacheUpdater=function(e,t){TC.Util.getQueryStringParams(t);for(var a=0,s=TC._appCacheBuilders.length;a<s;a++){var n=TC._appCacheBuilders[a];switch(e.type){case"cached":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:t}));break;case"obsolete":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:t}));break;case"checking":break;case"progress":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:t,loaded:e.loaded,total:e.total}));break;case"error":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:t,reason:e.reason,status:e.status}));break;case"noupdate":case"updateready":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:t,reason:"already_exists",status:e.status}))}}});var t,a=(t=window.parent!==window&&document.referrer&&TC.Util.isSameOrigin(document.referrer)&&parent.TC&&parent.TC._appCacheUpdater,function(e){t&&parent.TC._appCacheUpdater(e,location.href)}),s=function(){var e=$.Deferred(),t=$("html").attr("manifest");t?$.ajax({url:t,type:"GET",dataType:"text"}).done(function(t){var a=t.indexOf("NETWORK:");a>=0&&(t=t.substr(0,a));(a=t.indexOf("FALLBACK:"))>=0&&(t=t.substr(0,a));(a=t.indexOf("SETTINGS:"))>=0&&(t=t.substr(0,a));var s=$.grep(t.split(/[\n\r]/),function(e){return e.length>0&&0!==e.indexOf("#")&&"CACHE:"!==e});s.shift();e.resolve(s)}).fail(function(){e.reject()}):e.reject();return e};e.addEventListener("cached",a,!1);e.addEventListener("error",a,!1);e.addEventListener("noupdate",a,!1);e.addEventListener("obsolete",a,!1);e.addEventListener("progress",a,!1);e.addEventListener("updateready",a,!1);TC.control.CacheBuilder=function(){var e=this;TC.control.SWCacheClient.apply(this,arguments);var t=e._classSelector="."+e.CLASS;e._selectors={DRAW:t+"-draw",DRAWING:t+"-drawing",PROGRESS:t+"-progress",NEW:t+"-new",LIST:t+"-list",LISTITEM:t+"-list > li",DELBTN:t+"-btn-del",OKBTN:t+"-btn-ok",NEWBTN:t+"-btn-new",SAVEBTN:".tc-btn-save",CANCELBTN:".tc-btn-cancel",EDITBTN:".tc-btn-edit",VIEWBTN:".tc-btn-view",DELETEBTN:".tc-btn-delete",TILECOUNT:t+"-tile-count",NAMETB:t+"-txt-name",TEXTBOX:"input.tc-textbox",EXIT:t+"-link-exit",OFFPANEL:t+"-off-panel",BLLIST:t+"-bl-list",BLLISTITEM:t+"-bl-list > li",BLLISTTEXT:t+"-bl-panel-txt",RNGMAXRES:t+"-rng-maxres",SEARCH:t+"-map-available-srch",EMPTYLIST:t+"-map-available-empty",OFFLINEHIDDEN:"[data-no-cb]"};e.storedMaps=[];TC._appCacheBuilders.push(e);try{if(window.localStorage){for(var a=0,s=localStorage.length;a<s;a++){var n=localStorage.key(a);if(0===n.indexOf(e.LOCAL_STORAGE_KEY_PREFIX)){var r=localStorage.getItem(n).split(" "),l=i(r.shift()),o={name:r.join(" "),extent:l,url:decodeURIComponent(n.substr(e.LOCAL_STORAGE_KEY_PREFIX.length))};e.storedMaps.push(o)}}e.storedMaps.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0})}}catch(t){TC.error(e.getLocaleString("couldNotAccessLocalStorage"))}var c=$.extend({},s>1?arguments[1]:arguments[0]);e._$dialogDiv=$(TC.Util.getDiv(c.dialogDiv));c.dialogDiv||e._$dialogDiv.appendTo("body");e.mapIsOffline=location.pathname.indexOf("/"+e.CACHE_REQUEST_PATH)===location.pathname.length-e.CACHE_REQUEST_PATH.length-1;e.mapIsOffline&&$(e._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN);TC.Control.apply(e,arguments);e.wrap=new TC.wrap.control.CacheBuilder(e);e.isDownloading=!1;e.baseLayers=[];e.options.avgTileSize=e.options.avgTileSize||TC.Cfg.avgTileSize;e.requestSchemas=[];e.minResolution=0;e.currentMap=null;e._loadedCount=0;var d=history.pushState;history.pushState=function(t){var a;a=d.apply(history,arguments);if(e._$offlinePanelDiv){var s=location.pathname.replace("/"+e.CACHE_REQUEST_PATH,"/"),n=TC.Util.getQueryStringParams();delete n[e.MAP_DEFINITION_PARAM_NAME];delete n[e.MAP_EXTENT_PARAM_NAME];delete n[e.SERVICE_WORKER_FLAG];var i=$.param(n);i.length&&(i="?"+i);var r=s+i+location.hash;e._$offlinePanelDiv.find(e._selectors.EXIT).attr("href",r)}return a};var C=navigator.connection||navigator.mozConnection||navigator.webkitConnection||{},u=function(){if(e._$offlinePanelDiv){var t=e._$offlinePanelDiv.find(e._selectors.OFFPANEL);t.removeClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI);switch(C.type){case 1:case 2:case void 0:t.addClass(TC.Consts.classes.CONNECTION_WIFI);break;default:t.addClass(TC.Consts.classes.CONNECTION_MOBILE)}}};C.addEventListener&&C.addEventListener("typechange",u);window.addEventListener("online",u);window.addEventListener("offline",function(){e._$offlinePanelDiv&&e._$offlinePanelDiv.find(e._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI)})};TC.inherit(TC.control.CacheBuilder,TC.control.SWCacheClient);var n=TC.control.CacheBuilder.prototype;n.CLASS="tc-ctl-cbuild";n.MAP_DEFINITION_PARAM_NAME="map-def";n.MAP_EXTENT_PARAM_NAME="map-extent";n.LOCAL_STORAGE_KEY_PREFIX="TC.offline.map.";n.ROOT_CACHE_NAME="root";n.COOKIE_KEY_PREFIX="TC.offline.map.";n.CACHE_REQUEST_PATH="offline";n.SERVICE_WORKER_FLAG="sw";n._states={READY:"ready",EDIT:"editing",DOWNLOADING:"downloading",DELETING:"deleting"};n._actions={CREATE:"create",DELETE:"delete"};n.offlineControls=["attribution","basemapSelector","cacheBuilder","click","coordinates","draw","edit","geolocation","loadingIndicator","measure","navBar","popup","print","scale","scaleBar","scaleSelector","state","fullScreen"];TC.Consts.event.MAPCACHEDOWNLOAD=TC.Consts.event.MAPCACHEDOWNLOAD||"mapcachedownload.tc";TC.Consts.event.MAPCACHEDELETE=TC.Consts.event.MAPCACHEDELETE||"mapcachedelete.tc";TC.Consts.event.MAPCACHEPROGRESS=TC.Consts.event.MAPCACHEPROGRESS||"mapcacheprogress.tc";TC.Consts.event.MAPCACHEERROR=TC.Consts.event.MAPCACHEERROR||"mapcacheerror.tc";n.template={};if(TC.isDebug){n.template[n.CLASS]=TC.apiLocation+"TC/templates/CacheBuilder.html";n.template[n.CLASS+"-map-node"]=TC.apiLocation+"TC/templates/CacheBuilderMapNode.html";n.template[n.CLASS+"-bl-node"]=TC.apiLocation+"TC/templates/CacheBuilderBaseLayerNode.html";n.template[n.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/CacheBuilderDialog.html";n.template[n.CLASS+"-off-panel"]=TC.apiLocation+"TC/templates/CacheBuilderOfflinePanel.html"}else{n.template[n.CLASS]=function(){dust.register(n.CLASS,e);function e(e,n){return e.w("<h2>").h("i18n",n,{},{$key:"offlineMaps"}).w('</h2><div class="tc-ctl-cbuild-content"><div class="tc-ctl-cbuild-draw tc-hidden"></div><i class="tc-ctl-cbuild-map-search-icon"></i><input type="search" list="').f(n.get(["listId"],!1),n,"h").w('" class="tc-ctl-cbuild-map-available-srch tc-textbox" placeholder="').h("i18n",n,{},{$key:"cb.filter.plhr"}).w('"').x(n.get(["storedMaps"],!1),n,{else:t,block:a},{}).w(' maxlength="200" /> <ul id="').f(n.get(["listId"],!1),n,"h").w('" class="tc-ctl-cbuild-list"><li class="tc-ctl-cbuild-map-available-empty"').x(n.get(["storedMaps"],!1),n,{block:s},{}).w("><span>").h("i18n",n,{},{$key:"cb.noMaps"}).w('</span></li><li class="tc-ctl-cbuild-map-not" hidden><span>').h("i18n",n,{},{$key:"noMatches"}).w("</span></li>").s(n.get(["storedMaps"],!1),n,{block:i},{}).w('</ul><div class="tc-ctl-cbuild-new"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-new" disabled title="').h("i18n",n,{},{$key:"newofflinemap"}).w('">').h("i18n",n,{},{$key:"newOfflineMap"}).w('</button></div><div class="tc-ctl-cbuild-drawing tc-hidden"><div class="tc-ctl-cbuild-tile-cmd"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-draw" title="').h("i18n",n,{},{$key:"cancel"}).w('">').h("i18n",n,{},{$key:"cancel"}).w('</button></div></div><div class="tc-ctl-cbuild-progress tc-hidden"><p>').h("i18n",n,{},{$key:"cb.DownloadingMap|s"}).w(': <span class="tc-ctl-cbuild-progress-count"></span></p><div class="tc-ctl-cbuild-progress-bar"><div class="tc-ctl-cbuild-progress-ratio" style="width:0"></div></div><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-dl" title="').h("i18n",n,{},{$key:"cancel"}).w('">').h("i18n",n,{},{$key:"cancel"}).w("</button></div></div>")}e.__dustBody=!0;function t(e,t){return e.w(" disabled")}t.__dustBody=!0;function a(e,t){return e}a.__dustBody=!0;function s(e,t){return e.w(" hidden")}s.__dustBody=!0;function i(e,t){return e.p("tc-ctl-cbuild-map-node",t,t.rebase(t.getPath(!0,[])),{})}i.__dustBody=!0;return e};n.template[n.CLASS+"-map-node"]=function(){dust.register(n.CLASS+"-map-node",e);function e(e,t){return e.w('<li data-extent="').f(t.get(["extent"],!1),t,"h").w('"><span><a href="').f(t.get(["url"],!1),t,"h").w('" title="').f(t.get(["name"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w('</a></span><input class="tc-textbox tc-hidden" type="text" value="').f(t.get(["name"],!1),t,"h").w('" /><button class="tc-btn-save tc-hidden" title="').h("i18n",t,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",t,{},{$key:"cancel"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",t,{},{$key:"editMapName"}).w('">').h("i18n",t,{},{$key:"editMapName"}).w('</button><button class="tc-btn-view" title="').h("i18n",t,{},{$key:"viewMapExtent"}).w('">').h("i18n",t,{},{$key:"viewMapExtent"}).w('</button><button class="tc-btn-delete" title="').h("i18n",t,{},{$key:"deleteMap"}).w('">').h("i18n",t,{},{$key:"deleteMap"}).w("</button></li>")}e.__dustBody=!0;return e};n.template[n.CLASS+"-bl-node"]=function(){dust.register(n.CLASS+"-bl-node",e);function e(e,t){return e.w('<li class="tc-ctl-cbuild-bl-node" data-tc-layer-uid="').f(t.get(["id"],!1),t,"h").w('"><label style="background-size: 100% 100%; background-image: url(').f(t.get(["thumbnail"],!1),t,"h").w(')"><input type="checkbox" name="cbbl" value="').f(t.get(["id"],!1),t,"h").w('" disabled><span>').f(t.get(["title"],!1),t,"h").w("</span></label></li>")}e.__dustBody=!0;return e};n.template[n.CLASS+"-dialog"]=function(){dust.register(n.CLASS+"-dialog",e);function e(e,t){return e.w('<div class="tc-ctl-cbuild-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"newOfflineMap"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><input type="text" class="tc-ctl-cbuild-txt-name" placeholder="').h("i18n",t,{},{$key:"nameRequired"}).w('" required /><div class="tc-ctl-cbuild-bl-panel"><h4>').h("i18n",t,{},{$key:"availableOfflineMaps"}).w("</h4><p>").h("i18n",t,{},{$key:"selectAtLeastOne"}).w(':</p><ul class="tc-ctl-cbuild-bl-list"></ul></div><div class="tc-ctl-cbuild-res-panel"><h4>').h("i18n",t,{},{$key:"maxRes"}).w('</h4><div class="tc-ctl-cbuild-res"></div><input type="range" class="tc-ctl-cbuild-rng-maxres" disabled value="0" title="').h("i18n",t,{},{$key:"maxRes"}).w('"></div><div class="tc-ctl-cbuild-tile-count"></div></div><div class="tc-modal-footer"><button class="tc-button tc-modal-close tc-ctl-cbuild-btn-ok" disabled>').h("i18n",t,{},{$key:"ok"}).w('</button><button type="button" class="tc-button tc-modal-close tc-ctl-cbuild-btn-cancel">').h("i18n",t,{},{$key:"cancel"}).w("</button></div></div></div>")}e.__dustBody=!0;return e};n.template[n.CLASS+"-off-panel"]=function(){dust.register(n.CLASS+"-off-panel",e);function e(e,t){return e.w('<div class="tc-ctl-cbuild-off-panel tc-conn-wifi"><span>').h("i18n",t,{},{$key:"offlineMap"}).w('</span> <a href="" class="tc-ctl-cbuild-link-exit" title="').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w('"><span>').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w("</span></a></div>")}e.__dustBody=!0;return e}}var i=function(e){return $.map(decodeURIComponent(e).split(","),function(e){return parseFloat(e)})},r=function(e){e._state=e._states.READY;e.showDownloadProgress(0,1);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.LISTITEM).removeClass(TC.Consts.classes.DISABLED);e._$div.find(e._selectors.DELBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.TILECOUNT).html("");e.extent=null;e._loadedCount=0;e.boxDraw&&e.boxDraw.cancel()},l=function(e,t){t.find("span").first().removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.TEXTBOX).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.SAVEBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.CANCELBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.EDITBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.VIEWBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.DELETEBTN).removeClass(TC.Consts.classes.HIDDEN)},o=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},c=function(e,t){var a,s,n,i=t||{},r=e._$dialogDiv.find(e._classSelector+"-res"),l=e._$dialogDiv.find(e._selectors.RNGMAXRES),o=e.getResolutions();if(o.length){if(e.minResolution){if(void 0===i.rangeValue)for(var c=0,d=o.length;c<d;c++)if(e.minResolution>=o[c]){l.val(c);break}}else void 0===i.rangeValue&&l.val(Math.floor(o.length/2));s=parseInt(l.attr("max",o.length-1).val());var C=Math.floor(1e3*new Number(o[s]))/1e3;a=e.getLocaleString("metersPerPixel",{value:C.toLocaleString((e.map?e.map.options.locale:TC.Cfg.locale).replace("_","-"))});n=100*(s+1)/(o.length+1)+"%";l.prop("disabled",!1);e.minResolution=o[l.val()]}else{s=0;a="";l.val(0);n="0";e.minResolution=0;l.prop("disabled",!0)}r.css("left",n).html(a)},d=function(e){e._$dialogDiv.find(e._classSelector+"-bl-node input[type=checkbox]").each(function(t,a){var s=$(a);if(s.prop("checked")){var n=e.requestSchemas.filter(function(e){return e.layerId===s.val()})[0];if(n){var i=function(e,t){for(var a=null,s=0,n=e.tileMatrixLimits.length;s<n&&!((a=e.tileMatrixLimits[s]).res<=t);s++);return a}(n,e.minResolution);if(i){var r=n.url;if(r.indexOf("{TileMatrix}")<0){var l=r.indexOf("?");l>=0&&(r=r.substr(0,l));for(var o=0,c=e.baseLayers.length;o<c;o++){var d=e.baseLayers[o];if(d.id===n.layerId){r=r+"?layer="+d.layerNames+"&style=default&tilematrixset="+d.matrixSet+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+d.format+"&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}";break}}}s.parent("label").css("background-size","auto").css("background-position","left bottom").css("background-image","url("+r.replace("{TileMatrix}",i.mId).replace("{TileRow}",i.rt).replace("{TileCol}",i.cl)+")")}}}})},C=function(e,t){return t<1?e.getLocaleString("lessThan1Mb"):e.getLocaleString("approxXMb",{quantity:o(t)})},u=function(e){var t="";e.tileCount=0;for(var a=0,s=e.requestSchemas.length;a<s;a++)for(var n=e.requestSchemas[a],i=0,r=n.tileMatrixLimits.length;i<r;i++){var l=n.tileMatrixLimits[i];e.tileCount+=(l.cr-l.cl+1)*(l.rb-l.rt+1);if(l.res<e.minResolution)break}if(e.tileCount){e.estimatedMapSize=Math.round(e.tileCount*e.options.avgTileSize/1048576);t=e.getLocaleString("xTiles",{quantity:o(e.tileCount)})+" ("+C(e,e.estimatedMapSize)+")"}e._$dialogDiv.find(e._selectors.TILECOUNT).html(t)},f=function(e,t){var a=t.indexOf("#");a>=0&&(t=t.substr(0,a));return e._$div.find(e._selectors.LISTITEM).filter(function(e,a){return $(a).find("a").first().attr("href")===t})},p=function(e,t){$("<iframe>").css("display","none").attr("src",t).appendTo(e._$div)},T=function(e,t){e._$div.find('iframe[src="'+t+'"]').remove()},v=function(e,t){var a=!1;if(window.localStorage){localStorage.setItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t.url),t.extent+" "+t.name);a=!0}return a},E=function(e,t){var a=e.findStoredMap({url:t});if(a){(function(e,t){var a=!1;if(window.localStorage){localStorage.removeItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t));a=!0}return a})(e,t)&&function(e,t){return e._$div.find(e._selectors.LISTITEM).filter(function(e,a){return $(a).find("a").first().html()===t})}(e,a.name).remove();var s=$.inArray(a,e.storedMaps);e.storedMaps.splice(s,1);if(!e.storedMaps.length){e._$div.find(e._selectors.SEARCH).prop("disabled",!0);e._$div.find(e._selectors.EMPTYLIST).removeAttr("hidden")}return a.name}return null},g=function(e){e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!e.extent||0===e._$dialogDiv.find(e._selectors.NAMETB).val().length||e._$dialogDiv.find(e._selectors.RNGMAXRES).prop("disabled"))};n.render=function(e){var t=this,a={storedMaps:t.storedMaps,listId:t.CLASS+"-list-"+TC.getUID()};t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e);t._$dialogDiv.find(t._selectors.NAMETB).on(TC.Consts.event.CLICK,function(e){e.preventDefault();this.selectionStart=0;this.selectionEnd=this.value.length;this.focus()})}).then(function(){t.renderData(a,function(){t._$dialogDiv.find(t._selectors.OKBTN).on(TC.Consts.event.CLICK,function(){var e={mapName:t._$dialogDiv.find(t._selectors.NAMETB).val()};if(t.findStoredMap({name:e.mapName}))TC.alert(t.getLocaleString("cb.mapNameAlreadyExists.error",e));else{var a=function(){t._$div.find(t._classSelector+"-name").html(e.mapName);t.map.toast(t.getLocaleString("downloadingMap",{mapName:e.mapName}));!function(e){e._state=e._states.DOWNLOADING;TC.Util.closeModal();e.showDownloadProgress(0,1);e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).removeClass(TC.Consts.classes.HIDDEN);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!0);e.layer.clearFeatures();e.boxDraw.cancel()}(t);t.requestCache(e)},n=navigator.temporaryStorage||navigator.webkitTemporaryStorage||{};if(n.queryUsageAndQuota)n.queryUsageAndQuota(function(s,n){var i=(n-s)/1048576;t.estimatedMapSize<i?a():TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonSize",{mapName:e.mapName,mapSize:C(t,t.estimatedMapSize),availableStorage:C(t,Math.round(i))}),a)},function(e){TC.error(e)});else{var i=TC.Util.detectIE();if(i){var r=i<12?1e3:2e3,l=0,c=function(){var s=t.tileCount+l;s>r?TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonCount",{mapName:e.mapName,resourceCount:o(s),maxResourceCount:o(r)}),a):a()};s().done(function(e){l=e.length;c()}).fail(c)}else a()}}});t._$dialogDiv.find(t._selectors.NAMETB).on("input",function(){g(t)});t._$div.find(t._selectors.NEWBTN).on(TC.Consts.event.CLICK,function(){!function(e){e._state=e._states.EDITING;e.showDownloadProgress(0,1);e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.DRAWING).removeClass(TC.Consts.classes.HIDDEN);e.map.toast(e.getLocaleString("clickOnDownloadAreaFirstCorner"),{type:TC.Consts.msgType.INFO});e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!0);e._$dialogDiv.find(e._selectors.NAMETB).val("");e.boxDraw.activate()}(t)});t._$div.find(t._classSelector+"-btn-cancel-draw").on(TC.Consts.event.CLICK,function(){r(t)});t._$div.find(t._classSelector+"-btn-cancel-dl").on(TC.Consts.event.CLICK,function(){t.cancelCacheRequest()});t._$div.find(t._selectors.LIST).on(TC.Consts.event.CLICK,t._selectors.DELETEBTN,function(e){if(navigator.onLine){$btn=$(e.target);var a=$btn.parent().find("a").html();if(a){var s=t.getLocaleString("cb.delete.confirm",{mapName:a});t.serviceWorkerEnabled||(s=s+" "+t.getLocaleString("cb.delete.confirm.connect.warning"));if(confirm(s))if(navigator.onLine){!function(e){e._state=e._states.DELETING;e.showDownloadProgress(0,1);e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN);e._$div.find(e._selectors.LISTITEM).addClass(TC.Consts.classes.DISABLED);e._$div.find(e._selectors.DELBTN).prop("disabled",!0);e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0);e._$div.find(e._selectors.NEWBTN).prop("disabled",!1);e._$dialogDiv.find(e._selectors.TILECOUNT).html("");e.boxDraw.cancel()}(t);t.deleteMap(a)}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}).on(TC.Consts.event.CLICK,t._selectors.EDITBTN,function(e){!function(e,t){t.find("span").first().addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.TEXTBOX).removeClass(TC.Consts.classes.HIDDEN).val(t.find("span a").html()).focus();t.find(e._selectors.SAVEBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.CANCELBTN).removeClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.EDITBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.VIEWBTN).addClass(TC.Consts.classes.HIDDEN);t.find(e._selectors.DELETEBTN).addClass(TC.Consts.classes.HIDDEN)}(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.CANCELBTN,function(e){var a=$(e.target).parent();a.find(t._selectors.TEXTBOX).val(a.find("a").html());l(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.SAVEBTN,function(e){var a=$(e.target).parent();l(t,a);var s=a.find("a"),n=(s.html(),a.find(t._selectors.TEXTBOX).val()),i=t.findStoredMap({url:s.attr("href")});if(i){i.name=n;s.html(n);s.attr("title",n);v(t,i)}}).on(TC.Consts.event.CLICK,t._selectors.VIEWBTN,function(e){$btn=$(e.target);var a=!$btn.hasClass(TC.Consts.classes.ACTIVE);t._$div.find(t._selectors.VIEWBTN).removeClass(TC.Consts.classes.ACTIVE).parent().removeClass(TC.Consts.classes.ACTIVE);var s=$btn.parent().find("a").html();if(s){var n=t.findStoredMap({name:s});if(n){var r=i(n.extent);t.layer.clearFeatures();if(a){t.layer.addPolygon([[[r[0],r[1]],[r[0],r[3]],[r[2],r[3]],[r[2],r[1]]]],{showsPopup:!1}).then(function(){t.layer.map.zoomToFeatures(t.layer.features)});$btn.addClass(TC.Consts.classes.ACTIVE);$btn.parent().addClass(TC.Consts.classes.ACTIVE);$btn.attr("title",t.getLocaleString("removeMapExtent"))}}}});var a=function(e){e=e.toLowerCase();var a=t._$div.find(t._selectors.LISTITEM).hide(),s=a.filter("li:not([class]),li."+TC.Consts.classes.ACTIVE);if(0===e.length){s.show();t._$div.find(t._classSelector+"-map-search-icon").css("visibility","visible")}else{t._$div.find(t._classSelector+"-map-search-icon").css("visibility","hidden");var n=new RegExp(e,"i");s.each(function(){var e=$(this);e.toggle(n.test(e.find("a").text()))});0===s.filter(":visible").length&&a.filter('[class^="tc-ctl-cbuild-map-not"]').show()}},n=t._$div.find(t._selectors.SEARCH);n.on("keyup search",function(){a($(this).val().toLowerCase().trim())});try{if(n.has($("::-ms-clear"))){n.on("mouseup",function(e){""!==n.val()&&setTimeout(function(){var e=n.val();""===e&&a(e)},1)})}}catch(e){}t._$dialogDiv.find(t._selectors.BLLIST).on("change","input[type=checkbox]",function(e){t.baseLayers.length=0;t._$dialogDiv.find(t._selectors.BLLIST+" input[type=checkbox]").each(function(e,a){var s=$(a);if(s.prop("checked"))for(var n=s.val(),i=0,r=t.map.baseLayers.length;i<r;i++){var l=t.map.baseLayers[i];if(l.id===n&&l.type===TC.Consts.layerType.WMTS){t.baseLayers[t.baseLayers.length]=l;break}}});t.updateRequestSchemas();c(t);d(t);g(t);u(t)});t._$dialogDiv.find(t._selectors.RNGMAXRES).on("input change",function(e){c(t,{rangeValue:$(e.target).val()});d(t);u(t)});TC.Util.getQueryStringParams();f(t,location.href).addClass(TC.Consts.classes.ACTIVE);$.isFunction(e)&&e()})});window.addEventListener("beforeunload",function(e){if(t.isDownloading){var a=t.getLocaleString("cb.mapDownloading.warning");e.returnValue=a;return a}},!0)};n.register=function(t){var a=this;TC.control.SWCacheClient.prototype.register.call(a,t);if(navigator.serviceWorker){navigator.serviceWorker.addEventListener("message",function(e){switch(e.data.event){case"progress":a.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:e.data.name,loaded:e.data.count,total:e.data.total}));break;case"cached":a.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:e.data.name}));break;case"deleted":a.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:e.data.name}));break;case"error":e.data.action===a._actions.CREATE&&TC.error(a.getLocaleString("cb.resourceDownload.error",{url:e.data.url}))}});var n=function(){s().then(function(e){a.cacheUrlList(e,{silent:!0})})},l=function(){a.deleteCache(a.LOCAL_STORAGE_KEY_PREFIX+a.ROOT_CACHE_NAME,{silent:!0})};if(e.status===e.CACHED||e.status===e.UPDATEREADY||e.status===e.UNCACHED)n();else{e.addEventListener("cached",n,!1);e.addEventListener("updateready",n,!1);e.addEventListener("downloading",l,!1);e.addEventListener("obsolete",l,!1)}}if(a.mapIsOffline){t._$div.addClass(TC.Consts.classes.OFFLINE);a._$offlinePanelDiv=$(TC.Util.getDiv(a.options.offlinePanelDiv));a.options.offlinePanelDiv||a._$offlinePanelDiv.appendTo(t._$div);a.getRenderedHtml(a.CLASS+"-off-panel",null,function(e){a._$offlinePanelDiv.html(e);navigator.onLine||a._$offlinePanelDiv.find(a._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI);a._$offlinePanelDiv.find(a._selectors.EXIT).on(TC.Consts.event.CLICK,function(e){TC.confirm(a.getLocaleString("offlineMapExit.confirm"),null,function(){e.preventDefault()})})})}a.layer=null;t.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0}).then(function(e){a.layer=e;TC.loadJS(!TC.control.Draw,TC.apiLocation+"TC/control/Draw",function(){a.boxDraw=new TC.control.Draw({div:a._$div.find(a._selectors.DRAW),mode:TC.Consts.geom.RECTANGLE,layer:a.layer,persistent:!1});a.boxDraw.$events.on(TC.Consts.event.DRAWSTART,function(e){a.map.toast(a.getLocaleString("clickOnDownloadAreaOppositeCorner"),{type:TC.Consts.msgType.INFO})}).on(TC.Consts.event.DRAWEND,function(e){var t=e.feature.geometry[0],s=t[0],n=t[2],i=Math.min(s[0],n[0]),r=Math.max(s[0],n[0]),l=Math.min(s[1],n[1]),o=Math.max(s[1],n[1]);a.setExtent([i,l,r,o]);var c,C=a._$dialogDiv.find("input[type=checkbox]");C.each(function(e,t){for(var s=0,n=a.map.baseLayers.length;s<n;s++){var i=a.map.baseLayers[s];if(t.value===i.id){var r=$(t),l=r.parents("li").first(),o=i.getResolutions(),c=a.wrap.getRequestSchemas({extent:a.extent,layers:[i]})[0].tileMatrixLimits;if(c.length&&o[o.length-1]==c[c.length-1].res)l.removeClass(TC.Consts.classes.HIDDEN);else{r.prop("checked",!1);l.addClass(TC.Consts.classes.HIDDEN)}break}}});c=a._$dialogDiv.find(a._selectors.BLLISTITEM).filter(":not(."+TC.Consts.classes.HIDDEN+")").length?"selectAtLeastOne":"cb.noMapsAtSelectedExtent";a._$dialogDiv.find(a._selectors.BLLISTTEXT).html(a.getLocaleString(c));d(a);u(a);TC.Util.showModal(a._$dialogDiv.find(a._classSelector+"-dialog"),{openCallback:function(){C.prop("disabled",!1);var e;if(Date.prototype.toLocaleString){var t={};t.year=t.month=t.day=t.hour=t.minute=t.second="numeric";e=(new Date).toLocaleString(a.map.options.locale.replace("_","-"),t)}else e=(new Date).toString();a._$dialogDiv.find(a._selectors.NAMETB).val(e)[0];g(a)},closeCallback:function(){C.prop("disabled",!0);a.layer.clearFeatures()}})});t.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){a.boxDraw===e.control&&a._state===a._states.EDITING&&r(a)});t.addControl(a.boxDraw)})});var o=function(e){var t=!1,s=a._$dialogDiv.find(a._selectors.BLLIST),n=function(){return s.find('li[data-tc-layer-uid="'+e.id+'"]').length>0},i=e.type===TC.Consts.layerType.WMTS&&!e.mustReproject;TC.Util.detectSafari()&&TC.Util.detectIOS()&&(i=i&&TC.Util.isSameOrigin(e.url));if(i&&!n()){t=!0;a.getRenderedHtml(a.CLASS+"-bl-node",e,function(e){n()||s.append(e)})}return t};t.on(TC.Consts.event.LAYERADD,function(e){o(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){e.layer.type===TC.Consts.layerType.WMTS&&a._$dialogDiv.find(a._selectors.BLLIST).find('li[data-tc-layer-uid="'+e.layer.id+'"]').remove()});var c=TC.Util.getQueryStringParams(),C=c[a.MAP_DEFINITION_PARAM_NAME],p=c[a.MAP_EXTENT_PARAM_NAME];t.ready(function(){if(a.mapIsOffline){for(var e=[],s=0,n=a.offlineControls.length;s<n;s++){var i=a.offlineControls[s];i=i.substr(0,1).toUpperCase()+i.substr(1);e=e.concat(t.getControlsByClass("TC.control."+i))}for(s=0,n=t.controls.length;s<n;s++){var r=t.controls[s];e.indexOf(r)<0&&r.disable()}$(a._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN)}});t.loaded(function(){t.putLayerOnTop(a.layer);a._firstRender.then(function(){a._$div.find(a._selectors.NEWBTN).prop("disabled",!1);for(var e=0,s=t.baseLayers.length;e<s;e++)o(t.baseLayers[e])});if(a.mapIsOffline){var e=JSON.parse(window.atob(decodeURIComponent(C))),s=[],n=$.grep(t.baseLayers,function(t){var a=!1;if(t.type===TC.Consts.layerType.WMTS)for(var n=0,i=e.layers.length;n<i;n++){var r=e.layers[n];if((0===t.url.indexOf("//")?location.protocol+t.url:t.url)===e.url[r.urlIdx]&&t.layerNames===r.id&&t.matrixSet===e.tms[r.tmsIdx]){a=!0;break}}a||t.type!==TC.Consts.layerType.VECTOR&&(s[s.length]=t);return a})[0];n&&t.setBaseLayer(n);for(var r=0,l=s.length;r<l;r++)t.removeLayer(s[r]);t.setExtent(i(p))}});a.$events.on(TC.Consts.event.MAPCACHEDOWNLOAD,function(e){a.isDownloading=!1;var s=function(e){var t=e.indexOf("#");return t>=0?e.substr(0,t):e}(e.url),n=f(a,s);if(n.length&&!a.serviceWorkerEnabled){n.removeClass(TC.Consts.classes.DISABLED);n.find(a._selectors.DELBTN).prop("disabled",!1);TC.alert(a.getLocaleString("cb.delete.error"))}else if(a.currentMap&&s===a.currentMap.url){!function(e){var t=e.currentMap;if(v(e,t)){e.getRenderedHtml(e.CLASS+"-map-node",{name:t.name,url:t.url},function(t){e._$div.find(e._selectors.LIST).append(t);e._$div.find(e._selectors.EMPTYLIST).attr("hidden","hidden");e._$div.find(e._selectors.SEARCH).prop("disabled",!1)});e.storedMaps.push(t)}}(a);t.toast(a.getLocaleString("mapDownloaded",{mapName:a.currentMap.name}))}a.currentMap=null;T(a,e.url);r(a)}).on(TC.Consts.event.MAPCACHEDELETE,function(e){a.isDownloading=!1;var s=E(a,e.url)||a.currentMap&&a.currentMap.name;T(a,e.url);a.currentMap=null;if(s){document.cookie=a.COOKIE_KEY_PREFIX+"delete=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";t.toast(a.getLocaleString("mapDeleted",{mapName:s}))}r(a)}).on(TC.Consts.event.MAPCACHEPROGRESS,function(e){var t=e.total;!t&&a.requestSchemas&&(t=a.requestSchemas[0].tileCount);var s=e.loaded;if(s)a._loadedCount=s;else{a._loadedCount+=1;s=a._loadedCount}a.showDownloadProgress(s,t)}).on(TC.Consts.event.MAPCACHEERROR,function(e){a.isDownloading=!1;T(a,e.url);r(a);var t=a.getLocaleString("cb.mapCreation.error"),s=!0;switch(e.reason){case"quota":t+=". "+a.getLocaleString("cb.mapCreation.error.reasonQuota");break;case"resource":t+=". "+a.getLocaleString("cb.mapCreation.error.reasonResource");break;case"manifest":"410"==e.status&&E(a,e.url);s=!1;break;case"already_exists":t+=". "+a.getLocaleString("cb.mapCreation.error.reasonAlreadyExists")}if(s)if(TC.Util.detectIE()){TC.error(t);TC.alert(a.getLocaleString("cb.mapCreation.error.reasonIE"))}else TC.alert(t);a.currentMap=null})};n.setExtent=function(e){if($.isArray(e)&&e.length>=4){this.extent=e;this.updateRequestSchemas()}};n.cacheUrlList=function(e,t){var a=t||{};this.createCache(a.name||this.LOCAL_STORAGE_KEY_PREFIX+this.ROOT_CACHE_NAME,{urlList:e,silent:a.silent})};n.requestCache=function(e){var t=this,a=e||{};if(t.map){var s=a.extent||t.extent||t.map.getExtent();t.updateRequestSchemas({extent:s});if(t.requestSchemas){for(var n=function(e,a,s){var n=e.res>=t.minResolution;!n&&a>0&&(n=s[a-1].res>t.minResolution);return n},i=function(e){return{mId:e.mId,cl:e.cl,cr:e.cr,rt:e.rt,rb:e.rb}},r=t.requestSchemas.map(function(e){return{layerId:e.layerId,tileMatrixLimits:e.tileMatrixLimits.filter(n)}}),l=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],o=0,c=r.length;o<c;o++){var d=r[o],C=(O=d.tileMatrixLimits[d.tileMatrixLimits.length-1]).res*O.tSize;l[0]=Math.min(l[0],O.origin[0]+C*O.cl);l[1]=Math.min(l[1],O.origin[1]-C*(O.rb+1));l[2]=Math.max(l[2],O.origin[0]+C*(O.cr+1));l[3]=Math.max(l[3],O.origin[1]-C*O.rt);d.tileMatrixLimits=d.tileMatrixLimits.map(i)}var u=Math.pow(10,t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),f={bBox:l=l.map(function(e,t){return(t<3?Math.ceil:Math.floor)(e*u)/u}),res:Math.floor(1e3*t.minResolution)/1e3,url:[],tms:[],format:[],layers:new Array(t.baseLayers.length)};for(o=0,c=t.baseLayers.length;o<c;o++){var T=t.baseLayers[o],v=0===T.url.indexOf("//")?location.protocol+T.url:T.url,E=$.inArray(v,f.url);E<0&&(E=f.url.push(v)-1);var g=$.inArray(T.matrixSet,f.tms);g<0&&(g=f.tms.push(T.matrixSet)-1);var h=T.format.substr(T.format.indexOf("/")+1),_=$.inArray(h,f.format);_<0&&(_=f.format.push(h)-1);f.layers[o]={urlIdx:E,id:T.layerNames,tmsIdx:g,formatIdx:_}}var b=TC.Util.getQueryStringParams(),N=b[t.MAP_EXTENT_PARAM_NAME]=l.toString();b[t.MAP_DEFINITION_PARAM_NAME]=btoa(JSON.stringify(f));t.serviceWorkerEnabled&&(b[t.SERVICE_WORKER_FLAG]=1);var I=location.origin+location.pathname.substr(0,location.pathname.lastIndexOf("/")+1)+t.CACHE_REQUEST_PATH+"?"+$.param(b);t.currentMap={name:a.mapName,extent:N,url:I};t.isDownloading=!0;if(t.serviceWorkerEnabled)for(o=0,c=r.length;o<c;o++){for(var L=r[o],S=null,D=0,A=t.baseLayers.length;D<A;D++){var y=t.baseLayers[D];if(y.id===L.layerId){S=t.wrap.getGetTilePattern(y);break}}if(S){urlList=[];var M=0;for(k=0,lenk=L.tileMatrixLimits.length;k<lenk;k++){var O;for(y=(O=L.tileMatrixLimits[k]).cl;y<=O.cr;y++)for(m=O.rt;m<=O.rb;m++)urlList[M++]=S.replace("{TileMatrix}",O.mId).replace("{TileCol}",y).replace("{TileRow}",m)}urlList.push(I);t.cacheUrlList(urlList,{name:I})}}else p(t,I)}}};n.cancelCacheRequest=function(){var e=this;if(e.currentMap){T(e,e.currentMap.url);e.deleteCache(e.currentMap.url).then(function(t){t||(e.currentMap=null)})}e.isDownloading=!1;r(e)};n.deleteMap=function(e){var t=this,a=t.findStoredMap({name:e});if(a){var s=TC.Util.getQueryStringParams(a.url);t.deleteCache(a.url).then(function(e){if(!e){document.cookie=t.COOKIE_KEY_PREFIX+"delete="+atob(decodeURIComponent(s[t.MAP_DEFINITION_PARAM_NAME]));p(t,a.url)}})}};n.findStoredMap=function(e){return $.grep(this.storedMaps,function(t){var a=!0;e.name&&e.name!==t.name&&(a=!1);a&&e.url&&e.url!==t.url&&(a=!1);return a})[0]};n.showDownloadProgress=function(e,t){var a=this._classSelector,s=this._$div.find(a+"-progress-count");if(t){var n=Math.min(Math.round(100*e/t),100)+"%";this._$div.find(a+"-progress-ratio").css("width",n);s.html(n)}else{this._$div.find(a+"-progress-bar").addClass(TC.Consts.classes.HIDDEN);s.html(this.getLocaleString("xFiles",{quantity:e}))}};n.updateRequestSchemas=function(e){var t=e||{};t.extent=t.extent||this.extent;t.layers=t.layers||this.baseLayers;this.requestSchemas=this.wrap.getRequestSchemas(t);return this.requestSchemas};n.getResolutions=function(){for(var e=[],t=function(e){return e.res},a=this.requestSchemas.map(function(e){return e.tileMatrixLimits.map(t)}),s=Number.POSITIVE_INFINITY,n=0,i=0,r=a.length;i<r;i++){var l=a[i];s=Math.min(s,l[0]);n=Math.max(n,l[l.length-1])}for(i=0,r=a.length;i<r;i++)e=e.concat(a[i].filter(function(t){return t<=s&&t>=n&&e.indexOf(t)<0}));e.sort(function(e,t){return t-e});return e}}();