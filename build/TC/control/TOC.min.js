TC.control=TC.control||{},TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents.js"),TC.control.TOC=function(){var t=this;TC.control.MapContents.apply(t,arguments)},TC.inherit(TC.control.TOC,TC.control.MapContents),function(){var t=TC.control.TOC.prototype;t.CLASS="tc-ctl-toc",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/TOC.html",t.template[t.CLASS+"-branch"]=TC.apiLocation+"TC/templates/TOCBranch.html",t.template[t.CLASS+"-node"]=TC.apiLocation+"TC/templates/TOCNode.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"worklayers"}).w('</h2><div class="tc-ctl-toc-tree"><form><div class="tc-ctl-toc-empty">').h("i18n",e,{},{$key:"noData"}).w('</div><ul class="tc-ctl-toc-branch tc-ctl-toc-wl">').s(e.get(["workLayers"],!1),e,{block:n},{}).w("</ul></form></div>")}function n(t,e){return t.p("tc-ctl-toc-wlbranch",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS,e),e.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-branch"]=function(){function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{"else":n,block:a},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><input type="checkbox" class="tc-ctl-toc-branch-cb" name="toc" value="').f(e.get(["name"],!1),e,"h").w('"').x(e.get(["isVisible"],!1),e,{block:i},{}).w(" /><span>").f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-toc-branch">').s(e.get(["children"],!1),e,{block:c},{}).w("</ul></li>")}function n(t,e){return t.w('class="tc-ctl-toc-node tc-ctl-toc-leaf"')}function a(t,e){return t.w('class="tc-ctl-toc-node"')}function i(t,e){return t.w(" checked")}function c(t,e){return t.p("tc-ctl-toc-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-branch",e),e.__dustBody=!0,n.__dustBody=!0,a.__dustBody=!0,i.__dustBody=!0,c.__dustBody=!0,e},t.template[t.CLASS+"-node"]=function(){function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{"else":n,block:a},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><input type="checkbox" name="toc" value="').f(e.get(["name"],!1),e,"h").w('"').x(e.get(["isVisible"],!1),e,{block:i},{}).w(" /><span>").f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-toc-branch">').s(e.get(["children"],!1),e,{block:c},{}).w("</ul></li>")}function n(t,e){return t.w('class="tc-ctl-toc-node tc-ctl-toc-leaf"')}function a(t,e){return t.w('class="tc-ctl-toc-node"')}function i(t,e){return t.w(" checked")}function c(t,e){return t.p("tc-ctl-toc-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-node",e),e.__dustBody=!0,n.__dustBody=!0,a.__dustBody=!0,i.__dustBody=!0,c.__dustBody=!0,e});var e={layer:"tcLayer",layerUid:"tcLayerUid"};t.register=function(t){var n=this;TC.control.MapContents.prototype.register.call(n,t),n.$events.on(TC.Consts.event.CONTROLRENDER,function(){var e=n.options.controls||[];if(e.length>0){var a=e[0],i=$("<div/>");n._$div.append(i),t.addControl(a.name,$.extend({div:i},a.options))}}),n._$div.on(TC.Consts.event.CLICK,"input[type=checkbox]",function(t){var a=$(t.target),i=a.closest("ul."+n.CLASS+"-wl").children("li").has(a).data(e.layer),c=a.parents("li").first().data(e.layerUid),o=a.prop("checked");i.setNodeVisibility(c,o),t.stopPropagation()}).on("mouseup.tc","li",function(t){var e=$(t.target);e.hasClass(n.CLASS+"-leaf")||(e.toggleClass(TC.Consts.classes.COLLAPSED),e.find("ul").first().toggleClass(TC.Consts.classes.COLLAPSED),t.stopPropagation())}),t.on(TC.Consts.event.EXTERNALSERVICEADDED,function(e){e&&e.layer&&(e.layer.map=t,t.addLayer(e.layer),n.updateLayerTree(e.layer))})},t.update=function(){var t=this,n=function(t){return t.children("input[type=checkbox]")},a=t._$div.find("ul."+t.CLASS+"-wl").first();a.children("li").each(function(t,a){var i=$(a),c=i.data(e.layer);if(c){var o=c.getVisibility();n(i).prop("checked",o),c.tree=null,i.find("li").each(function(t,a){var i=$(a),o=n(i),r=i.data(e.layerUid);switch(c.getNodeVisibility(r)){case TC.Consts.visibility.VISIBLE:o.prop("checked",!0),o.prop("indeterminate",!1);break;case TC.Consts.visibility.NOT_VISIBLE_AT_RESOLUTION:o.prop("checked",!0),o.prop("indeterminate",!1);break;case TC.Consts.visibility.HAS_VISIBLE:o.prop("checked",!1),o.prop("indeterminate",!0);break;default:o.prop("checked",!1),o.prop("indeterminate",!1)}})}}),t.updateScale()},t.updateScale=function(){var t=this;t._$div.find("ul."+t.CLASS+"-wl").children("li").each(function(n,a){var i=$(a),c=i.data(e.layer);i.find("li").each(function(n,a){var i=$(a);i.toggleClass(t.CLASS+"-node-notvisible",!c.isVisibleByScale(i.data(e.layerUid)))})})},t.updateLayerTree=function(t){var n=this;if(!t.isBase&&!t.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(n,t),n._$div.find("."+n.CLASS+"-empty").addClass(TC.Consts.classes.HIDDEN);var a=n.CLASS+"-branch";TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(a,n.layerTrees[t.id],function(a,i){var c=$(i);Modernizr.canvas||c.find("li:last-child").addClass(TC.Consts.classes.LASTCHILD);var o=c.data(e.layerUid),r=n._$div.find("."+n.CLASS+"-wl"),l=r.find('li[data-tc-layer-uid="'+o+'"]');1===l.length?(l.html(c.html()),l.data(e.layer)||l.data(e.layer,t)):(c.data(e.layer,t),r.prepend(c)),a&&TC.error(a)});var i="ul."+n.CLASS+"-wl",c="ul."+n.CLASS+"-branch",o="li."+n.CLASS+"-node",r="li."+n.CLASS+"-leaf";n._$div.find(i+" "+c+" "+c+","+i+" "+c+" "+o).not(r).addClass(TC.Consts.classes.COLLAPSED),n.update()})}},t.removeLayer=function(t){if(!t.isBase){var n=this,a=function(){return n._$div.find("."+n.CLASS+"-wl").children("li")},i=a();i.each(function(n,c){var o=$(c);return o.data(e.layer)===t?(o.remove(),i=a(),!1):void 0}),0===i.length&&n._$div.find("."+n.CLASS+"-empty").removeClass(TC.Consts.classes.HIDDEN)}},t.updateLayerVisibility=function(t){var n=this;n._$div.find("."+n.CLASS+"-wl").children("li").each(function(a,i){var c=$(i);if(c.data(e.layer)===t){var o=!t.getVisibility(),r=c.find("input[type=checkbox]"),l=r.filter("."+n.CLASS+"-branch-cb");return l.prop("checked",!o),r.not(l).prop("disabled",o),!1}})}}();