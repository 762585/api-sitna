TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.PrintPdf=function(){var e=this;TC.Control.apply(e,arguments)},TC.inherit(TC.control.PrintPdf,TC.Control),function(){var e=TC.control.PrintPdf.prototype;e.CLASS="tc-ctl-print-pdf";var t={marginTop:20,marginLeft:55,a4:{width:596,height:842},a3:{width:842,height:1191},qrCode:{sideLength:85},headerHeight:20},n={PORTRAIT:"portrait",LANDSCAPE:"landscape"},r={A4:"a4",A3:"a3"},a=TC.Util.getParameterByName("orientation"),i=TC.Util.getParameterByName("size"),o=function(e,r){return e===n.PORTRAIT?t[r].width:t[r].height},s=function(e,r){return e===n.PORTRAIT?t[r].height:t[r].width};e.template=TC.isDebug?TC.apiLocation+"TC/templates/PrintPdf.html":function(){function t(e,t){return e.w('<button disabled class="disabled tc-button tc-ctl-printMap-btn" title="').h("i18n",t,{},{$key:"printPdf"}).w('"></button>')}return dust.register(e.CLASS,t),t.__dustBody=!0,t};var l=function(){var e=window.location.href,t=e.indexOf("?"),n=e.indexOf("#");return t>0&&(e=n>t?e.replace(e.substring(t,n),""):e.replace(e.substring(t,e.length-1),"")),e},d=function(e){var n=$.Deferred(),r=150;return e?TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>r&&(e=TC.Util.shortenUrl(e));var a=$("#qrcode");a.empty();new QRCode(a.get(0),{text:e,width:t.qrCode.sideLength,height:t.qrCode.sideLength});setTimeout(function(){var e=a.find("img").attr("src");n.resolve(e)},100)}):n.resolve(imgBase64),n.promise()};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t.pdfLibPromise=function(){var e=$.Deferred();return window.pdfMake?e.resolve():TC.loadJS(!window.pdfMake,[TC.Consts.url.PDFMAKE],function(){e.resolve()}),e.promise()}();var n=!0;e._$div.on("mouseover",function(){n&&(e.toast(t.getLocaleString("print.advice.title")+": "+t.getLocaleString("print.advice.desc"),{type:TC.Consts.msgType.INFO,duration:7e3}),n=!1)});var r=".tc-ctl-printMap-btn";t.map.$events.on(TC.Consts.event.STARTLOADING,function(){var e=t._$div.find(r);e.addClass("disabled"),e.attr("disabled","disabled")}),t.map.$events.on(TC.Consts.event.STOPLOADING,function(){var e=t._$div.find(r);e.removeClass("disabled"),e.removeAttr("disabled")}),t.getLayersFromOpener(),t.options.qrCode&&d(l()),t._$div.on("click",".tc-ctl-printMap-btn",function(){t.createPdf()})};var c=function(){var e=$.Deferred(),o={pageOrientation:a||n.LANDSCAPE,pageSize:i||r.A4,pageMargins:[t.marginLeft,t.marginTop]};return e.resolve(o),e.promise()};e.createPdf=function(){var e=this,n=o(a,i),r=s(a,i);e.canvas=$(".tc-map .ol-viewport canvas")[0],e.mapSize=TC.Util.calculateAspectRatioFit(e.canvas.width,e.canvas.height,n-2*t.marginLeft,r-2*t.marginTop-t.headerHeight);var h=function(n){n.content=n.content||[];var r=$.Deferred(),a=e.map.getControlsByClass(TC.control.ScaleBar)[0];if(a)var i=$(".tc-ctl-sb .ol-scale-line-inner"),o=e.canvas.width/e.mapSize.width,s=i.width()/o;var l=function(e){var t;e&&(t=[[e]]),t[0].push({text:TC.Util.getParameterByName("title"),alignment:"center",fontSize:11}),a&&t[0].push({table:{widths:[s],body:[[{text:a.getText(),fontSize:10,alignment:"center"}]]},layout:{hLineWidth:function(e,t){return 0===e?0:1},paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return 0},paddingBottom:function(e,t){return 0}}}),n.content.push({table:{widths:[s,"*",s]},layout:"noBorders"}),n.content[0].table.body=t,r.resolve(n)};return e.options.logo?$.when(TC.Util.imgToDataUrl(e.options.logo,"image/png")).then(function(e,n){var r=(t.headerHeight,n.width*t.headerHeight/n.height,TC.Util.calculateAspectRatioFit(n.width,n.height,s,t.headerHeight));l({image:e,height:r.height,width:r.width})}):l(),r.promise()},p=function(n){var r=$.Deferred();n.content=n.content||[];var a=function(t){n.content.push({table:{widths:["*"],body:[[{image:TC.Util.toDataUrl(t),width:e.mapSize.width}]]},layout:{paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return.1},paddingBottom:function(e,t){return 0}}}),r.resolve(n)};return e.options.qrCode?$.when(d(l())).then(function(n){n?$.when(TC.Util.addToCanvas(e.canvas,n,{x:e.canvas.width-t.qrCode.sideLength,y:e.canvas.height-t.qrCode.sideLength})).then(function(e){a(e)}):(TC.error(e.getLocaleString("print.qr.error")),a(e.canvas))}):a(e.canvas),r.promise()},g=function(t){var n=$.Deferred(),r=function(e,t,n){if(t.isVisibleByScale(e.name)){var r,a;t.options&&t.options.params&&t.options.params.base64LegendSrc?a=t.options.params.base64LegendSrc:e.legend&&(r=e.legend.src),result.push({src:r,title:e.title,level:n,srcBase64:a})}},i=function(e,t,n,r){if(Array.isArray(e))for(var a=0;a<e.length;a++)i(e[a],t,n,r);else e&&e.hasOwnProperty("children")&&e.children.length>0&&(e.title&&e.name&&result.push({header:e.title,level:r}),i(e.children,t,n,++r));e&&e.hasOwnProperty("children")&&0==e.children.length&&(t.apply(this,[e,n,r]),r--)},o=function(){for(var e=[],t=0;t<d.length;t++)for(var n=d[t].layers,r=0;r<n.length;r++)!function(t,n){var r=d[t].layers[n],a=r.src||r.srcBase64;if(a){var i=TC.Util.imgToDataUrl(a,"image/png");e.push(i),i.then(function(e,t){r.image={base64:e,canvas:t}})}}(t,r);return e};if(e.options.legend&&e.options.legend.visible){var s=e.options.legend.orientation||a,l=e.map.workLayers,d=[],c=7;if(t.content=t.content||{},l.length>0){for(var h=0;h<l.length;h++){var p=l[h];p.type===TC.Consts.layerType.WMS&&p.getVisibility()&&(result=[],i(p.getTree(),r,p,0),result.length>0&&d.push({title:p.title,layers:result}))}$.when.apply($,o()).then(function(){d.length>0&&t.content.push({text:" ",pageBreak:"before",pageOrientation:s});for(var e=0;e<d.length;e++){var r=d[e],a=10;t.content.push({text:r.title,fontSize:11,margin:[0,0,0,5]});for(var i=0;i<r.layers.length;i++){var o=r.layers[i];if(a=c*o.level,o.header)t.content.push({text:o.header,fontSize:10,margin:[a,0,0,3]});else{var l=o.image.canvas.width/2,h=l*o.image.canvas.height/o.image.canvas.width;t.content.push({text:o.title,fontSize:9,margin:[a,0,0,2]}),t.content.push({image:o.image.base64,width:l,height:h,margin:[a,0,0,2]})}}}n.resolve(t)})}else n.resolve(t)}else n.resolve(t);return n.promise()},f=function(e){var t=window.location.host+"_",n=TC.Util.getParameterByName("title");if(n)t+=n;else{var r=TC.Util.getFormattedDate((new Date).toString());t+=r}pdfMake.createPdf(e).download(t.replace(/[\\\/:*?"<>\|]/g,"")+".pdf")},u=e.map.getControlsByClass(TC.control.LoadingIndicator)[0],m=u.addWait();$.when(e.pdfLibPromise).then(c).then(h).then(p).then(g).then(f).then(function(){u.removeWait(m)})},e.getLayersFromOpener=function(e){var t=this,n=window.opener;if(n){var e=t.options.openerMap;if(e){for(var r=e.split("."),a=n,i=0;i<r.length;i++)a=a[r[i]];var o=a}o?t.map.loaded(function(){0===n.location.hash.length&&t.map.setExtent(o.options.initialExtent);for(var e=0;e<t.map.baseLayers.length;e++)t.map.removeLayer(t.map.baseLayers[e]);var r=o.getBaseLayer();t.map.addLayer({id:r.id,title:r.title,type:r.type,url:r.url,encoding:r.encoding,layerNames:r.layerNames,matrixSet:r.matrixSet,format:r.format,minResolution:r.minResolution,maxZoom:r.maxZoom,isBase:!0});for(var a=o.workLayers,e=0;e<a.length;e++){var i=a[e];if((i.type===TC.Consts.layerType.VECTOR||i.type===TC.Consts.layerType.WFS)&&i.getVisibility()&&i.features.length>0){var s=i.features;t.map.addLayer(i,function(e){for(var t=0;t<s.length;t++)e.addFeature(s[t])})}else i.type===TC.Consts.layerType.WMS&&i.options.stateless&&t.map.addLayer({id:i.id,title:i.title,type:i.type,method:i.method,url:i.url,format:i.format,stateless:i.stateless,params:i.params,layerNames:i.layerNames})}}):TC.error("No se ha definido una variable con el contenido de TC.Map en el visor original")}}}();