TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.PrintPdf=function(){var e=this;TC.Control.apply(e,arguments)},TC.inherit(TC.control.PrintPdf,TC.Control),function(){var e=TC.control.PrintPdf.prototype;e.CLASS="tc-ctl-print-pdf";var t={marginTop:20,marginLeft:55,a4:{width:596,height:842},a3:{width:842,height:1191},qrCode:{sideLength:85},headerHeight:20},n={PORTRAIT:"portrait",LANDSCAPE:"landscape"},a={A4:"a4",A3:"a3"},i=TC.Util.getParameterByName("orientation"),r=TC.Util.getParameterByName("size"),o=function(e,a){return e===n.PORTRAIT?t[a].width:t[a].height},s=function(e,a){return e===n.PORTRAIT?t[a].height:t[a].width};e.template=TC.isDebug?TC.apiLocation+"TC/templates/PrintPdf.html":function(){function t(e,t){return e.w('<button disabled class="disabled tc-button tc-ctl-print-pdf-btn" title="').h("i18n",t,{},{$key:"printpdf"}).w('"></button>')}return dust.register(e.CLASS,t),t.__dustBody=!0,t};var l=function(){var e=window.location.href,t=e.indexOf("?"),n=e.indexOf("#");return t>0&&(e=n>t?e.replace(e.substring(t,n),""):e.replace(e.substring(t,e.length-1),"")),e},d=function(e){var n=$.Deferred(),a=150;return e?TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>a&&(e=TC.Util.shortenUrl(e));var i=$("#qrcode");i.empty();new QRCode(i.get(0),{text:e,width:t.qrCode.sideLength,height:t.qrCode.sideLength});setTimeout(function(){var e=i.find("img").attr("src");n.resolve(e)},100)}):n.resolve(imgBase64),n.promise()};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t.pdfLibPromise=function(){var e=$.Deferred();return window.pdfMake?e.resolve():TC.loadJS(!window.pdfMake,[TC.Consts.url.PDFMAKE],function(){e.resolve()}),e.promise()}();var n=!0;e._$div.on("mouseover",function(){n&&(e.toast(t.getLocaleString("print.advice.title")+": "+t.getLocaleString("print.advice.desc"),{type:TC.Consts.msgType.INFO,duration:7e3}),n=!1)});var a="."+t.CLASS+"-btn";t.map.$events.on(TC.Consts.event.STARTLOADING,function(){var e=t._$div.find(a);e.addClass("disabled"),e.attr("disabled","disabled")}),t.map.$events.on(TC.Consts.event.STOPLOADING,function(){var e=t._$div.find(a);e.removeClass("disabled"),e.removeAttr("disabled")}),t.getLayersFromOpener(),t.options.qrCode&&d(l()),t._$div.on("click","."+t.CLASS+"-btn",function(){t.createPdf()})};var c=function(){var e=$.Deferred(),o={pageOrientation:i||n.LANDSCAPE,pageSize:r||a.A4,pageMargins:[t.marginLeft,t.marginTop]};return e.resolve(o),e.promise()};e.createPdf=function(){var e=this,n=o(i,r),a=s(i,r);e.canvas=$(".tc-map .ol-viewport canvas")[0],e.mapSize=TC.Util.calculateAspectRatioFit(e.canvas.width,e.canvas.height,n-2*t.marginLeft,a-2*t.marginTop-t.headerHeight);var p=function(n){n.content=n.content||[];var a=$.Deferred(),i=e.map.getControlsByClass(TC.control.ScaleBar)[0];if(i)var r=$(".tc-ctl-sb .ol-scale-line-inner"),o=e.canvas.width/e.mapSize.width,s=r.width()/o;var l=function(e){var t;e&&(t=[[e]]),t[0].push({text:TC.Util.getParameterByName("title"),alignment:"center",fontSize:11}),i&&t[0].push({table:{widths:[s],body:[[{text:i.getText(),fontSize:10,alignment:"center"}]]},layout:{hLineWidth:function(e,t){return 0===e?0:1},paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return 0},paddingBottom:function(e,t){return 0}}}),n.content.push({table:{widths:[s,"*",s]},layout:"noBorders"}),n.content[0].table.body=t,a.resolve(n)};return e.options.logo?$.when(TC.Util.imgToDataUrl(e.options.logo,"image/png")).then(function(e,n){var a=(t.headerHeight,n.width*t.headerHeight/n.height,TC.Util.calculateAspectRatioFit(n.width,n.height,s,t.headerHeight));l({image:e,height:a.height,width:a.width})}):l(),a.promise()},g=function(n){var a=$.Deferred();n.content=n.content||[];var i=function(t){n.content.push({table:{widths:["*"],body:[[{image:TC.Util.toDataUrl(t),width:e.mapSize.width}]]},layout:{paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return.1},paddingBottom:function(e,t){return 0}}}),a.resolve(n)};return e.options.qrCode?$.when(d(l())).then(function(n){n?$.when(TC.Util.addToCanvas(e.canvas,n,{x:e.canvas.width-t.qrCode.sideLength,y:e.canvas.height-t.qrCode.sideLength})).then(function(e){i(e)}):(TC.error(e.getLocaleString("print.qr.error")),i(e.canvas))}):i(e.canvas),a.promise()},h=function(t){var n=$.Deferred(),a=function(e,t,n){if(t.isVisibleByScale(e.name)){var a,i;t.options&&t.options.params&&t.options.params.base64LegendSrc?i=t.options.params.base64LegendSrc:e.legend&&(a=e.legend.src),result.push({src:a,title:e.title,level:n,srcBase64:i})}},r=function(e,t,n,a){if(Array.isArray(e))for(var i=0;i<e.length;i++)r(e[i],t,n,a);else e&&e.hasOwnProperty("children")&&e.children.length>0&&(e.title&&e.name&&result.push({header:e.title,level:a}),r(e.children,t,n,++a));e&&e.hasOwnProperty("children")&&0==e.children.length&&(t.apply(this,[e,n,a]),a--)},o=function(){for(var e=[],t=0;t<d.length;t++)for(var n=d[t].layers,a=0;a<n.length;a++)!function(t,n){var a=d[t].layers[n],i=a.src||a.srcBase64;if(i){var r=TC.Util.imgToDataUrl(i,"image/png");e.push(r),r.then(function(e,t){a.image={base64:e,canvas:t}})}}(t,a);return e};if(e.options.legend&&e.options.legend.visible){var s=e.options.legend.orientation||i,l=e.map.workLayers,d=[],c=7;if(t.content=t.content||{},l.length>0){for(var p=l.length-1;p>=0;p--){var g=l[p];g.type===TC.Consts.layerType.WMS&&g.getVisibility()&&(result=[],r(g.getTree(),a,g,0),result.length>0&&d.push({title:g.title,layers:result}))}$.when.apply($,o()).then(function(){d.length>0&&t.content.push({text:" ",pageBreak:"before",pageOrientation:s});for(var e=0;e<d.length;e++){var a=d[e],i=10;t.content.push({text:a.title,fontSize:11,margin:[0,0,0,5]});for(var r=0;r<a.layers.length;r++){var o=a.layers[r];if(i=c*o.level,o.header)t.content.push({text:o.header,fontSize:10,margin:[i,0,0,3]});else if(t.content.push({text:o.title,fontSize:9,margin:[i,0,0,2]}),o.image){var l=o.image.canvas.width/2,p=l*o.image.canvas.height/o.image.canvas.width;t.content.push({image:o.image.base64,width:l,height:p,margin:[i,0,0,2]})}}}n.resolve(t)})}else n.resolve(t)}else n.resolve(t);return n.promise()},u=function(e){var t=window.location.host+"_",n=TC.Util.getParameterByName("title");if(n)t+=n;else{var a=TC.Util.getFormattedDate((new Date).toString());t+=a}pdfMake.createPdf(e).download(t.replace(/[\\\/:*?"<>\|]/g,"")+".pdf")},f=e.map.getControlsByClass(TC.control.LoadingIndicator)[0],m=f.addWait();$.when(e.pdfLibPromise).then(c).then(p).then(g).then(h).then(u).then(function(){f.removeWait(m)})},e.getLayersFromOpener=function(e){var t=this,n=window.opener;if(n){var a=n.refererMap;a&&t.map.loaded(function(){0===n.location.hash.length&&t.map.setExtent(a.options.initialExtent);for(var e=0;e<t.map.baseLayers.length;e++)t.map.removeLayer(t.map.baseLayers[e]);var i=a.getBaseLayer();t.map.addLayer({id:i.id,title:i.title,type:i.type,url:i.url,encoding:i.encoding,layerNames:i.layerNames,matrixSet:i.matrixSet,format:i.format,minResolution:i.minResolution,maxZoom:i.maxZoom,isBase:!0});for(var r,o=a.workLayers,e=0;e<o.length;e++)r=o[e],r.type===TC.Consts.layerType.WMS&&r.options.stateless&&t.map.addLayer({id:r.id,title:r.title,type:r.type,method:r.method,url:r.url,format:r.format,stateless:r.stateless,params:r.params,layerNames:r.layerNames},function(e){e.setVisibility(r.getVisibility()),e.setOpacity(r.getOpacity())});var s=window.opener.mapFeatures;s&&t.map.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR},function(e){TC.loadJS(!TC.feature,[TC.apiLocation+"TC/Feature.js",TC.apiLocation+"TC/feature/Point.js",TC.apiLocation+"TC/feature/Polyline.js",TC.apiLocation+"TC/feature/Polygon.js",TC.apiLocation+"TC/feature/MultiPolygon.js",TC.apiLocation+"TC/feature/MultiPolyline.js",TC.apiLocation+"TC/feature/Circle.js",TC.apiLocation+"TC/feature/Marker.js"],function(){for(var t=0;t<s.length;t++){var n=s[t];switch(n.CLASSNAME){case"TC.feature.Point":e.addPoint(n.geometry,n.options);break;case"TC.feature.Polyline":e.addPolyline(n.geometry,n.options);break;case"TC.feature.Polygon":e.addPolygon(n.geometry,n.options);break;case"TC.feature.MultiPolygon":e.addMultiPolygon(n.geometry,n.options);break;case"TC.feature.MultiPolyline":e.addMultiPolyline(n.geometry,n.options);break;case"TC.feature.Circle":e.addCircle(n.geometry,n.options);break;case"TC.feature.Marker":e.addMarker(n.geometry,n.options)}}})})})}}}();