TC.control=TC.control||{},TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC.js"),TC.control.ListTOC=function(){var t=this;TC.control.TOC.apply(t,arguments),t.layers=[]},TC.inherit(TC.control.ListTOC,TC.control.TOC),function(){var t=TC.control.ListTOC.prototype;t.CLASS="tc-ctl-ltoc",t.CLICKEVENT="click.tc",TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag",TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend",TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/ListTOC.html",t.template[t.CLASS+"-elm"]=TC.apiLocation+"TC/templates/ListTOCElement.html",t.template[t.CLASS+"-type-sgl"]=TC.apiLocation+"TC/templates/ListTOCTooltipSingle.html",t.template[t.CLASS+"-type-grp"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroup.html",t.template[t.CLASS+"-type-grp-node"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroupNode.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-ltoc-n"></span><button class="tc-ctl-ltoc-del-all tc-hidden" title="').h("i18n",e,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-ltoc-empty">').h("i18n",e,{},{$key:"noData"}).w('</div><div class="tc-ctl-ltoc-content"><form><ul>').s(e.get(["workLayers"],!1),e,{block:a},{}).w("</ul></form></div>")}function a(t,e){return t.p("tc-ctl-ltoc-elm",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS,e),e.__dustBody=!0,a.__dustBody=!0,e},t.template[t.CLASS+"-elm"]=function(){function e(t,e){return t.w('<li class="tc-ctl-ltoc-elm"><div class="tc-ctl-ltoc-lyr">').f(e.get(["title"],!1),e,"h").w('</div><div class="tc-ctl-ltoc-type"></div><div class="tc-ctl-ltoc-path">').s(e.get(["path"],!1),e,{block:a},{}).w('</div><div><div class="tc-ctl-ltoc-btn-info" title="').h("i18n",e,{},{$key:"infoFromThisLayer"}).w('"></div><input type="range" value="').f(e.get(["opacity"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"transparencyOfThisLayer"}).w('" /><input type="checkbox" ').nx(e.get(["hide"],!1),e,{block:s},{}).w(' title="').h("i18n",e,{},{$key:"visibilityOfThisLayer"}).w('" /></div><div class="tc-ctl-ltoc-info tc-hidden">').x(e.get(["abstract"],!1),e,{block:r},{}).x(e.get(["legend"],!1),e,{block:o},{}).x(e.get(["metadata"],!1),e,{block:l},{}).w('</div><div class="tc-ctl-ltoc-dd ').x(e.get(["hide"],!1),e,{block:d},{}).w('" title="').h("i18n",e,{},{$key:"dragToReorder"}).w('"></div><div class="tc-ctl-ltoc-del ').nx(e.get(["hide"],!1),e,{block:C},{}).w('" title="').h("i18n",e,{},{$key:"removeLayerFromMap"}).w('"></div></li>')}function a(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:n},{})}function n(t,e){return t.w(" &bull; ")}function s(t,e){return t.w('checked="checked"')}function r(t,e){return t.w('<div class="tc-ctl-ltoc-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div>").f(e.get(["abstract"],!1),e,"h").w("</div></div>")}function o(t,e){return t.w('<div class="tc-ctl-ltoc-legend" data-tc-layer-name="').f(e.get(["layerNames"],!1),e,"h").w('"><h4>').h("i18n",e,{},{$key:"content"}).w("</h4>").s(e.get(["legend"],!1),e,{block:i},{}).w(" </div>")}function i(t,e){return t.w("<div><p>").f(e.get(["title"],!1),e,"h").w('</p><img data-tc-img="').f(e.get(["src"],!1),e,"h").w('" /></div>')}function l(t,e){return t.w('<div class="tc-ctl-ltoc-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:c},{}).w("</ul></div>")}function c(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h").w("</a></li>")}function d(t,e){return t.w("tc-hidden")}function C(t,e){return t.w("tc-hidden")}return dust.register(t.CLASS+"-elm",e),e.__dustBody=!0,a.__dustBody=!0,n.__dustBody=!0,s.__dustBody=!0,r.__dustBody=!0,o.__dustBody=!0,i.__dustBody=!0,l.__dustBody=!0,c.__dustBody=!0,d.__dustBody=!0,C.__dustBody=!0,e},t.template[t.CLASS+"-type-sgl"]=function(){function e(t,e){return t.h("i18n",e,{},{$key:"singleLayer"})}return dust.register(t.CLASS+"-type-sgl",e),e.__dustBody=!0,e},t.template[t.CLASS+"-type-grp"]=function(){function e(t,e){return t.w("<div>").h("i18n",e,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(e.get(["Layer"],!1),e,{block:a},{}).w("</ul>")}function a(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-type-grp",e),e.__dustBody=!0,a.__dustBody=!0,e},t.template[t.CLASS+"-type-grp-node"]=function(){function e(t,e){return t.w('<li class="tc-ctl-ltoc-tip-grp-elm"><span>').f(e.get(["Title"],!1),e,"h").w("</span><ul>").s(e.get(["Layer"],!1),e,{block:a},{}).w("</ul></li>")}function a(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-type-grp-node",e),e.__dustBody=!0,a.__dustBody=!0,e});var e={layer:"tcLayer"},a=function(t,a){var n;return t._$div.find("li."+t.CLASS+"-elm").each(function(t,s){var r=$(s);return r.data(e.layer)===a?(n=r,!1):void 0}),n},n=function(t){return $.grep(t.map.workLayers,function(t){return!t.stealth}).length};t.register=function(t){var n=this;TC.control.TOC.prototype.register.call(n,t),t.off(TC.Consts.event.EXTERNALSERVICEADDED),t.on(TC.Consts.event.LAYEROPACITY,function(t){var e=a(n,t.layer);e&&e.find("input[type=range]").val(Math.round(100*t.opacity))}).on(TC.Consts.event.LAYERORDER,function(a){if(a.oldIndex>=0&&a.oldIndex!==a.newIndex)for(var s,r,o=n._$div.find("ul").first(),i=o.children("li."+n.CLASS+"-elm"),l=t.workLayers.length-1;l>=0;l--){var c=t.workLayers[l];if(r=s,i.each(function(t,a){var n=$(a);return n.data(e.layer)===c?(s=n,!1):void 0}),c===a.layer){r?r.after(s):o.prepend(s);break}}}).on(TC.Consts.event.FEATURESIMPORT,function(e){var a=e.fileName;if(e.features&&e.features.length>0){var s="."+TC.Consts.format.GPX.toLowerCase();if(e.fileName.toLowerCase().indexOf(s)===e.fileName.length-s.length)return;t.one(TC.Consts.event.LAYERADD,function(t){if(t&&t.layer&&t.layer.title==a){if(n.map&&n.map.layout&&n.map.layout.accordion&&n._$div.hasClass(TC.Consts.classes.COLLAPSED))for(var e=0;e<n.map.controls.length;e++)n.map.controls[e]!==n&&n.map.controls[e]._$div.addClass(TC.Consts.classes.COLLAPSED);n.map.$events.trigger($.Event(TC.Consts.event.TOOLSOPEN),{}),n._$div.removeClass(TC.Consts.classes.COLLAPSED)}})}})},t._addBrowserEventHandlers=function(){var t=this;t._$div.on(t.CLICKEVENT,"input[type=checkbox]",function(a){var n=$(a.target),s=n.parents("li."+t.CLASS+"-elm").first(),r=s.data(e.layer),o=n.prop("checked");r.setVisibility(o),a.stopPropagation()}).on("change input","input[type=range]",function(t){var a=$(t.target),n=a.parents("li").first().data(e.layer);n.setOpacity(a.val()/100)}).on(t.CLICKEVENT,"."+t.CLASS+"-del",function(a){var n=$(a.target).parents("li").first(),s=n.data(e.layer);t.map.removeLayer(s)}).on(t.CLICKEVENT,"."+t.CLASS+"-del-all",function(a){TC.confirm(t.getLocaleString("layersRemove.confirm"),function(){var a=t._$div.find("li."+t.CLASS+"-elm"),n=new Array(a.length);a.each(function(t,a){n[t]=$(a).data(e.layer)});for(var s=0,r=n.length;r>s;s++)t.map.removeLayer(n[s])})}).on(t.CLICKEVENT,"."+t.CLASS+"-btn-info",function(a){var n=$(a.target),s=n.parents("li").first(),r=s.find("."+t.CLASS+"-info");r.find("."+t.CLASS+"-legend img").each(function(a,n){var r=s.data(e.layer);t.styleLegendImage($(n),r)}),r.toggleClass(TC.Consts.classes.HIDDEN),s.find('input[type="checkbox"]').is(":checked")&&s.find("."+t.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!r.hasClass(TC.Consts.classes.HIDDEN)),n.toggleClass(TC.Consts.classes.CHECKED)})},t.updateLayerVisibility=function(t){var e=this,n=a(e,t);if(n){var s=t.getVisibility();n.find("."+e.CLASS+"-del").toggleClass(TC.Consts.classes.HIDDEN,s),n.find("."+e.CLASS+"-info").hasClass(TC.Consts.classes.HIDDEN)&&n.find("."+e.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!s)}},t.updateLayerTree=function(t){var a=this,s=function(t,n,s){if(t!==n){for(var r=t.data(e.layer),o=n.data(e.layer),i=-1,l=0;l<a.map.layers.length;l++)if(o===a.map.layers[l]){i=l;break}i>=1&&i<a.map.layers.length&&a.map.insertLayer(r,i,s)}},r=function(t){var e=$.Deferred();return t&&t.options.method&&"POST"===t.options.method?t.getLegendGraphicImage().done(function(t){e.resolve(t)}).fail(function(t){TC.error(t)}):e.resolve(),e.promise()};if(!t.isBase&&!t.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(a,t);for(var o=!1,i=0,l=a.layers.length;l>i;i++)if(t===a.layers[i]){o=!0;break}if(!o){var c=a.CLASS+"-elm";a.layers.push(t),TC.loadJSInOrder(!window.dust,TC.url.templating,function(){TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){var n=t.title?t.title:t.capabilities.Service.Title,o={title:t.options.hideTitle?"":n,hide:t.renderOptions&&t.renderOptions.hide?!0:!1,opacity:t.renderOptions&&t.renderOptions.opacity?100*t.renderOptions.opacity:100},i=t.isRaster();if(i){o.layerNames=t.layerNames;var l=t.getPath();l.shift(),o.path=l;var d=t.names[0],C=t.wrap.getInfo(d);o.legend=C.legend,o["abstract"]=C["abstract"];var p,f=C.hasOwnProperty("abstract")||C.hasOwnProperty("legend")||C.hasOwnProperty("metadata");if(t.tree&&t.tree.children&&t.tree.children.length&&t.tree.children[0].children&&t.tree.children[0].children.length)p=null;else if(p=C.metadata)for(var u=0,g=p.length;g>u;u++){var v=p[u];v.formatDescription=a.getLocaleString(TC.Util.getSimpleMimeType(v.format))||a.getLocaleString("viewMetadata")}o.metadata=p}r(t).done(function(n){n&&(legend.src=n),dust.render(c,o,function(n,r){var o,l=$(r),c=!1;if(i&&(c=t.names.length>1,!c))for(var C=t.wrap.getAllLayerNodes(),p=0;p<C.length;p++){var u=C[p];if(t.wrap.getName(u)===d){o=u,t.wrap.getLayerNodes(u).length>0&&(c=!0);break}}var g=l.find("."+a.CLASS+"-type"),v=c?a.CLASS+"-type-grp":a.CLASS+"-type-sgl";g.addClass(v),f||l.find("."+a.CLASS+"-btn-info").addClass(TC.Consts.classes.HIDDEN),o&&(t.wrap.normalizeLayerNode(o),dust.render(v,o,function(t,e){var n;g.on("mouseover",function(t){var s=g.offset(),r=$(a.map.div).offset();n=$("<div>").addClass(a.CLASS+"-tip").html(e).css({top:s.top-r.top+"px",right:$(a.map.div).width()-(s.left-r.left)+"px"}).appendTo(a.map.div)}).on("mouseout",function(t){n.remove()})}));var h=a._$div.find("ul").first();l.data(e.layer,t),l.drag("start",function(t,e){var a=$(this),n=h.children("li");n.not(a).addClass(TC.Consts.classes.DRAGEND);n.index(a);a.css("zIndex",100).addClass(TC.Consts.classes.DRAG);var s=n.last(),r=a.position();e.limit={top:n.first().position().top-r.top,bottom:s.height()+s.position().top-r.top-a.height()-1},e.dropTargetIndex=-1}).drag("end",function(t,e){var a=$(this);a.removeClass(TC.Consts.classes.DRAG).addClass(TC.Consts.classes.DRAGEND);var n=a.css("transform");n=parseInt(n.substr(n.lastIndexOf(",")+1));var r,o,i=this.getBoundingClientRect().top-n;if(e.dropTargetIndex>=0){r=h.children("li").get(e.dropTargetIndex),o=$(r);var l=o.css("transform");l=parseInt(l.substr(l.lastIndexOf(",")+1));var c=r.getBoundingClientRect().top-l}a.css("transform",o?"translateY("+(c-i)+"px)":"");var d="transitionend.tc";a.on(d,function C(t){"transform"===t.originalEvent.propertyName&&(a.off(d,C).removeClass(TC.Consts.classes.DRAGEND).css("zIndex",""),o&&s(a,o,function(){h.children("li").css("transform","").removeClass(TC.Consts.classes.DRAGEND)}))})}).drag(function(t,e){var a,n=$(this),s=Math.min(Math.max(e.limit.top,Math.round(e.deltaY)),e.limit.bottom),r=this.getBoundingClientRect(),o=r.height-1,i=(r.top+r.bottom)/2,l=[],c=h.children("li");c.each(function(t,n){var s=n.getBoundingClientRect();l[t]={elm:n,top:s.top,bottom:s.bottom},n===e.drag&&(a=t)});for(var d,C=-1,p=0,f=l.length;f>p;p++){var u=l[p];a>p?(i<u.bottom?i>u.top&&e.deltaY>e.prevDeltaY?d="":(d="translateY("+o+"px)",0>C&&(C=p)):d="",$(u.elm).css("transform",d)):p>a&&(i>u.top?i<u.bottom&&e.deltaY<e.prevDeltaY?d="":(d="translateY(-"+o+"px)",C=p):d="",$(u.elm).css("transform",d))}e.dropTargetIndex=C,n.css("transform","translateY("+s+"px)"),e.prevDeltaY=e.deltaY},{handle:"."+a.CLASS+"-dd"}),h.prepend(l),a.updateScale()})})})});var d=n(a);$("."+a.CLASS+"-n").text(d).toggleClass(TC.Consts.classes.VISIBLE,d>0),a._$div.find("."+a.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,d>0),a._$div.find("."+a.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,!1)}}},t.updateScale=function(){var t=this;t._$div.find("ul").find("li."+t.CLASS+"-elm").each(function(a,n){var s=$(n),r=s.data(e.layer);if(r.names){for(var o=!1,i=0;i<r.names.length;i++)if(r.isVisibleByScale(r.names[i])){o=!0;break}s.toggleClass(t.CLASS+"-elm-notvisible",!o)}})},t.removeLayer=function(t){var a=this,s=a.layers.indexOf(t);s>=0&&a.layers.splice(s,1);var r=a._$div.find("ul").first();r.find("li."+a.CLASS+"-elm").each(function(a,n){var s=$(n);return s.data(e.layer)===t?(s.remove(),!1):void 0});var o=n(a);a._$div.find("."+a.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,0===o),a._$div.find("."+a.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,o>0),$("."+a.CLASS+"-n").text(o).toggleClass(TC.Consts.classes.VISIBLE,o>0)}}();