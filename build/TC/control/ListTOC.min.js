TC.control=TC.control||{},TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC.js"),TC.control.ListTOC=function(){var t=this;TC.control.TOC.apply(t,arguments),t.layers=[]},TC.inherit(TC.control.ListTOC,TC.control.TOC),function(){var t=TC.control.ListTOC.prototype;t.CLASS="tc-ctl-ltoc",t.CLICKEVENT="click.tc",TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag",TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/ListTOC.html",t.template[t.CLASS+"-elm"]=TC.apiLocation+"TC/templates/ListTOCElement.html",t.template[t.CLASS+"-type-sgl"]=TC.apiLocation+"TC/templates/ListTOCTooltipSingle.html",t.template[t.CLASS+"-type-grp"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroup.html",t.template[t.CLASS+"-type-grp-node"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroupNode.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-ltoc-n"></span><button class="tc-ctl-ltoc-del-all tc-hidden" title="').h("i18n",e,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-ltoc-empty">').h("i18n",e,{},{$key:"noData"}).w('</div><div class="tc-ctl-ltoc-content"><form><ul>').s(e.get(["workLayers"],!1),e,{block:n},{}).w("</ul></form></div>")}function n(t,e){return t.p("tc-ctl-ltoc-elm",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS,e),e.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-elm"]=function(){function e(t,e){return t.w('<li class="tc-ctl-ltoc-elm"><div class="tc-ctl-ltoc-lyr">').f(e.get(["title"],!1),e,"h").w('</div><div class="tc-ctl-ltoc-type"></div><div class="tc-ctl-ltoc-path">').s(e.get(["path"],!1),e,{block:n},{}).w('</div><div><div class="tc-ctl-ltoc-btn-info" title="').h("i18n",e,{},{$key:"infoFromThisLayer"}).w('"></div><input type="range" value="').f(e.get(["opacity"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"transparencyOfThisLayer"}).w('" /><input type="checkbox" ').nx(e.get(["hide"],!1),e,{block:s},{}).w(' title="').h("i18n",e,{},{$key:"visibilityOfThisLayer"}).w('" /></div><div class="tc-ctl-ltoc-info tc-hidden">').x(e.get(["abstract"],!1),e,{block:r},{}).x(e.get(["legend"],!1),e,{block:o},{}).x(e.get(["metadata"],!1),e,{block:l},{}).w('</div><div class="tc-ctl-ltoc-dd ').x(e.get(["hide"],!1),e,{block:d},{}).w('" title="').h("i18n",e,{},{$key:"dragToReorder"}).w('"></div><div class="tc-ctl-ltoc-del ').nx(e.get(["hide"],!1),e,{block:C},{}).w('" title="').h("i18n",e,{},{$key:"removeLayerFromMap"}).w('"></div></li>')}function n(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:a},{})}function a(t,e){return t.w(" &bull; ")}function s(t,e){return t.w('checked="checked"')}function r(t,e){return t.w('<div class="tc-ctl-ltoc-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div>").f(e.get(["abstract"],!1),e,"h").w("</div></div>")}function o(t,e){return t.w('<div class="tc-ctl-ltoc-legend" data-tc-layer-name="').f(e.get(["layerNames"],!1),e,"h").w('"><h4>').h("i18n",e,{},{$key:"content"}).w("</h4>").s(e.get(["legend"],!1),e,{block:i},{}).w(" </div>")}function i(t,e){return t.w("<div><p>").f(e.get(["title"],!1),e,"h").w('</p><img data-tc-img="').f(e.get(["src"],!1),e,"h").w('" /></div>')}function l(t,e){return t.w('<div class="tc-ctl-ltoc-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:c},{}).w("</ul></div>")}function c(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h").w("</a></li>")}function d(t,e){return t.w("tc-hidden")}function C(t,e){return t.w("tc-hidden")}return dust.register(t.CLASS+"-elm",e),e.__dustBody=!0,n.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,r.__dustBody=!0,o.__dustBody=!0,i.__dustBody=!0,l.__dustBody=!0,c.__dustBody=!0,d.__dustBody=!0,C.__dustBody=!0,e},t.template[t.CLASS+"-type-sgl"]=function(){function e(t,e){return t.h("i18n",e,{},{$key:"singleLayer"})}return dust.register(t.CLASS+"-type-sgl",e),e.__dustBody=!0,e},t.template[t.CLASS+"-type-grp"]=function(){function e(t,e){return t.w("<div>").h("i18n",e,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(e.get(["Layer"],!1),e,{block:n},{}).w("</ul>")}function n(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-type-grp",e),e.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-type-grp-node"]=function(){function e(t,e){return t.w('<li class="tc-ctl-ltoc-tip-grp-elm"><span>').f(e.get(["Title"],!1),e,"h").w("</span><ul>").s(e.get(["Layer"],!1),e,{block:n},{}).w("</ul></li>")}function n(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-type-grp-node",e),e.__dustBody=!0,n.__dustBody=!0,e});var e={layer:"tcLayer"},n=function(t,n){var a;return t._$div.find("li."+t.CLASS+"-elm").each(function(t,s){var r=$(s);return r.data(e.layer)===n?(a=r,!1):void 0}),a},a=function(t){return $.grep(t.map.workLayers,function(t){return!t.stealth}).length};t.register=function(t){var a=this;TC.control.TOC.prototype.register.call(a,t),t.$events.off(TC.Consts.event.EXTERNALSERVICEADDED),a._$div.off(TC.Consts.event.CLICK,"input[type=checkbox]").on(a.CLICKEVENT,"input[type=checkbox]",function(t){var n=$(t.target),s=n.parents("li."+a.CLASS+"-elm").first(),r=s.data(e.layer),o=n.prop("checked");r.setVisibility(o),t.stopPropagation()}).on("change input","input[type=range]",function(t){var n=$(t.target),a=n.parents("li").first().data(e.layer);a.setOpacity(n.val()/100)}).on(a.CLICKEVENT,"."+a.CLASS+"-del",function(n){var a=$(n.target).parents("li").first(),s=a.data(e.layer);t.removeLayer(s)}).on(a.CLICKEVENT,"."+a.CLASS+"-del-all",function(n){TC.confirm(a.getLocaleString("layersRemove.confirm"),function(){var n=a._$div.find("li."+a.CLASS+"-elm"),s=new Array(n.length);n.each(function(t,n){s[t]=$(n).data(e.layer)});for(var r=0,o=s.length;o>r;r++)t.removeLayer(s[r])})}).on(a.CLICKEVENT,"."+a.CLASS+"-btn-info",function(t){var n=$(t.target),s=n.parents("li").first(),r=s.find("."+a.CLASS+"-info");r.find("."+a.CLASS+"-legend img").each(function(t,n){var r=s.data(e.layer);a.styleLegendImage($(n),r)}),r.toggleClass(TC.Consts.classes.HIDDEN),s.find('input[type="checkbox"]').is(":checked")&&s.find("."+a.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!r.hasClass(TC.Consts.classes.HIDDEN)),n.toggleClass(TC.Consts.classes.CHECKED)}),t.on(TC.Consts.event.LAYEROPACITY,function(t){var e=n(a,t.layer);e&&e.find("input[type=range]").val(Math.round(100*t.opacity))}).on(TC.Consts.event.LAYERORDER,function(n){if(n.oldIndex>=0&&n.oldIndex!==n.newIndex)for(var s,r,o=a._$div.find("ul").first(),i=o.children("li."+a.CLASS+"-elm"),l=t.workLayers.length-1;l>=0;l--){var c=t.workLayers[l];if(r=s,i.each(function(t,n){var a=$(n);return a.data(e.layer)===c?(s=a,!1):void 0}),c===n.layer){r?r.after(s):o.prepend(s);break}}})},t.updateLayerVisibility=function(t){var e=this,a=n(e,t);if(a){var s=t.getVisibility();a.find("."+e.CLASS+"-del").toggleClass(TC.Consts.classes.HIDDEN,s),a.find("."+e.CLASS+"-info").hasClass(TC.Consts.classes.HIDDEN)&&a.find("."+e.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!s)}},t.updateLayerTree=function(t){var n=this,s=function(t,a,s){if(t!==a){for(var r=t.data(e.layer),o=a.data(e.layer),i=-1,l=0;l<n.map.layers.length;l++)if(o===n.map.layers[l]){i=l;break}i>=1&&i<n.map.layers.length&&n.map.insertLayer(r,i,s)}},r=function(t){var e=$.Deferred();return t&&t.options.method&&"POST"===t.options.method?t.getLegendGraphicImage().done(function(t){e.resolve(t)}).fail(function(t){TC.error(t)}):e.resolve(),e.promise()};if(!t.isBase&&!t.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(n,t);for(var o=!1,i=0,l=n.layers.length;l>i;i++)if(t===n.layers[i]){o=!0;break}if(!o){var c=n.CLASS+"-elm";n.layers.push(t),TC.loadJSInOrder(!window.dust,TC.url.templating,function(){TC.loadJS(!$.fn.drag||!$.fn.drop,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js",TC.apiLocation+"lib/jQuery/jquery.event.drop.js"],function(){$.drop({mode:"middle"});var a=t.title?t.title:t.capabilities.Service.Title,o={title:t.options.hideTitle?"":a,hide:t.renderOptions&&t.renderOptions.hide?!0:!1,opacity:t.renderOptions&&t.renderOptions.opacity?100*t.renderOptions.opacity:100},i=t.isRaster();if(i){o.layerNames=t.layerNames;var l=t.getPath();l.shift(),o.path=l;var d=t.names[0],C=t.wrap.getInfo(d);o.legend=C.legend,o["abstract"]=C["abstract"];var p,f=C.hasOwnProperty("abstract")||C.hasOwnProperty("legend")||C.hasOwnProperty("metadata");if(t.tree&&t.tree.children&&t.tree.children.length&&t.tree.children[0].children&&t.tree.children[0].children.length)p=null;else if(p=C.metadata)for(var u=0,g=p.length;g>u;u++){var y=p[u];y.formatDescription=n.getLocaleString(TC.Util.getSimpleMimeType(y.format))||n.getLocaleString("viewMetadata")}o.metadata=p}r(t).done(function(a){a&&(legend.src=a),dust.render(c,o,function(a,r){var o,l=$(r),c=!1;if(i&&(c=t.names.length>1,!c))for(var C=t.wrap.getAllLayerNodes(),p=0;p<C.length;p++){var u=C[p];if(t.wrap.getName(u)===d){o=u,t.wrap.getLayerNodes(u).length>0&&(c=!0);break}}var g=l.find("."+n.CLASS+"-type"),y=c?n.CLASS+"-type-grp":n.CLASS+"-type-sgl";g.addClass(y),f||l.find("."+n.CLASS+"-btn-info").addClass(TC.Consts.classes.HIDDEN),o&&(t.wrap.normalizeLayerNode(o),dust.render(y,o,function(t,e){var a;g.on("mouseover",function(t){var s=g.offset(),r=$(n.map.div).offset();a=$("<div>").addClass(n.CLASS+"-tip").html(e).css({top:s.top-r.top+"px",right:$(n.map.div).width()-(s.left-r.left)+"px"}).appendTo(n.map.div)}).on("mouseout",function(t){a.remove()})}));var h=n._$div.find("ul").first();l.data(e.layer,t),l.drag("start",function(t,e){var n=$(this);n.css("zIndex",100).addClass(TC.Consts.classes.DRAG);var a=n.position(),s=h.position();e.limit={top:-a.top+s.top,bottom:h.height()+s.top-a.top-n.height()}}).drag("end",function(t,e){var n=$(this);if(e.drop.length){n.addClass(TC.Consts.classes.DRAGEND);for(var a=0;a<e.drop.length;a++)$(e.drop[a]).removeClass(TC.Consts.classes.DROP);var r=$(e.drop[0]),o=n.css("transform");o=parseInt(o.substr(o.lastIndexOf(",")+1));var i=n.position().top-o,l=r.position().top;o=l-i,n.css("transform","translateY("+o+"px)");var c="transitionend.tc";n.on(c,function(t){"transform"===t.originalEvent.propertyName&&(n.off(c),s(n,r,function(){n.removeClass(TC.Consts.classes.DRAGEND).removeClass(TC.Consts.classes.DRAG).css("zIndex","").css("transform","")}))})}else n.css({transform:"",zIndex:""}).removeClass(TC.Consts.classes.DRAG)}).drag(function(t,e){$(this).css("transform","translateY("+Math.min(Math.max(e.limit.top,Math.round(e.deltaY)),e.limit.bottom)+"px)")},{handle:"."+n.CLASS+"-dd"}).drop("init",function(t,e){return!(this==e.drag)}).drop("start",function(){$(this).addClass(TC.Consts.classes.DROP)}).drop("end",function(){$(this).removeClass(TC.Consts.classes.DROP)}),h.prepend(l),n.updateScale()})})})});var d=a(n);$("."+n.CLASS+"-n").text(d).toggleClass(TC.Consts.classes.VISIBLE,d>0),n._$div.find("."+n.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,d>0),n._$div.find("."+n.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,!1)}}},t.updateScale=function(){var t=this;t._$div.find("ul").find("li."+t.CLASS+"-elm").each(function(n,a){var s=$(a),r=s.data(e.layer);if(r.names){for(var o=!1,i=0;i<r.names.length;i++)if(r.isVisibleByScale(r.names[i])){o=!0;break}s.toggleClass(t.CLASS+"-elm-notvisible",!o)}})},t.removeLayer=function(t){var n=this,s=n.layers.indexOf(t);s>=0&&n.layers.splice(s,1);var r=n._$div.find("ul").first();r.find("li."+n.CLASS+"-elm").each(function(n,a){var s=$(a);return s.data(e.layer)===t?(s.remove(),!1):void 0});var o=a(n);n._$div.find("."+n.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,0===o),n._$div.find("."+n.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,o>0),$("."+n.CLASS+"-n").text(o).toggleClass(TC.Consts.classes.VISIBLE,o>0)}}();