TC.control=TC.control||{};TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC");TC.control.ListTOC=function(){TC.control.TOC.apply(this,arguments);this.layers=[]};TC.inherit(TC.control.ListTOC,TC.control.TOC);!function(){var t=TC.control.ListTOC.prototype;t.CLASS="tc-ctl-ltoc";t.CLICKEVENT="click.tc";TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag";TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend";TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc";t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/ListTOC.html";t.template[t.CLASS+"-elm"]=TC.apiLocation+"TC/templates/ListTOCElement.html";t.template[t.CLASS+"-type-sgl"]=TC.apiLocation+"TC/templates/ListTOCTooltipSingle.html";t.template[t.CLASS+"-type-grp"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroup.html";t.template[t.CLASS+"-type-grp-node"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroupNode.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-ltoc-n"></span><button class="tc-ctl-ltoc-del-all tc-hidden" title="').h("i18n",e,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-ltoc-empty">').h("i18n",e,{},{$key:"noData"}).w('</div><div class="tc-ctl-ltoc-content tc-hidden"><form><ul>').s(e.get(["workLayers"],!1),e,{block:n},{}).w("</ul></form></div>")}e.__dustBody=!0;function n(t,e){return t.p("tc-ctl-ltoc-elm",e,e.rebase(e.getPath(!0,[])),{})}n.__dustBody=!0;return e};t.template[t.CLASS+"-elm"]=function(){dust.register(t.CLASS+"-elm",e);function e(t,e){return t.w('<li class="tc-ctl-ltoc-elm" tabindex="-1"><div class="tc-ctl-ltoc-lyr">').x(e.get(["path"],!1),e,{block:n},{}).w('</div><div class="tc-ctl-ltoc-type"></div><div class="tc-ctl-ltoc-path" title="').s(e.get(["path"],!1),e,{else:s,block:a},{}).w('">').s(e.get(["path"],!1),e,{else:o,block:r},{}).w('</div><div><div class="tc-ctl-ltoc-btn-info" title="').h("i18n",e,{},{$key:"infoFromThisLayer"}).w('"></div><input type="range" value="').f(e.get(["opacity"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"transparencyOfThisLayer"}).w('" /><input type="checkbox" ').nx(e.get(["hide"],!1),e,{block:c},{}).w(' title="').h("i18n",e,{},{$key:"visibilityOfThisLayer"}).w('" /></div><div class="tc-ctl-ltoc-info tc-hidden">').x(e.get(["abstract"],!1),e,{block:d},{}).x(e.get(["legend"],!1),e,{block:C},{}).x(e.get(["metadata"],!1),e,{block:f},{}).w('</div><div class="tc-ctl-ltoc-dd ').x(e.get(["hide"],!1),e,{block:g},{}).w('" title="').h("i18n",e,{},{$key:"dragToReorder"}).w('"></div><div class="tc-ctl-ltoc-del ').nx(e.get(["hide"],!1),e,{block:h},{}).w('" title="').h("i18n",e,{},{$key:"removeLayerFromMap"}).w('"></div></li>')}e.__dustBody=!0;function n(t,e){return t.f(e.get(["title"],!1),e,"h")}n.__dustBody=!0;function s(t,e){return t.f(e.get(["title"],!1),e,"h")}s.__dustBody=!0;function a(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:i},{})}a.__dustBody=!0;function i(t,e){return t.w(" &bull; ")}i.__dustBody=!0;function o(t,e){return t.f(e.get(["title"],!1),e,"h")}o.__dustBody=!0;function r(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:l},{})}r.__dustBody=!0;function l(t,e){return t.w(" &bull; ")}l.__dustBody=!0;function c(t,e){return t.w('checked="checked"')}c.__dustBody=!0;function d(t,e){return t.w('<div class="tc-ctl-ltoc-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div>").f(e.get(["abstract"],!1),e,"h").w("</div></div>")}d.__dustBody=!0;function C(t,e){return t.w('<div class="tc-ctl-ltoc-legend" data-tc-layer-name="').f(e.get(["layerNames"],!1),e,"h").w('"><h4>').h("i18n",e,{},{$key:"content"}).w("</h4>").s(e.get(["legend"],!1),e,{block:p},{}).w(" </div>")}C.__dustBody=!0;function p(t,e){return t.w("<div><p>").f(e.get(["title"],!1),e,"h").w('</p><img data-tc-img="').f(e.get(["src"],!1),e,"h").w('" /></div>')}p.__dustBody=!0;function f(t,e){return t.w('<div class="tc-ctl-ltoc-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:u},{}).w("</ul></div>")}f.__dustBody=!0;function u(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h",["s"]).w('" type="').f(e.get(["format"],!1),e,"h").w('" title="').f(e.get(["formatDescription"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h").w("</a></li>")}u.__dustBody=!0;function g(t,e){return t.w("tc-hidden")}g.__dustBody=!0;function h(t,e){return t.w("tc-hidden")}h.__dustBody=!0;return e};t.template[t.CLASS+"-type-sgl"]=function(){dust.register(t.CLASS+"-type-sgl",e);function e(t,e){return t.h("i18n",e,{},{$key:"singleLayer"})}e.__dustBody=!0;return e};t.template[t.CLASS+"-type-grp"]=function(){dust.register(t.CLASS+"-type-grp",e);function e(t,e){return t.w("<div>").h("i18n",e,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(e.get(["Layer"],!1),e,{block:n},{}).w("</ul>")}e.__dustBody=!0;function n(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}n.__dustBody=!0;return e};t.template[t.CLASS+"-type-grp-node"]=function(){dust.register(t.CLASS+"-type-grp-node",e);function e(t,e){return t.w('<li class="tc-ctl-ltoc-tip-grp-elm"><span>').f(e.get(["Title"],!1),e,"h").w("</span><ul>").s(e.get(["Layer"],!1),e,{block:n},{}).w("</ul></li>")}e.__dustBody=!0;function n(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}n.__dustBody=!0;return e}}var e="tcLayer",n=function(t,n){var s;t._$div.find("li."+t.CLASS+"-elm").each(function(t,a){var i=$(a);if(i.data(e)===n){s=i;return!1}});return s},s=function(t){return $.grep(t.map.workLayers,function(t){return!t.stealth}).length};t.register=function(t){var e=this;TC.control.TOC.prototype.register.call(e,t);t.off(TC.Consts.event.EXTERNALSERVICEADDED);t.on(TC.Consts.event.LAYEROPACITY,function(t){var s=n(e,t.layer);s&&s.find("input[type=range]").val(Math.round(100*t.opacity))}).on(TC.Consts.event.FEATURESIMPORT,function(n){var s=n.fileName;if(n.features&&n.features.length>0){var a="."+TC.Consts.format.GPX.toLowerCase();if(n.fileName.toLowerCase().indexOf(a)===n.fileName.length-a.length)return;t.one(TC.Consts.event.LAYERADD,function(t){if(t&&t.layer&&t.layer.title==s){if(e.map&&e.map.layout&&e.map.layout.accordion&&e._$div.hasClass(TC.Consts.classes.COLLAPSED))for(var n=0;n<e.map.controls.length;n++)e.map.controls[n]!==e&&e.map.controls[n]._$div.addClass(TC.Consts.classes.COLLAPSED);e.map.$events.trigger($.Event(TC.Consts.event.TOOLSOPEN),{});e._$div.removeClass(TC.Consts.classes.COLLAPSED)}})}})};t._addBrowserEventHandlers=function(){var t=this;t._$div.on(t.CLICKEVENT,"input[type=checkbox]",function(n){var s=$(n.target),a=s.parents("li."+t.CLASS+"-elm").first().data(e),i=s.prop("checked");a.setVisibility(i);n.stopPropagation()}).on("change input","input[type=range]",function(t){var n=$(t.target);n.parents("li").first().data(e).setOpacity(n.val()/100)}).on(t.CLICKEVENT,"."+t.CLASS+"-del",function(n){var s=$(n.target).parents("li").first().data(e);t.map.removeLayer(s)}).on(t.CLICKEVENT,"."+t.CLASS+"-del-all",function(n){TC.confirm(t.getLocaleString("layersRemove.confirm"),function(){var n=t._$div.find("li."+t.CLASS+"-elm"),s=new Array(n.length);n.each(function(t,n){s[t]=$(n).data(e)});for(var a=0,i=s.length;a<i;a++)t.map.removeLayer(s[a])})}).on(t.CLICKEVENT,"."+t.CLASS+"-btn-info",function(n){var s=$(n.target),a=s.parents("li").first(),i=a.find("."+t.CLASS+"-info");i.find("."+t.CLASS+"-legend img").each(function(n,s){var i=a.data(e);t.styleLegendImage($(s),i)});i.toggleClass(TC.Consts.classes.HIDDEN);a.find('input[type="checkbox"]').is(":checked")&&a.find("."+t.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!i.hasClass(TC.Consts.classes.HIDDEN));s.toggleClass(TC.Consts.classes.CHECKED)})};t.updateLayerVisibility=function(t){var e=n(this,t);if(e){var s=t.getVisibility();e.find("."+this.CLASS+"-del").toggleClass(TC.Consts.classes.HIDDEN,s);e.find("."+this.CLASS+"-info").hasClass(TC.Consts.classes.HIDDEN)&&e.find("."+this.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!s)}};t.updateLayerTree=function(t){var n=this,a=function(t,s,a){if(t!==s){for(var i=t.data(e),o=s.data(e),r=-1,l=0;l<n.map.layers.length;l++)if(o===n.map.layers[l]){r=l;break}r>=1&&r<n.map.layers.length&&n.map.insertLayer(i,r,a)}};if(!t.isBase&&!t.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(n,t);for(var i=!1,o=0,r=n.layers.length;o<r;o++)if(t===n.layers[o]){i=!0;break}if(!i){var l=n.CLASS+"-elm";n.layers.push(t);TC.loadJSInOrder(!window.dust,TC.url.templating,function(){TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){var s=t.title||t.wrap.getServiceTitle(),i={title:t.options.hideTitle?"":s,hide:!(!t.renderOptions||!t.renderOptions.hide),opacity:t.renderOptions&&t.renderOptions.opacity?100*t.renderOptions.opacity:100},o=t.isRaster();if(o){i.layerNames=t.layerNames;var r=t.getPath();r.shift();i.path=r;var c=t.names[0],d=t.wrap.getInfo(c);i.legend=d.legend;i.abstract=d.abstract;var C,p=d.hasOwnProperty("abstract")||d.hasOwnProperty("legend")||d.hasOwnProperty("metadata");if(t.tree&&t.tree.children&&t.tree.children.length&&t.tree.children[0].children&&t.tree.children[0].children.length)C=null;else if(C=d.metadata)for(var f=0,u=C.length;f<u;f++){var g=C[f];g.formatDescription=n.getLocaleString(TC.Util.getSimpleMimeType(g.format))||n.getLocaleString("viewMetadata")}i.metadata=C}(function(t){var e=$.Deferred();t&&t.options.method&&"POST"===t.options.method?t.getLegendGraphicImage().done(function(t){e.resolve(t)}).fail(function(t){TC.error(t)}):e.resolve();return e.promise()})(t).done(function(s){s&&(legend.src=t.getLegendUrl(s));dust.render(l,i,function(s,i){var r,l=$(i),d=!1;if(o&&!(d=t.names.length>1))for(var C=t.wrap.getAllLayerNodes(),f=0;f<C.length;f++){var u=C[f];if(t.wrap.getName(u)===c){r=u;t.wrap.getLayerNodes(u).length>0&&(d=!0);break}}var g=l.find("."+n.CLASS+"-type"),h=d?n.CLASS+"-type-grp":n.CLASS+"-type-sgl";g.addClass(h);p||l.find("."+n.CLASS+"-btn-info").addClass(TC.Consts.classes.HIDDEN);if(r){t.wrap.normalizeLayerNode(r);dust.render(h,r,function(t,e){var s;g.on("mouseover",function(t){var a=g.offset(),i=$(n.map.div).offset();s=$("<div>").addClass(n.CLASS+"-tip").html(e).css({top:a.top-i.top+"px",right:$(n.map.div).width()-(a.left-i.left)+"px"}).appendTo(n.map.div)}).on("mouseout",function(t){s.remove()})})}var v=n._$div.find("ul").first();l.data(e,t);l.drag("start",function(t,e){var n=$(this),s=v.children("li");s.not(n).addClass(TC.Consts.classes.DRAGEND);s.index(n);n.css("zIndex",100).addClass(TC.Consts.classes.DRAG);var a=s.last(),i=n.position();e.limit={top:s.first().position().top-i.top,bottom:a.height()+a.position().top-i.top-n.height()-1};e.dropTargetIndex=-1}).drag("end",function(t,e){var n=$(this);n.removeClass(TC.Consts.classes.DRAG).addClass(TC.Consts.classes.DRAGEND);var s,i,o=function(t){return parseInt(t.substr(t.lastIndexOf(",")+1))},r=o(n.css("transform")),l=this.getBoundingClientRect().top-r;if(e.dropTargetIndex>=0){s=v.children("li").get(e.dropTargetIndex);var c=o((i=$(s)).css("transform")),d=s.getBoundingClientRect().top-c}n.css("transform",i?"translateY("+(d-l)+"px)":"");n.on("transitionend.tc",function t(e){if("transform"===e.originalEvent.propertyName){n.off("transitionend.tc",t).removeClass(TC.Consts.classes.DRAGEND).css("zIndex","");i&&a(n,i,function(){v.children("li").css("transform","").removeClass(TC.Consts.classes.DRAGEND)})}})}).drag(function(t,e){var n,s,a=$(this),i=Math.min(Math.max(e.limit.top,Math.round(e.deltaY)),e.limit.bottom),o=this.getBoundingClientRect(),r=o.height-1,l=(o.top+o.bottom)/2,c=[];v.children("li").each(function(t,s){var a=s.getBoundingClientRect();c[t]={elm:s,top:a.top,bottom:a.bottom};s===e.drag&&(n=t)});for(var d=-1,C=0,p=c.length;C<p;C++){var f=c[C];if(C<n){if(l<f.bottom)if(l>f.top&&e.deltaY>e.prevDeltaY)s="";else{s="translateY("+r+"px)";d<0&&(d=C)}else s="";$(f.elm).css("transform",s)}else if(C>n){if(l>f.top)if(l<f.bottom&&e.deltaY<e.prevDeltaY)s="";else{s="translateY(-"+r+"px)";d=C}else s="";$(f.elm).css("transform",s)}}e.dropTargetIndex=d;a.css("transform","translateY("+i+"px)");e.prevDeltaY=e.deltaY},{handle:"."+n.CLASS+"-dd"}).on("keydown",function(t){var e=this,n=function(){e.focus()},s=$(this);switch(!0){case/Up$/.test(t.key):var i=s.prev();i.length&&a(s,i,n);break;case/Down$/.test(t.key):var o=s.next();o.length&&a(s,o,n)}});v.prepend(l);n.updateScale()})})})});var c=s(n);$("."+n.CLASS+"-n").text(c).toggleClass(TC.Consts.classes.VISIBLE,c>0);n._$div.find("."+n.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,c>0);n._$div.find("."+n.CLASS+"-content").toggleClass(TC.Consts.classes.HIDDEN,0===c);n._$div.find("."+n.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,!1)}}};t.updateScale=function(){var t=this;t._$div.find("ul").find("li."+t.CLASS+"-elm").each(function(n,s){var a=$(s),i=a.data(e);if(i.names){for(var o=!1,r=0;r<i.names.length;r++)if(i.isVisibleByScale(i.names[r])){o=!0;break}a.toggleClass(t.CLASS+"-elm-notvisible",!o)}})};t.updateLayerOrder=function(t,e,n){TC.control.MapContents.prototype.updateLayerOrder.call(this,t,e,n)};t.removeLayer=function(t){var n=this.layers.indexOf(t);n>=0&&this.layers.splice(n,1);this._$div.find("ul").first().find("li."+this.CLASS+"-elm").each(function(n,s){var a=$(s);if(a.data(e)===t){a.remove();return!1}});var a=s(this);this._$div.find("."+this.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,0===a);this._$div.find("."+this.CLASS+"-content").toggleClass(TC.Consts.classes.HIDDEN,0===a);this._$div.find("."+this.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,a>0);$("."+this.CLASS+"-n").text(a).toggleClass(TC.Consts.classes.VISIBLE,a>0)};t.getLayerUIElements=function(){return this._$div.find("ul").first().children("li."+this.CLASS+"-elm")}}();