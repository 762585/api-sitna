TC.control=TC.control||{},TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons.js"),function(){TC.control.PolygonFeatureInfo=function(){var t=this;TC.control.FeatureInfoCommons.apply(this,arguments),t.wrap=new TC.wrap.control.PolygonFeatureInfo(t),t.lineColor=t.options.lineColor?t.options.lineColor:"#c00",t.callback=function(e,o){if(!t._drawToken){t.popup.hide(),t.layerDraw.clearFeatures();for(var n=!1,l=0;l<t.map.workLayers.length;l++){var r=t.map.workLayers[l];if(r.type===TC.Consts.layerType.WMS&&r.getVisibility()&&r.names.length>0){n=!0;break}}n&&(t.popup.hide(),t.wrap.beginDraw(e,t.layerDraw,function(e){t.wrap.getFeaturesByPolygon(e)}))}},t.layer=null,t.marker=null,t.info=null,t.popup=null,t.lastFeatureCount=null,t._isDrawing=!1,t._isSearching=!1,t._drawToken=!1},TC.inherit(TC.control.PolygonFeatureInfo,TC.control.FeatureInfoCommons);var t=TC.control.PolygonFeatureInfo.prototype;t.CLASS="tc-ctl-finfo",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/FeatureInfo.html",t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureInfoDialog.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w('<ul class="tc-ctl-finfo-services">').s(e.get(["services"],!1),e,{"else":o,block:n},{}).w("</ul>").x(e.get(["featureCount"],!1),e,{block:B},{})}function o(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noData"}).w("</li>")}function n(t,e){return t.w("<li><h3>").x(e.getPath(!1,["mapLayer","title"]),e,{"else":l,block:r},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(e.get(["hasLimits"],!1),e,{"else":a,block:L},{}).w("</div></li>")}function l(t,e){return t.f(e.getPath(!1,["mapLayer","id"]),e,"h")}function r(t,e){return t.f(e.getPath(!1,["mapLayer","title"]),e,"h")}function a(t,e){return t.w('<ul class="tc-ctl-finfo-layers">').s(e.get(["layers"],!1),e,{"else":s,block:i},{}).w("</ul>")}function s(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataAtThisService"}).w("</li>")}function i(t,e){return t.w("<li><h4>").s(e.get(["path"],!1),e,{block:c},{}).w(' <span class="tc-ctl-finfo-layer-n">').f(e.getPath(!1,["features","length"]),e,"h").w('</span> </h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(e.get(["features"],!1),e,{"else":f,block:d},{}).w("</ul></div></li>")}function c(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:u},{})}function u(t,e){return t.w(" &bull; ")}function f(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataInThisLayer"}).w("</li>")}function d(t,e){return t.w("<li>").x(e.get(["rawContent"],!1),e,{"else":p,block:v},{}).w("</li>")}function p(t,e){return t.x(e.get(["error"],!1),e,{"else":y,block:g},{})}function y(t,e){return t.w("<h5>").f(e.get(["id"],!1),e,"h").w("</h5><table").x(e.get(["geometry"],!1),e,{block:h},{}).w("><tbody>").s(e.get(["attributes"],!1),e,{block:C},{}).w("</tbody></table>").x(e.get(["geometry"],!1),e,{block:w},{})}function h(t,e){return t.w(' title="').h("i18n",e,{},{$key:"clickToCenter"}).w('"')}function C(t,e){return t.w('<tr><th class="tc-ctl-finfo-attr">').f(e.get(["name"],!1),e,"h").w('</th><td class="tc-ctl-finfo-val">').f(e.get(["value"],!1),e,"h").w("</td></tr>")}function w(t,e){return t.w('<div class="tc-ctl-finfo-tools"><button class="tc-ctl-finfo-tools-btn" title="').h("i18n",e,{},{$key:"download"}).w("/").h("i18n",e,{},{$key:"share"}).w('">').h("i18n",e,{},{$key:"download"}).w("/").h("i18n",e,{},{$key:"share"}).w("</button></div>")}function g(t,e){return t.w('<span class="tc-ctl-finfo-errors">').h("i18n",e,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(e.get(["error"],!1),e,"h").w("</span></span>")}function v(t,e){return t.w("<h5>").h("i18n",e,{},{$key:"feature"}).w("</h5>").h("eq",e,{"else":k,block:b},{key:e.get(["rawFormat"],!1),value:"text/html"})}function k(t,e){return t.w("<pre>").f(e.get(["rawContent"],!1),e,"h").w("</pre>")}function b(t,e){return t.w(" ").x(e.get(["expandUrl"],!1),e,{block:_},{})}function _(t,e){return t.h("ne",e,{"else":m,block:T},{key:e.get(["expandUrl"],!1),value:""})}function m(t,e){return t.w('<iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" />')}function T(t,e){return t.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" /><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(e.get(["expandUrl"],!1),e,"h").w("', '_blank')\" title=\"").h("i18n",e,{},{$key:"expand"}).w('"></a></div>')}function L(t,e){return t.w('<span class="tc-ctl-finfo-errors">').f(e.get(["hasLimits"],!1),e,"h").w("</span>")}function B(t,e){return t.h("gt",e,{block:D},{key:e.get(["featureCount"],!1),value:"1",type:"number"})}function D(t,e){return t.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",e,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-idx"></span>/').f(e.get(["featureCount"],!1),e,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",e,{},{$key:"next"}).w("</a>")}return dust.register(t.CLASS,e),e.__dustBody=!0,o.__dustBody=!0,n.__dustBody=!0,l.__dustBody=!0,r.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,i.__dustBody=!0,c.__dustBody=!0,u.__dustBody=!0,f.__dustBody=!0,d.__dustBody=!0,p.__dustBody=!0,y.__dustBody=!0,h.__dustBody=!0,C.__dustBody=!0,w.__dustBody=!0,g.__dustBody=!0,v.__dustBody=!0,k.__dustBody=!0,b.__dustBody=!0,_.__dustBody=!0,m.__dustBody=!0,T.__dustBody=!0,L.__dustBody=!0,B.__dustBody=!0,D.__dustBody=!0,e},t.template[t.CLASS+"-dialog"]=function(){function e(t,e){return t.w('<div class="tc-ctl-finfo-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"feature"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-finfo-dialog-dl"><h2>').h("i18n",e,{},{$key:"download"}).w('</h2><div><button class="tc-button tc-ctl-finfo-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-ctl-finfo-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-ctl-finfo-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-ctl-finfo-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button></div></div><div class="tc-ctl-finfo-dialog-share"></div></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}return dust.register(t.CLASS+"-dialog",e),e.__dustBody=!0,e}),t.register=function(t){var e=this;TC.control.Click.prototype.register.call(e,t),t.loaded(function(){var o=e.map.addLayer({id:TC.getUID(),title:"PolygonFeatureInfo",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:{fillColor:e.lineColor,fillOpacity:0,strokeColor:e.lineColor,strokeWidth:2,radius:6},line:{strokeColor:e.lineColor,strokeWidth:2},polygon:{strokeColor:e.lineColor,strokeWidth:2,fillColor:"#000",fillOpacity:.3}}});$.when(t.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0})).then(function(t){e.layer=t}),$.when(o).then(function(t){e.layerDraw=t});var n=e.map.addLayer({id:TC.getUID(),title:"FeatureInfo",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:{fillColor:"#D8ED6C",fillOpacity:0,strokeColor:"#D8ED6C",strokeWidth:2,radius:6},line:{strokeColor:"#D8ED6C",strokeWidth:2},polygon:{strokeColor:"#D8ED6C",strokeWidth:2,fillColor:"#000",fillOpacity:.3}}});$.when(n).then(function(t){e.layerDraw=t}),$.when(t.addControl("popup",{closeButton:!0,draggable:e.options.draggable})).then(function(o){e.popup=o,t.on(TC.Consts.event.POPUP,function(t){e.onShowPopUp(t)}),t.on(TC.Consts.event.POPUPHIDE,function(t){t.control===o&&e.popup.$popupDiv.css("width","auto")})})}),t.$events.on(TC.Consts.event.POPUPHIDE,function(t){e.popup===t.control&&e.layerDraw.clearFeatures()}),t.on(TC.Consts.event.BEFOREFEATUREINFO,function(t){e.beforeGetFeatureInfo(t)}),t.on(TC.Consts.event.FEATUREINFO,function(t){e.isActive&&(e.lastFeatureCount=e.countFeatures(t),e.responseCallback(t))}),t.$events.on(TC.Consts.event.NOFEATUREINFO,function(t){e.lastFeatureCount=0,e.popup&&e.popup.hide()}),TC.loadJS(!TC.Consts.event.POPUPHIDE,[TC.apiLocation+"TC/control/Popup.js"],function(){t.$events.on(TC.Consts.event.POPUPHIDE,function(t){e.popup===t.control&&e.layer.clearFeatures()})}),e.$events.on(TC.Consts.event.CONTROLDEACTIVATE,function(t){e.wrap.cancelDraw()})},t.responseCallback=function(t){var e=this;if(e.marker){var o=t.services;e.info={services:o};for(var n=0;n<o.length;n++){var l=o[n];if(l.hasLimits)delete l.layers;else{for(var r=0;r<l.layers.length;r++)l.layers[r].features.length||(l.layers.splice(r,1),r-=1);l.layers.length||(o.splice(n,1),n-=1)}}o.length?e.renderData(t,function(){e._$div.find("td."+e.CLASS+"-val").each(function(t,e){var o=$(e),n=o.text();TC.Util.isURL(n)&&o.html('<a href="'+n+'" target="_blank">'+n+"</a>")}),e.marker.data=$("<div>").append(e._$div.clone()).html(),e.popup&&e.marker.showPopup(e.popup)}):e.layer.clearFeatures()}}}();