TC.control=TC.control||{},TC.control.Click||TC.syncLoadJS(TC.apiLocation+"TC/control/Click.js"),TC.control.FeatureInfoCommons=function(){var e=this;TC.control.Click.apply(e,arguments),e._$dialogDiv=$(TC.Util.getDiv(e.options.dialogDiv)),e.options.dialogDiv||e._$dialogDiv.appendTo("body")},function(){var e="ul.tc-ctl-finfo-features li",t=function(e){e.popup.$popupDiv.find("ul."+e.CLASS+"-services li").removeClass(TC.Consts.classes.CHECKED).removeClass(TC.Consts.classes.DISABLED).removeClass(TC.Consts.classes.FROMLEFT).removeClass(TC.Consts.classes.FROMRIGHT)},s=function(s,o){if(!s._zooming){var a,n,i,r;this instanceof TC.Feature?(a=this,s.popup.$popupDiv.find(e).each(function(e,t){var o=$(t),l=o.parents("li").first(),C=l.parents("li").first(),c=s.getFeature(s.info,C.index(),l.index(),o.index());c===a&&(n=o,i=l,r=C)})):n=$(this),i=i||n.parents("li").first(),r=r||i.parents("li").first(),t(s),n.addClass(TC.Consts.classes.CHECKED),i.addClass(TC.Consts.classes.CHECKED),r.addClass(TC.Consts.classes.CHECKED),o>0?(n.addClass(TC.Consts.classes.FROMLEFT),i.addClass(TC.Consts.classes.FROMLEFT),r.addClass(TC.Consts.classes.FROMLEFT)):0>o&&(n.addClass(TC.Consts.classes.FROMRIGHT),i.addClass(TC.Consts.classes.FROMRIGHT),r.addClass(TC.Consts.classes.FROMRIGHT)),a=a||s.getFeature(s.info,r.index(),i.index(),n.index());for(var l=s.layer.features.slice(),C=0;C<l.length;C++){var c=l[C];c!==s.marker&&s.layer.removeFeature(c)}a&&a.geometry?s.layer.addFeature(a):n.addClass(TC.Consts.classes.DISABLED)}},o=function(e,t){var s=e.popup.$popupDiv.find("ul."+e.CLASS+"-features > li"),o=s.length,a=s.filter("."+TC.Consts.classes.CHECKED),n=s.index(a.get(0));return s.get((n+t+o)%o)};TC.inherit(TC.control.FeatureInfoCommons,TC.control.Click);var a=TC.control.FeatureInfoCommons.prototype;a.CLASS="tc-ctl-abstract-finfo",a.render=function(e){var t=this;t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e).on(TC.Consts.event.CLICK,"button[data-format]",function(e){TC.Util.closeModal();var s=t.layer.features[t.layer.features.length-1];t.map.exportFeatures([s],{fileName:s.id,format:$(e.target).data("format")})})})},a.markerStyle={cssClass:TC.Consts.classes.POINT,anchor:[.5,.5],width:15,height:15,noPrint:!0},a.onShowPopUp=function(a){var n=this,i=n.map;if(a.control===n.popup){var r=n.popup.$popupDiv,l="ficHandlers",C=r.data(l);if(!C){var c,u="click";r.on(u,e,function(e){s.call(this,n)}),u="mouseover";var f;r.on(u,e,function(e){var t=this;clearTimeout(f),f=setTimeout(function(){s.call(t,n)},50)}),u="mouseout",r.on(u,e,function(e){clearTimeout(f)}),u=TC.Consts.event.CLICK,c="."+n.CLASS+"-btn-next",r.on(u,c,function(e){return s.call(o(n,1),n,1),!1}),c="."+n.CLASS+"-btn-prev",r.on(u,c,function(e){return s.call(o(n,-1),n,-1),!1}),c="ul."+n.CLASS+"-layers h4",r.on(u,c,function(o){var a=$(o.target).parent();a.hasClass(TC.Consts.classes.CHECKED)?"none"===r.find(".tc-ctl-finfo-btn-next").css("display")&&t(n):(s.call(a.find(e).first()[0],n),n.popup.fitToView(!0))}),c="."+n.CLASS+"-tools-btn",r.on(u,c,function(e){TC.Util.showModal(n._$dialogDiv.find("."+n.CLASS+"-dialog"),{openCallback:function(){n.onShowModal()}})}),r.data(l,!0)}n.info&&(n.info.defaultFeature?s.call(n.info.defaultFeature,n):s.call(r.find(e).first()[0],n)),n.fitSize(),r.find("table").on("click",function(e){if(!$(this).parent().hasClass(TC.Consts.classes.DISABLED)){if(n.layer.features[1]){var t=function s(){n._zooming=!1,i.off(TC.Consts.event.ZOOM,s)};i.on(TC.Consts.event.ZOOM,t),n.zooming=!0,i.zoomToFeatures([n.layer.features[1]],{animate:!0})}e.stopPropagation()}}),r.find("table a").on("click",function(e){e.stopPropagation()})}},a.onShowModal=function(){},a.highlightFeature=function(e){s.call(e,this)},a.fitSize=function(){var e=this,t=e.popup.$popupDiv,s=0;t.find(".tc-ctl-finfo-features li").each(function(e,t){s=Math.max(s,$(t).position().left+$(t).width())}),s&&t.width(s+50)},a.countFeatures=function(e){for(var t=0,s=0;s<e.services.length;s++)e.services[s].layers.forEach(function(e){t+=e.features.length});return t},a.getFeature=function(e,t,s,o){var a;return e&&(a=e.services[t],a&&(a=a.layers[s],a&&(a=a.features[o]))),a},a.getFeatureIdx=function(e,t,s,o){var a=-1;if(e)for(var n=0;t>n;n++)for(var i=e.services[n],r=n===t-1?s:i.layers.length,l=0;r>l;l++)for(var C=i.layers[l],c=l===s-1?o:C.features.length,u=0;c>u;u++)a+=1;return a},a.beforeGetFeatureInfo=function(e){var t=this;if(t.popup&&t.popup.isVisible()&&t.popup.hide(),e.control===t&&t.map&&t.layer){t.lastFeatureCount=null;var s=t.getLocaleString("featureInfo");t.layer.clearFeatures(),t.info=null,$.when(t.layer.addMarker(t.map.getCoordinateFromPixel(e.xy),$.extend({},t.map.options.styles.marker,t.markerStyle,{title:s,set:s}))).then(function(e){null===t.lastFeatureCount?(t.map.putLayerOnTop(t.layer),t.marker=e):t.layer.clearFeatures()})}else t.popup&&t.popup.hide()}}();