TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.Consts.event.RESULTTOOLTIP="resulttooltip.tc",TC.Consts.event.RESULTTOOLTIPEND="resulttooltipend.tc",TC.Consts.event.DRAWCHART="drawchart.tc",TC.Consts.event.RESULTSPANELMIN="resultspanelmin.tc",TC.Consts.event.RESULTSPANELMAX="resultspanelmax.tc",TC.Consts.event.RESULTSPANELCLOSE="resultspanelclose.tc",TC.control.ResultsPanel=function(){var t=this;TC.Control.apply(t,arguments),t.data={},t.classes={FA:"fa"},t.contentType={TABLE:{fnOpen:TC.control.ResultsPanel.prototype.openTable,collapsedClass:".fa-list-alt"},CHART:{fnOpen:TC.control.ResultsPanel.prototype.openChart,collapsedClass:".fa-area-chart"}},t.content=t.contentType.TABLE,t.options&&(t.options.content&&(t.content=t.contentType[t.options.content.toUpperCase()]),t.options.chart&&(t.chart=t.options.chart),t.options.table&&(t.table=t.options.table))},TC.inherit(TC.control.ResultsPanel,TC.Control),TC.control.ResultsPanel.prototype.CLASS="tc-ctl-p-results",TC.control.ResultsPanel.prototype.template={},TC.isDebug?(TC.control.ResultsPanel.prototype.template[TC.control.ResultsPanel.prototype.CLASS]=TC.apiLocation+"TC/templates/ResultsPanel.html",TC.control.ResultsPanel.prototype.template[TC.control.ResultsPanel.prototype.CLASS+"-table"]=TC.apiLocation+"TC/templates/ResultsPanelTable.html",TC.control.ResultsPanel.prototype.template[TC.control.ResultsPanel.prototype.CLASS+"-chart"]=TC.apiLocation+"TC/templates/ResultsPanelChart.html"):(TC.control.ResultsPanel.prototype.template[TC.control.ResultsPanel.prototype.CLASS]=function(){function t(t,e){return t.w('<div class="prpanel-group prsidebar-body " style="display: none" data-no-cb data-no-3d><div class="prpanel prpanel-default"><div class="prpanel-heading"><h4 class="prpanel-title"><label>').h("i18n",e,{},{$key:"geo.trk.chart.chpe"}).w('</label> <span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-close" title="').h("i18n",e,{},{$key:"close"}).w('"><i class="fa fa-times"></i></span><span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-min" title="').h("i18n",e,{},{$key:"hide"}).w('"><i class="fa fa-chevron-left"></i></span><span class="prcollapsed-pull-right prcollapsed-slide-submenu prcollapsed-slide-submenu-csv" hidden title="Exportar a Excel"><i class="fa fa-file-excel-o"></i></span></h4></div><div id="results" class="prpanel-collapse collapse in"><div class="prpanel-body list-group tc-ctl-p-results-table">').p("tc-ctl-p-results-table",e,e.rebase(e.getPath(!0,[])),{}).w('</div><div class="prpanel-body list-group tc-ctl-p-results-chart"></div></div></div></div><div class="prcollapsed prcollapsed-max prcollapsed-pull-left" style="display: none;" title="').h("i18n",e,{},{$key:"expand"}).w('" data-no-cb data-no-3d><i class="fa-list-alt" hidden></i><i class="fa-area-chart" hidden></i></div>')}return dust.register(TC.control.ResultsPanel.prototype.CLASS,t),t.__dustBody=!0,t},TC.control.ResultsPanel.prototype.template[TC.control.ResultsPanel.prototype.CLASS+"-table"]=function(){function t(t,l){return t.w('<table class="table" style="display:none;"><thead>').s(l.get(["columns"],!1),l,{block:e},{}).w("</thead><tbody>").s(l.get(["results"],!1),l,{block:n},{}).w("</tbody></table>")}function e(t,e){return t.w("<th>").f(e.getPath(!0,[]),e,"h").w("</th>")}function n(t,e){return t.w("<tr>").h("iterate",e,{block:l},{on:e.getPath(!0,[])}).w("</tr>")}function l(t,e){return t.w("<td>").f(e.get(["value"],!1),e,"h").w("</td>")}return dust.register(TC.control.ResultsPanel.prototype.CLASS+"-table",t),t.__dustBody=!0,e.__dustBody=!0,n.__dustBody=!0,l.__dustBody=!0,t},TC.control.ResultsPanel.prototype.template[TC.control.ResultsPanel.prototype.CLASS+"-chart"]=function(){function t(t,l){return t.w('<div id="track-chart">').x(l.get(["msg"],!1),l,{"else":e,block:n},{}).w("</div>")}function e(t,e){return t.w('<span id="elevationGain" >').h("i18n",e,{},{$key:"geo.trk.chart.elevationGain"}).w(": +").f(e.get(["upHill"],!1),e,"h").w("m, -").f(e.get(["downHill"],!1),e,"h").w('m</span><div id="chart"></div>')}function n(t,e){return t.f(e.get(["msg"],!1),e,"h")}return dust.register(TC.control.ResultsPanel.prototype.CLASS+"-chart",t),t.__dustBody=!0,e.__dustBody=!0,n.__dustBody=!0,t}),TC.control.ResultsPanel.prototype.render=function(t){var e=this;TC.Control.prototype.render.call(e,function(){e.$minimize=e._$div.find(".prcollapsed-slide-submenu-min"),e.$minimize.on("click",function(){e.minimize()}),e.$close=e._$div.find(".prcollapsed-slide-submenu-close"),e.$close.on("click",function(){e.close()}),e.$maximize=e._$div.find(".prcollapsed-max"),e.$maximize.on("click",function(){e.maximize()}),e.content&&(e.content=e.content,e.options.titles&&e.options.titles.max&&e.$maximize.attr("title",e.options.titles.max)),e._$div.find(e.content.collapsedClass).removeAttr("hidden").addClass(e.classes.FA),t&&"function"==typeof t&&t.call()})},TC.control.ResultsPanel.prototype.minimize=function(){var t=this;0==t._$div.find(t.content.collapsedClass+":visible").length&&(t._$div.find(t.content.collapsedClass).hasClass(t.classes.FA)||t._$div.find(t.content.collapsedClass).addClass(t.classes.FA),t._$div.find(t.content.collapsedClass).removeAttr("hidden"),t._$div.find(".prsidebar-body").toggle("slide",function(){t._$div.find(".prcollapsed-max").fadeIn()}),t.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELMIN),{}))},TC.control.ResultsPanel.prototype.maximize=function(){var t=this;0==t._$div.find(t.content.collapsedClass+":hidden").length&&(t._$div.find(t.content.collapsedClass).attr("hidden","hidden"),t._$div.find(".prsidebar-body").toggle("slide"),t._$div.find(".prcollapsed-max").hide(),t.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELMAX),{}))},TC.control.ResultsPanel.prototype.close=function(){var t=this;t._$div.find(".prsidebar-body").fadeOut("slide"),t._$div.find(".prcollapsed-max").hide(),t._$div.find(t.content.collapsedClass).attr("hidden","hidden").removeClass(t.classes.FA),t.chart&&t.chart.chart&&(t.chart.chart=t.chart.chart.destroy()),t.map.$events.trigger($.Event(TC.Consts.event.RESULTSPANELCLOSE),{})},TC.control.ResultsPanel.prototype.openChart=function(){var self=this,data=arguments.data||arguments[0].data;if(data)if(data.msg)self.map.toast(data.msg);else{var locale=TC.Util.getMapLocale(self.map);self.getRenderedHtml(TC.control.ResultsPanel.prototype.CLASS+"-chart",{upHill:data.upHill.toLocaleString(locale),downHill:data.downHill.toLocaleString(locale)},function(out){console.log(self._$div.find("."+TC.control.ResultsPanel.prototype.CLASS+"-chart").length),self._$div.find("."+TC.control.ResultsPanel.prototype.CLASS+"-chart").html(out);var chartOptions={bindto:"#chart",padding:{top:0,right:15,bottom:0,left:45},legend:{show:!1}};self.chart.tooltip&&(chartOptions.tooltip={contents:function(d){var fn=self.chart.tooltip;return"function"!=typeof fn&&(fn=TC.Util.getFNFromString(self.chart.tooltip)),fn.call(eval(self.chart.ctx),d)}}),self.chart&&self.chart.onmouseout&&(chartOptions.onmouseout=function(){var fn=self.chart.onmouseout;"function"!=typeof fn&&(fn=TC.Util.getFNFromString(self.chart.onmouseout)),fn.call(eval(self.chart.ctx))}),chartOptions=$.extend({},chartOptions,data),chartOptions.onrendered=function(){self.map.$events.trigger($.Event(TC.Consts.event.DRAWCHART),{svg:this.svg[0][0]}),self._$div.find(".prsidebar-body").fadeIn("slide")},window.c3&&(window.c3.chart.internal.fn.generateDrawLine=function(t,e){var n=this,l=n.config,o=n.d3.svg.line(),a=n.generateGetLinePoints(t,e),s=e?n.getSubYScale:n.getYScale,i=function(t){return(e?n.subxx:n.xx).call(n,t)},r=function(t,e){return l.data_groups.length>0?a(t,e)[0][1]:s.call(n,t.id)(t.value)};return o=l.axis_rotated?o.x(r).y(i):o.x(i).y(r),l.line_connectNull||(o=o.defined(function(t){return null!=t.value})),function(t){var a,i=l.line_connectNull?n.filterRemoveNull(t.values):t.values,r=e?n.x:n.subX,c=s.call(n,t.id),d=0,p=0;return n.isLineType(t)?l.data_regions[t.id]?a=n.lineWithRegions(i,r,c,l.data_regions[t.id]):(n.isStepType(t)&&(i=n.convertValuesToStep(i)),a=o.interpolate("linear")(i)):(i[0]&&(d=r(i[0].x),p=c(i[0].value)),a=l.axis_rotated?"M "+p+" "+d:"M "+d+" "+p),a?a:"M 0 0"}},window.c3.chart.internal.fn.generateDrawArea=function(t,e){var n=this,l=n.config,o=n.d3.svg.area(),a=n.generateGetAreaPoints(t,e),s=e?n.getSubYScale:n.getYScale,i=function(t){return(e?n.subxx:n.xx).call(n,t)},r=function(t,e){return l.data_groups.length>0?a(t,e)[0][1]:s.call(n,t.id)(0)},c=function(t,e){return l.data_groups.length>0?a(t,e)[1][1]:s.call(n,t.id)(t.value)};return o=l.axis_rotated?o.x0(r).x1(c).y(i):o.x(i).y0(r).y1(c),l.line_connectNull||(o=o.defined(function(t){return null!==t.value})),function(t){var e,a=l.line_connectNull?n.filterRemoveNull(t.values):t.values,s=0,i=0;return n.isAreaType(t)?(n.isStepType(t)&&(a=n.convertValuesToStep(a)),e=o.interpolate("linear")(a)):(a[0]&&(s=n.x(a[0].x),i=n.getYScale(t.id)(a[0].value)),e=l.axis_rotated?"M "+i+" "+s:"M "+s+" "+i),e?e:"M 0 0"}},self.chart.chart=c3.generate(chartOptions))})}else self.map.toast(data.msg);self.map.getLoadingIndicator().hide()},TC.control.ResultsPanel.prototype.openTable=function(){var t=this,e=arguments[0].columns,n=arguments[0].data,l=function(){for(var t=0;t<n.length;t++)for(var l in n[t])e.indexOf(l)<0&&delete n[t][l]};if(n&&n.length>0){if(!e){e=[];for(var o in n[0])e.push(o)}l(),t.tableData={columns:e,results:n},t.getRenderedHtml(t.CLASS+"-table",t.tableData,function(e){t._$div.find("."+t.CLASS+"-table").html(e)}),t._$div.find(".prsidebar-body").fadeIn("slide")}t.map.getLoadingIndicator().hide()},TC.control.ResultsPanel.prototype.open=function(t,e){var n=this,l=function(){for(var n=0;n<t.length;n++)for(var l in t[n])e.indexOf(l)<0&&delete t[n][l]};if(t&&t.length>0){if(!e){e=[];for(var o in t[0])e.push(o)}l(),n.tableData={columns:e,results:t},n.getRenderedHtml(n.CLASS+"-table",n.tableData,function(t){n._$div.find("."+n.CLASS+"-table").html(t)}),n._$div.find(".prsidebar-body").fadeIn("slide")}else TC.alert("No se han encontrado resultados");n.map.getLoadingIndicator().hide()},TC.control.ResultsPanel.prototype.register=function(t){var e=this;TC.Control.prototype.register.call(e,t),e.openOn&&e.map.$events.one(e.openOn,function(t,n){e.content.fnOpen.call(e,n)}),e.closeOn&&e.map.$events.one(e.closeOn,function(t,n){e.close()}),e.options.openOn&&e.map.$events.on(e.options.openOn,function(t,n){e.content.fnOpen.call(e,n)}),e.options.closeOn&&e.map.$events.on(e.options.closeOn,function(t,n){e.close()})};