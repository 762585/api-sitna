TC.control=TC.control||{};TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons");!function(){TC.control.FeatureInfo=function(){var e=this;TC.control.FeatureInfoCommons.apply(this,arguments);e.wrap=new TC.wrap.control.FeatureInfo(e);TC.Consts.classes.FROMLEFT="tc-fromleft";TC.Consts.classes.FROMRIGHT="tc-fromright";e.options.displayElevation&&TC.loadJS(!TC.tool||!TC.tool.Elevation,TC.apiLocation+"TC/tool/Elevation",function(){const t="boolean"==typeof e.options.displayElevation?{}:e.options.displayElevation;e.elevation=new TC.tool.Elevation(t)})};TC.inherit(TC.control.FeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.FeatureInfo.prototype;e.FEATURE_PARAM="showfeature";var t=TC.apiLocation+"lib/jshash/md5-min.js",r=function e(t,r){var a;if($.isArray(t))for(var o=0,n=(a=t.slice()).length;o<n;o++)a[o]=e(a[o]);else a="number"==typeof t?Math.round(t.toFixed(r)):t;return a};e.register=function(e){var r=this;TC.control.FeatureInfoCommons.prototype.register.call(r,e);r._$div.appendTo("<div>");e.loaded(function(){r._layersDeferred.then(function(){var e=TC.Util.getParameterByName(r.FEATURE_PARAM);if(e){var a;try{a=JSON.parse(decodeURIComponent(escape(window.atob(e))))}catch(e){TC.error(TC.Util.getLocaleString(r.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST)}a&&function(e,r){if(0!==jQuery.grep(e.map.workLayers,function(e,t){return e.type===TC.Consts.layerType.WMS&&e.url===r.s&&e.getDisgregatedLayerNames().indexOf(r.l)>=0}).length){e.sharedFeatureInfo=r;TC.loadJS(!window.hex_md5,[t],function(){const t=[-100,-100];e.beforeRequest({xy:t});e.filterLayer.clearFeatures();$.when(e.filterLayer.addMarker(t)).then(function(t){e.filterFeature=t;e.wrap.getFeatureInfo(r.xy,r.r,{serviceUrl:r.s,layerName:r.l,featureId:r.f})})})}else TC.error(TC.Util.getLocaleString(e.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST)}(r,a)}})})};e.onShowModal=function(){var e=this,a=$(e.getDisplayTarget()).find("ul."+e.CLASS+"-features li."+TC.Consts.classes.CHECKED),o=e._shareCtl;o.extraParams=null;var n=a.parents("li").first(),i=n.parents("li").first(),s=e.info.services[i.index()];if(s){var l=s.layers[n.index()];if(l){var f=l.features[a.index()];TC.loadJS(!window.hex_md5,[t],function(){var t=hex_md5(JSON.stringify({data:f.getData(),geometry:r(f.geometry,TC.Consts.DEGREE_PRECISION)}));o.extraParams={};o.extraParams[e.FEATURE_PARAM]=window.btoa(unescape(encodeURIComponent(JSON.stringify({xy:f.wrap.getInnerPoint(),r:e.map.getResolution(),s:s.mapLayer.url,l:l.name,f:f.id,h:t}))));var a=o._$div;a.find(".tc-url input[type=text]").val(o.generateLink());a.find(".tc-iframe input[type=text]").val(o.generateIframe())})}}};e.callback=function(e,t){var r=this;if(r.elevation){r.querying=!0;r.elevationRequest=r.elevation.getElevation({crs:r.map.crs,coordinates:e})}if(r.map&&r.filterLayer){var a=r.getLocaleString("featureInfo"),o=$.extend({},r.map.options.styles.marker,r.markerStyle,{title:a,set:a});r.displayMode!==TC.control.FeatureInfoCommons.POPUP&&(o.showsPopup=!1);r.filterLayer.clearFeatures();$.when(r.filterLayer.addMarker(e,o)).then(function(t){r.map.putLayerOnTop(r.filterLayer);r.filterFeature=t;for(var a=!1,o=0;o<r.map.workLayers.length;o++){var n=r.map.workLayers[o];if(n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0){a=!0;break}}var i=r.map.getResolution();a?r.wrap.getFeatureInfo(e,i):r.responseCallback({coords:e})})}};e.responseCallback=function(e){var t=this;const a=function(a){TC.control.FeatureInfoCommons.prototype.responseCallback.call(t,e);t.querying=!0;if(t.filterFeature){var o=e.services;t.info={services:o,defaultFeature:e.defaultFeature};if(o)for(var n=0;n<o.length;n++){for(var i=o[n],s=0;s<i.layers.length;s++)if(!i.layers[s].features.length){i.layers.splice(s,1);s-=1}if(!i.layers.length){o.splice(n,1);n-=1}}var l=t.map.options.locale||TC.Cfg.locale;e.isGeo=t.map.wrap.isGeo();a.length&&(e.elevation=TC.Util.formatNumber(Math.round(a[0][2]),l));if(e.coords){e.crs=t.map.crs;e.coords=e.coords.map(function(t){return TC.Util.formatNumber(t.toFixed(e.isGeo?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION),l)})}if(o&&o.length||a.length)t.renderData(e,function(){t.insertLinks();if(t.sharedFeatureInfo){t._$div.find("ul."+t.CLASS+"-services li").addClass(TC.Consts.classes.CHECKED);for(var e,a=t.sharedFeatureInfo,o=0,n=t.info.services.length;o<n;o++){var i=t.info.services[o];if(i.mapLayer.url===a.s){for(var s=0,l=i.layers.length;s<l;s++){var f=i.layers[s];if(f.name===a.l){for(var u=0,c=f.features.length;u<c;u++){var C=f.features[u];if(C.id===a.f){e=C;var p=hex_md5(JSON.stringify({data:C.getData(),geometry:r(C.geometry,TC.Consts.DEGREE_PRECISION)}));a.h!==p&&TC.alert(t.getLocaleString("finfo.featureChanged.warning"));break}}break}}break}}e&&t.map.addControl(new TC.control.Popup({div:TC.Util.getDiv(),closeButton:!0})).then(function(r){e.data=t._$div.html();r.$popupDiv.addClass(t.CLASS+"-lite");t.getLocaleString("deleteFeature");t.getRenderedHtml(t.CLASS+"-del-btn",null,function(e){r.$popupDiv.append(e);r.$popupDiv.find("."+t.CLASS+"-del-btn").on(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("deleteFeature.confirm"),function(){t.map.removeLayer(t.sharedFeatureLayer);delete t.sharedFeatureLayer})})});e.showsPopup=!0;e.popup=r;t.map.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,title:t.getLocaleString("foi")}).then(function(r){t.sharedFeatureLayer=r;t.filterLayer.clearFeatures();r.addFeature(e);t.map.zoomToFeatures([e])});t.map.on(TC.Consts.event.POPUP,function(a){a.control===r&&r.$popupDiv.find("table").on(TC.Consts.event.CLICK,function(r){t.map.zoomToFeatures([e])})})});delete t.sharedFeatureInfo}else t.displayResults()});else{t.resultsLayer.clearFeatures();t.filterLayer.clearFeatures()}t.querying=!1}};t.elevationRequest?t.elevationRequest.then(a):a([])}}();