TC.control=TC.control||{},TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons.js"),function(){TC.control.FeatureInfo=function(){var t=this;TC.control.FeatureInfoCommons.apply(this,arguments),t.wrap=new TC.wrap.control.FeatureInfo(t),TC.Consts.classes.FROMLEFT="tc-fromleft",TC.Consts.classes.FROMRIGHT="tc-fromright",t.callback=function(e,n){for(var o=!1,a=0;a<t.map.workLayers.length;a++){var r=t.map.workLayers[a];if(r.type===TC.Consts.layerType.WMS&&r.getVisibility()&&r.names.length>0){o=!0;break}}o?t.wrap.getFeatureInfo(n):t.map.$events.trigger($.Event(TC.Consts.event.NOFEATUREINFO,{xy:n,control:t}))},t.layer=null,t.marker=null,t.info=null,t.popup=null,t.lastFeatureCount=null},TC.inherit(TC.control.FeatureInfo,TC.control.FeatureInfoCommons);var t=TC.control.FeatureInfo.prototype;t.CLASS="tc-ctl-finfo",t.FEATURE_PARAM="showfeature";var e=TC.apiLocation+"lib/jshash/md5-min.js";t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/FeatureInfo.html",t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureInfoDialog.html",t.template[t.CLASS+"-del-btn"]=TC.apiLocation+"TC/templates/FeatureInfoDeleteButton.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w('<ul class="tc-ctl-finfo-services">').s(e.get(["services"],!1),e,{"else":n,block:o},{}).w("</ul>").x(e.get(["featureCount"],!1),e,{block:L},{})}function n(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noData"}).w("</li>")}function o(t,e){return t.w("<li><h3>").x(e.getPath(!1,["mapLayer","title"]),e,{"else":a,block:r},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(e.get(["hasLimits"],!1),e,{"else":l,block:S},{}).w("</div></li>")}function a(t,e){return t.f(e.getPath(!1,["mapLayer","id"]),e,"h")}function r(t,e){return t.f(e.getPath(!1,["mapLayer","title"]),e,"h")}function l(t,e){return t.w('<ul class="tc-ctl-finfo-layers">').s(e.get(["layers"],!1),e,{"else":i,block:s},{}).w("</ul>")}function i(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataAtThisService"}).w("</li>")}function s(t,e){return t.w("<li><h4>").s(e.get(["path"],!1),e,{block:c},{}).w(' <span class="tc-ctl-finfo-layer-n">').f(e.getPath(!1,["features","length"]),e,"h").w('</span> </h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(e.get(["features"],!1),e,{"else":f,block:d},{}).w("</ul></div></li>")}function c(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:u},{})}function u(t,e){return t.w(" &bull; ")}function f(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataInThisLayer"}).w("</li>")}function d(t,e){return t.w("<li>").x(e.get(["rawContent"],!1),e,{"else":p,block:m},{}).w("</li>")}function p(t,e){return t.x(e.get(["error"],!1),e,{"else":C,block:g},{})}function C(t,e){return t.w("<h5>").f(e.get(["id"],!1),e,"h").w("</h5><table").x(e.get(["geometry"],!1),e,{block:y},{}).w("><tbody>").s(e.get(["attributes"],!1),e,{block:h},{}).w("</tbody></table>").x(e.get(["geometry"],!1),e,{block:v},{})}function y(t,e){return t.w(' title="').h("i18n",e,{},{$key:"clickToCenter"}).w('"')}function h(t,e){return t.w('<tr><th class="tc-ctl-finfo-attr">').f(e.get(["name"],!1),e,"h").w('</th><td class="tc-ctl-finfo-val">').f(e.get(["value"],!1),e,"h").w("</td></tr>")}function v(t,e){return t.w('<div class="tc-ctl-finfo-tools"><button class="tc-ctl-finfo-tools-btn" title="').h("i18n",e,{},{$key:"tools"}).w('">').h("i18n",e,{},{$key:"tools"}).w("</button></div>")}function g(t,e){return t.w('<span class="tc-ctl-finfo-errors">').h("i18n",e,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(e.get(["error"],!1),e,"h").w("</span></span>")}function m(t,e){return t.w("<h5>").h("i18n",e,{},{$key:"feature"}).w("</h5>").h("eq",e,{"else":w,block:_},{key:e.get(["rawFormat"],!1),value:"text/html"})}function w(t,e){return t.w("<pre>").f(e.get(["rawContent"],!1),e,"h").w("</pre>")}function _(t,e){return t.w(" ").x(e.get(["expandUrl"],!1),e,{block:b},{})}function b(t,e){return t.h("ne",e,{"else":T,block:k},{key:e.get(["expandUrl"],!1),value:""})}function T(t,e){return t.w('<iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" />')}function k(t,e){return t.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" /><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(e.get(["expandUrl"],!1),e,"h").w("', '_blank')\" title=\"").h("i18n",e,{},{$key:"expand"}).w('"></a></div>')}function S(t,e){return t.w('<span class="tc-ctl-finfo-errors">').f(e.get(["hasLimits"],!1),e,"h").w("</span>")}function L(t,e){return t.h("gt",e,{block:F},{key:e.get(["featureCount"],!1),value:"1",type:"number"})}function F(t,e){return t.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",e,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-idx"></span>/').f(e.get(["featureCount"],!1),e,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",e,{},{$key:"next"}).w("</a>")}return dust.register(t.CLASS,e),e.__dustBody=!0,n.__dustBody=!0,o.__dustBody=!0,a.__dustBody=!0,r.__dustBody=!0,l.__dustBody=!0,i.__dustBody=!0,s.__dustBody=!0,c.__dustBody=!0,u.__dustBody=!0,f.__dustBody=!0,d.__dustBody=!0,p.__dustBody=!0,C.__dustBody=!0,y.__dustBody=!0,h.__dustBody=!0,v.__dustBody=!0,g.__dustBody=!0,m.__dustBody=!0,w.__dustBody=!0,_.__dustBody=!0,b.__dustBody=!0,T.__dustBody=!0,k.__dustBody=!0,S.__dustBody=!0,L.__dustBody=!0,F.__dustBody=!0,e},t.template[t.CLASS+"-dialog"]=function(){function e(t,e){return t.w('<div class="tc-ctl-finfo-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"feature"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-finfo-dialog-dl"><h2>').h("i18n",e,{},{$key:"download"}).w('</h2><div><button class="tc-button tc-ctl-finfo-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-ctl-finfo-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-ctl-finfo-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-ctl-finfo-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button></div></div><div class="tc-ctl-finfo-dialog-share"></div></div></div></div>')}return dust.register(t.CLASS+"-dialog",e),e.__dustBody=!0,e},t.template[t.CLASS+"-del-btn"]=function(){function e(t,e){return t.w('<button class="tc-ctl-finfo-del-btn" title="').h("i18n",e,{},{$key:"deleteFeature"}).w('">').h("i18n",e,{},{$key:"deleteFeature"}).w("</button>")}return dust.register(t.CLASS+"-del-btn",e),e.__dustBody=!0,e});var n=function(t,n){t.sharedFeatureInfo=n,TC.loadJS(!window.hex_md5,[e],function(){var e=t.map.options.pixelTolerance||TC.Cfg.pixelTolerance,o=2*e+1,a=[e,e],r=o*n.r/2,l=[n.xy[0]-r,n.xy[1]-r,n.xy[0]+r,n.xy[1]+r];t.beforeGetFeatureInfo({xy:a,control:t}),t.wrap.getFeatureInfo(a,{serviceUrl:n.s,layerName:n.l,featureId:n.f,mapSize:[o,o],boundingBox:l})})},o=function a(t,e){var n;if($.isArray(t)){n=t.slice();for(var o=0,r=n.length;r>o;o++)n[o]=a(n[o])}else n="number"==typeof t?Math.round(t.toFixed(e)):t;return n};t.register=function(t){var e=this;TC.control.Click.prototype.register.call(e,t),e._$div.appendTo("<div>"),_layer=e.options.layer?e.options.layer:{id:TC.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0},t.loaded(function(){$.when(t.addLayer(_layer)).then(function(t){e.layer=t;var o=TC.Util.getParameterByName(e.FEATURE_PARAM);if(o){var a;try{a=JSON.parse(decodeURIComponent(escape(window.atob(o))))}catch(r){}a&&n(e,a)}})}),$.when(t.addControl("popup",{closeButton:!0,draggable:e.options.draggable})).then(function(n){e.popup=n,n.caller=e,t.on(TC.Consts.event.POPUP,function(t){e.onShowPopUp(t),e.popup.$popupDiv.on(TC.Consts.event.CLICK,"."+e.CLASS+"-tools-btn",function(t){e._shareCtl||e.map.addControl("share",{div:e._$dialogDiv.find(".tc-modal-body .tc-ctl-finfo-dialog-share")}).then(function(t){e._shareCtl=t})})}),t.on(TC.Consts.event.POPUPHIDE,function(t){t.control===n&&e.popup.$popupDiv.css("width","auto")})}),t.on(TC.Consts.event.BEFOREFEATUREINFO,function(t){e.beforeGetFeatureInfo(t)}),t.on(TC.Consts.event.FEATUREINFO,function(t){e.isActive&&(e.lastFeatureCount=e.countFeatures(t),e.responseCallback(t))}),t.$events.on(TC.Consts.event.NOFEATUREINFO,function(t){e.lastFeatureCount=0,e.popup&&e.popup.hide()}),TC.loadJS(!TC.Consts.event.POPUPHIDE,[TC.apiLocation+"TC/control/Popup.js"],function(){t.$events.on(TC.Consts.event.POPUPHIDE,function(t){e.popup===t.control&&e.layer&&e.layer.clearFeatures()})})},t.onShowModal=function(){var t=this,n=t.popup.$popupDiv.find("ul."+t.CLASS+"-features li."+TC.Consts.classes.CHECKED),a=t._shareCtl;a.extraParams=null;var r=n.parents("li").first(),l=r.parents("li").first(),i=t.info.services[l.index()];if(i){var s=i.layers[r.index()];if(s){var c=s.features[n.index()];TC.loadJS(!window.hex_md5,[e],function(){var e=hex_md5(JSON.stringify({data:c.getData(),geometry:o(c.geometry,TC.Consts.DEGREE_PRECISION)}));a.extraParams={},a.extraParams[t.FEATURE_PARAM]=window.btoa(unescape(encodeURIComponent(JSON.stringify({xy:c.wrap.getInnerPoint(),r:t.map.getResolution(),s:i.mapLayer.url,l:s.name,f:c.id,h:e}))));var n=a._$div;n.find(".tc-url input[type=text]").val(a.generateLink()),n.find(".tc-iframe input[type=text]").val(a.generateIframe())})}}},t.responseCallback=function(t){var e=this;if(e.marker){var n=t.services;e.info={services:n,defaultFeature:t.defaultFeature};for(var a=0;a<n.length;a++){for(var r=n[a],l=0;l<r.layers.length;l++)r.layers[l].features.length||(r.layers.splice(l,1),l-=1);r.layers.length||(n.splice(a,1),a-=1)}n.length?e.renderData(t,function(){if(e._$div.find("td."+e.CLASS+"-val").each(function(t,n){var o=$(n),a=o.text();TC.Util.isURL(a)&&o.html('<a href="'+a+'" target="_blank" title="'+e.getLocaleString("linkInNewWindow")+'">'+a+"</a>")}),e.sharedFeatureInfo){e._$div.find("ul."+e.CLASS+"-services li").addClass(TC.Consts.classes.CHECKED);for(var t,n=e.sharedFeatureInfo,a=0,r=e.info.services.length;r>a;a++){var l=e.info.services[a];if(l.mapLayer.url===n.s){for(var i=0,s=l.layers.length;s>i;i++){var c=l.layers[i];if(c.name===n.l){for(var u=0,f=c.features.length;f>u;u++){var d=c.features[u];if(d.id===n.f){t=d;var p=hex_md5(JSON.stringify({data:d.getData(),geometry:o(d.geometry,TC.Consts.DEGREE_PRECISION)}));n.h!==p&&TC.alert(e.getLocaleString("finfo.featureChanged.warning"));break}}break}}break}}t&&e.map.addControl(new TC.control.Popup({div:TC.Util.getDiv(),closeButton:!0})).then(function(n){t.data=e._$div.html(),n.$popupDiv.addClass(e.CLASS+"-lite");e.getLocaleString("deleteFeature");e.getRenderedHtml(e.CLASS+"-del-btn",null,function(t){n.$popupDiv.append(t),n.$popupDiv.find("."+e.CLASS+"-del-btn").on(TC.Consts.event.CLICK,function(t){TC.confirm(e.getLocaleString("deleteFeature.confirm"),function(){e.map.removeLayer(e.sharedFeatureLayer),delete e.sharedFeatureLayer})})}),t.showsPopup=!0,t.popup=n,e.map.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,title:e.getLocaleString("foi")}).then(function(n){e.sharedFeatureLayer=n,e.layer.clearFeatures(),n.addFeature(t),e.map.zoomToFeatures([t])})}),delete e.sharedFeatureInfo}else e.popup&&(e.marker.data=$("<div>").append(e._$div.clone()).html(),e.marker.showPopup(e.popup))}):e.layer.clearFeatures()}}}();