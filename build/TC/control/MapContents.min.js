TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.MapContents=function(){var e=this;TC.Control.apply(e,arguments),e.layerTrees={}},TC.inherit(TC.control.MapContents,TC.Control),function(){var e=TC.control.MapContents.prototype;e.CLASS="tc-ctl-mc";var t={img:"tcImg"};e.render=function(e){var t=this;t.map&&t.renderData(t.map.getLayerTree(),e)},e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t.render(function(){for(var r=0,n=e.layers.length;n>r;r++)t.updateLayerTree(e.layers[r]);e.on(TC.Consts.event.ZOOM,function(){t.updateScale()}).on(TC.Consts.event.UPDATEPARAMS,function(e){var r=e.layer.names,n=function o(e){var t=!1;if(e)if($.inArray(e.name,r)>=0)t=!0;else for(var n=0;n<e.children.length;n++)if(o(e.children[n])){t=!0;break}return t};n(t.layerTrees[e.layer.id])||0===r.length?t.update():t.updateLayerTree(e.layer)}).on(TC.Consts.event.LAYERVISIBILITY,function(e){t.updateLayerVisibility(e.layer)}).on(TC.Consts.event.LAYERADD,function(e){t.updateLayerTree(e.layer)}).on(TC.Consts.event.VECTORUPDATE+" "+TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(e){t._updateLayerTreeTimeout&&clearTimeout(t._updateLayerTreeTimeout),t._updateLayerTreeTimeout=setTimeout(function(){t.map.workLayers.indexOf(e.layer)>-1&&(t.updateLayerTree(e.layer),delete t._updateLayerTreeTimeout)},100)}).on(TC.Consts.event.LAYERREMOVE,function(e){t.removeLayer(e.layer)})})},e.updateScale=function(){},e.updateLayerVisibility=function(e){},e.updateLayerTree=function(e){this.layerTrees[e.id]=e.getTree()},e.removeLayer=function(e){this.update()};var r=function(e){return/[&?]REQUEST=getLegendGraphic/i.test(e)},n=function(e,t){var r="error.tc";TC.Cfg.proxy&&e.off(r).on(r,function(){e.attr("src",TC.proxify(t))});var n=t.indexOf("//");e.attr("src",0>n?t:t.substr(n))};e.styleLegendImage=function(e,o){if(!e.attr("src")){var a=e.data(t.img);if(o&&o.options.method&&"POST"===o.options.method)o.getLegendGraphicImage().done(function(t){n(e,t)}).fail(function(e){TC.error(e)});else{if(r(a)){var i=e.parent(),s=i.css("color"),c=s.indexOf("("),T=s.indexOf(")");if(c>=0&&T>c){color=s.substr(0,T).substr(c+1).split(","),s="0x";for(var l=0;3>l;l++){var u=parseInt(color[l]).toString(16);s+=1===u.length?"0"+u:u}}else s.replace("#","0x");a+="&LEGEND_OPTIONS=fontName:"+i.css("font-family")+";fontSize:"+parseInt(i.css("font-size"))+";fontColor:"+s+";fontAntiAliasing:true",e.data(t.img,a)}n(e,a)}}}}();