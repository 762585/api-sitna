TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.LayerCatalog=function(){var t=this;t.layers=[],t.searchInit=!1,TC.Control.apply(t,arguments),t._readyDeferred=$.Deferred(),TC.Consts.classes.SELECTABLE||(TC.Consts.classes.SELECTABLE="tc-selectable"),TC.Consts.classes.INCOMPATIBLE||(TC.Consts.classes.INCOMPATIBLE="tc-incompatible"),TC.Consts.classes.ACTIVE||(TC.Consts.classes.ACTIVE="tc-active"),t._$div.on("mouseup.tc","li",function(e){var a=$(e.target);a.hasClass(t.CLASS+"-leaf")||(a.toggleClass(TC.Consts.classes.COLLAPSED),a.find("ul").first().toggleClass(TC.Consts.classes.COLLAPSED),e.stopPropagation())})},TC.inherit(TC.control.LayerCatalog,TC.Control),function(){var t=TC.control.LayerCatalog.prototype;t.CLASS="tc-ctl-lcat",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/LayerCatalog.html",t.template[t.CLASS+"-branch"]=TC.apiLocation+"TC/templates/LayerCatalogBranch.html",t.template[t.CLASS+"-node"]=TC.apiLocation+"TC/templates/LayerCatalogNode.html",t.template[t.CLASS+"-info"]=TC.apiLocation+"TC/templates/LayerCatalogInfo.html",t.template[t.CLASS+"-results"]=TC.apiLocation+"TC/templates/LayerCatalogResults.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"availableLayers"}).x(e.get(["enableSearch"],!1),e,{block:a},{}).w('</h2><div class="tc-ctl-lcat-search tc-hidden tc-collapsed"><div class="tc-group"><input type="search" class="tc-ctl-lcat-input tc-textbox" placeholder="').h("i18n",e,{},{$key:"textToSearchInLayers"}).w('" /></div><ul></ul></div><div class="tc-ctl-lcat-tree">').x(e.get(["layerTrees"],!1),e,{"else":n,block:r},{}).w('</div><div class="tc-ctl-lcat-info tc-hidden">').p("tc-ctl-lcat-info",e,e.rebase(e.getPath(!0,[])),{}).w("</div>")}function a(t,e){return t.x(e.get(["layerTrees"],!1),e,{block:s},{})}function s(t,e){return t.w('<button class="tc-ctl-lcat-btn-search" title="').h("i18n",e,{},{$key:"searchlayersbytext"}).w('"></button>')}function n(t,e){return t.w('<div class="tc-ctl tc-ctl-lcat-loading"><span>').h("i18n",e,{},{$key:"loadingLayerTree"}).w("...</span></div>")}function r(t,e){return t.w('<ul class="tc-ctl-lcat-branch">').s(e.get(["layerTrees"],!1),e,{block:l},{}).w("</ul>")}function l(t,e){return t.p("tc-ctl-lcat-branch",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS,e),e.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,n.__dustBody=!0,r.__dustBody=!0,l.__dustBody=!0,e},t.template[t.CLASS+"-branch"]=function(){function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{"else":a,block:s},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><span>').f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:n},{}).w("</ul></li>")}function a(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}function s(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}function n(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-branch",e),e.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-node"]=function(){function e(t,e){return t.x(e.get(["isVisible"],!1),e,{block:a},{})}function a(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{"else":s,block:n},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><span data-tooltip="').x(e.get(["name"],!1),e,{block:r},{}).w('">').f(e.get(["title"],!1),e,"h").w("</span>").x(e.get(["name"],!1),e,{block:l},{}).w('<ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:o},{}).w("</ul></li>")}function s(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}function n(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}function r(t,e){return t.h("i18n",e,{},{$key:"clickToAddToMap"})}function l(t,e){return t.w('<a class="tc-ctl-lcat-btn-info"/>')}function o(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-node",e),e.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,n.__dustBody=!0,r.__dustBody=!0,l.__dustBody=!0,o.__dustBody=!0,e},t.template[t.CLASS+"-info"]=function(){function e(t,e){return t.w('<a class="tc-ctl-lcat-info-close"></a><h2>').h("i18n",e,{},{$key:"layerInfo"}).w('</h2><h3 class="tc-ctl-lcat-title">').f(e.get(["title"],!1),e,"h").w("</h3>").x(e.get(["abstract"],!1),e,{block:a},{}).x(e.get(["metadata"],!1),e,{block:s},{})}function a(t,e){return t.w('<div class="tc-ctl-lcat-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div>").f(e.get(["abstract"],!1),e,"h").w("</div></div>")}function s(t,e){return t.w('<div class="tc-ctl-lcat-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:n},{}).w("</ul></div>")}function n(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h").w("</a></li>")}return dust.register(t.CLASS+"-info",e),e.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-results"]=function(){function e(t,e){return t.s(e.get(["results"],!1),e,{"else":a,block:s},{})}function a(t,e){return t.w('<li class="tc-ctl-lcat-no-results"><h5>').h("i18n",e,{},{$key:"geo.noFilteredTracks"}).w("</h5></li>")}function s(t,e){return t.w('<li data-tc-layer-name="').f(e.get(["Name"],!1),e,"h").w('" ').x(e.get(["alreadyAdded"],!1),e,{"else":n,block:r},{}).w('><h5 class="tc-selectable">').f(e.get(["Title"],!1),e,"h").w('</h5><button class="tc-ctl-lcat-search-btn-info" /><p>').f(e.get(["Abstract"],!1),e,"h").w("</p></li>")}function n(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"clickToAddToMap"}).w('" ')}function r(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"layerAlreadyAdded"}).w('" class="tc-checked" ')}return dust.register(t.CLASS+"-results",e),e.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,n.__dustBody=!0,r.__dustBody=!0,e}),function(){var e={LAYER:"tcLayer",LAYERNAME:"tcLayerName",LAYERINFO:"tcLayerInfo"},a=3,s="data-tooltip";t.register=function(t){var a=this;TC.Control.prototype.register.call(a,t);var n=function(){if($.isArray(a.options.layers)){for(var t=0;t<a.options.layers.length;t++){var e=a.options.layers[t];e.type&&e.type!==TC.Consts.layerType.WMS||(e.id||(e.id=TC.getUID()),$.isPlainObject(e)&&(e=new TC.layer.Raster(e)),a.layers.push(e))}a.render(function(){a._readyDeferred.resolve()})}else a._readyDeferred.resolve()},r=function(e){e.layer===t.baseLayer&&(n(),t.off(TC.Consts.event.LAYERUPDATE,r))};t.loaded(function(){t.baseLayer.state&&t.baseLayer.state!==TC.Layer.state.IDLE?t.on(TC.Consts.event.LAYERUPDATE,r):n()});var l=function(t){var s=$();if(!t.isBase){var n=t.options.url;a._$roots&&a._$roots.each(function(a,r){var l=$(r),o=l.data(e.LAYER);o&&o.type===t.type&&o.options.url===n&&(s=s.add(l))})}return s},o=function(t,e){var a=$(),s=e||l(t);if(s.length)for(var n=0;n<t.names.length;n++){var r=s.find('li[data-tc-layer-name="'+t.names[n]+'"]');a=a.add(r),a=a.add(r.find("li"))}return a},i=function(t){var s=$();if(!t.isBase){var n=t.options.url;a.$list&&a.$list.find("li").each(function(a,r){var l=$(r),o=l.data(e.LAYER);if(o&&o.type===t.type&&o.options.url===n)for(var i=0;i<t.names.length;i++)l.is('li[data-tc-layer-name="'+t.names[i]+'"]')&&(s=s.add(l))})}return s},c=function(){if("createEvent"in document){var t=document.createEvent("HTMLEvents");t.initEvent("keyup",!1,!0),a.$text&&a.$text[0].dispatchEvent(t)}else a.$text&&a.$text[0].fireEvent("keyup")},C=function(t){var e=a.map.getControlsByClass(TC.control.ListTOC)[0];if(e)for(var n=e.layers,r=0;r<n.length;r++){var l=n[r];l!==t&&o(l).addClass(TC.Consts.classes.CHECKED).find("span").attr(s,d)}},d=a.getLocaleString("layerAlreadyAdded"),u=a.getLocaleString("clickToAddToMap");t.on(TC.Consts.event.BEFORELAYERADD+" "+TC.Consts.event.BEFOREUPDATEPARAMS,function(t){o(t.layer).hasClass(TC.Consts.classes.LOADING)||o(t.layer).addClass(TC.Consts.classes.LOADING).find("span").removeAttr(s)}).on(TC.Consts.event.LAYERADD+" "+TC.Consts.event.UPDATEPARAMS,function(t){var e=t.layer;e.isBase||e.type!==TC.Consts.layerType.WMS||a._readyDeferred.then(function(){var t=l(e),n=function(){o(e,t).removeClass(TC.Consts.classes.LOADING).addClass(TC.Consts.classes.CHECKED).find("span").attr(s,d),c()};if(t.length)n();else{for(var r=!1,i=0,C=a.layers.length;C>i;i++){var u=a.layers[i];if(u.type===e.type&&u.options.url===e.options.url){r=!0;break}}r||a.addLayer(new TC.layer.Raster({url:e.options.url,type:e.type,layerNames:[],title:e.title||e.wrap.getServiceTitle(),hideTitle:!0,hideTree:!1})).then(function(){t=l(e),n()})}})}).on(TC.Consts.event.LAYERERROR,function(t){t.reason&&TC.alert(a.getLocaleString(t.reason,{url:t.layer.url})),o(t.layer).removeClass(TC.Consts.classes.LOADING)}).on(TC.Consts.event.LAYERREMOVE,function(t){o(t.layer).removeClass(TC.Consts.classes.CHECKED).find("span").attr(s,u),i(t.layer).removeClass(TC.Consts.classes.CHECKED).attr(s,u),C(t.layer),c()}).on(TC.Consts.event.EXTERNALSERVICEADDED,function(t){t&&t.layer&&(a.addLayer(t.layer),a._$div.removeClass("tc-collapsed"))}),a._$div.on(TC.Consts.event.CLICK,"span",function(n){var r=$(n.target),l=r.parent();if(!l.hasClass(TC.Consts.classes.LOADING)&&!l.hasClass(TC.Consts.classes.CHECKED)){n.preventDefault;var o=l.data(e.LAYERNAME);o=void 0!==o?o.toString():"";var i=a._$roots.has(l).data(e.LAYER);if(i||(i=l.data(e.LAYER)),i&&o){var c=1;/iPad/i.test(navigator.userAgent)?c=10:TC.Util.detectFirefox()&&(c=250),i.title||(i.title=i.getTree().title),l.addClass(TC.Consts.classes.LOADING).find("span").attr(s,"");var C=function(t){var e=new $.Deferred;return setTimeout(function(){t[0].offsetHeight=t[0].offsetHeight,t[0].offsetWidth=t[0].offsetWidth,e.resolve()},c),e.promise()};C(l).then(function(){t.addLayer({id:TC.getUID(),url:i.options.url,hideTitle:i.options.hideTitle,title:i.title,layerNames:[o]}),n.stopPropagation()})}}})},t.render=function(t){var n=this,r=$.map(n.layers,function(t){return t.wrap.getLayer()});$.when.apply(n,r).then(function(){var r=$.map(n.layers,function(t){var e=t.getTree(),a=function s(e){for(var a=!1,n=0;n<e.children.length;n++)s(e.children[n])&&(a=!0);return e.hasOwnProperty("isVisible")&&(e.isVisible=!t.names||!t.names.length||a||e.isVisible),e.isVisible};return a(e),e});n.renderData({layerTrees:r,enableSearch:n.options.enableSearch},function(){var r=n.getLocaleString("layerAlreadyAdded");n._$roots=n._$div.find("div."+n.CLASS+"-tree > ul."+n.CLASS+"-branch > li."+n.CLASS+"-node"),n._$roots.each(function(t,a){var l=n.layers[t],o=$(a).data(e.LAYER,l),i=o.find("a."+n.CLASS+"-btn-info"),c={};i.each(function(t,a){var o=$(a),i=o.parent().find("span").first(),C=o.parent().data(e.LAYERNAME).toString();if(C){i.addClass(TC.Consts.classes.SELECTABLE);var d=l.wrap.getInfo(C);if(d.hasOwnProperty("abstract")||d.hasOwnProperty("legend")||d.hasOwnProperty("metadata")){if(d.metadata)for(var u=0,f=d.metadata.length;f>u;u++){var h=d.metadata[u];h.formatDescription=c[h.format]=c[h.format]||n.getLocaleString(TC.Util.getSimpleMimeType(h.format))||n.getLocaleString("viewMetadata")}o.data(e.LAYERINFO,d),o.on(TC.Consts.event.CLICK,function(){$(this).hasClass(TC.Consts.classes.CHECKED)?($(this).removeClass(TC.Consts.classes.CHECKED),n.hideLayerInfo()):(n.showLayerInfo(l,C),$(this).addClass(TC.Consts.classes.CHECKED))})}else o.remove();if(l.compatibleLayers&&l.compatibleLayers.indexOf(C)<0&&i.parent().append('<span class="'+TC.Consts.classes.INCOMPATIBLE+'" title="'+n.getLocaleString("srsNotCompatible")+'"></span>'),n.map)for(var u=0,f=n.map.workLayers.length;f>u;u++){var y=n.map.workLayers[u];y.type===TC.Consts.layerType.WMS&&y.url===l.url&&1===y.names.length&&y.names[0]===C&&(i.parent().addClass(TC.Consts.classes.CHECKED),i.attr(s,r))}}else i.attr(s,""),o.remove()})}),n.$text=n._$div.find("."+n.CLASS+"-input"),n.$list=n._$div.find("."+n.CLASS+"-search ul"),n.$text.on("mouseup",function(t){var e=n.$text.val();""!==e&&setTimeout(function(){var t=n.$text.val();""===t&&n.$list.empty()},1)});var l=[];TC._search=TC._search||{},TC._search.retryTimeout=null,TC.loadJS(!n.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){n.$text.autocomplete({link:"#",target:n.$list,minLength:0,source:function(t,s){l=[],n._$roots.find("li."+TC.Consts.classes.CHECKED).each(function(t,a){l.push($(a).data(e.LAYERNAME).toString())}),t=t.trim(),t.length<a?n.$list.html(""):t.length>=a&&(TC._search.retryTimeout&&clearTimeout(TC._search.retryTimeout),TC._search.retryTimeout=setTimeout(function(){var e=n.layers[0].searchSubLayers(t);s(e)},TC._search.interval))},callback:function(t){n.$text.val(t.target.text||t.target.innerText),TC._search.lastPattern=n.$text.val(),n.goToResult(unescape(t.target.hash).substring(1)),n.$text.autocomplete("clear")},buildHTML:function(t){if(t.results.length>0)for(var e=n.map.getLayerTree().workLayers,a=0;a<t.results.length;a++){delete t.results[a].alreadyAdded;for(var s=0;s<e.length;s++)if(l.indexOf(t.results[a].Name)>=0){t.results[a].alreadyAdded=!0;break}t.results[a].Name||(t.results.splice(a,1),a--)}var r="";return dust.render(n.CLASS+"-results",t,function(t,e){r=e}),r}})}),n.searchInit||(n._$div.on("click","h2 button",function(){var t=n._$div.hasClass("tc-collapsed");n._$div.removeClass("tc-collapsed");var e=n._$div.find("."+n.CLASS+"-search"),a=n._$div.find("."+n.CLASS+"-tree"),s=n._$div.find("."+n.CLASS+"-info");e.hasClass(TC.Consts.classes.HIDDEN)||t?(e.removeClass(TC.Consts.classes.HIDDEN),a.addClass(TC.Consts.classes.HIDDEN),s.addClass(TC.Consts.classes.HIDDEN),n.$text[0].focus(),$(this).addClass(n.CLASS+"-btn-tree"),$(this).attr("title",n.getLocaleString("viewAvailableLayersTree")),$(this).removeClass(n.CLASS+"-btn-search")):(e.addClass(TC.Consts.classes.HIDDEN),a.removeClass(TC.Consts.classes.HIDDEN),$(this).addClass(n.CLASS+"-btn-search"),$(this).attr("title",n.getLocaleString("searchLayersByText")),$(this).removeClass(n.CLASS+"-btn-tree"))}),n._$div.on("click",".tc-ctl-lcat-search button",function(t){t.stopPropagation();var e=$(this).parents("li:first");e.hasClass(TC.Consts.classes.ACTIVE)?e.removeClass(TC.Consts.classes.ACTIVE):($(this).parents("ul:first").find("li."+TC.Consts.classes.ACTIVE).removeClass(TC.Consts.classes.ACTIVE),e.addClass(TC.Consts.classes.ACTIVE))}),n._$div.on("click",".tc-ctl-lcat-search li",function(t){t.stopPropagation();var a=$(this),l=a.data(e.LAYERNAME);if(l=void 0!==l?l.toString():"",!$(this).hasClass(TC.Consts.classes.CHECKED)){var o=n.layers[0].options.url,i=n.layers[0].title;n.map.addLayer({id:TC.getUID(),url:o,title:i,hideTitle:!0,layerNames:[l]},function(t){a.data(e.LAYER,t)}),$(this).addClass(TC.Consts.classes.CHECKED),$(this).attr(s,r)}}),n.searchInit=!0),$.isFunction(t)&&t()})})},t.showLayerInfo=function(t,a){var s=this,n=null,r=s._$div.find("."+s.CLASS+"-info"),l=function(t,a){var n=!1,l=r.data(e.LAYERNAME);return void 0!==l&&l.toString()===t?(r.data(e.LAYERNAME,""),r.removeClass(TC.Consts.classes.HIDDEN)):a&&(n=!0,r.data(e.LAYERNAME,t),r.removeClass(TC.Consts.classes.HIDDEN),dust.render(s.CLASS+"-info",a,function(t,e){r.html(e),t&&TC.error(t),r.find("."+s.CLASS+"-info-close").on(TC.Consts.event.CLICK,function(){s.hideLayerInfo()})})),n};return s._$roots.find("a."+s.CLASS+"-btn-info").removeClass(TC.Consts.classes.CHECKED),s._$roots.each(function(r,o){var i=$(o);if(i.data(e.LAYER)===t){var c=i.find("a."+s.CLASS+"-btn-info");return c.each(function(t,s){var r=$(s),o=r.parent().data(e.LAYERNAME).toString();if(o===a){var i=r.data(e.LAYERINFO);return r.toggleClass(TC.Consts.classes.CHECKED,l(o,i)),n=i,!1}}),!1}}),n}}(),t.hideLayerInfo=function(){var t=this;t._$roots.find("a."+t.CLASS+"-btn-info").removeClass(TC.Consts.classes.CHECKED),t._$div.find("."+t.CLASS+"-info").addClass(TC.Consts.classes.HIDDEN)},t.addLayer=function(t){var e=$.Deferred(),a=this,s=[];return a.options.layers&&a.options.layers.length&&(s=$.grep(a.options.layers,function(e){var a=TC.Util.reqGetMapOnCapabilities(e.url);return a&&a.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)})),0==s.length&&(s=$.grep(a.layers,function(e){return e.url.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)})),0==s.length?(a.layers.push(t),t.getCapabilitiesPromise().then(function(){t.compatibleLayers=t.wrap.getCompatibleLayers(a.map.crs),t.title=t.title||t.wrap.getServiceTitle(),a.render(function(){e.resolve()})})):e.resolve(),e}}();