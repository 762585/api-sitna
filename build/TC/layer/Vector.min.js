TC.layer=TC.layer||{};TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer");TC.layer.Vector=function(){TC.Layer.apply(this,arguments);this.type=this.options.type||TC.Consts.layerType.VECTOR;this.features=[];this.selectedFeatures=[];if(this.url&&(function(e){var t=e.indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));return".kml"===e.substr(e.length-4).toLowerCase()}(this.url)||this.type===TC.Consts.layerType.KML)){this.type=TC.Consts.layerType.KML;this.title=this.options.title||function(e){for(var t=e,i=new RegExp("([^/]+.kml)","i"),r=0;r<3;r++){e=decodeURIComponent(e);var n=i.exec(e);if(n.length>1){t=n[1];break}}return t}(this.url)}this.wrap=new TC.wrap.layer.Vector(this);var e=this.wrap.createVectorLayer();this.wrap.setLayer(e)};TC.inherit(TC.layer.Vector,TC.Layer);!function(){var e=TC.layer.Vector.prototype;e.getTree=function(){var e=null;if(!this.options.stealth){(e={}).children=[];for(var t=0;t<this.features.length;t++){var i=this.features[t].getPath();if(i.length){var r=TC.Util.addArrayToTree(i,e);r&&(r.legend=this.features[t].getLegend())}}e.name=this.name||e.name;e.customLegend=this.options.customLegend;e.title=this.title||e.title;e.uid=this.id}return e};var t=function(e,t,i,r){var n=new $.Deferred;$.when(t.call(e,[i],r)).then(function(t){n.resolve(t[0]);e.map.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{layer:e,feature:t[0]}))});return n},i=function(e,t,i,r,n){var s=new $.Deferred,a=e.options.styles&&e.options.styles[r]||TC.Cfg.styles[r],o=$.extend(!0,{},a,n);TC.loadJS(!TC.feature||TC.feature&&!TC.feature[i],[TC.apiLocation+"TC/feature/"+i],function(){for(var r=TC.feature[i],n=new Array(t.length),a=[],l=0,u=t.length;l<u;l++){var h,f=t[l];const i=TC.wrap.Feature.prototype.isNative(f);if(f instanceof r)h=f;else{o.layer=e;i&&(h=f._wrap&&f._wrap.parent);h||(h=new r(f,o))}h.layer=e;n[l]=h;e.features[e.features.length]=h;i||(a[a.length]=h.wrap.feature);h.options.showPopup&&h.showPopup()}a.length&&e.wrap.addFeatures(a);s.resolve(n)});return s};e.addPoint=function(e,i){return t(this,this.addPoints,e,i)};e.addPoints=function(e,t){return i(this,e,"Point",TC.Consts.geom.POINT,t)};e.addMarker=function(e,i){return t(this,this.addMarkers,e,i)};e.addMarkers=function(e,t){return i(this,e,"Marker","marker",t)};e.addPolyline=function(e,i){return t(this,this.addPolylines,e,i)};e.addPolylines=function(e,t){return i(this,e,"Polyline",TC.Consts.geom.POLYLINE,t)};e.addMultiPolyline=function(e,i){return t(this,this.addMultiPolylines,e,i)};e.addMultiPolylines=function(e,t){return i(this,e,"MultiPolyline",TC.Consts.geom.POLYLINE,t)};e.addPolygon=function(e,i){return t(this,this.addPolygons,e,i)};e.addPolygons=function(e,t){return i(this,e,"Polygon",TC.Consts.geom.POLYGON,t)};e.addMultiPolygon=function(e,i){return t(this,this.addMultiPolygons,e,i)};e.addMultiPolygons=function(e,t){return i(this,e,"MultiPolygon",TC.Consts.geom.POLYGON,t)};e.addCircle=function(e,i){return t(this,this.addCircles,e,i)};e.addCircles=function(e,t){return i(this,e,"Circle",TC.Consts.geom.POLYGON,t)};e.addFeature=function(e){var t;TC.feature&&(TC.feature.Point&&e instanceof TC.feature.Point?t=this.addPoint(e):TC.feature.Polyline&&e instanceof TC.feature.Polyline?t=this.addPolyline(e):TC.feature.Polygon&&e instanceof TC.feature.Polygon?t=this.addPolygon(e):TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon?t=this.addMultiPolygon(e):TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline?t=this.addMultiPolyline(e):TC.feature.Circle&&e instanceof TC.feature.Circle&&(t=this.addCircle(e)));return t};e.removeFeature=function(e){const t=this;if(t.map){t.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&t.currentFeature===e&&t.hide()})}t.wrap.removeFeature(e)};e.getFeatureById=function(e){var t=null,i=this.wrap.getFeatureById(e);i&&(t=i._wrap.parent);return t};e.clearFeatures=function(){var e=this;if(e.features&&e.wrap){if(e.map){e.map.getControlsByClass("TC.control.Popup").forEach(function(t){t.isVisible()&&e.features.indexOf(t.currentFeature)>=0&&t.hide()})}e.features.length=0;e.wrap.clearFeatures()}};e.describeFeatureType=function(e,t){var i=$.Deferred();$.ajax({url:this.wrap.getDescribeFeatureTypeUrl(),type:"GET",dataType:"xml"}).then(function(e){var t="http://www.w3.org/2001/XMLSchema",r=e.getElementsByTagNameNS(t,"complexType")[0];if(r){for(var n=r.getElementsByTagNameNS(t,"element"),s=new Array(n.length),a=0,o=n.length;a<o;a++){var l=n[a];s[a]={name:l.getAttribute("name"),type:l.getAttribute("type"),nillable:"true"===l.getAttribute("nillable"),minOccurs:parseInt(l.getAttribute("minOccurs")),maxOccurs:parseInt(l.getAttribute("maxOccurs"))}}i.resolve(s)}else{var u=e.getElementsByTagName("Exception")[0];u&&i.reject(u.getElementsByTagName("ExceptionText")[0].innerHTML)}},function(e,t,r){i.reject(r)});i.then(function(t){$.isFunction(e)&&e(t)},function(e){$.isFunction(t)&&t(e)});return i.promise()};e.import=function(e){this.wrap.import(e)};e.setNodeVisibility=function(e,t){this.state=TC.Layer.state.LOADING;this.map.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE));this.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:this}));this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)this.setVisibility(t);else{this._cache.visibilityStates[e]=t?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var i,r,n=!1;for(i=0;i<this.features.length;i++)if((r=this.features[i]).id==e){n=!0;r.setVisibility(t);break}if(!n)for(i=0;i<this.features.length;i++){void 0===(r=this.features[i])._path&&(r._path="/"+r.getPath().join("/"));r._path===e&&r.setVisibility(t)}}this.state=TC.Layer.state.IDLE;this.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:this}));this.map.$events.trigger($.Event(TC.Consts.event.UPDATE))};e.getNodeVisibility=function(e){var t=TC.Layer.prototype.getNodeVisibility.call(this,e);this.tree||(this.tree=this.getTree());if(this.findNode(e,this.tree)===this.tree)t=this.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var i=this._cache.visibilityStates[e];void 0!==i&&(t=i)}return t};e.setModifiable=function(e){this.wrap.setModifiable(e)};e.applyEdits=function(e,t,i){return this.wrap.sendTransaction(e,t,i)};e.refresh=function(){return this.wrap.reloadSource()};e.getFeaturesInCurrentExtent=function(e){var t=this.map.getExtent();return this.getFeaturesInExtent(t,e)};e.getFeaturesInExtent=function(e,t){return this.wrap.getFeaturesInExtent(e,t)};e.setProjection=function(e){const t=this;t.wrap.setProjection(e);if(e.crs&&e.oldCrs){t.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:t}));t.features.forEach(function(t){t.wrap.setGeometry(TC.Util.reproject(t.geometry,e.oldCrs,e.crs));t.geometry=t.wrap.getGeometry()});t.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:t}))}}}();