var SITNA=window.SITNA||{},TC=window.TC||{};TC.isDebug=!1;!function(){if(!window.TC||!window.TC.Cfg){if(document.currentScript)o=document.currentScript;else{var e=document.getElementsByTagName("script");o=e[e.length-1]}var a=o.getAttribute("src");TC.apiLocation=a.substr(0,a.lastIndexOf("/")+1);var t=TC.apiLocation+(TC.isDebug?"tcmap.js":"tcmap.min.js"),r=new XMLHttpRequest;r.open("GET",t,!1);r.send(null);var o,s=document.getElementsByTagName("head")[0];(o=document.createElement("script")).type="text/javascript";o.text=r.responseText;s.appendChild(o)}}();SITNA.Map=function(e,a){var t=this;TC.Cfg.controls.search.allowedSearchTypes=$.extend(TC.Cfg.controls.search.allowedSearchTypes,{urban:{},street:{},number:{},cadastral:{}});if(a&&a.controls&&a.controls.search){var r=$.extend(a.controls.search,{allowedSearchTypes:{}});for(key in a.controls.search)if("boolean"==typeof a.controls.search[key]){if(a.controls.search[key])switch(!0){case"postalAddress"===key:r.allowedSearchTypes[TC.Consts.searchType.NUMBER]={};break;case"cadastralParcel"===key:r.allowedSearchTypes[TC.Consts.searchType.CADASTRAL]={};break;case"town"===key:r.allowedSearchTypes[TC.Consts.searchType.URBAN]={};break;default:r.allowedSearchTypes[key]={}}delete r[key]}a.controls.search=r}var o,s,n=new TC.Map(e,a);t.addLayer=function(e,a){n.addLayer(e,a)};t.setBaseLayer=function(e,a){n.setBaseLayer(e,a)};t.addMarker=function(e,a){n.addMarker(e,a)};t.zoomToMarkers=function(e){n.zoomToMarkers(e)};t.loaded=function(e){n.loaded(e)};n.loaded(function(){(o=new TC.control.Search).register(n);o.getLayer().then(function(e){s=e});if(!n.activeControl){var e=n.getControlsByClass("TC.control.FeatureInfo")[0];e&&e.activate()}});t.getQueryableData=function(e,a){var t=o.availableSearchTypes[e];if(t.queryableData)a&&a(t.queryableData);else{var r={request:"GetFeature",service:"WFS",typename:t.featurePrefix+":"+t.featureType,version:t.version,propertyname:(t.dataIdProperty instanceof Array?t.dataIdProperty:[t.dataIdProperty]).concat(t.outputProperties instanceof Array?t.outputProperties:[t.outputProperties]).join(","),outputformat:TC.Consts.format.JSON},s=t.url+"?"+$.param(r);$.ajax({url:s}).done(function(e){t.queryableData=[];if(e.features)for(var r=e.features,s=0;s<r.length;s++){var n=r[s];e={id:[]};t.dataIdProperty instanceof Array||(t.dataIdProperty=[t.dataIdProperty]);for(var l=0;l<t.dataIdProperty.length;l++)n.properties.hasOwnProperty(t.dataIdProperty[l])&&e.id.push(n.properties[t.dataIdProperty[l]]);e.id=t.idPropertiesIdentifier?e.id.join(t.idPropertiesIdentifier):e.id.join("");e.label=[];t.outputProperties instanceof Array||(t.outputProperties=[t.outputProperties]);for(var i=0;i<t.outputProperties.length;i++)n.properties.hasOwnProperty(t.outputProperties[i])&&e.label.push(n.properties[t.outputProperties[i]]);var u=e.label instanceof Array&&e.label.join("").trim().length>0||!(e.label instanceof Array)&&e.label.trim().length>0;e.label=t.outputFormatLabel?t.outputFormatLabel.tcFormat(e.label):e.label.join("-");u&&t.queryableData.push(e)}t.queryableData=t.queryableData.sort(function(e,a){return t.idPropertiesIdentifier&&-1==e.id.indexOf(t.idPropertiesIdentifier)?o.removePunctuation(e.label)<o.removePunctuation(a.label)?-1:o.removePunctuation(e.label)>o.removePunctuation(a.label)?1:0:o.removePunctuation(e.label.split(" ")[0])<o.removePunctuation(a.label.split(" ")[0])?-1:o.removePunctuation(e.label.split(" ")[0])>o.removePunctuation(a.label.split(" ")[0])?1:0});t.queryableData=t.queryableData.filter(function(e,a,t){return a<1||e.id!==t[a-1].id&&e.label!==t[a-1].label});a&&a(t.queryableData)})}};t.getMunicipalities=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.MUNICIPALITY,e)};t.getUrbanAreas=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.URBAN,e)};t.getCommonwealths=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.COMMONWEALTH,e)};t.getCouncils=function(e){t.getQueryableData(SITNA.Consts.mapSearchType.COUNCIL,e)};t.searchCommonwealth=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.COMMONWEALTH,e,a)};t.searchCouncil=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.COUNCIL,e,a)};t.searchUrbanArea=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.URBAN,e,a)};t.searchMunicipality=function(e,a){t.searchTyped(SITNA.Consts.mapSearchType.MUNICIPALITY,e,a)};t.searchTyped=function(e,a,r){var l=TC.getUID(),i=o.availableSearchTypes[e];a instanceof Array&&i.goToIdFormat&&(a=i.goToIdFormat.tcFormat(a));o._search.data=o._search.data||[];o._search.data.push({dataLayer:i.featureType,dataRole:e,id:a,label:"",text:""});t.removeSearch();if(o.availableSearchTypes[e]&&!o.allowedSearchTypes[e]){o.allowedSearchTypes={};o.allowedSearchTypes[e]={};o.availableSearchTypes[e].hasOwnProperty("goTo")||(o.allowedSearchTypes[e]={goTo:function(){var r,s={id:l,type:SITNA.Consts.layerType.WFS,url:i.url,version:i.version,stealth:!0,geometryName:"the_geom",featurePrefix:i.featurePrefix,featureType:i.featureType,properties:function(e){TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter");var a=[];i.idPropertiesIdentifier&&(e=e.split(i.idPropertiesIdentifier));e instanceof Array||(e=[e]);for(var t=0;t<i.dataIdProperty.length;t++)a.push(new TC.filter.equalTo(i.dataIdProperty[t],$.trim(e[t])));return a=a.length>1?new TC.filter.and(a):a[0]}(a),outputFormat:TC.Consts.format.JSON,styles:i.styles[i.featureType]};n.addLayer(s).then(function(a){r=a;t.search={layer:a,type:e};delete o.allowedSearchTypes[e]});n.one(TC.Consts.event.FEATURESADD,function(e){if(e.layer==r&&e.layer.features&&e.layer.features.length>0){for(var a=0;a<e.layer.features.length;a++)e.layer.features[a].showsPopup!=o.queryableFeatures&&(e.layer.features[a].showsPopup=o.queryableFeatures);n.zoomToFeatures(e.layer.features)}})}})}n.one(TC.Consts.event.SEARCHQUERYEMPTY,function(e){n.toast(o.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});r&&r(null)});n.one(TC.Consts.event.FEATURESADD,function(a){a.layer==s&&a.layer.features&&a.layer.features.length>0&&n.zoomToFeatures(a.layer.features);t.search={layer:a.layer,type:e};r&&r(a.layer.id!==l?a.layer.id:l)});o.goToResult(a)};t.searchFeature=function(e,a,r,s){var l=TC.getUID(),i=o.featurePrefix;t.removeSearch();e=(e||"").trim();a=(a||"").trim();r=(r||"").trim();if(0==e.length||0==a.length||0==r.length){n.toast(o.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});s&&s(null)}else{if(e.indexOf(":")>-1){i=e.split(":")[0];e=e.split(":")[1]}var u,p={id:l,type:SITNA.Consts.layerType.WFS,url:o.url,version:o.version,stealth:!0,geometryName:"the_geom",featurePrefix:i,featureType:e,maxFeatures:1,properties:o.transformFilter([{name:a,value:r,type:TC.Consts.comparison.EQUAL_TO}]),outputFormat:TC.Consts.format.JSON};n.addLayer(p).then(function(e){u=e;t.search={layer:e,type:SITNA.Consts.mapSearchType.GENERIC}});n.on(TC.Consts.event.FEATURESADD,function(e){if(e.layer==u&&e.layer.features&&e.layer.features.length>0){for(var a=0;a<e.layer.features.length;a++)e.layer.features[a].showsPopup!=o.queryableFeatures&&(e.layer.features[a].showsPopup=o.queryableFeatures);n.zoomToFeatures(e.layer.features)}});n.on(TC.Consts.event.LAYERUPDATE,function(e){e.layer==u&&e.newData&&e.newData.features&&0==e.newData.features.length&&n.toast(o.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3});s&&s(e.layer==u&&e.newData&&e.newData.features&&0==e.newData.features.length?null:l)})}};t.removeSearch=function(e){if(t.search)if(o.availableSearchTypes[t.search.type]&&o.availableSearchTypes[t.search.type].hasOwnProperty("goTo")){for(var a=0;a<t.search.layer.features.length;a++)t.search.layer.removeFeature(t.search.layer.features[a]);t.search=null}else n.removeLayer(t.search.layer).then(function(){t.search=null});e&&e()};t.exportImage=function(){return n.exportImage()};t.search=null};SITNA.Consts=TC.Consts;SITNA.Cfg=TC.Cfg;SITNA.Cfg.layout=TC.apiLocation+"TC/layout/responsive";