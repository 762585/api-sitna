var SITNA=window.SITNA||{},TC=window.TC||{};SITNA.syncLoadJS=function(e){var a=new XMLHttpRequest;a.open("GET",e,!1),a.send(null);var t=document.getElementsByTagName("head")[0],r=document.createElement("script");r.type="text/javascript",r.text=a.responseText,t.appendChild(r)},function(){if(!window.TC||!window.TC.Cfg){var e,a;if(document.currentScript)a=document.currentScript;else{var t=document.getElementsByTagName("script");a=t[t.length-1]}var e=a.getAttribute("src");TC.apiLocation=e.substr(0,e.lastIndexOf("/")+1),SITNA.syncLoadJS(TC.apiLocation+"tcmap.js")}}(),SITNA.Map=function(e,a){var t,r,o=this,n=new TC.Map(e,a);o.addLayer=function(e,a){n.addLayer(e,a)},o.setBaseLayer=function(e,a){n.setBaseLayer(e,a)},o.addMarker=function(e,a){n.addMarker(e,a)},o.zoomToMarkers=function(e){n.zoomToMarkers(e)},o.loaded=function(e){n.loaded(e)},n.loaded(function(){if(t=new TC.control.Search,t.register(n),t.getLayer().then(function(e){r=e}),!n.activeControl){var e=n.getControlsByClass("TC.control.FeatureInfo")[0];e&&e.activate()}}),o.getQueryableData=function(e,a){var r=t.availableSearchTypes[e];if(r.queryableData)a&&a(r.queryableData);else{var o={request:"GetFeature",service:"WFS",typename:r.featurePrefix+":"+r.featureType,version:r.version,propertyname:(r.dataIdProperty instanceof Array?r.dataIdProperty:[r.dataIdProperty]).concat(r.outputProperties instanceof Array?r.outputProperties:[r.outputProperties]).join(","),outputformat:TC.Consts.format.JSON},n=r.url+"?"+$.param(o);$.ajax({url:n}).done(function(e){if(r.queryableData=[],e.features)for(var o=e.features,n=0;n<o.length;n++){var s=o[n],e={};e.id=[],r.dataIdProperty instanceof Array||(r.dataIdProperty=[r.dataIdProperty]);for(var l=0;l<r.dataIdProperty.length;l++)s.properties.hasOwnProperty(r.dataIdProperty[l])&&e.id.push(s.properties[r.dataIdProperty[l]]);e.id=e.id.join(r.idPropertiesIdentifier?r.idPropertiesIdentifier:""),e.label=[],r.outputProperties instanceof Array||(r.outputProperties=[r.outputProperties]);for(var i=0;i<r.outputProperties.length;i++)s.properties.hasOwnProperty(r.outputProperties[i])&&e.label.push(s.properties[r.outputProperties[i]]);var u=e.label instanceof Array&&e.label.join("").trim().length>0||!(e.label instanceof Array)&&e.label.trim().length>0;e.label=r.outputFormatLabel?r.outputFormatLabel.tcFormat(e.label):e.label.join("-"),u&&r.queryableData.push(e)}r.queryableData=r.queryableData.sort(function(e,a){return(r.idPropertiesIdentifier?-1!=e.id.indexOf(r.idPropertiesIdentifier):1)?t.removePunctuation(e.label.split(" ")[0])<t.removePunctuation(a.label.split(" ")[0])?-1:t.removePunctuation(e.label.split(" ")[0])>t.removePunctuation(a.label.split(" ")[0])?1:0:t.removePunctuation(e.label)<t.removePunctuation(a.label)?-1:t.removePunctuation(e.label)>t.removePunctuation(a.label)?1:0}),r.queryableData=r.queryableData.filter(function(e,a,t){return 1>a?!0:e.id!==t[a-1].id&&e.label!==t[a-1].label}),a&&a(r.queryableData)})}},o.getMunicipalities=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.MUNICIPALITY,e)},o.getUrbanAreas=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.URBAN,e)},o.getCommonwealths=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.COMMONWEALTH,e)},o.getCouncils=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.COUNCIL,e)},o.searchCommonwealth=function(e,a){o.searchTyped(SITNA.Consts.mapSearchType.COMMONWEALTH,e,a)},o.searchCouncil=function(e,a){o.searchTyped(SITNA.Consts.mapSearchType.COUNCIL,e,a)},o.searchUrbanArea=function(e,a){o.searchTyped(SITNA.Consts.mapSearchType.URBAN,e,a)},o.searchMunicipality=function(e,a){o.searchTyped(SITNA.Consts.mapSearchType.MUNICIPALITY,e,a)},o.searchTyped=function(e,a,s){var l=TC.getUID(),i=t.availableSearchTypes[e];a instanceof Array&&i.goToIdFormat&&(a=i.goToIdFormat.tcFormat(a)),t._search.data=t._search.data||[],t._search.data.push({dataLayer:i.featureType,dataRole:e,id:a,label:"",text:""}),o.removeSearch(),t.availableSearchTypes[e]&&!t.allowedSearchTypes[e]&&(t.allowedSearchTypes={},t.allowedSearchTypes[e]={},t.availableSearchTypes[e].hasOwnProperty("goTo")||(t.allowedSearchTypes[e]={goTo:function(){var r,s=function(e,a,t){return e[a][t]},u=function(e){var a=[];i.idPropertiesIdentifier&&(e=e.split(i.idPropertiesIdentifier)),e instanceof Array||(e=[e]);for(var t=0;t<i.dataIdProperty.length;t++)a.push({name:i.dataIdProperty[t],value:e[t],type:TC.Consts.comparison.EQUAL_TO});return a},p={id:l,type:SITNA.Consts.layerType.WFS,url:i.url,version:i.version,stealth:!0,geometryName:"the_geom",featurePrefix:i.featurePrefix,featureType:i.featureType,properties:u(a),outputFormat:TC.Consts.format.JSON,styles:{polygon:{fillColor:s.bind(self,i.styles[i.featureType],"polygon","fillColor"),fillOpacity:s.bind(self,i.styles[i.featureType],"polygon","fillOpacity")},line:{strokeColor:s.bind(self,i.styles[i.featureType],"line","strokeColor"),strokeOpacity:s.bind(self,i.styles[i.featureType],"line","strokeOpacity"),strokeWidth:s.bind(self,i.styles[i.featureType],"line","strokeWidth")}}};n.addLayer(p).then(function(a){r=a,o.search={layer:a,type:e},delete t.allowedSearchTypes[e]}),n.one(TC.Consts.event.FEATURESADD,function(e){if(e.layer==r&&e.layer.features&&e.layer.features.length>0){for(var a=0;a<e.layer.features.length;a++)e.layer.features[a].showsPopup!=t.queryableFeatures&&(e.layer.features[a].showsPopup=t.queryableFeatures);n.zoomToFeatures(e.layer.features)}})}})),n.one(TC.Consts.event.SEARCHQUERYEMPTY,function(e){n.toast(t.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3}),s&&s(null)}),n.one(TC.Consts.event.FEATURESADD,function(a){a.layer==r&&a.layer.features&&a.layer.features.length>0&&n.zoomToFeatures(a.layer.features),o.search={layer:a.layer,type:e},s&&s(a.layer.id!==l?a.layer.id:l)}),t.goToResult(a)},o.searchFeature=function(e,a,r,s){var l=TC.getUID(),i=t.featurePrefix;if(o.removeSearch(),e=(e||"").trim(),a=(a||"").trim(),r=(r||"").trim(),0==e.length||0==a.length||0==r.length)n.toast(t.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3}),s&&s(null);else{e.indexOf(":")>-1&&(i=e.split(":")[0],e=e.split(":")[1]);var u,p={id:l,type:SITNA.Consts.layerType.WFS,url:t.url,version:t.version,stealth:!0,geometryName:"the_geom",featurePrefix:i,featureType:e,maxFeatures:1,properties:[{name:a,value:r,type:TC.Consts.comparison.EQUAL_TO}],outputFormat:TC.Consts.format.JSON};n.addLayer(p).then(function(e){u=e,o.search={layer:e,type:SITNA.Consts.mapSearchType.GENERIC}}),n.on(TC.Consts.event.FEATURESADD,function(e){if(e.layer==u&&e.layer.features&&e.layer.features.length>0){for(var a=0;a<e.layer.features.length;a++)e.layer.features[a].showsPopup!=t.queryableFeatures&&(e.layer.features[a].showsPopup=t.queryableFeatures);n.zoomToFeatures(e.layer.features)}}),n.on(TC.Consts.event.LAYERUPDATE,function(e){e.layer==u&&e.layer.features&&0==e.layer.features.length&&n.toast(t.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3}),s&&s(e.layer==u&&e.layer.features&&0==e.layer.features.length?null:l)})}},o.removeSearch=function(e){if(o.search)if(t.availableSearchTypes[o.search.type]&&t.availableSearchTypes[o.search.type].hasOwnProperty("goTo")){for(var a=0;a<o.search.layer.features.length;a++)o.search.layer.removeFeature(o.search.layer.features[a]);o.search=null}else n.removeLayer(o.search.layer).then(function(){o.search=null});e&&e()},o.search=null},SITNA.Consts=TC.Consts,SITNA.Cfg=TC.Cfg,SITNA.Cfg.layout=TC.apiLocation+"TC/layout/responsive";